<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>âš”ï¸ Pixel Quest â€” 20 Stages</title>
<link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
<style>
:root{
  --gold:#f0c060;--gold2:#c8932a;--dark:#0a0804;--panel:rgba(14,8,2,.95);
  --border:#8b6020;--border2:#3a2008;--red:#e03020;--green:#20a040;--blue:#2060c0;
}
*{margin:0;padding:0;box-sizing:border-box;image-rendering:pixelated;font-family:'Press Start 2P',monospace;}
body{background:#050302;display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:100vh;overflow:hidden;user-select:none;}

/* â”€â”€ WRAPPER â”€â”€ */
#wrap{position:relative;width:700px;max-width:100vw;}
#gc{display:block;width:700px;height:420px;max-width:100vw;border:3px solid var(--border2);outline:3px solid var(--border);
  box-shadow:0 0 0 2px var(--border2),0 0 50px rgba(255,120,20,.35),0 0 100px rgba(150,70,0,.2);cursor:default;}

/* â”€â”€ HUD TOP â”€â”€ */
#hud{position:absolute;top:0;left:0;right:0;pointer-events:none;padding:5px 7px;display:flex;justify-content:space-between;align-items:flex-start;gap:6px;}
.hudbox{background:var(--panel);border:2px solid var(--border);outline:1px solid var(--border2);padding:5px 8px;}
.hrow{display:flex;align-items:center;gap:5px;margin-bottom:3px;font-size:6px;color:var(--gold);white-space:nowrap;}
.hrow:last-child{margin-bottom:0;}
.bar{width:76px;height:7px;background:#1a0808;border:1px solid #4a1010;position:relative;overflow:hidden;flex-shrink:0;}
.bfill{height:100%;position:absolute;top:0;left:0;transition:width .2s;}
#hpf{background:linear-gradient(90deg,#b01818,#e83028);}
#xpf{background:linear-gradient(90deg,#1850b0,#3090f0);}
#stf{background:linear-gradient(90deg,#b07010,#f0c020);}
.hudmid{display:flex;flex-direction:column;align-items:center;gap:3px;}
.hudr{display:flex;flex-direction:column;align-items:flex-end;gap:3px;}
.tag{font-size:6px;color:var(--gold);background:var(--panel);border:2px solid var(--border);outline:1px solid var(--border2);padding:3px 6px;display:flex;align-items:center;gap:4px;white-space:nowrap;}

/* â”€â”€ BOTTOM BAR â”€â”€ */
#bot{display:flex;align-items:center;justify-content:space-between;background:#0d0702;border:2px solid var(--border2);border-top:2px solid var(--border);padding:4px 8px;gap:6px;}
#inv{display:flex;gap:3px;}
.isl{width:36px;height:36px;background:#0a0602;border:2px solid #5a3810;display:flex;align-items:center;justify-content:center;font-size:14px;cursor:pointer;position:relative;transition:border-color .1s;}
.isl:hover,.isl.active{border-color:var(--gold);}
.isl .ic{position:absolute;bottom:0;right:1px;font-size:5px;color:var(--gold);}
#btns{display:flex;gap:3px;flex-wrap:wrap;justify-content:center;}
.btn{font-size:5px;color:var(--gold);background:#0e0802;border:2px solid var(--border);padding:4px 7px;cursor:pointer;transition:all .1s;white-space:nowrap;}
.btn:hover{background:#2a1608;border-color:var(--gold);}
.btn:active{transform:scale(.96);}
.btn.r{border-color:#6b2020;} .btn.r:hover{border-color:#ff4040;background:#1a0808;}
.btn.g{border-color:#206b20;} .btn.g:hover{border-color:#40ff40;background:#081808;}
.btn.b{border-color:#20406b;} .btn.b:hover{border-color:#4080ff;background:#080818;}
.btn.y{border-color:#6b6020;} .btn.y:hover{border-color:#ffff40;background:#181408;}
#stageinfo{font-size:5px;color:#806030;text-align:right;line-height:1.9;min-width:90px;}

/* â”€â”€ MSG â”€â”€ */
#msg{position:absolute;bottom:48px;left:50%;transform:translateX(-50%);background:rgba(6,3,0,.97);border:2px solid var(--gold2);outline:1px solid var(--border2);padding:4px 12px;font-size:6px;color:#f0d080;white-space:nowrap;pointer-events:none;opacity:0;transition:opacity .18s;z-index:10;}
#msg.show{opacity:1;}

/* â”€â”€ CTRL HINT â”€â”€ */
#ctrl{position:absolute;bottom:48px;right:5px;font-size:4px;color:#4a3010;line-height:2;pointer-events:none;text-align:right;}

/* â”€â”€ MINIMAP â”€â”€ */
#mm{position:absolute;top:4px;left:50%;transform:translateX(-50%);pointer-events:none;display:none;}
#mmc{border:1px solid var(--border);outline:1px solid var(--border2);}

/* â”€â”€ SCREENS â”€â”€ */
.screen{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:30;}

/* â”€â”€ TITLE â”€â”€ */
#title{background:radial-gradient(ellipse at center,#120804 0%,#050302 70%);}
#title h1{font-size:22px;color:var(--gold);text-shadow:0 0 30px rgba(240,150,0,.9),4px 4px 0 #3a1000;margin-bottom:8px;animation:glowpulse 2s ease-in-out infinite;text-align:center;}
#title h2{font-size:7px;color:#806028;margin-bottom:6px;letter-spacing:.1em;}
#title h3{font-size:6px;color:#5a4018;margin-bottom:30px;letter-spacing:.05em;}
@keyframes glowpulse{0%,100%{text-shadow:0 0 30px rgba(240,150,0,.9),4px 4px 0 #3a1000}50%{text-shadow:0 0 60px rgba(255,210,0,1),4px 4px 0 #3a1000,0 0 100px rgba(255,180,0,.5)}}

/* Name entry */
#nameform{display:flex;flex-direction:column;align-items:center;gap:10px;margin-bottom:20px;}
#nameform label{font-size:7px;color:var(--gold);}
#nameinput{font-family:'Press Start 2P',monospace;font-size:9px;color:var(--gold);background:#0e0802;border:3px solid var(--border);outline:none;padding:8px 14px;text-align:center;width:260px;letter-spacing:.05em;}
#nameinput::placeholder{color:#4a3010;font-size:7px;}

.bigbtn{font-family:'Press Start 2P',monospace;font-size:9px;color:var(--gold);background:#0e0802;border:3px solid var(--gold2);padding:10px 28px;cursor:pointer;transition:all .15s;margin:4px;}
.bigbtn:hover{background:#2a1a06;box-shadow:0 0 20px rgba(200,147,42,.5);}
.bigbtn.blink{animation:blink 1s step-end infinite;}
@keyframes blink{0%,100%{opacity:1}50%{opacity:.25}}

/* â”€â”€ WORLD MAP SCREEN â”€â”€ */
#mapscr{background:#040608;display:none;}
#mapscr h2{font-size:9px;color:var(--gold);margin-bottom:14px;text-shadow:2px 2px 0 #2a1000;}
#mapcv{border:3px solid var(--border);outline:2px solid var(--border2);cursor:pointer;}
#maplbl{font-size:6px;color:#907040;margin-top:8px;background:rgba(14,8,2,.8);border:1px solid var(--border2);padding:5px 10px;}

/* â”€â”€ SHOP SCREEN â”€â”€ */
#shopscr{background:rgba(4,2,0,.98);display:none;}
#shopscr h2{font-size:9px;color:#ffd060;margin-bottom:4px;}
#shopgold{font-size:7px;color:#ffd700;margin-bottom:10px;}
#shopgrid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:6px;width:640px;max-height:300px;overflow-y:auto;margin-bottom:10px;padding:2px;}
.sitem{background:#0c0800;border:2px solid #5a3810;padding:7px 9px;cursor:pointer;transition:all .12s;display:flex;flex-direction:column;gap:3px;}
.sitem:hover{border-color:var(--gold2);background:#1a1004;}
.sitem.owned{border-color:#206020;opacity:.55;pointer-events:none;}
.si-name{font-size:6px;color:var(--gold);}
.si-desc{font-size:5px;color:#907040;line-height:1.6;}
.si-price{font-size:6px;color:#ffd700;margin-top:2px;}

/* â”€â”€ RANK SCREEN â”€â”€ */
#rankscr{background:rgba(2,4,10,.98);display:none;}
#rankscr h2{font-size:9px;color:#60c0ff;margin-bottom:4px;text-shadow:0 0 20px rgba(60,150,255,.6);}
#ranksub{font-size:6px;color:#406080;margin-bottom:12px;}
#ranklist{width:580px;max-height:300px;overflow-y:auto;}
.rrow{display:flex;align-items:center;gap:8px;padding:6px 10px;border-bottom:1px solid #0a1020;font-size:6px;}
.rrow.me{background:rgba(60,100,200,.12);border-color:#204060;}
.rrank{width:30px;color:#406080;text-align:center;}
.rrank.gold{color:#ffd700;}.rrank.silv{color:#c0c0c0;}.rrank.bron{color:#cd7f32;}
.rname{flex:1;color:#80c0f0;}
.rcoins{color:#ffd700;min-width:60px;text-align:right;}
.rstage{color:#806040;min-width:60px;text-align:right;font-size:5px;}
.rlvl{color:#60a060;min-width:40px;text-align:right;font-size:5px;}

/* â”€â”€ GAME OVER / WIN â”€â”€ */
#ovl{background:rgba(0,0,0,.92);display:none;}
#ovl h2{font-size:20px;margin-bottom:12px;}
#ovl p{font-size:6px;color:#a07030;margin-bottom:20px;text-align:center;line-height:2.2;}
#finalstats{font-size:6px;color:#80c060;text-align:center;margin-bottom:16px;line-height:2;}

/* â”€â”€ STAGE CLEAR â”€â”€ */
#stageclear{position:absolute;inset:0;background:rgba(0,0,0,.6);display:none;flex-direction:column;align-items:center;justify-content:center;z-index:25;pointer-events:none;}
#stageclear h2{font-size:18px;color:#ffd700;text-shadow:0 0 30px rgba(255,200,0,.8),3px 3px 0 #5a3000;animation:glowpulse 1s ease-in-out infinite;}
#stageclear p{font-size:8px;color:#c0a040;margin-top:10px;}

@keyframes fadein{from{opacity:0;transform:translateY(-10px)}to{opacity:1;transform:translateY(0)}}
</style>
</head>
<body>
<div id="wrap">
  <canvas id="gc" width="700" height="420"></canvas>

  <!-- HUD -->
  <div id="hud">
    <div class="hudbox">
      <div class="hrow">â¤ï¸<div class="bar"><div class="bfill" id="hpf"></div></div><span id="hptx"></span></div>
      <div class="hrow">â­<div class="bar"><div class="bfill" id="xpf"></div></div><span id="xptx"></span></div>
      <div class="hrow">âš¡<div class="bar"><div class="bfill" id="stf"></div></div><span id="sttx"></span></div>
    </div>
    <div id="mm"><canvas id="mmc" width="88" height="66"></canvas></div>
    <div class="hudr">
      <div class="tag">ğŸª™<span id="cntx">0</span></div>
      <div class="tag">ğŸ§ªx<span id="pttx">3</span></div>
      <div class="tag">ğŸ’£x<span id="bmtx">0</span></div>
      <div class="tag" id="lvltag">LVL 1</div>
    </div>
  </div>

  <div id="msg"></div>
  <div id="ctrl">WASD:Move Z:Atk X:Pot B:Bomb<br>E:Shop M:Map R:Rank TAB:Next</div>

  <!-- BOTTOM BAR -->
  <div id="bot">
    <div id="inv">
      <div class="isl active" id="sl0" onclick="selSlot(0)" title="Weapon">âš”ï¸</div>
      <div class="isl" id="sl1" onclick="selSlot(1)" title="Potion">ğŸ§ª<span class="ic" id="pic"></span></div>
      <div class="isl" id="sl2" onclick="selSlot(2)" title="Bomb">ğŸ’£<span class="ic" id="bic"></span></div>
      <div class="isl" id="sl3" onclick="selSlot(3)" title="Special">â“</div>
      <div class="isl" id="sl4" onclick="selSlot(4)" title="Special 2">â“</div>
      <div class="isl" id="sl5" onclick="selSlot(5)" title="Special 3">â“</div>
    </div>
    <div id="btns">
      <button class="btn r" onclick="plAtk()">âš”ATK[Z]</button>
      <button class="btn g" onclick="usePot()">ğŸ§ªPOT[X]</button>
      <button class="btn r" onclick="useBomb()">ğŸ’£BOM[B]</button>
      <button class="btn b" onclick="toggleShop()">ğŸªSHOP[E]</button>
      <button class="btn b" onclick="toggleMap()">ğŸ—ºMAP[M]</button>
      <button class="btn y" onclick="toggleRank()">ğŸ†RANK[R]</button>
      <button class="btn" onclick="nextStage()" id="nextbtn" style="display:none">â–¶NEXT[TAB]</button>
    </div>
    <div id="stageinfo"><div id="stnm" style="color:var(--gold)">â€”</div><div id="stsb" style="color:#604020">â€”</div><div id="stwv" style="color:#403010">â€”</div></div>
  </div>

  <!-- STAGE CLEAR FLASH -->
  <div id="stageclear"><h2>âš” STAGE CLEAR! âš”</h2><p id="screwards"></p></div>

  <!-- TITLE -->
  <div class="screen" id="title">
    <div id="starbg" style="position:absolute;inset:0;pointer-events:none;overflow:hidden;"></div>
    <h1>âš” PIXEL QUEST</h1>
    <h2>Chronicles of the Ember Realm</h2>
    <h3>20 STAGES Â· GLOBAL RANKINGS Â· ENDLESS PLAY</h3>
    <div id="nameform">
      <label>ENTER YOUR NAME:</label>
      <input id="nameinput" type="text" maxlength="14" placeholder="KNIGHT" spellcheck="false" autocomplete="off">
    </div>
    <button class="bigbtn blink" onclick="startGame()">â–¶ EMBARK</button>
    <button class="bigbtn" onclick="toggleRank()" style="font-size:7px;margin-top:4px;">ğŸ† VIEW RANKINGS</button>
  </div>

  <!-- WORLD MAP -->
  <div class="screen" id="mapscr">
    <h2>ğŸ—º WORLD MAP â€” EMBER REALM</h2>
    <canvas id="mapcv" width="620" height="320" onclick="mapClick(event)"></canvas>
    <div id="maplbl">Hover or click a stage node to travel</div>
    <div style="display:flex;gap:8px;margin-top:8px;">
      <button class="bigbtn" style="font-size:7px;padding:7px 18px;" onclick="toggleMap()">âœ– CLOSE</button>
    </div>
  </div>

  <!-- SHOP -->
  <div class="screen" id="shopscr">
    <h2>âš— MERCHANT'S EMPORIUM</h2>
    <div id="shopgold">ğŸª™ Gold: <span id="sgold">0</span></div>
    <div id="shopgrid"></div>
    <button class="bigbtn" style="font-size:7px;padding:7px 18px;" onclick="toggleShop()">âœ– CLOSE SHOP</button>
  </div>

  <!-- RANK -->
  <div class="screen" id="rankscr">
    <h2>ğŸ† GLOBAL RANKINGS</h2>
    <div id="ranksub">Most gold collected across all runs</div>
    <div id="ranklist"></div>
    <div style="margin-top:10px;display:flex;gap:8px;">
      <button class="bigbtn" style="font-size:7px;padding:7px 18px;" onclick="toggleRank()">âœ– CLOSE</button>
      <button class="bigbtn" style="font-size:7px;padding:7px 18px;" onclick="clearRank()">ğŸ—‘ CLEAR MY SCORE</button>
    </div>
  </div>

  <!-- GAME OVER / VICTORY -->
  <div class="screen" id="ovl">
    <h2 id="ovltitle"></h2>
    <div id="finalstats"></div>
    <p id="ovlsub"></p>
    <div style="display:flex;gap:8px;flex-wrap:wrap;justify-content:center;">
      <button class="bigbtn" onclick="continueRun()">â–¶ CONTINUE RUN</button>
      <button class="bigbtn" onclick="restartGame()" style="font-size:7px;">â†º NEW GAME</button>
    </div>
  </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PIXEL QUEST â€” 20 STAGES FULL ENGINE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const cv=document.getElementById('gc'), ctx=cv.getContext('2d');
const mmc=document.getElementById('mmc'), mmx=mmc.getContext('2d');
ctx.imageSmoothingEnabled=false; mmx.imageSmoothingEnabled=false;

let G=null, RAF=null, lastT=0, msgT=null;
const W=700, H=420;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// 20 STAGE DEFINITIONS
// Each has unique: layout, bg theme, enemy mix, boss, map pos
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MAP LAYOUT: Linear path S1â†’S20 left-to-right, top-to-bottom
// Row 1 (yâ‰ˆ60):  S1  S2  S3  S4  S5
// Row 2 (yâ‰ˆ160): S10 S9  S8  S7  S6
// Row 3 (yâ‰ˆ230): S11 S12 S13 S14 S15
// Row 4 (yâ‰ˆ300): S20 S19 S18 S17 S16
// Snake pattern ensures strict level order 1â†’20

// MAP node positions (mx,my) arranged in snake order
// Canvas is 620x320
const _R1Y=55, _R2Y=145, _R3Y=225, _R4Y=305;
const _COL=[38,155,272,389,506]; // 5 columns

const STAGES=[
  // â”€â”€ ACT I: VOLCANIC WASTES â”€â”€â”€ row1 leftâ†’right (S1â€“S5)
  {id:0, name:'Ember Flats',   act:'ACT I',   bg:'lava',
   sky:['#200a00','#140500'],gr:'#3a1808',ac:'#ff6010',
   mx:_COL[0],my:_R1Y, conn:[1],
   enemies:['imp','sprite'],boss:'demon',waves:2,maxE:3,
   loot:{coins:[8,18],xp:[6,12]}},
  {id:1, name:'Lava Chasms',   act:'ACT I',   bg:'lava2',
   sky:['#2a0c00','#180600'],gr:'#4a1a08',ac:'#ff8020',
   mx:_COL[1],my:_R1Y, conn:[0,2],
   enemies:['imp','demon'],boss:'lavaking',waves:2,maxE:4,
   loot:{coins:[12,22],xp:[8,16]}},
  {id:2, name:'Ashfall Ruins', act:'ACT I',   bg:'ruins',
   sky:['#180a08','#100605'],gr:'#2c1210',ac:'#e05020',
   mx:_COL[2],my:_R1Y, conn:[1,3],
   enemies:['sprite','ashgolem'],boss:'ruinwarden',waves:3,maxE:4,
   loot:{coins:[14,26],xp:[10,18]}},
  {id:3, name:'The Smelter',   act:'ACT I',   bg:'forge',
   sky:['#1a0800','#0e0500'],gr:'#301008',ac:'#ffaa00',
   mx:_COL[3],my:_R1Y, conn:[2,4],
   enemies:['imp','ashgolem','forge'],boss:'forgelord',waves:3,maxE:5,
   loot:{coins:[18,32],xp:[14,22]}},
  {id:4, name:'Twilight Grove', act:'ACT II',  bg:'forest',
   sky:['#030e06','#020a04'],gr:'#0a1a0c',ac:'#30d050',
   mx:_COL[4],my:_R1Y, conn:[3,5],
   enemies:['wolf','hexbat'],boss:'forestwitch',waves:2,maxE:3,
   loot:{coins:[14,24],xp:[10,18]}},

  // â”€â”€ ACT II: CURSED FOREST â”€â”€â”€â”€ row2 rightâ†’left (S6â€“S10) SNAKE
  {id:5, name:'Mushroom Depths',act:'ACT II',  bg:'mushroom',
   sky:['#050a10','#030608'],gr:'#081814',ac:'#60ff80',
   mx:_COL[4],my:_R2Y, conn:[4,6],
   enemies:['spider','hexbat','wolf'],boss:'sporemind',waves:3,maxE:4,
   loot:{coins:[16,28],xp:[12,20]}},
  {id:6, name:'Wraithwood',    act:'ACT II',  bg:'forest2',
   sky:['#040c06','#020804'],gr:'#0c1c0c',ac:'#20c040',
   mx:_COL[3],my:_R2Y, conn:[5,7],
   enemies:['wraith','necro','wolf'],boss:'lichknight',waves:3,maxE:4,
   loot:{coins:[20,34],xp:[14,24]}},
  {id:7, name:'Black Canopy',  act:'ACT II',  bg:'darkforest',
   sky:['#020808','#010506'],gr:'#061410',ac:'#10d870',
   mx:_COL[2],my:_R2Y, conn:[6,8],
   enemies:['necro','wraith','spider'],boss:'shadowdruid',waves:3,maxE:5,
   loot:{coins:[24,40],xp:[18,28]}},
  {id:8, name:'Frost Shore',   act:'ACT III', bg:'ice',
   sky:['#04080f','#02050c'],gr:'#0a1020',ac:'#40c0ff',
   mx:_COL[1],my:_R2Y, conn:[7,9],
   enemies:['golem','icearcher'],boss:'frostgiant',waves:3,maxE:4,
   loot:{coins:[20,36],xp:[14,24]}},
  {id:9, name:'Blizzard Pass', act:'ACT III', bg:'blizzard',
   sky:['#030610','#02040c'],gr:'#08101c',ac:'#60d0ff',
   mx:_COL[0],my:_R2Y, conn:[8,10],
   enemies:['wraith','golem','icelich'],boss:'icelich',waves:3,maxE:5,
   loot:{coins:[24,42],xp:[18,28]}},

  // â”€â”€ ACT III: ICE CITADEL â”€â”€â”€â”€â”€ row3 leftâ†’right (S11â€“S15) SNAKE
  {id:10,name:'Glacial Spires', act:'ACT III', bg:'glacier',
   sky:['#050812','#030510'],gr:'#0c1426',ac:'#80e0ff',
   mx:_COL[0],my:_R3Y, conn:[9,11],
   enemies:['icelicher','golem','icedrake'],boss:'crystalqueen',waves:4,maxE:5,
   loot:{coins:[28,48],xp:[20,32]}},
  {id:11,name:'Frozen Throne',  act:'ACT III', bg:'throne',
   sky:['#040610','#02040c'],gr:'#060c1e',ac:'#a0d8ff',
   mx:_COL[1],my:_R3Y, conn:[10,12],
   enemies:['icelich','icedrake','golem'],boss:'winterking',waves:4,maxE:5,
   loot:{coins:[32,54],xp:[24,36]}},
  {id:12,name:'Mire Entrance',  act:'ACT IV',  bg:'swamp',
   sky:['#050c02','#030800'],gr:'#0a1604',ac:'#80ff20',
   mx:_COL[2],my:_R3Y, conn:[11,13],
   enemies:['troll','bog'],boss:'boghag',waves:3,maxE:4,
   loot:{coins:[26,44],xp:[20,30]}},
  {id:13,name:'Venom Pools',    act:'ACT IV',  bg:'swamp2',
   sky:['#060e02','#040900'],gr:'#0c1806',ac:'#a0ff40',
   mx:_COL[3],my:_R3Y, conn:[12,14],
   enemies:['troll','vbat','bog'],boss:'venomqueen',waves:3,maxE:5,
   loot:{coins:[30,50],xp:[22,34]}},
  {id:14,name:'Putrid Depths',  act:'ACT IV',  bg:'swamp3',
   sky:['#040c02','#030800'],gr:'#081404',ac:'#60d040',
   mx:_COL[4],my:_R3Y, conn:[13,15],
   enemies:['vbat','bog','troll'],boss:'plagueguard',waves:4,maxE:5,
   loot:{coins:[34,56],xp:[26,38]}},

  // â”€â”€ ACT IVâ€“V: SWAMPâ†’SKY â”€â”€â”€â”€â”€â”€ row4 rightâ†’left (S16â€“S20) SNAKE
  {id:15,name:'The Rot Core',   act:'ACT IV',  bg:'swamp4',
   sky:['#030a00','#020600'],gr:'#060e02',ac:'#40ff10',
   mx:_COL[4],my:_R4Y, conn:[14,16],
   enemies:['troll','vbat','bog'],boss:'rotlord',waves:4,maxE:6,
   loot:{coins:[38,62],xp:[28,42]}},
  {id:16,name:'Storm Approach', act:'ACT V',   bg:'sky',
   sky:['#070510','#04030c'],gr:'#10082a',ac:'#c060ff',
   mx:_COL[3],my:_R4Y, conn:[15,17],
   enemies:['drake','stormkin'],boss:'stormdrake',waves:3,maxE:4,
   loot:{coins:[40,66],xp:[30,44]}},
  {id:17,name:'Cloud Ramparts', act:'ACT V',   bg:'sky2',
   sky:['#090614','#060410'],gr:'#140a30',ac:'#e080ff',
   mx:_COL[2],my:_R4Y, conn:[16,18],
   enemies:['drake','stormkin','thunderel'],boss:'cloudgiant',waves:4,maxE:5,
   loot:{coins:[44,72],xp:[34,50]}},
  {id:18,name:'Apex Spire',     act:'ACT V',   bg:'sky3',
   sky:['#0a0618','#070412'],gr:'#180c36',ac:'#ff80ff',
   mx:_COL[1],my:_R4Y, conn:[17,19],
   enemies:['thunderel','drake','stormkin'],boss:'skyemperor',waves:4,maxE:6,
   loot:{coins:[50,80],xp:[38,56]}},
  {id:19,name:'ETERNAL ABYSS',  act:'FINAL',   bg:'abyss',
   sky:['#0c0000','#080000'],gr:'#1c0000',ac:'#ff0020',
   mx:_COL[0],my:_R4Y, conn:[18],
   enemies:['shade','voidknight'],boss:'chaosdragon',waves:5,maxE:6,
   loot:{coins:[80,150],xp:[60,100]}},
];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ENEMY TEMPLATES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const ETMPL={
  imp:      {name:'Lava Imp',    hp:18, atk:6,  def:1, xp:8,  coins:12, color:'#c03010',sz:26,sp:'imp'},
  sprite:   {name:'Fire Sprite', hp:14, atk:8,  def:0, xp:6,  coins:8,  color:'#ff6010',sz:20,sp:'sprite'},
  demon:    {name:'Fire Demon',  hp:45, atk:13, def:3, xp:20, coins:32, color:'#8b1a00',sz:38,sp:'demon',boss:true},
  lavaking: {name:'Lava King',   hp:70, atk:16, def:5, xp:32, coins:55, color:'#cc2200',sz:46,sp:'lavaking',boss:true},
  ashgolem: {name:'Ash Golem',   hp:28, atk:9,  def:4, xp:12, coins:16, color:'#5a3020',sz:32,sp:'golem2'},
  forge:    {name:'Forge Guard', hp:22, atk:10, def:2, xp:10, coins:14, color:'#804010',sz:28,sp:'forge'},
  ruinwarden:{name:'Ruin Warden',hp:60, atk:14, def:6, xp:28, coins:48, color:'#703010',sz:44,sp:'ruinwarden',boss:true},
  forgelord:{name:'Forge Lord',  hp:80, atk:18, def:6, xp:36, coins:65, color:'#aa5000',sz:50,sp:'forgelord',boss:true},
  wolf:     {name:'Shadow Wolf', hp:22, atk:8,  def:2, xp:10, coins:15, color:'#2a0a4a',sz:30,sp:'wolf'},
  hexbat:   {name:'Hex Bat',     hp:16, atk:9,  def:1, xp:8,  coins:10, color:'#3a0a1a',sz:20,sp:'bat'},
  spider:   {name:'Hex Spider',  hp:18, atk:10, def:1, xp:9,  coins:12, color:'#1a0a30',sz:22,sp:'spider'},
  forestwitch:{name:'Forest Witch',hp:55,atk:14,def:4,xp:26,coins:46,color:'#2a1040',sz:42,sp:'forestwitch',boss:true},
  sporemind:{name:'Spore Mind',  hp:72, atk:16, def:4, xp:34, coins:58, color:'#104030',sz:48,sp:'sporemind',boss:true},
  wraith:   {name:'Wraith',      hp:24, atk:11, def:2, xp:11, coins:14, color:'#60a0c0',sz:28,sp:'wraith'},
  necro:    {name:'Necromancer', hp:30, atk:13, def:3, xp:14, coins:20, color:'#4a0a6a',sz:32,sp:'necro'},
  lichknight:{name:'Lich Knight',hp:80,atk:18,def:5,xp:38,coins:65,color:'#3a0860',sz:50,sp:'lichknight',boss:true},
  shadowdruid:{name:'Shadow Druid',hp:90,atk:20,def:6,xp:44,coins:75,color:'#060c20',sz:52,sp:'shadowdruid',boss:true},
  golem:    {name:'Frost Golem', hp:36, atk:10, def:6, xp:15, coins:20, color:'#3060a0',sz:34,sp:'golem'},
  icedrake: {name:'Ice Drake',   hp:30, atk:13, def:3, xp:14, coins:19, color:'#4080c0',sz:30,sp:'icedrake'},
  icelicher:{name:'Ice Licher',  hp:26, atk:12, def:2, xp:13, coins:18, color:'#2050a0',sz:26,sp:'icelicher'},
  icelich:  {name:'Ice Lich',    hp:28, atk:14, def:2, xp:14, coins:19, color:'#1040a0',sz:28,sp:'icelicher'},
  icearcher: {name:'Frost Archer',hp:20,atk:11, def:1, xp:10, coins:14, color:'#3070b0',sz:24,sp:'iceArcher'},
  frostgiant:{name:'Frost Giant',hp:90,atk:18,def:7,xp:40,coins:70,color:'#2050a0',sz:54,sp:'frostgiant',boss:true},
  crystalqueen:{name:'Crystal Queen',hp:100,atk:20,def:7,xp:48,coins:82,color:'#4090d0',sz:54,sp:'crystalqueen',boss:true},
  winterking:{name:'Winter King',hp:120,atk:24,def:8,xp:58,coins:100,color:'#1030a0',sz:58,sp:'winterking',boss:true},
  troll:    {name:'Bog Troll',   hp:34, atk:11, def:5, xp:14, coins:19, color:'#2a4010',sz:34,sp:'troll'},
  bog:      {name:'Bog Wisp',    hp:18, atk:10, def:1, xp:9,  coins:12, color:'#204010',sz:22,sp:'bogwisp'},
  vbat:     {name:'Venom Bat',   hp:20, atk:11, def:1, xp:10, coins:13, color:'#304008',sz:22,sp:'bat'},
  boghag:   {name:'Bog Hag',     hp:80, atk:16, def:5, xp:38, coins:66, color:'#1a3008',sz:48,sp:'boghag',boss:true},
  venomqueen:{name:'Venom Queen',hp:100,atk:20,def:5,xp:48,coins:85,color:'#204010',sz:54,sp:'queen',boss:true},
  plagueguard:{name:'Plague Guard',hp:110,atk:22,def:6,xp:55,coins:95,color:'#184008',sz:56,sp:'plagueguard',boss:true},
  rotlord:  {name:'Rot Lord',    hp:130,atk:26,def:7,xp:65,coins:115,color:'#0a2004',sz:60,sp:'rotlord',boss:true},
  drake:    {name:'Storm Drake', hp:44, atk:14, def:4, xp:20, coins:30, color:'#5028a0',sz:38,sp:'drake'},
  stormkin: {name:'Storm Kin',   hp:28, atk:13, def:2, xp:12, coins:18, color:'#3020a0',sz:26,sp:'stormkin'},
  thunderel:{name:'Thunder Elf', hp:24, atk:14, def:2, xp:13, coins:19, color:'#4040c0',sz:26,sp:'thunderelf'},
  stormdrake:{name:'Storm Drake BOSS',hp:100,atk:20,def:6,xp:50,coins:90,color:'#4010c0',sz:56,sp:'drake',boss:true},
  cloudgiant:{name:'Cloud Giant',hp:130,atk:24,def:7,xp:62,coins:110,color:'#5030a0',sz:60,sp:'cloudgiant',boss:true},
  skyemperor:{name:'Sky Emperor',hp:160,atk:28,def:9,xp:78,coins:140,color:'#2008a0',sz:64,sp:'skyemperor',boss:true},
  shade:    {name:'Void Shade',  hp:50, atk:16, def:4, xp:28, coins:42, color:'#200030',sz:32,sp:'shade'},
  voidknight:{name:'Void Knight',hp:60, atk:18, def:5, xp:34, coins:52, color:'#300050',sz:36,sp:'voidknight'},
  chaosdragon:{name:'CHAOS DRAGON',hp:250,atk:36,def:12,xp:200,coins:400,color:'#800000',sz:70,sp:'dragon',boss:true},
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SHOP ITEMS â€” 25 ITEMS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const SHOP=[
  // Consumables (can rebuy)
  {id:'pot3',  name:'Potions x3',      desc:'Restore 40% HP. Stackable.',         price:30,  icon:'ğŸ§ª', stack:true, fn:()=>{G.pl.pots+=3;}},
  {id:'pot5',  name:'Potions x5',      desc:'Restore 40% HP. Stackable.',         price:45,  icon:'ğŸ§ª', stack:true, fn:()=>{G.pl.pots+=5;}},
  {id:'bomb2', name:'Bombs x2',        desc:'50 dmg to ALL enemies.',             price:35,  icon:'ğŸ’£', stack:true, fn:()=>{G.pl.bombs+=2;}},
  {id:'bomb4', name:'Bombs x4',        desc:'50 dmg to ALL enemies.',             price:60,  icon:'ğŸ’£', stack:true, fn:()=>{G.pl.bombs+=4;}},
  {id:'elixir',name:'Grand Elixir',    desc:'Fully restore HP.',                  price:90,  icon:'âœ¨', stack:true, fn:()=>{G.pl.hp=G.pl.maxHp;}},
  {id:'megapot',name:'Mega Potion',    desc:'Restore 70% HP.',                    price:65,  icon:'ğŸ’Š', stack:true, fn:()=>{G.pl.hp=Math.min(G.pl.maxHp,G.pl.hp+Math.floor(G.pl.maxHp*.7));}},
  {id:'revive',name:'Phoenix Feather', desc:'Auto-revive once (lasts 1 stage).', price:120, icon:'ğŸ”¥', stack:true, fn:()=>{G.pl.revive=true;}},
  {id:'xpboost',name:'Tome of Power', desc:'Gain +50 XP instantly.',             price:40,  icon:'ğŸ“–', stack:true, fn:()=>{gainXP(50);}},
  // Permanent upgrades (one-time)
  {id:'sword1', name:'Iron Sword',     desc:'+4 ATK permanently.',                price:55,  icon:'âš”ï¸', fn:()=>{G.pl.atk+=4;}},
  {id:'sword2', name:'Steel Blade',    desc:'+8 ATK permanently.',                price:110, icon:'ğŸ—¡ï¸', fn:()=>{G.pl.atk+=8;}},
  {id:'sword3', name:'Magic Blade',    desc:'+12 ATK + AOE attacks.',             price:200, icon:'âš¡', fn:()=>{G.pl.atk+=12;G.pl.aoe=true;}},
  {id:'swordS', name:'Soul Reaper',    desc:'+6 ATK + 20% lifesteal.',           price:280, icon:'ğŸ’€', fn:()=>{G.pl.atk+=6;G.pl.lifesteal=0.2;}},
  {id:'shield1',name:'Wooden Shield', desc:'+3 DEF permanently.',                price:45,  icon:'ğŸªµ', fn:()=>{G.pl.def+=3;}},
  {id:'shield2',name:'Iron Shield',   desc:'+6 DEF permanently.',                price:90,  icon:'ğŸ›¡ï¸', fn:()=>{G.pl.def+=6;}},
  {id:'shield3',name:'Rune Shield',   desc:'+10 DEF + reflect 2 dmg.',           price:175, icon:'ğŸ”®', fn:()=>{G.pl.def+=10;G.pl.reflect=2;}},
  {id:'ring1',  name:'Life Ring',      desc:'+20 Max HP.',                        price:55,  icon:'ğŸ’', fn:()=>{G.pl.maxHp+=20;G.pl.hp+=20;}},
  {id:'ring2',  name:'Regen Ring',     desc:'+30 Max HP + slow regen.',           price:110, icon:'ğŸ’', fn:()=>{G.pl.maxHp+=30;G.pl.hp+=30;G.pl.regen=true;}},
  {id:'boots1', name:'Swiftboots',     desc:'+25% move speed.',                   price:50,  icon:'ğŸ‘Ÿ', fn:()=>{G.pl.spd=Math.min(G.pl.spd*1.25,240);}},
  {id:'boots2', name:'Wind Treads',    desc:'+50% move speed.',                   price:100, icon:'ğŸŒ¬ï¸', fn:()=>{G.pl.spd=Math.min(G.pl.spd*1.5,280);}},
  {id:'armor1', name:'Chain Mail',     desc:'+5 DEF, -10 SPD.',                   price:80,  icon:'ğŸª–', fn:()=>{G.pl.def+=5;G.pl.spd=Math.max(70,G.pl.spd-10);}},
  {id:'armor2', name:'Dragon Armor',   desc:'+8 DEF, +10 HP, -5 SPD.',           price:180, icon:'ğŸ‰', fn:()=>{G.pl.def+=8;G.pl.maxHp+=10;G.pl.hp+=10;G.pl.spd=Math.max(70,G.pl.spd-5);}},
  {id:'amu1',   name:'Death Amulet',   desc:'Survive a killing blow once.',       price:130, icon:'â˜ ï¸', fn:()=>{G.pl.amulet=true;}},
  {id:'amu2',   name:'Battle Charm',   desc:'+20% damage dealt.',                 price:150, icon:'ğŸ…', fn:()=>{G.pl.atkMult=(G.pl.atkMult||1)*1.2;}},
  {id:'scroll', name:'Arcane Scroll',  desc:'Double XP gain for 3 stages.',       price:95,  icon:'ğŸ“œ', fn:()=>{G.pl.xpMult=2;G.pl.xpMultStages=3;}},
  {id:'compass',name:'Hero Compass',   desc:'Reveal all map stage names.',         price:70,  icon:'ğŸ§­', fn:()=>{G.pl.compass=true;}},
];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RANK STORAGE  (window.storage API)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const RANK_KEY='pixelquest:leaderboard';
async function loadRank(){
  try{const r=await window.storage.get(RANK_KEY,true);return r?JSON.parse(r.value):[];}
  catch{return[];}
}
async function saveScore(entry){
  let rows=await loadRank();
  const i=rows.findIndex(r=>r.name===entry.name);
  if(i>=0){if(entry.coins>rows[i].coins)rows[i]=entry;}
  else rows.push(entry);
  rows.sort((a,b)=>b.coins-a.coins);
  rows=rows.slice(0,50);
  try{await window.storage.set(RANK_KEY,JSON.stringify(rows),true);}catch{}
}
async function clearMyScore(){
  if(!G) return;
  let rows=await loadRank();
  rows=rows.filter(r=>r.name!==G.pl.name);
  try{await window.storage.set(RANK_KEY,JSON.stringify(rows),true);}catch{}
  renderRank();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GAME INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function startGame(){
  const nm=document.getElementById('nameinput').value.trim().toUpperCase()||'KNIGHT';
  document.getElementById('title').style.display='none';
  document.getElementById('mm').style.display='block';

  G={
    scene:'map',
    pl:{
      name:nm,
      x:200,y:240,
      hp:50,maxHp:50,
      xp:0,xpNext:30,
      atk:12,def:4,spd:120,level:1,
      coins:0,pots:3,bombs:0,
      aoe:false,lifesteal:0,reflect:0,regen:false,
      amulet:false,amuletUsed:false,revive:false,
      atkMult:1,xpMult:1,xpMultStages:0,
      compass:false,
      stamina:100,maxStamina:100,
      invT:0,facing:1,moving:false,anim:0,
      purchased:new Set(),
    },
    enemies:[],
    particles:[],texts:[],
    bgA:0,keys:{},
    shakeT:0,
    stage:null,
    stageIdx:null,
    wave:0,
    maxWave:0,
    bossSpawned:false,
    killCount:0,
    totalKills:0,
    totalCoins:0,
    stagesCleared:[],
    currentStageCleared:false,
  };
  openMap();
  updateHUD();
  loop(0);
}

function restartGame(){
  document.getElementById('ovl').style.display='none';
  document.getElementById('title').style.display='flex';
  cancelAnimationFrame(RAF);G=null;
}

function continueRun(){
  // After death â€” keep all stats, restart current stage with reduced penalty
  document.getElementById('ovl').style.display='none';
  if(!G) return;
  G.pl.hp=Math.floor(G.pl.maxHp*0.5);
  G.pl.amuletUsed=false;
  G.pl.revive=false;
  G.enemies=[];
  G.wave=0;
  G.bossSpawned=false;
  G.killCount=0;
  G.currentStageCleared=false;
  document.getElementById('nextbtn').style.display='none';
  updateHUD();
  if(G.stageIdx!==null) beginStage(G.stageIdx);
  else openMap();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MAP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toggleMap(){
  const s=document.getElementById('mapscr');
  if(s.style.display==='flex'){s.style.display='none';if(G)G.scene='battle';}
  else{s.style.display='flex';if(G)G.scene='map';drawWorldMap();}
}

function openMap(){
  document.getElementById('mapscr').style.display='flex';
  if(G){G.scene='map';drawWorldMap();}
}

function drawWorldMap(){
  const mc=document.getElementById('mapcv');
  const cx=mc.getContext('2d');
  cx.imageSmoothingEnabled=false;
  const W2=mc.width, H2=mc.height; // 620 Ã— 320
  cx.fillStyle='#030508'; cx.fillRect(0,0,W2,H2);

  // Pixel-dot grid bg
  cx.fillStyle='#080b12';
  for(let i=0;i<W2;i+=20) for(let j=0;j<H2;j+=20) cx.fillRect(i,j,1,1);

  // â”€â”€ Row dividers / act zones â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const actZones=[
    {y:0,   h:100, label:'ACT I  â€” VOLCANIC WASTES',   c:'rgba(200,80,10,.06)'},
    {y:100, h:90,  label:'ACT II â€” CURSED FOREST',      c:'rgba(30,180,40,.05)'},
    {y:190, h:90,  label:'ACT III/IV â€” ICE & SWAMP',    c:'rgba(40,120,255,.05)'},
    {y:280, h:40,  label:'ACT V â€” SKY & FINAL ABYSS',   c:'rgba(150,50,255,.06)'},
  ];
  cx.font='5px "Press Start 2P"';
  cx.textBaseline='top';
  for(const z of actZones){
    cx.fillStyle=z.c; cx.fillRect(0,z.y,W2,z.h);
    cx.fillStyle='rgba(200,140,40,.18)';
    cx.textAlign='left';
    cx.fillText(z.label, 6, z.y+4);
  }

  // â”€â”€ Draw connections (snake path) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  for(const s of STAGES){
    for(const nb of s.conn){
      if(nb<=s.id) continue;
      const s2=STAGES[nb];
      const bothOpen=isOpen(s)&&isOpen(s2);
      const eitherCleared=G&&(G.stagesCleared.includes(s.id)||G.stagesCleared.includes(nb));
      cx.strokeStyle=eitherCleared?'rgba(240,180,40,.55)':bothOpen?'rgba(140,90,30,.5)':'rgba(40,30,60,.45)';
      cx.lineWidth=bothOpen||eitherCleared?2.5:1.5;
      cx.setLineDash(eitherCleared?[]:[4,4]);
      cx.beginPath(); cx.moveTo(s.mx,s.my); cx.lineTo(s2.mx,s2.my); cx.stroke();
      cx.setLineDash([]);
    }
  }

  // â”€â”€ Draw nodes â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const now=G&&G.stageIdx!==null?G.stageIdx:-1;
  const actColors={
    'ACT I':  '#ff6010',
    'ACT II': '#30c050',
    'ACT III':'#40c0ff',
    'ACT IV': '#80ff20',
    'ACT V':  '#c060ff',
    'FINAL':  '#ff1030',
  };
  const icons=['ğŸŒ‹','ğŸŒ‹','ğŸš','âš’','ğŸŒ²','ğŸ„','ğŸŒ²','ğŸŒ²','â„','â„','ğŸ”','â„','ğŸŒ¿','â˜ ï¸','ğŸŒ¿','ğŸŒ¿','âš¡','â˜ï¸','âš¡','ğŸ’€'];

  for(const s of STAGES){
    const cleared=G&&G.stagesCleared.includes(s.id);
    const open=isOpen(s);
    const active=s.id===now;
    const ac=actColors[s.act]||'#c8932a';

    // Glow ring for active/cleared
    if(active){
      cx.fillStyle='rgba(240,200,60,.18)';
      cx.beginPath(); cx.arc(s.mx,s.my,22,0,Math.PI*2); cx.fill();
    } else if(cleared){
      cx.fillStyle='rgba(40,220,80,.1)';
      cx.beginPath(); cx.arc(s.mx,s.my,19,0,Math.PI*2); cx.fill();
    }

    // Node circle
    cx.fillStyle=cleared?'#0a2010':active?'#201400':open?'#100c02':'#0a0818';
    cx.strokeStyle=cleared?'#30d050':active?'#f0c060':open?ac:'#282040';
    cx.lineWidth=active?3:cleared?2.5:2;
    cx.beginPath(); cx.arc(s.mx,s.my,13,0,Math.PI*2); cx.fill(); cx.stroke();

    // Icon / lock
    cx.font='10px serif'; cx.textAlign='center'; cx.textBaseline='middle';
    cx.fillText(cleared?'âœ…':(!open?'ğŸ”’':icons[s.id]), s.mx, s.my);

    // Stage number badge (top-left of node)
    cx.fillStyle=open||cleared?ac:'#302850';
    cx.font='bold 5px "Press Start 2P"';
    cx.textAlign='center'; cx.textBaseline='middle';
    cx.fillText(`${s.id+1}`, s.mx-16, s.my-16);

    // Stage name below node
    cx.textBaseline='top';
    cx.font='4px "Press Start 2P"';
    const nm=G&&G.pl&&G.pl.compass?s.name:(!open&&!cleared?'???':s.name);
    cx.fillStyle=cleared?'#60e070':active?'#f0c060':open?'#b08030':'#3a2a60';
    // wrap if long
    if(nm.length>10){
      cx.fillText(nm.slice(0,10), s.mx, s.my+16);
      cx.fillText(nm.slice(10),   s.mx, s.my+23);
    } else {
      cx.fillText(nm, s.mx, s.my+16);
    }
  }

  // â”€â”€ Legend â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const legend=[['âœ…','Cleared'],['ğŸ”’','Locked'],['ğŸŒ‹','Available']];
  cx.font='4px "Press Start 2P"'; cx.textBaseline='middle';
  legend.forEach(([ic,lb],i)=>{
    cx.font='8px serif'; cx.fillText(ic, W2-72, 12+i*14);
    cx.font='4px "Press Start 2P"'; cx.fillStyle='#806040';
    cx.textAlign='left'; cx.fillText(lb, W2-60, 12+i*14);
  });
}

function isOpen(s){
  if(!G) return s.id===0;
  if(s.id===0) return true;
  if(G.stagesCleared.includes(s.id)) return true;
  // A stage is open if the previous stage (id-1) has been cleared
  return G.stagesCleared.includes(s.id-1);
}

function mapClick(e){
  if(!G) return;
  const mc=document.getElementById('mapcv');
  const r=mc.getBoundingClientRect();
  const mx=(e.clientX-r.left)*(mc.width/r.width);
  const my=(e.clientY-r.top)*(mc.height/r.height);
  for(const s of STAGES){
    const dx=mx-s.mx, dy=my-s.my;
    if(Math.sqrt(dx*dx+dy*dy)<16){
      if(!isOpen(s)){
        const needed=s.id>0?`Clear S${s.id}: ${STAGES[s.id-1].name} first`:'???';
        document.getElementById('maplbl').textContent='ğŸ”’ Locked â€” '+needed;
        return;
      }
      document.getElementById('maplbl').textContent=`â–¶ Entering: S${s.id+1} â€” ${s.name} (${s.act})`;
      document.getElementById('mapscr').style.display='none';
      beginStage(s.id);
      return;
    }
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STAGE START
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function beginStage(id){
  const s=STAGES[id];
  G.stage=s;G.stageIdx=id;
  G.enemies=[];G.wave=0;G.maxWave=s.waves;
  G.bossSpawned=false;G.killCount=0;G.currentStageCleared=false;
  G.scene='battle';
  G.pl.x=120;G.pl.y=240;
  G.pl.amuletUsed=false;
  document.getElementById('nextbtn').style.display='none';
  document.getElementById('stageclear').style.display='none';
  document.getElementById('stnm').textContent=`S${id+1}: ${s.name}`;
  document.getElementById('stsb').textContent=s.act;
  updateHUD();
  spawnWave();
  showMsg(`âš” ${s.name}`);
}

function nextStage(){
  if(!G||!G.stage) return;
  document.getElementById('nextbtn').style.display='none';
  const nextId=G.stageIdx+1;
  if(nextId<STAGES.length){
    beginStage(nextId);
  } else {
    openMap();
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// WAVE / ENEMY SPAWNING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function spawnWave(){
  if(!G||!G.stage) return;
  const s=G.stage;
  G.wave++;
  G.enemies=G.enemies.filter(e=>e.alive); // clear dead

  const isBoss = G.wave>=G.maxWave && !G.bossSpawned;

  if(isBoss){
    G.bossSpawned=true;
    const bt=ETMPL[s.boss];
    if(!bt){showMsg('Stage complete!');return;}
    const scaledHp=Math.round(bt.hp*(1+G.stageIdx*0.08));
    const e=makeEnemy(bt,true,480,210);
    e.hp=scaledHp;e.maxHp=scaledHp;
    G.enemies.push(e);
    showMsg(`âš  BOSS: ${bt.name}!`);
  } else {
    const pool=s.enemies;
    const count=Math.min(G.wave+1,s.maxE);
    for(let i=0;i<count;i++){
      const tid=pool[Math.floor(Math.random()*pool.length)];
      const tmpl=ETMPL[tid];
      if(!tmpl) continue;
      const scale=1+G.stageIdx*0.06+G.wave*0.04;
      const e=makeEnemy(tmpl,false,380+Math.random()*250,170+Math.random()*120);
      e.hp=Math.round(e.hp*scale);e.maxHp=e.hp;
      e.atk=Math.round(e.atk*scale);
      G.enemies.push(e);
    }
    showMsg(`Wave ${G.wave}/${G.maxWave-1} â€” ${count} enemies!`);
  }
  document.getElementById('stwv').textContent=isBoss?'âš  BOSS':(`Wave ${G.wave}/${G.maxWave}`);
}

function makeEnemy(t,isBoss,x,y){
  return{
    ...JSON.parse(JSON.stringify(t)),
    x,y,alive:true,isBoss,
    anim:0,hurtT:0,deathA:1,
    atkTimer:1+Math.random()*1.5,
    wanderX:x+(Math.random()-.5)*80,
    wanderY:clamp(y+(Math.random()-.5)*60,160,330),
    wanderT:2+Math.random()*2,
  };
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// COMBAT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function plAtk(){
  if(!G||G.scene!=='battle') return;
  if(G.pl.stamina<10){showMsg('âš¡ Not enough stamina!');return;}
  const alive=G.enemies.filter(e=>e.alive);
  if(!alive.length) return;
  G.pl.stamina=Math.max(0,G.pl.stamina-15);
  const targets=G.pl.aoe?alive:[closest()].filter(Boolean);
  for(const e of targets){
    const raw=Math.round((G.pl.atk+rng(-2,4))*(G.pl.atkMult||1));
    const dmg=Math.max(1,raw-e.def);
    e.hp=Math.max(0,e.hp-dmg);
    e.hurtT=.2;
    addFT('-'+dmg,e.x,e.y-28,e.isBoss?'#ff5050':'#ff9050');
    addPart(e.x,e.y,e.color,6);
    G.shakeT=.06;
    // Lifesteal
    if(G.pl.lifesteal>0){
      const heal=Math.ceil(dmg*G.pl.lifesteal);
      G.pl.hp=Math.min(G.pl.maxHp,G.pl.hp+heal);
      if(heal>0) addFT('+'+heal,G.pl.x,G.pl.y-44,'#40ff80');
    }
    if(e.hp<=0) killEnemy(e);
  }
  addPart(G.pl.x+G.pl.facing*16,G.pl.y-10,'#fff',4);
  setTimeout(()=>{ if(G&&G.scene==='battle') alive.filter(e=>e.alive&&dist(G.pl,e)<240).forEach(e=>enAtk(e)); },320);
}

function enAtk(e){
  if(!G||!e.alive||G.pl.invT>0) return;
  const dmg=Math.max(1,e.atk-G.pl.def+rng(-2,3));
  const final=G.pl.reflect>0?Math.max(0,dmg-G.pl.reflect):dmg;
  // Reflect
  if(G.pl.reflect>0&&G.pl.reflect>=dmg){addFT('REFLECT!',G.pl.x,G.pl.y-50,'#80c0ff');e.hp=Math.max(0,e.hp-2);if(e.hp<=0){killEnemy(e);return;}}
  // Death prevention
  if(G.pl.hp-final<=0){
    if(G.pl.revive&&!G.pl.amuletUsed){G.pl.hp=Math.floor(G.pl.maxHp*.3);G.pl.amuletUsed=true;G.pl.revive=false;addFT('REVIVED!',G.pl.x,G.pl.y-55,'#ff8000');G.pl.invT=2;showMsg('ğŸ”¥ Phoenix Feather saved you!');updateHUD();return;}
    if(G.pl.amulet&&!G.pl.amuletUsed){G.pl.hp=1;G.pl.amuletUsed=true;addFT('AMULET!',G.pl.x,G.pl.y-55,'#ffd700');G.pl.invT=1.5;showMsg('â˜ ï¸ Death Amulet saved you!');updateHUD();return;}
    G.pl.hp=0;updateHUD();setTimeout(playerDeath,500);return;
  }
  G.pl.hp=Math.max(0,G.pl.hp-final);
  G.pl.invT=.35;
  addFT('-'+final,G.pl.x,G.pl.y-40,'#ff2020');
  addPart(G.pl.x,G.pl.y,'#ff2020',4);
  updateHUD();
}

function usePot(){
  if(!G) return;
  if(G.pl.pots<=0){showMsg('No potions!');return;}
  if(G.pl.hp>=G.pl.maxHp){showMsg('HP full!');return;}
  const h=Math.floor(G.pl.maxHp*.4);
  G.pl.hp=Math.min(G.pl.maxHp,G.pl.hp+h);G.pl.pots--;
  addFT('+'+h+'HP',G.pl.x,G.pl.y-40,'#40ff80');addPart(G.pl.x,G.pl.y,'#40ff80',8);
  showMsg('ğŸ§ª +'+h+' HP');updateHUD();
}

function useBomb(){
  if(!G||!G.pl.bombs){showMsg('No bombs!');return;}
  G.pl.bombs--;
  const alive=G.enemies.filter(e=>e.alive);
  for(const e of alive){const d=Math.max(1,50-e.def);e.hp=Math.max(0,e.hp-d);addFT('-'+d,e.x,e.y-28,'#ff8020');addPart(e.x,e.y,'#ff6010',10);if(e.hp<=0)killEnemy(e);}
  addPart(G.pl.x,G.pl.y-20,'#ff8020',20);showMsg('ğŸ’£ BOOM! '+alive.length+' hit!');updateHUD();
}

function killEnemy(e){
  if(!e.alive) return;
  e.alive=false;e.deathA=1;
  addPart(e.x,e.y,'#fff',14);addPart(e.x,e.y,e.color,10);
  const xpGain=Math.round(e.xp*(G.pl.xpMult||1));
  const coinsGain=e.coins+rng(0,Math.floor(e.coins*.3));
  G.pl.coins+=coinsGain;G.totalCoins+=coinsGain;
  gainXP(xpGain);
  addFT('+'+coinsGain+'ğŸª™',e.x,e.y-48,'#ffd700');
  G.killCount++;G.totalKills++;

  // Check wave
  setTimeout(()=>{
    if(!G) return;
    const alive=G.enemies.filter(e=>e.alive);
    if(alive.length===0){
      if(e.isBoss){
        stageComplete();
      } else if(!G.bossSpawned && G.wave<G.maxWave){
        setTimeout(spawnWave,1600);
      } else if(!G.bossSpawned){
        // All normal waves done, spawn boss
        setTimeout(spawnWave,1600);
      }
    }
  },400);
}

function gainXP(amt){
  if(!G) return;
  G.pl.xp+=amt;
  while(G.pl.xp>=G.pl.xpNext){
    G.pl.xp-=G.pl.xpNext;G.pl.level++;
    G.pl.xpNext=Math.floor(G.pl.xpNext*1.4);
    G.pl.maxHp+=12;G.pl.hp=Math.min(G.pl.maxHp,G.pl.hp+20);
    G.pl.atk+=2;G.pl.def+=1;G.pl.stamina=G.pl.maxStamina;
    addFT('LEVEL UP!',G.pl.x,G.pl.y-60,'#ffd700');
    showMsg('ğŸ‰ LEVEL '+G.pl.level+'! +HP +ATK +DEF');
  }
  updateHUD();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STAGE COMPLETE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function stageComplete(){
  if(!G||G.currentStageCleared) return;
  G.currentStageCleared=true;
  if(!G.stagesCleared.includes(G.stageIdx)) G.stagesCleared.push(G.stageIdx);

  // XP mult counter
  if(G.pl.xpMultStages>0){G.pl.xpMultStages--;if(G.pl.xpMultStages===0)G.pl.xpMult=1;}
  // Bonus coins
  const bonus=rng(...G.stage.loot.coins)*2;
  G.pl.coins+=bonus; G.totalCoins+=bonus;
  addFT('+'+bonus+'ğŸª™ CLEAR!',350,190,'#ffd700');

  // Save score
  saveScore({name:G.pl.name,coins:G.pl.coins,level:G.pl.level,stage:G.stageIdx+1,kills:G.totalKills});

  // Show stage clear banner
  const sc=document.getElementById('stageclear');
  const nextId=G.stageIdx+1;
  const hasNext=nextId<STAGES.length;
  document.getElementById('screwards').textContent=
    `+${bonus} Gold  â€¢  ${G.killCount} Kills  â€¢  Wave ${G.wave} Cleared${hasNext?' â€” NEXT: S'+(nextId+1)+': '+STAGES[nextId].name:'  â˜… ALL COMPLETE â˜…'}`;
  sc.style.display='flex';
  document.getElementById('nextbtn').style.display='inline-block';
  document.getElementById('nextbtn').textContent=hasNext?`â–¶ S${nextId+1}: ${STAGES[nextId].name} [TAB]`:'â–¶ MAP [TAB]';
  updateHUD();

  setTimeout(()=>{if(sc)sc.style.display='none';if(G.stageIdx===19)setTimeout(victory,500);},3000);
}

function playerDeath(){
  if(!G) return;
  G.scene='dead';
  saveScore({name:G.pl.name,coins:G.pl.coins,level:G.pl.level,stage:G.stageIdx+1,kills:G.totalKills});
  const ov=document.getElementById('ovl');
  document.getElementById('ovltitle').innerHTML='<span style="color:#e02020">ğŸ’€ YOU FELL</span>';
  document.getElementById('finalstats').textContent=
    `Stage: ${G.stageIdx+1} / 20  â€¢  Level: ${G.pl.level}  â€¢  Gold: ${G.pl.coins}\nKills: ${G.totalKills}  â€¢  Stages Cleared: ${G.stagesCleared.length}`;
  document.getElementById('ovlsub').textContent='Your score was saved. Continue from here or start fresh.';
  ov.style.display='flex';
}

function victory(){
  if(!G) return;
  G.scene='win';
  saveScore({name:G.pl.name,coins:G.pl.coins,level:G.pl.level,stage:20,kills:G.totalKills});
  const ov=document.getElementById('ovl');
  document.getElementById('ovltitle').innerHTML='<span style="color:#ffd700">ğŸ† VICTORY!</span>';
  document.getElementById('finalstats').textContent=
    `All 20 Stages Cleared!\nLevel: ${G.pl.level}  â€¢  Gold: ${G.pl.coins}\nTotal Kills: ${G.totalKills}`;
  document.getElementById('ovlsub').textContent='The Ember Realm is saved. Your legend endures!';
  ov.style.display='flex';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SHOP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toggleShop(){
  const s=document.getElementById('shopscr');
  if(s.style.display==='flex'){s.style.display='none';if(G&&G.scene==='shop')G.scene='battle';}
  else{s.style.display='flex';if(G)G.scene='shop';renderShop();}
}

function renderShop(){
  if(!G) return;
  document.getElementById('sgold').textContent=G.pl.coins;
  const grid=document.getElementById('shopgrid');
  grid.innerHTML='';
  for(const it of SHOP){
    const owned=!it.stack&&G.pl.purchased.has(it.id);
    const d=document.createElement('div');
    d.className='sitem'+(owned?' owned':'');
    d.innerHTML=`<div class="si-name">${it.icon} ${it.name}</div><div class="si-desc">${it.desc}</div><div class="si-price">ğŸª™${it.price}${owned?' âœ…':''}</div>`;
    if(!owned) d.onclick=()=>buyItem(it);
    grid.appendChild(d);
  }
}

function buyItem(it){
  if(!G) return;
  if(G.pl.coins<it.price){showMsg('Not enough gold!');return;}
  G.pl.coins-=it.price;
  it.fn();
  if(!it.stack) G.pl.purchased.add(it.id);
  showMsg(`âœ… ${it.name} purchased!`);
  updateHUD();renderShop();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RANK
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toggleRank(){
  const s=document.getElementById('rankscr');
  if(s.style.display==='flex'){s.style.display='none';}
  else{s.style.display='flex';renderRank();}
}

async function renderRank(){
  const rows=await loadRank();
  const list=document.getElementById('ranklist');
  list.innerHTML='';
  if(!rows.length){list.innerHTML='<div style="font-size:7px;color:#406080;padding:20px;text-align:center">No scores yet. Be the first!</div>';return;}
  rows.forEach((r,i)=>{
    const isMe=G&&r.name===G.pl.name;
    const d=document.createElement('div');
    d.className='rrow'+(isMe?' me':'');
    const medal=i===0?'ğŸ¥‡':i===1?'ğŸ¥ˆ':i===2?'ğŸ¥‰':'';
    const rankCls=i===0?'gold':i===1?'silv':i===2?'bron':'';
    d.innerHTML=`<div class="rrank ${rankCls}">${medal||'#'+(i+1)}</div>
      <div class="rname">${isMe?'â–¶ ':''} ${r.name}</div>
      <div class="rcoins">ğŸª™${r.coins}</div>
      <div class="rstage">S${r.stage}</div>
      <div class="rlvl">LV${r.level}</div>`;
    list.appendChild(d);
  });
}

function clearRank(){clearMyScore();}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GAME LOOP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function loop(ts){
  const dt=Math.min((ts-lastT)/1000,.05);lastT=ts;
  if(G&&G.scene==='battle') update(dt);
  render();
  drawMinimap();
  RAF=requestAnimationFrame(loop);
}

function update(dt){
  G.bgA+=dt;
  if(G.shakeT>0) G.shakeT-=dt;
  const p=G.pl;
  p.anim+=dt*4;
  p.invT=Math.max(0,p.invT-dt);

  // Stamina regen
  p.stamina=Math.min(p.maxStamina,p.stamina+dt*20);

  // HP regen
  if(p.regen&&p.hp<p.maxHp) p.hp=Math.min(p.maxHp,p.hp+dt*2);

  // Movement
  let dx=0,dy=0;
  if(G.keys['ArrowLeft']||G.keys['a']||G.keys['A']) dx=-1;
  if(G.keys['ArrowRight']||G.keys['d']||G.keys['D']) dx=1;
  if(G.keys['ArrowUp']||G.keys['w']||G.keys['W']) dy=-1;
  if(G.keys['ArrowDown']||G.keys['s']||G.keys['S']) dy=1;
  if(dx&&dy){dx*=.707;dy*=.707;}
  if(dx) p.facing=dx;
  p.moving=!!dx||!!dy;
  p.x=clamp(p.x+dx*p.spd*dt,16,684);
  p.y=clamp(p.y+dy*p.spd*dt,130,340);

  // Enemy AI
  for(const e of G.enemies){
    if(!e.alive){e.deathA=Math.max(0,e.deathA-dt*2);continue;}
    e.anim+=dt*(e.isBoss?1.8:3);
    e.hurtT=Math.max(0,e.hurtT-dt);
    e.atkTimer-=dt;
    const edx=p.x-e.x,edy=p.y-e.y,ed=Math.sqrt(edx*edx+edy*edy);
    e.facing=edx<0?-1:1;
    const spd2=e.isBoss?50:42;
    if(ed<300){e.x+=edx/ed*spd2*dt;e.y+=edy/ed*spd2*dt;}
    else{
      e.wanderT-=dt;
      if(e.wanderT<=0){e.wanderX=e.x+(Math.random()-.5)*120;e.wanderY=clamp(e.y+(Math.random()-.5)*80,150,330);e.wanderT=2+Math.random()*2;}
      const wx=e.wanderX-e.x,wy=e.wanderY-e.y,wd=Math.sqrt(wx*wx+wy*wy);
      if(wd>4){e.x+=wx/wd*26*dt;e.y+=wy/wd*26*dt;}
    }
    e.x=clamp(e.x,20,680);e.y=clamp(e.y,150,340);
    if(ed<38&&e.atkTimer<=0){e.atkTimer=e.isBoss?1.1:1.7;enAtk(e);}
  }

  // Particles / texts
  for(const p2 of G.particles){p2.x+=p2.vx;p2.y+=p2.vy;p2.vy+=.14;p2.life-=dt/p2.ml;}
  G.particles=G.particles.filter(p2=>p2.life>0);
  for(const t of G.texts){t.y+=t.vy;t.life-=dt*1.3;}
  G.texts=G.texts.filter(t=>t.life>0);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function render(){
  const si=G&&G.stageIdx!==null?G.stageIdx:0;
  const st=STAGES[Math.min(si,19)];

  ctx.save();
  if(G&&G.shakeT>0) ctx.translate(Math.sin(G.bgA*60)*G.shakeT*10,0);

  // Sky gradient
  const gr=ctx.createLinearGradient(0,0,0,280);
  gr.addColorStop(0,st.sky[0]);gr.addColorStop(1,st.sky[1]);
  ctx.fillStyle=gr;ctx.fillRect(0,0,W,H);

  if(G&&G.scene==='battle'){
    drawBG(st);drawGround(st);
    const objs=[...G.enemies,{...G.pl,_isPlayer:true}].sort((a,b)=>a.y-b.y);
    for(const o of objs){
      if(o._isPlayer) drawPlayer(G.pl);
      else if(o.alive||o.deathA>0) drawEnemy(o,st);
    }
    // Particles
    for(const p of G.particles){
      ctx.globalAlpha=Math.max(0,p.life);ctx.fillStyle=p.color;
      ctx.fillRect(~~(p.x-p.size/2),~~(p.y-p.size/2),p.size,p.size);
    }
    ctx.globalAlpha=1;
    // Texts
    ctx.textAlign='center';
    for(const t of G.texts){
      ctx.globalAlpha=Math.max(0,t.life);ctx.font='bold 8px "Press Start 2P"';
      ctx.fillStyle=t.c;ctx.shadowColor='#000';ctx.shadowBlur=4;
      ctx.fillText(t.t,~~t.x,~~t.y);
    }
    ctx.shadowBlur=0;ctx.globalAlpha=1;
    // Enemy HP bars + names
    for(const e of G.enemies){
      if(!e.alive||e.hp>=e.maxHp) continue;
      const bw=e.isBoss?110:75,bx=e.x-bw/2,by=e.y-e.sz/2-20;
      ctx.fillStyle='#180606';ctx.fillRect(bx,by,bw,7);
      ctx.fillStyle=e.isBoss?'#ff1030':'#d02818';ctx.fillRect(bx,by,bw*(e.hp/e.maxHp),7);
      ctx.strokeStyle='#4a1010';ctx.lineWidth=1;ctx.strokeRect(bx,by,bw,7);
      ctx.font='5px "Press Start 2P"';ctx.fillStyle='#f0c060';ctx.textAlign='center';
      ctx.fillText(e.name,e.x,by-3);
    }
    // Wave info
    ctx.font='6px "Press Start 2P"';ctx.textAlign='left';
    ctx.fillStyle='rgba(200,150,60,.6)';
    ctx.fillText(`Wave ${G.wave}/${G.maxWave} | Enemies: ${G.enemies.filter(e=>e.alive).length}`,8,310);
    ctx.fillStyle='rgba(100,180,240,.5)';
    ctx.fillText(`Kills: ${G.totalKills}`,8,320);
  } else {
    ctx.globalAlpha=.25;drawBG(st);drawGround(st);ctx.globalAlpha=1;
  }
  ctx.restore();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BACKGROUND DRAWING â€” per stage feat
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function drawBG(st){
  const t=G?G.bgA:0,f=st.bg;

  // Lava variants
  if(f==='lava'||f==='lava2'){
    drawMtn(ctx,260,80,130,'#3a1a00');drawMtn(ctx,460,100,90,'#2a1000');drawMtn(ctx,100,110,70,'#301400');
    glow(ctx,280,55,50,'rgba(255,160,0,.7)');
    drawLava(ctx,280,80,t);if(f==='lava2'){drawLava(ctx,420,90,t+1.2);drawLava(ctx,160,100,t+2.4);}
    drawChain(ctx,60,20,110,190);drawChain(ctx,580,10,560,170);
    drawSkull(ctx,80,190,'#6a4020');drawSkull(ctx,130+Math.sin(t*.8)*18,105+Math.sin(t*.5)*14,'#805020');
  }
  if(f==='ruins'){
    drawMtn(ctx,300,90,110,'#2a1a10');
    // Crumbled pillars
    ctx.fillStyle='#3a2010';
    for(let i=0;i<5;i++){ctx.fillRect(40+i*130,180-i*10,20,100);}
    ctx.fillStyle='#2a1508';
    for(let i=0;i<5;i++){ctx.fillRect(42+i*130,182-i*10,16,8);}
    drawLava(ctx,350,100,t+.5);
  }
  if(f==='forge'){
    // Forge interior
    ctx.fillStyle='#200c04';ctx.fillRect(0,80,W,200);
    // Furnaces
    for(let i=0;i<3;i++){
      ctx.fillStyle='#3a1808';ctx.fillRect(60+i*220,100,80,140);
      glow(ctx,100+i*220,170,35,`rgba(255,${100+Math.sin(t*3+i)*50},0,${.4+Math.sin(t*2+i)*.3})`);
      ctx.fillStyle='rgba(255,120,0,.6)';ctx.fillRect(80+i*220,140,40,60);
    }
    drawLava(ctx,200,110,t);drawLava(ctx,450,120,t+1.5);
  }
  // Forest variants
  if(f==='forest'||f==='forest2'||f==='darkforest'){
    const dc=f==='darkforest'?'#050a06':f==='forest2'?'#040c06':'#030e06';
    for(let i=0;i<7;i++) drawTree(ctx,30+i*100,250-(70+Math.sin(i*1.4)*30),70+Math.sin(i*1.4)*30,dc);
    const spirits=f==='darkforest'?6:3;
    for(let i=0;i<spirits;i++){
      const sx=80+i*(W/spirits)+Math.sin(t*.7+i)*28,sy=140+Math.sin(t*.4+i*2)*22;
      ctx.fillStyle=`rgba(${f==='darkforest'?'80,0,120':'100,255,100'},${.12+Math.sin(t+i)*.08})`;
      ctx.fillRect(~~sx-7,~~sy-9,14,18);ctx.fillRect(~~sx-9,~~sy-5,18,12);
    }
    if(f!=='darkforest'){drawMshroom(ctx,60,288,'#aa2060');drawMshroom(ctx,580,282,'#cc3080');}
    if(f==='darkforest'){
      // Dark tendrils
      ctx.strokeStyle='rgba(30,0,60,.5)';ctx.lineWidth=2;
      for(let i=0;i<6;i++){ctx.beginPath();ctx.moveTo(i*120,270);ctx.bezierCurveTo(i*120+30,230,i*120+60,250,i*120+80,270);ctx.stroke();}
    }
  }
  if(f==='mushroom'){
    for(let i=0;i<5;i++) drawTree(ctx,40+i*150,250-(60+i*8),60+i*8,'#030c08');
    // Giant mushrooms
    const mcolors=['#aa2060','#2060aa','#aa6020','#20aa60','#6020aa'];
    for(let i=0;i<5;i++) drawBigMshroom(ctx,60+i*140,280,mcolors[i]);
    // Spores
    for(let i=0;i<12;i++){
      const sx=(i*57+t*8*(i%3+.5))%700,sy=(i*41+t*6)%200+60;
      ctx.fillStyle=`rgba(100,255,100,${.3+Math.sin(t*2+i)*.2})`;ctx.fillRect(~~sx,~~sy,2,2);
    }
  }
  // Ice variants
  if(f==='ice'||f==='blizzard'||f==='glacier'||f==='throne'){
    const cc=f==='throne'?'#0a2040':'#0a1828';
    drawCastle(ctx,180,40,260,190,cc);
    for(let i=0;i<9;i++) drawCrystal(ctx,20+i*80,265-(28+Math.sin(i*2.2)*18),28+Math.sin(i*2.2)*18,'#3080c0');
    // Snow
    const flakes=f==='blizzard'?35:20;
    ctx.fillStyle='#a8c8e0';
    for(let i=0;i<flakes;i++){const sx=(i*61+t*18*((i%3)+.6))%700,sy=(i*43+t*12)%270;ctx.fillRect(~~sx,~~sy,2,2);}
    if(f==='glacier'){
      // Icebergs
      ctx.fillStyle='#0a2040';
      for(let i=0;i<4;i++){const bx=50+i*170,bh=30+i*10;ctx.fillRect(bx,230-bh,60,bh);}
    }
    if(f==='throne'){
      // Frozen throne glow
      glow(ctx,350,160,80,'rgba(40,100,200,.2)');
      ctx.strokeStyle='rgba(80,160,255,.3)';ctx.lineWidth=1;
      for(let i=0;i<4;i++){ctx.beginPath();ctx.arc(350,160,30+i*20,0,Math.PI*2);ctx.stroke();}
    }
  }
  // Swamp variants
  if(f==='swamp'||f==='swamp2'||f==='swamp3'||f==='swamp4'){
    for(let i=0;i<6;i++) drawTree(ctx,30+i*120,250-(55+i*7),55+i*7,'#060c04');
    // Murky water pools
    ctx.fillStyle=f==='swamp4'?'rgba(0,30,0,.5)':'rgba(20,60,10,.4)';
    ctx.fillRect(0,220,W,55);
    // Bubbles
    for(let i=0;i<10;i++){
      const bx=(i*72+t*14*(i%3+.4))%700,by=220+(Math.sin(t*2+i)*10);
      ctx.strokeStyle=`rgba(80,200,20,.4)`;ctx.lineWidth=1;ctx.beginPath();ctx.arc(~~bx,~~by,2+i%4,0,Math.PI*2);ctx.stroke();
    }
    if(f==='swamp4') glow(ctx,350,160,100,'rgba(0,80,0,.15)');
  }
  // Sky variants
  if(f==='sky'||f==='sky2'||f==='sky3'){
    const nc=f==='sky3'?5:4;
    for(let i=0;i<nc;i++) drawCloud(ctx,(i*180+t*12)%760-30,50+i*38,'#120830');
    // Lightning
    const freq=f==='sky3'?2.5:3.8;
    if(Math.sin(t*freq)>.8){
      const alpha=Math.sin(t*freq)*.9;
      ctx.strokeStyle=`rgba(${f==='sky3'?'255,80,255':'180,120,255'},${alpha})`;ctx.lineWidth=2;
      ctx.beginPath();ctx.moveTo(300,0);ctx.lineTo(278,82);ctx.lineTo(312,104);ctx.lineTo(288,200);ctx.stroke();
      if(f!=='sky') glow(ctx,300,0,40,`rgba(200,100,255,${alpha*.3})`);
    }
    drawTower(ctx,80,70,44,150);drawTower(ctx,520,50,54,170);
    if(f==='sky3'){
      drawTower(ctx,300,20,38,120);
      glow(ctx,350,100,60,'rgba(200,50,255,.1)');
    }
  }
  // Abyss
  if(f==='abyss'){
    // Void pillars
    for(let i=0;i<5;i++) drawFirePillar(ctx,60+i*155,110,t+i,true);
    // Runes
    ctx.font='16px monospace';
    const runes=['áš ','áš¢','áš¦','áš¨','áš±','áš²','á›—','á›'];
    for(let i=0;i<8;i++){
      ctx.fillStyle=`rgba(255,20,0,${.25+Math.sin(t*2.5+i)*.2})`;
      ctx.fillText(runes[i],40+i*82,38+Math.sin(t+i)*.11);
    }
    glow(ctx,350,200,120,'rgba(150,0,0,.12)');
  }
}

function drawGround(st){
  const t=G?G.bgA:0;
  ctx.fillStyle=st.gr;ctx.fillRect(0,270,W,150);
  ctx.strokeStyle=st.ac;ctx.lineWidth=2;
  const cracks=[[40,270,120,308],[180,270,250,315],[340,270,290,308],[460,270,540,302],[140,302,175,312],[390,302,490,332],[550,270,610,305],[20,305,60,315]];
  for(const[x1,y1,x2,y2]of cracks){
    ctx.beginPath();ctx.moveTo(x1,y1);ctx.lineTo(x2,y2);
    ctx.globalAlpha=.35+Math.sin(t*1.6+x1*.02)*.45;
    ctx.shadowColor=st.ac;ctx.shadowBlur=5;ctx.stroke();ctx.shadowBlur=0;
  }
  ctx.globalAlpha=1;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PLAYER DRAW + NAME
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function drawPlayer(p){
  const bob=(p.moving?Math.sin(p.anim*2):Math.sin(p.anim*.5))*2;
  ctx.save();
  ctx.translate(~~p.x,~~(p.y+bob));
  ctx.scale(p.facing,1);

  if(p.invT>0&&Math.floor(p.invT*20)%2===0){ctx.restore();return;}

  const ls=p.moving?Math.sin(p.anim*4)*5:0;

  // Shadow
  ctx.fillStyle='rgba(0,0,0,.28)';ctx.fillRect(-13,23,26,5);
  // Legs
  ctx.fillStyle='#2a4a18';ctx.fillRect(-9,14+ls,7,11);ctx.fillRect(2,14-ls,7,11);
  ctx.fillStyle='#5a3010';ctx.fillRect(-10,22+ls,8,5);ctx.fillRect(2,22-ls,8,5);
  // Cape
  ctx.fillStyle='#1a5020';ctx.fillRect(-12,2,4,14);
  // Torso
  ctx.fillStyle='#2a7030';ctx.fillRect(-9,0,18,14);
  ctx.fillStyle='#8b5020';ctx.fillRect(-9,11,18,3);
  ctx.fillStyle='#c8832a';ctx.fillRect(-2,11,4,4);
  // Helmet
  ctx.fillStyle='#5a7a90';ctx.fillRect(-7,-16,14,16);ctx.fillRect(-7,-16,14,6);
  ctx.fillStyle='#1a2a30';ctx.fillRect(-4,-10,8,3);
  ctx.fillStyle='#60d0f0';ctx.fillRect(-2,-10,4,2);
  ctx.fillStyle='#30c050';ctx.fillRect(-2,-22,4,8);ctx.fillRect(0,-24,2,4);
  // Sword
  ctx.fillStyle='#5a7a90';ctx.fillRect(9,0,7,12);
  const sa=p.moving?Math.sin(p.anim*4)*3:0;
  ctx.fillStyle='#c8c8d8';ctx.fillRect(13,-8+sa,3,20);
  ctx.fillStyle='#8b6020';ctx.fillRect(9,-2+sa,10,3);
  ctx.fillStyle='#e8e8f0';ctx.fillRect(13,-13+sa,3,6);
  // Shield
  ctx.fillStyle='#5a7a90';ctx.fillRect(-16,0,7,12);
  ctx.fillStyle='#2a6020';ctx.fillRect(-23,-4,12,18);
  ctx.fillStyle='#c8932a';ctx.fillRect(-19,2,5,5);ctx.fillRect(-16,-2,1,10);

  ctx.restore();

  // â”€â”€ PLAYER NAME ABOVE HEAD â”€â”€
  ctx.save();
  ctx.translate(~~p.x,~~(p.y+bob));
  ctx.font='5px "Press Start 2P"';
  ctx.textAlign='center';
  const nw=ctx.measureText(p.name).width+8;
  ctx.fillStyle='rgba(0,0,0,.7)';ctx.fillRect(-nw/2,-36,nw,10);
  ctx.fillStyle='#f0e060';ctx.shadowColor='#000';ctx.shadowBlur=3;
  ctx.fillText(p.name,-0,-28);
  ctx.shadowBlur=0;
  // Level badge
  ctx.font='4px "Press Start 2P"';
  ctx.fillStyle='#80c0ff';
  ctx.fillText('LV'+p.level,0,-40);
  ctx.restore();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ENEMY DRAW
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function drawEnemy(e,st){
  const bob=Math.sin(e.anim)*3;
  ctx.save();
  ctx.translate(~~e.x,~~(e.y+bob));
  if(!e.alive){ctx.globalAlpha=Math.max(0,e.deathA);ctx.translate(0,(1-e.deathA)*18);}
  if(e.hurtT>0) ctx.globalAlpha*=(.5+Math.sin(e.hurtT*35)*.45);
  ctx.scale(-e.facing||1,1);
  const sc=e.isBoss?1.25:1;ctx.scale(sc,sc);

  // Shadow
  ctx.globalAlpha*=.5;ctx.fillStyle='rgba(0,0,0,.3)';ctx.fillRect(-e.sz/2*.9,e.sz/2-2,e.sz*.9,5);
  ctx.globalAlpha=e.alive?(e.hurtT>0?.6:1):Math.max(0,e.deathA);

  drawSprite(ctx,e.sp,e.color,G?G.bgA:0,e.isBoss);

  if(e.isBoss){
    ctx.fillStyle=`rgba(${h2r(e.color)},${.06+Math.sin((G?G.bgA:0)*2.5)*.04})`;
    ctx.beginPath();ctx.arc(0,-8,48,0,Math.PI*2);ctx.fill();
  }
  ctx.restore();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SPRITE RENDERING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function drawSprite(ctx,sp,c,t,boss){
  const s=sp||'imp';
  // Shared palette helpers
  const dark=shade(c,.5),bright=shade(c,1.5);

  if(s==='imp'){
    ctx.fillStyle='#8b4010';ctx.fillRect(-3,-28,4,10);ctx.fillRect(6,-28,4,10);
    ctx.fillStyle=c;ctx.fillRect(-8,-18,20,16);
    ctx.fillStyle='#ff8020';ctx.fillRect(-4,-14,4,4);ctx.fillRect(4,-14,4,4);
    ctx.fillStyle='#8b2000';ctx.fillRect(-6,0,16,14);
    ctx.fillStyle=c;ctx.fillRect(-14,0,8,10);ctx.fillRect(10,0,8,10);
    ctx.fillStyle='#6b1800';ctx.fillRect(-4,14,6,10);ctx.fillRect(4,14,6,10);
    ctx.fillStyle=c;ctx.fillRect(12,4,6,4);ctx.fillRect(16,6,4,4);
  }
  if(s==='sprite'){
    ctx.fillStyle=c;ctx.fillRect(-6,-16,12,20);
    ctx.fillStyle='#ff9010';ctx.fillRect(-4,-12,4,4);ctx.fillRect(4,-12,4,4);
    ctx.fillStyle=`rgba(255,180,0,${.5+Math.sin(t*8)*.3})`;ctx.fillRect(-16,-10,10,14);ctx.fillRect(6,-10,10,14);
    ctx.fillStyle=`rgba(255,100,0,${.6+Math.sin(t*5)*.3})`;ctx.fillRect(-4,-22,8,10);
  }
  if(s==='demon'){
    ctx.fillStyle='#6b0000';ctx.fillRect(-6,-32,6,14);ctx.fillRect(8,-32,6,14);
    ctx.fillStyle=c;ctx.fillRect(-14,-18,32,20);
    ctx.fillStyle='#ff2000';ctx.fillRect(-8,-14,6,6);ctx.fillRect(4,-14,6,6);
    ctx.fillStyle='#4b0000';ctx.fillRect(-12,2,28,18);
    ctx.fillStyle=c;ctx.fillRect(-22,2,10,14);ctx.fillRect(12,2,10,14);
    ctx.fillStyle='#ff4000';ctx.fillRect(-24,14,8,6);ctx.fillRect(18,14,8,6);
    ctx.fillStyle='#4b0000';ctx.fillRect(-6,20,6,12);ctx.fillRect(6,20,6,12);
    ctx.fillStyle=`rgba(255,120,0,${.14+Math.sin(t*4)*.1})`;ctx.beginPath();ctx.arc(0,-5,28,0,Math.PI*2);ctx.fill();
  }
  if(s==='lavaking'){
    // Big flaming king
    ctx.fillStyle='#8a0000';ctx.fillRect(-10,-38,10,16);ctx.fillRect(8,-38,10,16);// crown
    ctx.fillStyle='#ffd700';ctx.fillRect(-14,-42,4,8);ctx.fillRect(-6,-46,4,12);ctx.fillRect(2,-46,4,12);ctx.fillRect(10,-42,4,8);
    ctx.fillStyle=c;ctx.fillRect(-16,-22,36,24);// head
    ctx.fillStyle='#ff4000';ctx.fillRect(-10,-18,6,7);ctx.fillRect(4,-18,6,7);// eyes
    ctx.fillStyle='#5a0000';ctx.fillRect(-14,2,32,22);// body
    ctx.fillStyle=c;ctx.fillRect(-24,2,10,18);ctx.fillRect(16,2,10,18);// arms
    ctx.fillStyle='#5a0000';ctx.fillRect(-8,24,8,14);ctx.fillRect(4,24,8,14);
    ctx.fillStyle='#ff6000';ctx.fillRect(-26,18,8,8);ctx.fillRect(20,18,8,8);// claws
    glow(ctx,0,0,38,`rgba(255,100,0,${.12+Math.sin(t*3)*.08})`);
  }
  if(s==='golem'||s==='golem2'){
    const cc=s==='golem2'?'#5a4030':'#3060a0';
    ctx.fillStyle=s==='golem2'?'#8a6050':'#c0d0e0';
    ctx.fillRect(-16,-26,36,24);
    ctx.fillStyle=s==='golem2'?'#704030':cc;ctx.fillRect(-8,-18,6,6);ctx.fillRect(6,-18,6,6);
    ctx.fillStyle=s==='golem2'?'#6090b0':'#6090b0';ctx.fillRect(-14,0,32,20);
    ctx.fillStyle=s==='golem2'?'#c09070':'#c0d0e0';ctx.fillRect(-22,0,8,16);ctx.fillRect(16,0,8,16);
    ctx.fillRect(-6,20,6,14);ctx.fillRect(6,20,6,14);
    ctx.strokeStyle=s==='golem2'?'#ff8020':'#80c0ff';ctx.lineWidth=1;
    ctx.beginPath();ctx.moveTo(-8,4);ctx.lineTo(4,16);ctx.stroke();
  }
  if(s==='forge'){
    ctx.fillStyle='#804010';ctx.fillRect(-10,-20,24,18);
    ctx.fillStyle='#ff6000';ctx.fillRect(-6,-16,4,4);ctx.fillRect(4,-16,4,4);
    ctx.fillStyle='#602808';ctx.fillRect(-12,0,28,18);
    ctx.fillStyle='#804010';ctx.fillRect(-20,0,8,14);ctx.fillRect(14,0,10,14);
    // hammer
    ctx.fillStyle='#c0c0d0';ctx.fillRect(16,-10,10,8);ctx.fillRect(18,-18,6,10);
    ctx.fillRect(-8,18,6,12);ctx.fillRect(4,18,6,12);
  }
  if(s==='ruinwarden'){
    ctx.fillStyle='#603020';ctx.fillRect(-14,-32,32,28);// helmet
    ctx.fillStyle='#ff6020';ctx.fillRect(-8,-26,6,6);ctx.fillRect(4,-26,6,6);
    ctx.fillStyle='#4a2010';ctx.fillRect(-16,0,36,26);// body
    ctx.fillStyle='#603020';ctx.fillRect(-26,0,10,20);ctx.fillRect(18,0,10,20);
    ctx.fillStyle='#301008';ctx.fillRect(-8,26,8,14);ctx.fillRect(4,26,8,14);
    ctx.fillStyle='#c08050';ctx.fillRect(-30,14,8,8);ctx.fillRect(22,14,8,8);
    glow(ctx,0,0,42,`rgba(180,80,20,${.08+Math.sin(t*2)*.06})`);
  }
  if(s==='forgelord'){
    ctx.fillStyle='#aa5000';ctx.fillRect(-8,-44,10,16);ctx.fillRect(6,-44,10,16);
    ctx.fillStyle='#ffd700';ctx.fillRect(-12,-48,4,10);ctx.fillRect(-4,-52,4,14);ctx.fillRect(4,-52,4,14);ctx.fillRect(12,-48,4,10);ctx.fillRect(-12,-44,28,4);
    ctx.fillStyle=c;ctx.fillRect(-16,-28,36,24);
    ctx.fillStyle='#ff8000';ctx.fillRect(-10,-24,7,7);ctx.fillRect(4,-24,7,7);
    ctx.fillStyle='#7a3000';ctx.fillRect(-16,0,36,26);
    ctx.fillStyle=c;ctx.fillRect(-28,0,12,20);ctx.fillRect(18,0,12,20);
    ctx.fillStyle='#ffd700';ctx.fillRect(20,-14,14,10);ctx.fillRect(22,-22,10,10);// hammer
    ctx.fillStyle='#7a3000';ctx.fillRect(-8,26,8,16);ctx.fillRect(4,26,8,16);
    glow(ctx,0,0,50,`rgba(255,140,0,${.1+Math.sin(t*2.5)*.08})`);
  }
  if(s==='wolf'){
    ctx.fillStyle=c;ctx.fillRect(-8,-24,6,10);ctx.fillRect(6,-24,6,10);
    ctx.fillRect(-10,-16,24,18);
    ctx.fillStyle='#1a0030';ctx.fillRect(-6,-12,6,6);ctx.fillRect(6,-12,6,6);
    ctx.fillStyle='#3a1a5a';ctx.fillRect(-4,-4,12,8);ctx.fillStyle='#e0a0c0';ctx.fillRect(-2,-2,8,4);
    ctx.fillStyle=c;ctx.fillRect(-12,2,28,16);
    ctx.fillRect(-6,18,6,12);ctx.fillRect(6,18,6,12);
    ctx.fillStyle=c;ctx.fillRect(14,0,12,6);ctx.fillRect(22,-6,8,8);
  }
  if(s==='bat'){
    ctx.fillStyle=c;ctx.fillRect(-6,-6,12,14);ctx.fillRect(-4,-14,8,10);
    ctx.fillStyle='#ff0020';ctx.fillRect(-2,-12,2,2);ctx.fillRect(2,-12,2,2);
    const wf=Math.sin(t*10)*10;
    ctx.fillStyle=c;ctx.fillRect(-24,-8+wf,18,20-wf);ctx.fillRect(6,-8+wf,18,20-wf);
  }
  if(s==='spider'){
    ctx.fillStyle=c;ctx.fillRect(-8,-8,16,14);ctx.fillRect(-4,-16,8,10);
    ctx.fillStyle='#ff0020';ctx.fillRect(-2,-14,2,2);ctx.fillRect(2,-14,2,2);
    ctx.strokeStyle=c;ctx.lineWidth=2;
    const la=[-1.1,-.5,.5,1.1];
    for(const a of la){ctx.beginPath();ctx.moveTo(-8,0);ctx.lineTo(-24,a*16);ctx.stroke();ctx.beginPath();ctx.moveTo(8,0);ctx.lineTo(24,a*16);ctx.stroke();}
  }
  if(s==='forestwitch'){
    ctx.fillStyle='#1a0030';ctx.fillRect(-14,-38,30,14);// pointy hat
    ctx.fillStyle='#2a0050';ctx.fillRect(-10,-30,22,10);
    ctx.fillStyle=c;ctx.fillRect(-10,-22,24,20);// head
    ctx.fillStyle='#d0a0e0';ctx.fillRect(-6,-18,16,14);
    ctx.fillStyle='#aa50e0';ctx.fillRect(-4,-14,4,4);ctx.fillRect(4,-14,4,4);
    ctx.fillStyle='#1a0030';ctx.fillRect(-14,0,32,28);
    ctx.fillStyle='#8030c0';ctx.fillRect(18,-30,4,50);ctx.fillRect(14,-36,12,10);
    ctx.fillStyle=`rgba(160,50,255,${.2+Math.sin(t*3)*.15})`;ctx.beginPath();ctx.arc(20,-28,14,0,Math.PI*2);ctx.fill();
    ctx.fillRect(-8,28,7,14);ctx.fillRect(6,28,7,14);
  }
  if(s==='sporemind'){
    // Mushroom boss
    ctx.fillStyle=c;ctx.fillRect(-16,-28,34,22);// cap
    ctx.fillStyle=shade(c,.7);ctx.fillRect(-12,-24,26,14);
    ctx.fillStyle='#ffffff';ctx.fillRect(-8,-20,4,4);ctx.fillRect(4,-20,4,4);ctx.fillRect(0,-26,6,4);// spots
    ctx.fillStyle=shade(c,1.3);ctx.fillRect(-8,0,18,28);// body
    ctx.fillStyle='#d0ffd0';ctx.fillRect(-4,-4,4,5);ctx.fillRect(4,-4,4,5);// eyes
    // tentacles
    ctx.strokeStyle=c;ctx.lineWidth=3;
    const ta=[-1.4,-.8,.8,1.4];
    for(const a of ta){ctx.beginPath();ctx.moveTo(-8,18);ctx.bezierCurveTo(-8+a*10,26,-8+a*20,18,-8+a*28,30);ctx.stroke();ctx.beginPath();ctx.moveTo(10,18);ctx.bezierCurveTo(10+a*10,26,10+a*20,18,10+a*28,30);ctx.stroke();}
    glow(ctx,0,0,44,`rgba(50,200,80,${.08+Math.sin(t*2)*.06})`);
  }
  if(s==='wraith'){
    ctx.globalAlpha*=(.65+Math.sin(t*3)*.2);
    ctx.fillStyle=c;ctx.fillRect(-10,-30,24,40);ctx.fillRect(-14,-20,8,30);ctx.fillRect(14,-20,8,30);
    ctx.fillRect(-8,10,6,16);ctx.fillRect(4,10,6,16);
    ctx.fillStyle='#fff';ctx.fillRect(-6,-24,6,6);ctx.fillRect(4,-24,6,6);
    ctx.fillStyle='#40c0ff';ctx.fillRect(-5,-23,4,4);ctx.fillRect(5,-23,4,4);
  }
  if(s==='necro'){
    ctx.fillStyle='#200030';ctx.fillRect(-14,-2,32,28);ctx.fillStyle=c;ctx.fillRect(-10,-18,24,18);
    ctx.fillStyle='#1a0028';ctx.fillRect(-12,-22,28,12);ctx.fillRect(-8,-28,20,10);
    ctx.fillStyle='#c0a060';ctx.fillRect(-6,-16,16,12);
    ctx.fillStyle='#8040c0';ctx.fillRect(-4,-12,4,4);ctx.fillRect(4,-12,4,4);
    ctx.fillStyle='#6040a0';ctx.fillRect(16,-30,4,50);ctx.fillStyle='#a060f0';ctx.fillRect(12,-36,12,10);
    glow(ctx,18,-28,14,`rgba(160,80,255,${.2+Math.sin(t*3)*.14})`);
  }
  if(s==='lichknight'){
    ctx.fillStyle='#2a0050';ctx.fillRect(-16,-34,36,28);
    ctx.fillStyle='#9000ff';ctx.fillRect(-10,-28,6,8);ctx.fillRect(4,-28,6,8);
    ctx.fillStyle='#180038';ctx.fillRect(-16,0,36,28);
    ctx.fillStyle='#5000c0';ctx.fillRect(-28,0,12,20);ctx.fillRect(18,0,12,20);
    // crystal sword
    ctx.fillStyle='#a040ff';ctx.fillRect(18,-20,6,34);ctx.fillRect(14,-6,14,4);
    ctx.fillStyle='#d080ff';ctx.fillRect(20,-28,4,10);
    ctx.fillStyle='#8a0000';ctx.fillRect(-8,-46,10,14);ctx.fillRect(6,-46,10,14);// horns
    ctx.fillStyle='#c0b0d0';ctx.fillRect(-8,-26,18,16);// skull face
    ctx.fillStyle='#8000ff';ctx.fillRect(-4,-22,4,4);ctx.fillRect(4,-22,4,4);
    ctx.fillRect(-8,28,7,14);ctx.fillRect(6,28,7,14);
    glow(ctx,0,0,52,`rgba(80,0,200,${.1+Math.sin(t*2)*.08})`);
  }
  if(s==='shadowdruid'){
    ctx.fillStyle='#040a14';ctx.fillRect(-18,-42,38,32);// antlers
    ctx.strokeStyle='#1a2a40';ctx.lineWidth=3;
    ctx.beginPath();ctx.moveTo(-10,-42);ctx.lineTo(-20,-60);ctx.lineTo(-8,-50);ctx.stroke();
    ctx.beginPath();ctx.moveTo(10,-42);ctx.lineTo(20,-60);ctx.lineTo(8,-50);ctx.stroke();
    ctx.fillStyle=c;ctx.fillRect(-14,-12,30,22);
    ctx.fillStyle='#0080ff';ctx.fillRect(-8,-8,6,6);ctx.fillRect(6,-8,6,6);
    ctx.fillStyle='#040820';ctx.fillRect(-16,10,34,30);
    ctx.fillStyle='#0040a0';ctx.fillRect(-28,10,12,22);ctx.fillRect(18,10,12,22);
    ctx.fillStyle='#0060d0';ctx.fillRect(-32,20,10,8);ctx.fillRect(24,20,10,8);
    ctx.fillStyle='#040820';ctx.fillRect(-8,40,8,14);ctx.fillRect(4,40,8,14);
    glow(ctx,0,0,56,`rgba(0,30,80,${.12+Math.sin(t*1.8)*.09})`);
  }
  if(s==='iceArcher'||s==='icelicher'||s==='icedrake'){
    if(s==='iceArcher'){
      ctx.fillStyle=c;ctx.fillRect(-8,-20,18,18);
      ctx.fillStyle='#80c0ff';ctx.fillRect(-4,-16,4,4);ctx.fillRect(6,-16,4,4);
      ctx.fillStyle='#2060a0';ctx.fillRect(-10,0,22,18);
      ctx.strokeStyle='#a0e0ff';ctx.lineWidth=2;ctx.beginPath();ctx.arc(20,-10,16,-.8,.8);ctx.stroke();
      ctx.fillStyle='#e0f0ff';ctx.fillRect(34,-12,2,14);
      ctx.fillRect(-6,18,6,12);ctx.fillRect(6,18,6,12);
    }
    if(s==='icelicher'){
      ctx.fillStyle=c;ctx.fillRect(-10,-28,24,42);
      ctx.fillStyle='#ffffff';ctx.fillRect(-6,-24,5,5);ctx.fillRect(4,-24,5,5);
      ctx.fillStyle='#1040a0';ctx.fillRect(-12,-36,26,12);
      ctx.fillStyle='#4080c0';ctx.fillRect(14,-32,4,52);ctx.fillRect(10,-38,12,8);
      glow(ctx,14,-30,12,`rgba(60,150,255,${.2+Math.sin(t*4)*.14})`);
    }
    if(s==='icedrake'){
      ctx.fillStyle=c;ctx.fillRect(-24,-12,16,28);ctx.fillRect(14,-12,16,28);// wings
      ctx.fillStyle='#3070b0';ctx.fillRect(-20,-8,12,22);ctx.fillRect(14,-8,12,22);
      ctx.fillStyle=c;ctx.fillRect(-14,-4,32,22);ctx.fillRect(-12,-20,26,18);
      ctx.fillStyle='#80d0ff';ctx.fillRect(-6,-16,5,5);ctx.fillRect(4,-16,5,5);
      ctx.fillRect(16,8,14,8);ctx.fillRect(28,2,10,8);
    }
  }
  if(s==='frostgiant'){
    ctx.fillStyle='#1a4080';ctx.fillRect(-6,-54,10,18);ctx.fillRect(4,-50,8,14);
    ctx.fillStyle=c;ctx.fillRect(-20,-36,44,28);
    ctx.fillStyle='#60a0ff';ctx.fillRect(-12,-30,8,8);ctx.fillRect(4,-30,8,8);
    ctx.fillStyle='#0a2060';ctx.fillRect(-22,0,48,32);
    ctx.fillStyle=c;ctx.fillRect(-36,0,14,26);ctx.fillRect(24,0,14,26);
    ctx.fillStyle='#c0e0ff';ctx.fillRect(-40,20,10,10);ctx.fillRect(32,20,10,10);
    ctx.fillStyle='#0a2060';ctx.fillRect(-10,32,10,18);ctx.fillRect(4,32,10,18);
    // ice club
    ctx.fillStyle='#a0d0ff';ctx.fillRect(26,-20,10,52);ctx.fillRect(22,-24,18,10);
    glow(ctx,0,0,60,`rgba(20,80,200,${.1+Math.sin(t*2)*.07})`);
  }
  if(s==='crystalqueen'){
    ctx.fillStyle='#4090d0';ctx.fillRect(-8,-56,6,16);ctx.fillRect(2,-56,6,16);// spires
    ctx.fillStyle='#70b0e0';ctx.fillRect(-6,-62,4,8);ctx.fillRect(2,-62,4,8);
    ctx.fillStyle=c;ctx.fillRect(-16,-40,36,26);
    ctx.fillStyle='#a0e0ff';ctx.fillRect(-10,-34,8,8);ctx.fillRect(4,-34,8,8);
    ctx.fillStyle='#2070b0';ctx.fillRect(-18,-14,40,32);
    // Crystal wings
    ctx.fillStyle=`rgba(120,200,255,${.4+Math.sin(t*4)*.2})`;ctx.fillRect(-38,-14,20,36);ctx.fillRect(20,-14,20,36);
    ctx.fillStyle='#1050a0';ctx.fillRect(-8,18,8,16);ctx.fillRect(4,18,8,16);
    glow(ctx,0,0,56,`rgba(60,160,255,${.12+Math.sin(t*2.5)*.09})`);
  }
  if(s==='winterking'){
    ctx.fillStyle='#0820a0';ctx.fillRect(-12,-58,8,20);ctx.fillRect(-4,-64,8,24);ctx.fillRect(4,-58,8,20);// crown spires
    ctx.fillStyle='#c0d8ff';ctx.fillRect(-16,-46,36,26);
    ctx.fillStyle='#60a8ff';ctx.fillRect(-10,-40,8,8);ctx.fillRect(4,-40,8,8);
    ctx.fillStyle='#0810a0';ctx.fillRect(-20,-20,44,36);
    ctx.fillStyle='#1428c0';ctx.fillRect(-36,-20,16,28);ctx.fillRect(22,-20,16,28);
    ctx.fillStyle='#c0d8ff';ctx.fillRect(-40,-6,10,12);ctx.fillRect(32,-6,10,12);
    ctx.fillStyle='#0818a0';ctx.fillRect(-10,16,10,20);ctx.fillRect(4,16,10,20);
    // Ice scepter
    ctx.fillStyle='#80c8ff';ctx.fillRect(24,-36,6,56);ctx.fillRect(18,-42,18,10);
    ctx.fillStyle='#ffffff';ctx.fillRect(26,-48,4,8);
    glow(ctx,0,0,64,`rgba(10,40,200,${.12+Math.sin(t*1.8)*.09})`);
  }
  if(s==='troll'){
    ctx.fillStyle=c;ctx.fillRect(-16,-22,34,48);ctx.fillRect(-14,-34,30,16);
    ctx.fillStyle='#ffdd00';ctx.fillRect(-8,-28,6,6);ctx.fillRect(6,-28,6,6);
    ctx.fillStyle='#1a2804';ctx.fillRect(-10,-22,8,6);ctx.fillRect(6,-22,8,6);
    ctx.fillStyle=c;ctx.fillRect(-22,0,10,18);ctx.fillRect(18,0,10,18);
    ctx.fillRect(-8,26,8,16);ctx.fillRect(8,26,8,16);
    ctx.fillStyle='#1a3008';ctx.fillRect(-2,-40,8,12);
  }
  if(s==='bogwisp'){
    ctx.globalAlpha*=(.5+Math.sin(t*4)*.3);
    ctx.fillStyle=c;ctx.fillRect(-8,-12,16,24);ctx.fillRect(-4,-20,8,10);
    ctx.fillStyle='#80ff20';ctx.fillRect(-4,-16,3,3);ctx.fillRect(4,-16,3,3);
  }
  if(s==='boghag'){
    ctx.fillStyle=c;ctx.fillRect(-14,-36,30,28);
    ctx.fillStyle='#202008';ctx.fillRect(-8,-30,5,5);ctx.fillRect(4,-30,5,5);
    ctx.fillStyle='#0a1804';ctx.fillRect(-16,0,34,30);
    ctx.fillStyle=c;ctx.fillRect(-26,0,10,22);ctx.fillRect(18,0,10,22);
    ctx.fillStyle='#0a1804';ctx.fillRect(-8,30,8,14);ctx.fillRect(4,30,8,14);
    // cauldron
    ctx.fillStyle='#304010';ctx.fillRect(-20,10,16,16);ctx.fillRect(-22,22,20,4);
    ctx.fillStyle=`rgba(100,255,20,${.4+Math.sin(t*4)*.3})`;ctx.fillRect(-18,12,12,12);
    glow(ctx,0,0,46,`rgba(40,120,0,${.1+Math.sin(t*2)*.07})`);
  }
  if(s==='queen'){
    ctx.fillStyle=c;ctx.fillRect(-18,-18,38,28);ctx.fillRect(-10,-30,22,16);
    ctx.fillStyle='#80ff20';ctx.fillRect(-6,-26,4,6);ctx.fillRect(4,-26,4,6);
    ctx.strokeStyle=c;ctx.lineWidth=3;
    const qa=[-1.3,-.65,.65,1.3];
    for(const a of qa){ctx.beginPath();ctx.moveTo(-18,4);ctx.lineTo(-44,a*26);ctx.stroke();ctx.beginPath();ctx.moveTo(20,4);ctx.lineTo(46,a*26);ctx.stroke();}
    glow(ctx,0,0,38,`rgba(80,220,10,${.1+Math.sin(t*3)*.07})`);
  }
  if(s==='venomqueen'){
    // Upgraded queen boss
    ctx.fillStyle=c;ctx.fillRect(-22,-24,48,34);ctx.fillRect(-14,-38,30,18);
    ctx.fillStyle='#c0ff40';ctx.fillRect(-8,-34,5,7);ctx.fillRect(5,-34,5,7);
    ctx.strokeStyle=c;ctx.lineWidth=4;
    const vqa=[-1.4,-.7,0,.7,1.4];
    for(const a of vqa){ctx.beginPath();ctx.moveTo(-22,8);ctx.lineTo(-56,a*32);ctx.stroke();ctx.beginPath();ctx.moveTo(24,8);ctx.lineTo(58,a*32);ctx.stroke();}
    ctx.fillRect(-8,10,7,22);ctx.fillRect(4,10,7,22);
    glow(ctx,0,0,52,`rgba(80,230,10,${.1+Math.sin(t*2.5)*.08})`);
  }
  if(s==='plagueguard'){
    ctx.fillStyle='#183008';ctx.fillRect(-16,-36,36,28);
    ctx.fillStyle='#60d020';ctx.fillRect(-10,-30,6,7);ctx.fillRect(4,-30,6,7);
    ctx.fillStyle='#0e2004';ctx.fillRect(-18,0,40,32);
    ctx.fillStyle='#183008';ctx.fillRect(-30,0,12,24);ctx.fillRect(20,0,12,24);
    ctx.fillStyle='#80ff30';ctx.fillRect(-32,12,10,10);ctx.fillRect(24,12,10,10);
    ctx.fillStyle='#c0e080';ctx.fillRect(20,-18,12,10);ctx.fillRect(22,-26,8,10);// spear
    ctx.fillStyle='#0e2004';ctx.fillRect(-8,32,8,16);ctx.fillRect(4,32,8,16);
    glow(ctx,0,0,52,`rgba(30,150,0,${.1+Math.sin(t*2.5)*.08})`);
  }
  if(s==='rotlord'){
    ctx.fillStyle='#081002';ctx.fillRect(-6,-60,10,22);ctx.fillRect(4,-56,8,18);// horns
    ctx.fillStyle='#162804';ctx.fillRect(-20,-40,44,30);
    ctx.fillStyle='#a0ff40';ctx.fillRect(-12,-34,8,8);ctx.fillRect(6,-34,8,8);
    ctx.fillStyle='#061002';ctx.fillRect(-22,0,48,36);
    ctx.fillStyle='#162804';ctx.fillRect(-38,0,16,28);ctx.fillRect(24,0,16,28);
    ctx.fillStyle='#90e020';ctx.fillRect(-42,14,12,12);ctx.fillRect(32,14,12,12);
    ctx.fillStyle='#061002';ctx.fillRect(-10,36,10,18);ctx.fillRect(4,36,10,18);
    // rot tendrils
    ctx.strokeStyle=`rgba(80,200,10,${.3+Math.sin(t*4)*.2})`;ctx.lineWidth=2;
    for(let i=0;i<6;i++){ctx.beginPath();ctx.moveTo((i-3)*8,36);ctx.bezierCurveTo((i-3)*14,50,(i-2)*12,46,(i-2)*18,60);ctx.stroke();}
    glow(ctx,0,0,64,`rgba(10,100,0,${.14+Math.sin(t*2)*.1})`);
  }
  if(s==='stormkin'){
    ctx.fillStyle=c;ctx.fillRect(-8,-20,18,18);
    ctx.fillStyle='#e0e0ff';ctx.fillRect(-4,-16,4,4);ctx.fillRect(6,-16,4,4);
    ctx.fillStyle='#2020a0';ctx.fillRect(-10,0,22,18);
    ctx.fillStyle=`rgba(180,180,255,${.5+Math.sin(t*6)*.3})`;ctx.fillRect(-16,-4,8,10);ctx.fillRect(12,-4,8,10);// sparks
    ctx.fillRect(-6,18,6,12);ctx.fillRect(6,18,6,12);
  }
  if(s==='thunderelf'){
    ctx.fillStyle='#3030c0';ctx.fillRect(-6,-24,14,20);
    ctx.fillStyle='#8080ff';ctx.fillRect(-4,-20,4,4);ctx.fillRect(4,-20,4,4);
    ctx.fillStyle='#2020a0';ctx.fillRect(-8,0,18,18);
    // Bow
    ctx.strokeStyle='#c0c0ff';ctx.lineWidth=2;ctx.beginPath();ctx.arc(18,4,14,-.8,.8);ctx.stroke();
    ctx.fillStyle='#ffffff';ctx.fillRect(28,-8,2,16);
    ctx.fillRect(-6,18,6,12);ctx.fillRect(6,18,6,12);
  }
  if(s==='cloudgiant'){
    ctx.fillStyle='#3020a0';ctx.fillRect(-8,-58,10,22);ctx.fillRect(4,-54,8,18);
    ctx.fillStyle=c;ctx.fillRect(-22,-38,48,28);
    ctx.fillStyle='#d0b0ff';ctx.fillRect(-14,-32,8,8);ctx.fillRect(6,-32,8,8);
    ctx.fillStyle='#2010a0';ctx.fillRect(-26,0,56,36);
    ctx.fillStyle=c;ctx.fillRect(-44,0,18,28);ctx.fillRect(28,0,18,28);
    ctx.fillStyle='#d0a0ff';ctx.fillRect(-48,14,12,12);ctx.fillRect(38,14,12,12);
    ctx.fillStyle='#2010a0';ctx.fillRect(-12,36,12,18);ctx.fillRect(4,36,12,18);
    ctx.fillStyle=`rgba(180,120,255,${.08+Math.sin(t*2)*.06})`;ctx.beginPath();ctx.arc(0,-5,66,0,Math.PI*2);ctx.fill();
    // Storm hammer
    ctx.fillStyle='#c0a0ff';ctx.fillRect(28,-24,12,60);ctx.fillRect(22,-28,24,12);
    glow(ctx,0,0,70,`rgba(80,20,200,${.12+Math.sin(t*2)*.09})`);
  }
  if(s==='skyemperor'){
    // Wings
    ctx.fillStyle='#1808a0';ctx.fillRect(-80,-24,40,60);ctx.fillRect(42,-24,40,60);
    ctx.fillStyle='#2010c0';ctx.fillRect(-72,-18,30,46);ctx.fillRect(44,-18,30,46);
    // Robe
    ctx.fillStyle='#0c0880';ctx.fillRect(-22,0,48,40);
    // Pauldrons
    ctx.fillStyle='#3020c0';ctx.fillRect(-36,0,14,22);ctx.fillRect(24,0,14,22);
    // Body
    ctx.fillStyle='#1810a0';ctx.fillRect(-20,-16,44,20);
    // Head
    ctx.fillStyle='#a090e0';ctx.fillRect(-12,-34,28,20);
    // Crown
    ctx.fillStyle='#ffd700';ctx.fillRect(-14,-44,4,12);ctx.fillRect(-6,-50,5,18);ctx.fillRect(1,-50,5,18);ctx.fillRect(8,-44,4,12);ctx.fillRect(-14,-40,30,4);
    // Eyes
    ctx.fillStyle='#ff40ff';ctx.fillRect(-8,-30,6,6);ctx.fillRect(4,-30,6,6);
    // Legs
    ctx.fillStyle='#0c0880';ctx.fillRect(-10,40,10,20);ctx.fillRect(2,40,10,20);
    // Scepter
    ctx.fillStyle='#c0a0ff';ctx.fillRect(26,-44,6,64);ctx.fillRect(20,-50,18,12);ctx.fillStyle='#ffffff';ctx.fillRect(27,-58,4,10);
    glow(ctx,0,0,82,`rgba(30,10,180,${.14+Math.sin(t*1.6)*.1})`);
  }
  if(s==='shade'){
    ctx.globalAlpha*=(.5+Math.sin(t*4)*.3);
    ctx.fillStyle=c;ctx.fillRect(-12,-32,28,48);
    ctx.fillStyle='rgba(200,0,200,.8)';ctx.fillRect(-6,-26,4,6);ctx.fillRect(6,-26,4,6);
    glow(ctx,0,-8,28,`rgba(180,0,180,${.18+Math.sin(t*6)*.14})`);
  }
  if(s==='voidknight'){
    ctx.fillStyle=c;ctx.fillRect(-14,-34,32,26);// helm
    ctx.fillStyle='#8000ff';ctx.fillRect(-8,-28,6,7);ctx.fillRect(4,-28,6,7);
    ctx.fillStyle=shade(c,1.4);ctx.fillRect(-16,0,36,28);
    ctx.fillStyle=c;ctx.fillRect(-28,0,12,20);ctx.fillRect(18,0,12,20);
    ctx.fillStyle='#6000ff';ctx.fillRect(20,-18,8,46);ctx.fillRect(14,-24,16,8);// void sword
    ctx.fillStyle=c;ctx.fillRect(-8,28,8,14);ctx.fillRect(4,28,8,14);
    glow(ctx,0,0,46,`rgba(60,0,180,${.12+Math.sin(t*3)*.09})`);
  }
  if(s==='dragon'){
    // CHAOS DRAGON â€” FINAL BOSS
    const gr2=ctx.createRadialGradient(0,0,8,0,0,70);
    gr2.addColorStop(0,`rgba(255,0,20,${.14+Math.sin(t*2)*.08})`);gr2.addColorStop(1,'transparent');
    ctx.fillStyle=gr2;ctx.beginPath();ctx.arc(0,0,70,0,Math.PI*2);ctx.fill();
    // Wings
    ctx.fillStyle='#500000';ctx.fillRect(-70,-24,34,62);ctx.fillRect(38,-24,34,62);
    ctx.fillStyle='#300000';ctx.fillRect(-64,-18,26,48);ctx.fillRect(40,-18,26,48);
    ctx.strokeStyle='#900000';ctx.lineWidth=2;ctx.beginPath();ctx.moveTo(-64,38);ctx.lineTo(-46,-18);ctx.stroke();ctx.beginPath();ctx.moveTo(72,38);ctx.lineTo(54,-18);ctx.stroke();
    // Body
    ctx.fillStyle='#860000';ctx.fillRect(-26,-6,56,40);
    ctx.fillStyle='#640000';for(let i=0;i<3;i++)for(let j=0;j<4;j++)ctx.fillRect(-20+j*13,-4+i*12,11,9);
    // Neck
    ctx.fillStyle='#760000';ctx.fillRect(-9,-32,20,30);
    // Head
    ctx.fillStyle='#860000';ctx.fillRect(-20,-54,44,26);ctx.fillRect(-16,-32,32,12);
    // Nostrils
    ctx.fillStyle='#ff2000';ctx.fillRect(-9,-30,4,4);ctx.fillRect(5,-30,4,4);
    // Eyes
    ctx.fillStyle='#ff0000';ctx.fillRect(-14,-50,9,9);ctx.fillRect(5,-50,9,9);
    ctx.fillStyle='#ff8000';ctx.fillRect(-13,-49,7,7);ctx.fillRect(6,-49,7,7);
    ctx.fillStyle='#ffff00';ctx.fillRect(-12,-48,5,5);ctx.fillRect(7,-48,5,5);
    // Horns
    ctx.fillStyle='#500000';ctx.fillRect(-18,-64,7,14);ctx.fillRect(-12,-70,4,8);ctx.fillRect(10,-64,7,14);ctx.fillRect(12,-70,4,8);
    // Teeth
    ctx.fillStyle='#f0f0d0';for(let i=0;i<4;i++){ctx.fillRect(-14+i*7,-26,4,7);}
    // Legs
    ctx.fillStyle='#760000';ctx.fillRect(-22,34,14,20);ctx.fillRect(10,34,14,20);
    ctx.fillStyle='#360000';ctx.fillRect(-24,52,7,9);ctx.fillRect(-18,54,7,7);ctx.fillRect(-12,54,7,7);ctx.fillRect(10,52,7,9);ctx.fillRect(16,54,7,7);ctx.fillRect(22,54,7,7);
    // Tail
    ctx.fillStyle='#760000';ctx.fillRect(32,26,20,12);ctx.fillRect(50,18,16,12);ctx.fillRect(64,10,12,12);ctx.fillRect(74,4,10,10);
    // Fire breath
    if(Math.sin(t*3)>-0.2){
      const fi=Math.max(0,Math.sin(t*3));
      ctx.fillStyle=`rgba(255,${60+fi*100},0,${.5+fi*.4})`;ctx.fillRect(-90,-42,fi*90,18);
      ctx.fillStyle=`rgba(255,220,0,${.4+fi*.3})`;ctx.fillRect(-90,-38,fi*70,10);
      ctx.fillStyle=`rgba(255,255,100,${.3+fi*.2})`;ctx.fillRect(-90,-35,fi*50,4);
    }
    glow(ctx,0,0,78,`rgba(180,0,0,${.14+Math.sin(t*1.5)*.1})`);
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MINIMAP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function drawMinimap(){
  if(!G||G.scene!=='battle') return;
  mmx.fillStyle='#040202';mmx.fillRect(0,0,88,66);
  const sx=88/W,sy=66/H;
  mmx.fillStyle='#2a1008';mmx.fillRect(0,40,88,26);
  for(const e of G.enemies){
    if(!e.alive) continue;
    mmx.fillStyle=e.isBoss?'#ff1020':'#e03010';
    mmx.fillRect(~~(e.x*sx)-1,~~(e.y*sy)-1,3,3);
  }
  mmx.fillStyle='#40ff80';mmx.fillRect(~~(G.pl.x*sx)-2,~~(G.pl.y*sy)-2,4,4);
  mmx.strokeStyle='#8b6020';mmx.strokeRect(0,0,88,66);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HUD UPDATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updateHUD(){
  if(!G) return;
  const p=G.pl;
  document.getElementById('hpf').style.width=(p.hp/p.maxHp*100)+'%';
  document.getElementById('xpf').style.width=(p.xp/p.xpNext*100)+'%';
  document.getElementById('stf').style.width=(p.stamina/p.maxStamina*100)+'%';
  document.getElementById('hptx').textContent=`${p.hp}/${p.maxHp}`;
  document.getElementById('xptx').textContent=`${p.xp}/${p.xpNext}`;
  document.getElementById('sttx').textContent=`${~~p.stamina}/${p.maxStamina}`;
  document.getElementById('lvltag').textContent='LVL '+p.level;
  document.getElementById('cntx').textContent=p.coins;
  document.getElementById('pttx').textContent=p.pots;
  document.getElementById('bmtx').textContent=p.bombs;
  document.getElementById('pic').textContent=p.pots;
  document.getElementById('bic').textContent=p.bombs;
}

function selSlot(n){
  document.querySelectorAll('.isl').forEach((el,i)=>el.classList.toggle('active',i===n));
  if(n===1) usePot();
  if(n===2) useBomb();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function drawMtn(ctx,x,y,w,c){ctx.fillStyle=c;for(let i=0;i<w;i++){const h=(1-Math.pow(i/w*2-1,2))*w*.8;ctx.fillRect(x-w/2+i,y+w*.8-h,1,h);}}
function drawLava(ctx,x,y,t){for(let i=0;i<50;i++){const sy=y+i*3,sx=x+Math.sin(t*2+i*.35)*7,a=.35+Math.sin(t*3+i*.25)*.4;ctx.fillStyle=`rgba(255,${90+Math.sin(t*2+i*.5)*50},0,${a})`;ctx.fillRect(~~sx-2,~~sy,4+~~(Math.abs(Math.sin(i*.4))*4),4);}}
function drawChain(ctx,x1,y1,x2,y2){const n=9;for(let i=0;i<=n;i++){const t=i/n,x=x1+(x2-x1)*t,y=y1+(y2-y1)*t;ctx.fillStyle='#5a4010';ctx.fillRect(~~x-3,~~y-3,6,6);ctx.fillStyle='#3a2808';ctx.fillRect(~~x-2,~~y-2,4,4);}}
function drawSkull(ctx,x,y,c){ctx.fillStyle=c;ctx.fillRect(x-8,y-10,16,14);ctx.fillStyle='#0a0504';ctx.fillRect(x-5,y-8,4,4);ctx.fillRect(x+2,y-8,4,4);ctx.fillRect(x-3,y,8,4);ctx.fillRect(x-5,y,2,6);ctx.fillRect(x-2,y,2,6);ctx.fillRect(x+2,y,2,6);ctx.fillRect(x+4,y,2,6);}
function drawTree(ctx,x,by,h,c){ctx.fillStyle=c||'#0a1808';ctx.fillRect(x-4,by,8,h);ctx.fillRect(x-20,by+h*.3,20,4);ctx.fillRect(x,by+h*.5,18,4);ctx.fillRect(x-14,by+h*.65,14,4);}
function drawMshroom(ctx,x,y,c){ctx.fillStyle='#3a1a00';ctx.fillRect(x-4,y-14,8,14);ctx.fillStyle=c;ctx.fillRect(x-14,y-22,28,12);ctx.fillRect(x-10,y-26,20,8);ctx.fillRect(x-6,y-28,12,4);ctx.fillStyle='rgba(255,255,255,.5)';ctx.fillRect(x-8,y-20,4,4);ctx.fillRect(x+2,y-20,4,4);}
function drawBigMshroom(ctx,x,y,c){ctx.fillStyle='#2a1000';ctx.fillRect(x-5,y-20,10,20);ctx.fillStyle=c;ctx.fillRect(x-22,y-36,44,18);ctx.fillRect(x-16,y-42,32,12);ctx.fillRect(x-10,y-46,20,6);ctx.fillStyle='rgba(255,255,255,.4)';ctx.fillRect(x-14,y-32,6,6);ctx.fillRect(x+2,y-32,6,6);}
function drawCrystal(ctx,x,y,h,c){ctx.fillStyle=c;ctx.fillRect(x-4,y,8,h);ctx.fillRect(x-2,y-8,4,10);ctx.fillStyle='rgba(150,220,255,.6)';ctx.fillRect(x-2,y,2,h*.4);}
function drawCastle(ctx,x,y,w,h,c){ctx.fillStyle=c||'#0a1828';ctx.fillRect(x,y+h*.3,w,h*.7);ctx.fillRect(x,y,44,h);ctx.fillRect(x+w-44,y,44,h);for(let i=0;i<5;i++){ctx.fillRect(x+i*11,y-12,7,12);ctx.fillRect(x+w-55+i*11,y-12,7,12);}ctx.fillStyle='#050c14';ctx.fillRect(x+w/2-17,y+h*.5,34,h*.5);ctx.fillStyle='#1040c0';ctx.fillRect(x+12,y+24,14,18);ctx.fillRect(x+w-26,y+24,14,18);}
function drawCloud(ctx,x,y,c){ctx.fillStyle=c;ctx.fillRect(x,y,64,18);ctx.fillRect(x+8,y-12,44,16);ctx.fillRect(x+18,y-20,26,14);}
function drawTower(ctx,x,y,w,h){ctx.fillStyle='#0f0820';ctx.fillRect(x-w/2,y,w,h);ctx.fillStyle='#180c30';for(let i=0;i<3;i++)ctx.fillRect(x-w/2+i*(w/3),y-12,w/4,12);ctx.fillStyle='#4020a0';ctx.fillRect(x-4,y+22,8,18);ctx.fillRect(x-4,y+52,8,18);}
function drawFirePillar(ctx,x,y,t,void_=false){for(let i=0;i<9;i++){const a=.2+Math.sin(t*4+i*.7)*.22,w=17-i*1.7,c=void_?`rgba(180,0,80,${a})`:`rgba(255,${i*22},0,${a})`;ctx.fillStyle=c;ctx.fillRect(x-w/2+~~(Math.sin(t*3+i)*5),y+i*16,~~w,18);}}
function glow(ctx,x,y,r,c){const g=ctx.createRadialGradient(x,y,0,x,y,r);g.addColorStop(0,c);g.addColorStop(1,'transparent');ctx.fillStyle=g;ctx.fillRect(x-r,y-r,r*2,r*2);}
function shade(hex,f){const r=parseInt(hex.slice(1,3),16),g=parseInt(hex.slice(3,5),16),b=parseInt(hex.slice(5,7),16);return`#${clamp255(r*f)}${clamp255(g*f)}${clamp255(b*f)}`;}
function clamp255(v){return Math.max(0,Math.min(255,Math.round(v))).toString(16).padStart(2,'0');}
function h2r(hex){const r=parseInt(hex.slice(1,3),16),g=parseInt(hex.slice(3,5),16),b=parseInt(hex.slice(5,7),16);return`${r},${g},${b}`;}
function addPart(x,y,c,n){for(let i=0;i<n;i++)G.particles.push({x,y,vx:(Math.random()-.5)*5.5,vy:(Math.random()-.5)*5.5-2,life:1,ml:.45+Math.random()*.4,color:c,size:2+~~(Math.random()*4)});}
function addFT(t,x,y,c){G.texts.push({t,x,y,c,life:1,vy:-1.1});}
function rng(a,b){return ~~(Math.random()*(b-a))+a;}
function clamp(v,a,b){return Math.max(a,Math.min(b,v));}
function dist(a,b){const dx=a.x-b.x,dy=a.y-b.y;return Math.sqrt(dx*dx+dy*dy);}
function closest(){return G.enemies.filter(e=>e.alive).sort((a,b)=>dist(G.pl,a)-dist(G.pl,b))[0]||null;}
function showMsg(t){const el=document.getElementById('msg');el.textContent=t;el.classList.add('show');clearTimeout(msgT);msgT=setTimeout(()=>el.classList.remove('show'),2600);}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INPUT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
document.addEventListener('keydown',e=>{
  if(!G) return;
  G.keys[e.key]=true;
  const n={'z':'Z','Z':'Z','x':'X','X':'X','b':'B','B':'B','e':'E','E':'E','m':'M','M':'M','r':'R','R':'R','Tab':'Tab'};
  if(n[e.key]==='Z'){e.preventDefault();plAtk();}
  if(n[e.key]==='X'){e.preventDefault();usePot();}
  if(n[e.key]==='B'){e.preventDefault();useBomb();}
  if(n[e.key]==='E'){e.preventDefault();toggleShop();}
  if(n[e.key]==='M'){e.preventDefault();toggleMap();}
  if(n[e.key]==='R'){e.preventDefault();toggleRank();}
  if(n[e.key]==='Tab'){e.preventDefault();nextStage();}
});
document.addEventListener('keyup',e=>{if(G) delete G.keys[e.key];});
document.getElementById('nameinput').addEventListener('keydown',e=>{if(e.code==='Enter') startGame();});

// Touch: tap right half to attack, left to use potion
cv.addEventListener('click',e=>{
  if(!G||G.scene!=='battle') return;
  const r=cv.getBoundingClientRect(),mx=(e.clientX-r.left)*(W/r.width);
  if(mx>W*.6) plAtk();
  else if(mx<W*.3) usePot();
});

// Title stars
(function(){
  const c=document.getElementById('starbg');
  for(let i=0;i<50;i++){
    const s=document.createElement('div');
    const sz=Math.random()>.75?2:1;
    s.style.cssText=`position:absolute;width:${sz}px;height:${sz}px;background:#fff;left:${Math.random()*100}%;top:${Math.random()*100}%;animation:blink ${1.5+Math.random()*2.5}s step-end infinite;animation-delay:${Math.random()*3}s;`;
    c.appendChild(s);
  }
})();
</script>
</body>
</html>