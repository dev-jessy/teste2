<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>âš” Pixel Quest</title>
<link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
<style>
:root{
  --g:#f0c060;--g2:#c8932a;--pan:rgba(12,6,1,.95);
  --bd:#8b6020;--bd2:#3a2008;
}
*{margin:0;padding:0;box-sizing:border-box;image-rendering:pixelated;
  -webkit-tap-highlight-color:transparent;font-family:'Press Start 2P',monospace;}
html{height:100%;overflow:hidden;}
body{
  background:#030201;
  height:100%;width:100%;
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  overflow:hidden;user-select:none;
}

/* â•â• GAME SHELL â€” fixed size set by JS â•â• */
#shell{
  position:relative;
  display:flex;flex-direction:column;
  background:#050302;
  overflow:hidden;
  box-shadow:0 0 60px rgba(200,100,0,.3);
}

/* â•â• CANVAS â•â• */
#gc{
  display:block;flex-shrink:0;
  border:2px solid var(--bd2);
  box-shadow:inset 0 0 0 2px var(--bd);
}

/* â•â• HUD overlay â•â• */
#hud{
  position:absolute;top:0;left:0;right:0;
  pointer-events:none;z-index:5;
  display:flex;justify-content:space-between;align-items:flex-start;
  padding:4px 5px;gap:3px;
}
.hbox{background:var(--pan);border:2px solid var(--bd);padding:3px 6px;}
.hr{display:flex;align-items:center;gap:4px;margin-bottom:2px;color:var(--g);white-space:nowrap;}
.hr:last-child{margin-bottom:0;}
.hr span{font-size:5px;}
.bar{width:70px;height:6px;background:#1a0808;border:1px solid #4a1010;position:relative;overflow:hidden;flex-shrink:0;}
.bf{height:100%;position:absolute;top:0;left:0;transition:width .2s;}
#hpf{background:linear-gradient(90deg,#b01818,#e83028);}
#xpf{background:linear-gradient(90deg,#1850b0,#3090f0);}
#stf{background:linear-gradient(90deg,#b07010,#f0c020);}
.htag{font-size:5px;color:var(--g);background:var(--pan);border:2px solid var(--bd);padding:2px 5px;display:flex;align-items:center;gap:3px;white-space:nowrap;}
.hright{display:flex;flex-direction:column;gap:2px;align-items:flex-end;}

/* minimap */
#mm{position:absolute;top:3px;left:50%;transform:translateX(-50%);pointer-events:none;z-index:5;display:none;}
#mmc{border:1px solid var(--bd);}

/* msg */
#msg{
  position:absolute;left:50%;transform:translateX(-50%);bottom:3px;
  background:rgba(6,3,0,.97);border:2px solid var(--g2);
  padding:3px 10px;font-size:5px;color:#f0d080;
  white-space:nowrap;pointer-events:none;opacity:0;transition:opacity .18s;z-index:10;
}
#msg.on{opacity:1;}

/* stage clear overlay */
#sc{
  position:absolute;inset:0;background:rgba(0,0,0,.5);
  display:none;flex-direction:column;align-items:center;justify-content:center;
  z-index:20;pointer-events:none;
}
#sc h2{font-size:16px;color:#ffd700;text-align:center;
  text-shadow:0 0 30px rgba(255,200,0,.8),2px 2px 0 #5a3000;
  animation:gp 1s ease-in-out infinite;}
#sc p{font-size:6px;color:#c0a040;margin-top:8px;text-align:center;padding:0 10px;}

/* â•â• STAGE INFO STRIP â•â• */
#strip{
  flex-shrink:0;width:100%;
  background:#0b0601;
  border-top:2px solid var(--bd);
  display:flex;align-items:center;justify-content:space-between;
  padding:3px 8px;gap:4px;
}
#strip .sl{font-size:5px;color:var(--g);}
#strip .sr{font-size:5px;color:#604020;}
#nextbtn{
  font-family:'Press Start 2P',monospace;font-size:5px;
  color:#f0d060;background:#1a0800;border:2px solid var(--g2);
  padding:3px 7px;cursor:pointer;display:none;flex-shrink:0;
}
#nextbtn:active{transform:scale(.96);}

/* â•â• PC BOTTOM BAR â•â• */
#pcbar{
  flex-shrink:0;width:100%;
  background:#0d0702;
  border-top:2px solid var(--bd);
  display:flex;align-items:center;justify-content:space-between;
  padding:3px 6px;gap:4px;
}
.pbs{display:flex;gap:3px;}
.psl{
  width:32px;height:32px;background:#0a0602;border:2px solid #5a3810;
  display:flex;align-items:center;justify-content:center;
  font-size:13px;cursor:pointer;position:relative;
}
.psl:hover,.psl.on{border-color:var(--g);}
.psl .c{position:absolute;bottom:0;right:1px;font-size:5px;color:var(--g);}
.pbv{display:flex;gap:3px;flex-wrap:wrap;justify-content:center;}
.pb{
  font-size:5px;color:var(--g);background:#0e0802;
  border:2px solid var(--bd);padding:3px 6px;cursor:pointer;white-space:nowrap;
}
.pb:hover{background:#2a1608;border-color:var(--g);}
.pb:active{transform:scale(.96);}
.pb.r{border-color:#6b2020;}.pb.r:hover{border-color:#f44;background:#1a0808;}
.pb.g{border-color:#206b20;}.pb.g:hover{border-color:#4f4;background:#081808;}
.pb.b{border-color:#20406b;}.pb.b:hover{border-color:#48f;background:#080818;}
.pb.y{border-color:#6b6020;}.pb.y:hover{border-color:#ff4;background:#181408;}
#pcctrl{font-size:4px;color:#4a3010;line-height:1.8;text-align:right;}

/* â•â• MOBILE CONTROL PAD â•â• */
#mpad{
  flex-shrink:0;width:100%;
  background:#080402;
  border-top:2px solid var(--bd2);
  display:none; /* shown on touch via JS */
  align-items:stretch;
}

/* DPAD */
#dp{
  flex-shrink:0;position:relative;
  /* size set by JS */
}
#dp canvas{position:absolute;top:0;left:0;pointer-events:none;}
.dk{
  position:absolute;
  display:flex;align-items:center;justify-content:center;
  font-size:16px;
  background:rgba(40,20,5,.55);
  border:1px solid #3a2008;
  cursor:pointer;
}
.dk:active,.dk.dn{background:rgba(200,147,42,.3);}

/* ACTION BUTTONS */
#abns{
  flex:1;display:flex;flex-direction:column;
  align-items:center;justify-content:space-evenly;
  padding:4px 0;gap:2px;
}
.ar{display:flex;gap:3px;justify-content:center;width:100%;padding:0 3px;}
.mb{
  flex:1;font-family:'Press Start 2P',monospace;
  font-size:6px;color:var(--g);
  background:#130a02;border:2px solid var(--bd);
  padding:7px 4px;cursor:pointer;text-align:center;
  min-width:0;
}
.mb:active{background:#3a1a06;transform:scale(.95);}
.mb.r{border-color:#8b2020;color:#ff9090;}
.mb.r:active{background:#2a0808;}
.mb.g{border-color:#208b20;color:#90ff90;}
.mb.g:active{background:#082008;}
.mb.b{border-color:#20408b;color:#90b0ff;}
.mb.b:active{background:#080818;}
.mb.y{border-color:#8b8020;color:#ffff90;}
.mb.y:active{background:#181408;}

/* QUICK SLOTS (mobile right) */
#qs{
  flex-shrink:0;
  display:flex;flex-direction:column;
  align-items:center;justify-content:space-evenly;
  padding:3px;gap:2px;
  border-left:1px solid var(--bd2);
}
.ql{
  display:flex;align-items:center;justify-content:center;
  background:#0a0602;border:2px solid #5a3810;
  font-size:15px;cursor:pointer;position:relative;
}
.ql:active{border-color:var(--g);transform:scale(.92);}
.ql .c{position:absolute;bottom:0;right:2px;font-size:5px;color:var(--g);}

/* â•â• SCREENS â•â• */
.scr{
  position:absolute;inset:0;
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  z-index:30;overflow:hidden;
}

/* TITLE */
#tscr{background:radial-gradient(ellipse at center,#120804,#050302);}
#tscr h1{
  font-size:clamp(14px,4.5vw,24px);color:var(--g);
  text-shadow:0 0 30px rgba(240,150,0,.9),3px 3px 0 #3a1000;
  margin-bottom:6px;animation:gp 2s ease-in-out infinite;text-align:center;
}
#tscr h2{font-size:clamp(5px,2vw,8px);color:#806028;margin-bottom:4px;letter-spacing:.1em;}
#tscr h3{font-size:clamp(4px,1.5vw,6px);color:#5a4018;margin-bottom:clamp(12px,3vh,24px);letter-spacing:.04em;text-align:center;padding:0 12px;}
@keyframes gp{
  0%,100%{text-shadow:0 0 30px rgba(240,150,0,.9),3px 3px 0 #3a1000}
  50%{text-shadow:0 0 60px rgba(255,210,0,1),3px 3px 0 #3a1000}
}
#nf{display:flex;flex-direction:column;align-items:center;gap:8px;margin-bottom:clamp(12px,3vh,22px);}
#nf label{font-size:clamp(5px,2vw,7px);color:var(--g);}
#ni{
  font-family:'Press Start 2P',monospace;
  font-size:clamp(8px,2.5vw,11px);color:var(--g);background:#0e0802;
  border:3px solid var(--bd);outline:none;
  padding:8px 12px;text-align:center;
  width:clamp(180px,60vw,280px);
}
#ni::placeholder{color:#4a3010;}
.bb{
  font-family:'Press Start 2P',monospace;
  font-size:clamp(7px,2.5vw,10px);color:var(--g);background:#0e0802;
  border:3px solid var(--g2);padding:clamp(8px,2vh,12px) clamp(14px,4vw,26px);
  cursor:pointer;margin:3px;
}
.bb:hover{background:#2a1a06;}
.bb:active{transform:scale(.96);}
.bb.bl{animation:blink 1s step-end infinite;}
@keyframes blink{0%,100%{opacity:1}50%{opacity:.25}}

/* MAP */
#mscr{background:#040608;display:none;padding:6px 4px 4px;}
#mscr h2{font-size:clamp(7px,2.5vw,10px);color:var(--g);margin-bottom:8px;text-shadow:2px 2px 0 #2a1000;}
#mapcv{border:3px solid var(--bd);outline:2px solid var(--bd2);cursor:pointer;max-width:100%;}
#mlbl{font-size:clamp(5px,1.5vw,6px);color:#907040;margin-top:5px;background:rgba(12,6,0,.8);border:1px solid var(--bd2);padding:3px 8px;text-align:center;}

/* SHOP */
#shscr{background:rgba(4,2,0,.98);display:none;padding:6px 4px 4px;overflow-y:auto;}
#shscr h2{font-size:clamp(7px,2.5vw,10px);color:#ffd060;margin-bottom:3px;}
#sgold{font-size:clamp(5px,2vw,7px);color:#ffd700;margin-bottom:7px;}
#shgrid{
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(clamp(130px,28vw,180px),1fr));
  gap:4px;width:100%;max-height:62vh;overflow-y:auto;margin-bottom:7px;
}
.si{background:#0c0800;border:2px solid #5a3810;padding:6px 8px;cursor:pointer;display:flex;flex-direction:column;gap:2px;}
.si:hover,.si:active{border-color:var(--g2);background:#1a1004;}
.si.own{border-color:#206020;opacity:.55;pointer-events:none;}
.si-n{font-size:clamp(5px,1.5vw,6px);color:var(--g);}
.si-d{font-size:clamp(4px,1.2vw,5px);color:#907040;line-height:1.5;}
.si-p{font-size:clamp(5px,1.5vw,6px);color:#ffd700;margin-top:1px;}

/* RANK */
#rkscr{background:rgba(2,4,10,.98);display:none;padding:6px 4px 4px;overflow-y:auto;}
#rkscr h2{font-size:clamp(7px,2.5vw,10px);color:#60c0ff;margin-bottom:3px;}
#rksub{font-size:clamp(4px,1.5vw,6px);color:#406080;margin-bottom:7px;}
#rklist{width:100%;max-height:62vh;overflow-y:auto;}
.rr{display:flex;align-items:center;gap:5px;padding:4px 7px;border-bottom:1px solid #0a1020;font-size:clamp(5px,1.5vw,6px);}
.rr.me{background:rgba(60,100,200,.12);}
.rrk{width:24px;color:#406080;text-align:center;flex-shrink:0;}
.rrk.gd{color:#ffd700;}.rrk.sv{color:#c0c0c0;}.rrk.br{color:#cd7f32;}
.rnm{flex:1;color:#80c0f0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.rco{color:#ffd700;min-width:48px;text-align:right;flex-shrink:0;}
.rst{color:#806040;min-width:32px;text-align:right;font-size:clamp(4px,1.2vw,5px);flex-shrink:0;}
.rlv{color:#60a060;min-width:30px;text-align:right;font-size:clamp(4px,1.2vw,5px);flex-shrink:0;}

/* GAME OVER */
#ovl{background:rgba(0,0,0,.93);display:none;padding:16px 12px;}
#ovl h2{font-size:clamp(14px,5vw,22px);margin-bottom:10px;text-align:center;}
#ovl p{font-size:clamp(5px,1.8vw,7px);color:#a07030;margin-bottom:14px;text-align:center;line-height:2.2;}
#fst{font-size:clamp(5px,1.8vw,7px);color:#80c060;text-align:center;margin-bottom:12px;line-height:2.2;}
</style>
</head>
<body>
<div id="shell">
  <!-- CANVAS -->
  <canvas id="gc" width="700" height="420"></canvas>

  <!-- HUD OVERLAY -->
  <div id="hud">
    <div class="hbox">
      <div class="hr">â¤ï¸<div class="bar"><div class="bf" id="hpf"></div></div><span id="hptx"></span></div>
      <div class="hr">â­<div class="bar"><div class="bf" id="xpf"></div></div><span id="xptx"></span></div>
      <div class="hr">âš¡<div class="bar"><div class="bf" id="stf"></div></div><span id="sttx"></span></div>
    </div>
    <div id="mm"><canvas id="mmc" width="80" height="60"></canvas></div>
    <div class="hright">
      <div class="htag">ğŸª™<span id="cntx">0</span></div>
      <div class="htag">ğŸ§ªx<span id="pttx">3</span></div>
      <div class="htag">ğŸ’£x<span id="bmtx">0</span></div>
      <div class="htag" id="lvltag">LV1</div>
    </div>
  </div>
  <div id="msg"></div>

  <!-- STAGE CLEAR -->
  <div id="sc"><h2>âš” STAGE CLEAR! âš”</h2><p id="scr"></p></div>

  <!-- STAGE INFO STRIP -->
  <div id="strip">
    <div class="sl" id="stnm">â€”</div>
    <div class="sr" id="stsb">â€”</div>
    <div class="sr" id="stwv">â€”</div>
    <button id="nextbtn" onclick="nextStage()">â–¶NEXT</button>
  </div>

  <!-- PC BOTTOM BAR -->
  <div id="pcbar">
    <div class="pbs">
      <div class="psl on" onclick="pslClick(0)">âš”ï¸</div>
      <div class="psl" onclick="pslClick(1)">ğŸ§ª<span class="c" id="pic"></span></div>
      <div class="psl" onclick="pslClick(2)">ğŸ’£<span class="c" id="bic"></span></div>
    </div>
    <div class="pbv">
      <button class="pb r" onclick="plAtk()">âš”ATK[Z]</button>
      <button class="pb g" onclick="usePot()">ğŸ§ªPOT[X]</button>
      <button class="pb r" onclick="useBomb()">ğŸ’£BOM[B]</button>
      <button class="pb b" onclick="toggleShop()">ğŸª[E]</button>
      <button class="pb b" onclick="toggleMap()">ğŸ—º[M]</button>
      <button class="pb y" onclick="toggleRank()">ğŸ†[R]</button>
    </div>
    <div id="pcctrl">WASD/Arrows:Move<br>Z:Atk X:Pot B:Bomb<br>E:Shop M:Map R:Rank</div>
  </div>

  <!-- MOBILE PAD -->
  <div id="mpad">
    <!-- D-Pad (left) â€” sized by JS -->
    <div id="dp">
      <canvas id="dpc"></canvas><!-- visual only -->
      <div class="dk" id="dk-u">â–²</div>
      <div class="dk" id="dk-d">â–¼</div>
      <div class="dk" id="dk-l">â—€</div>
      <div class="dk" id="dk-r">â–¶</div>
      <div class="dk" id="dk-ul"></div>
      <div class="dk" id="dk-ur"></div>
      <div class="dk" id="dk-dl"></div>
      <div class="dk" id="dk-dr"></div>
      <div class="dk" id="dk-m" style="background:rgba(10,5,0,.4);border:none;cursor:default;border-radius:50%;"></div>
    </div>

    <!-- Action buttons (center) -->
    <div id="abns">
      <div class="ar">
        <button class="mb r" ontouchstart="plAtk()" onclick="plAtk()">âš”<br>ATK</button>
        <button class="mb g" ontouchstart="usePot()" onclick="usePot()">ğŸ§ª<br>POT</button>
        <button class="mb r" ontouchstart="useBomb()" onclick="useBomb()">ğŸ’£<br>BOM</button>
      </div>
      <div class="ar">
        <button class="mb b" ontouchstart="toggleShop()" onclick="toggleShop()">ğŸª<br>SHOP</button>
        <button class="mb b" ontouchstart="toggleMap()" onclick="toggleMap()">ğŸ—º<br>MAP</button>
        <button class="mb y" ontouchstart="toggleRank()" onclick="toggleRank()">ğŸ†<br>RANK</button>
      </div>
    </div>

    <!-- Quick slots (right) -->
    <div id="qs">
      <div class="ql" onclick="pslClick(0)">âš”ï¸</div>
      <div class="ql" onclick="pslClick(1)">ğŸ§ª<span class="c" id="mpic"></span></div>
      <div class="ql" onclick="pslClick(2)">ğŸ’£<span class="c" id="mbic"></span></div>
    </div>
  </div>

  <!-- SCREENS -->
  <div class="scr" id="tscr">
    <div id="starbg" style="position:absolute;inset:0;pointer-events:none;overflow:hidden;"></div>
    <h1>âš” PIXEL QUEST</h1>
    <h2>Chronicles of the Ember Realm</h2>
    <h3>20 STAGES Â· GLOBAL RANKINGS Â· ENDLESS PLAY</h3>
    <div id="nf">
      <label>ENTER YOUR NAME:</label>
      <input id="ni" type="text" maxlength="14" placeholder="KNIGHT" spellcheck="false" autocomplete="off" inputmode="text">
    </div>
    <button class="bb bl" onclick="startGame()">â–¶ EMBARK</button>
    <button class="bb" onclick="toggleRank()" style="font-size:6px;margin-top:3px;">ğŸ† RANKINGS</button>
  </div>

  <div class="scr" id="mscr">
    <h2>ğŸ—º WORLD MAP</h2>
    <canvas id="mapcv" width="580" height="300" onclick="mapClick(event)"></canvas>
    <div id="mlbl">Tap a stage to travel</div>
    <div style="display:flex;gap:8px;margin-top:6px;flex-wrap:wrap;justify-content:center;">
      <button class="bb" style="font-size:6px;padding:6px 16px;" onclick="toggleMap()">âœ– CLOSE</button>
    </div>
  </div>

  <div class="scr" id="shscr">
    <h2>âš— MERCHANT</h2>
    <div id="sgold">ğŸª™ <span id="sgo">0</span></div>
    <div id="shgrid"></div>
    <button class="bb" style="font-size:6px;padding:6px 14px;" onclick="toggleShop()">âœ– CLOSE</button>
  </div>

  <div class="scr" id="rkscr">
    <h2>ğŸ† RANKINGS</h2>
    <div id="rksub">Most gold collected</div>
    <div id="rklist"></div>
    <div style="margin-top:8px;display:flex;gap:6px;flex-wrap:wrap;justify-content:center;">
      <button class="bb" style="font-size:6px;padding:6px 14px;" onclick="toggleRank()">âœ– CLOSE</button>
      <button class="bb" style="font-size:6px;padding:6px 14px;" onclick="clearMyScore()">ğŸ—‘ CLEAR</button>
    </div>
  </div>

  <div class="scr" id="ovl">
    <h2 id="ovlt"></h2>
    <div id="fst"></div>
    <p id="ovls"></p>
    <div style="display:flex;gap:8px;flex-wrap:wrap;justify-content:center;">
      <button class="bb" onclick="continueRun()">â–¶ CONTINUE</button>
      <button class="bb" onclick="restartGame()" style="font-size:6px;">â†º NEW GAME</button>
    </div>
  </div>
</div>
<script>
const cv=document.getElementById('gc'),ctx=cv.getContext('2d');
const mmc=document.getElementById('mmc'),mmx=mmc.getContext('2d');
ctx.imageSmoothingEnabled=false;mmx.imageSmoothingEnabled=false;
let G=null,RAF=null,lastT=0,msgT=null;
const CW=700,CH=420;

// â”€â”€ RESPONSIVE LAYOUT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let TOUCH=false;
function detectTouch(){TOUCH=('ontouchstart' in window)||navigator.maxTouchPoints>0;}
function layout(){
  detectTouch();
  const shell=document.getElementById('shell');
  const pcbar=document.getElementById('pcbar');
  const mpad=document.getElementById('mpad');
  const vw=window.innerWidth,vh=window.innerHeight;
  const ctrlH=TOUCH?Math.min(Math.max(vh*.28,100),180):Math.min(Math.max(vh*.1,44),60);
  const stripH=26;
  const availH=vh-ctrlH-stripH;
  const sx=vw/CW,sy=availH/CH;
  const SC=Math.min(sx,sy,1.5);
  const cw=~~(CW*SC),ch=~~(CH*SC);
  cv.style.width=cw+'px';cv.style.height=ch+'px';
  shell.style.width=cw+'px';
  if(TOUCH){
    pcbar.style.display='none';
    mpad.style.display='flex';mpad.style.height=ctrlH+'px';
    layoutDpad(ctrlH,cw);
  } else {
    pcbar.style.display='flex';
    mpad.style.display='none';
  }
  const mapcv=document.getElementById('mapcv');
  const mw=Math.min(580,cw-16);
  mapcv.style.width=mw+'px';mapcv.style.height=~~(mw*(300/580))+'px';
}

function layoutDpad(h,cw){
  const dp=document.getElementById('dp');
  const sz=Math.min(h-8,120);
  dp.style.width=sz+'px';dp.style.height=sz+'px';dp.style.flexShrink='0';dp.style.position='relative';
  const ids=['dk-ul','dk-u','dk-ur','dk-l','dk-m','dk-r','dk-dl','dk-d','dk-dr'];
  const cols=[0,1,2,0,1,2,0,1,2],rows=[0,0,0,1,1,1,2,2,2];
  const cs=~~(sz/3);
  ids.forEach((id,i)=>{
    const el=document.getElementById(id);if(!el)return;
    const base=`position:absolute;width:${cs}px;height:${cs}px;left:${cols[i]*cs}px;top:${rows[i]*cs}px;display:flex;align-items:center;justify-content:center;box-sizing:border-box;`;
    if(id==='dk-m'){el.style.cssText=base+`background:rgba(10,5,0,.4);border:none;border-radius:50%;cursor:default;`;}
    else if(['dk-ul','dk-ur','dk-dl','dk-dr'].includes(id)){el.style.cssText=base+`background:rgba(25,12,2,.3);border:1px solid #2a1008;font-size:0;`;}
    else{el.style.cssText=base+`background:rgba(40,20,5,.55);border:1px solid #3a2008;font-size:${~~(cs*.45)}px;cursor:pointer;`;}
  });
  // size quick slots
  const qs=document.getElementById('qs');
  const qsz=Math.min(~~(h/3)-4,48);
  qs.querySelectorAll('.ql').forEach(el=>{el.style.width=qsz+'px';el.style.height=qsz+'px';});
  qs.style.width=(qsz+8)+'px';
  // size action buttons text
  const fs=Math.max(6,Math.min(~~(h*.04),9));
  document.querySelectorAll('.mb').forEach(el=>el.style.fontSize=fs+'px');
}

const DKEYS={};
function setupDpad(){
  function applyDirs(){
    if(!G)return;
    G.keys['dpad_left'] =!!(DKEYS['dk-l']||DKEYS['dk-ul']||DKEYS['dk-dl']);
    G.keys['dpad_right']=!!(DKEYS['dk-r']||DKEYS['dk-ur']||DKEYS['dk-dr']);
    G.keys['dpad_up']   =!!(DKEYS['dk-u']||DKEYS['dk-ul']||DKEYS['dk-ur']);
    G.keys['dpad_down'] =!!(DKEYS['dk-d']||DKEYS['dk-dl']||DKEYS['dk-dr']);
  }
  ['dk-u','dk-d','dk-l','dk-r','dk-ul','dk-ur','dk-dl','dk-dr'].forEach(id=>{
    const el=document.getElementById(id);if(!el)return;
    const dn=e=>{e.preventDefault();DKEYS[id]=1;el.style.background='rgba(200,147,42,.3)';applyDirs();};
    const up=e=>{e.preventDefault();delete DKEYS[id];el.style.background=['dk-ul','dk-ur','dk-dl','dk-dr'].includes(id)?'rgba(25,12,2,.3)':'rgba(40,20,5,.55)';applyDirs();};
    el.addEventListener('touchstart',dn,{passive:false});
    el.addEventListener('touchend',up,{passive:false});
    el.addEventListener('touchcancel',up,{passive:false});
    el.addEventListener('mousedown',dn);
    el.addEventListener('mouseup',up);
    el.addEventListener('mouseleave',up);
  });
  const dp=document.getElementById('dp');
  dp.addEventListener('touchmove',e=>{
    e.preventDefault();
    const r=dp.getBoundingClientRect(),sz=r.width;
    Object.keys(DKEYS).forEach(k=>delete DKEYS[k]);
    for(const t of e.touches){
      if(t.clientX<r.left||t.clientX>r.right||t.clientY<r.top||t.clientY>r.bottom)continue;
      const dx=t.clientX-r.left-sz/2,dy=t.clientY-r.top-sz/2,dz=sz*.13;
      if(dx<-dz)DKEYS['dk-l']=1;if(dx>dz)DKEYS['dk-r']=1;
      if(dy<-dz)DKEYS['dk-u']=1;if(dy>dz)DKEYS['dk-d']=1;
    }
    applyDirs();
  },{passive:false});
  dp.addEventListener('touchend',e=>{e.preventDefault();Object.keys(DKEYS).forEach(k=>delete DKEYS[k]);applyDirs();},{passive:false});
  dp.addEventListener('touchcancel',e=>{e.preventDefault();Object.keys(DKEYS).forEach(k=>delete DKEYS[k]);applyDirs();},{passive:false});
}

window.addEventListener('resize',layout);
window.addEventListener('orientationchange',()=>setTimeout(layout,250));

// â”€â”€ MAP POSITIONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const _R1Y=50,_R2Y=130,_R3Y=210,_R4Y=285;
const _COL=[40,145,250,355,460];

// â”€â”€ STAGES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const STAGES=[
  {id:0, name:'Ember Flats',    act:'ACT I',   bg:'lava',      sky:['#200a00','#140500'],gr:'#3a1808',ac:'#ff6010',mx:_COL[0],my:_R1Y,conn:[1],enemies:['imp','sprite'],boss:'demon',waves:2,maxE:3,loot:{coins:[8,18]}},
  {id:1, name:'Lava Chasms',    act:'ACT I',   bg:'lava2',     sky:['#2a0c00','#180600'],gr:'#4a1a08',ac:'#ff8020',mx:_COL[1],my:_R1Y,conn:[0,2],enemies:['imp','demon'],boss:'lavaking',waves:2,maxE:4,loot:{coins:[12,22]}},
  {id:2, name:'Ashfall Ruins',  act:'ACT I',   bg:'ruins',     sky:['#180a08','#100605'],gr:'#2c1210',ac:'#e05020',mx:_COL[2],my:_R1Y,conn:[1,3],enemies:['sprite','ashgolem'],boss:'ruinwarden',waves:3,maxE:4,loot:{coins:[14,26]}},
  {id:3, name:'The Smelter',    act:'ACT I',   bg:'forge',     sky:['#1a0800','#0e0500'],gr:'#301008',ac:'#ffaa00',mx:_COL[3],my:_R1Y,conn:[2,4],enemies:['imp','ashgolem','forge'],boss:'forgelord',waves:3,maxE:5,loot:{coins:[18,32]}},
  {id:4, name:'Twilight Grove', act:'ACT II',  bg:'forest',    sky:['#030e06','#020a04'],gr:'#0a1a0c',ac:'#30d050',mx:_COL[4],my:_R1Y,conn:[3,5],enemies:['wolf','hexbat'],boss:'forestwitch',waves:2,maxE:3,loot:{coins:[14,24]}},
  {id:5, name:'Mushroom Depths',act:'ACT II',  bg:'mushroom',  sky:['#050a10','#030608'],gr:'#081814',ac:'#60ff80',mx:_COL[4],my:_R2Y,conn:[4,6],enemies:['spider','hexbat','wolf'],boss:'sporemind',waves:3,maxE:4,loot:{coins:[16,28]}},
  {id:6, name:'Wraithwood',     act:'ACT II',  bg:'forest2',   sky:['#040c06','#020804'],gr:'#0c1c0c',ac:'#20c040',mx:_COL[3],my:_R2Y,conn:[5,7],enemies:['wraith','necro','wolf'],boss:'lichknight',waves:3,maxE:4,loot:{coins:[20,34]}},
  {id:7, name:'Black Canopy',   act:'ACT II',  bg:'darkforest',sky:['#020808','#010506'],gr:'#061410',ac:'#10d870',mx:_COL[2],my:_R2Y,conn:[6,8],enemies:['necro','wraith','spider'],boss:'shadowdruid',waves:3,maxE:5,loot:{coins:[24,40]}},
  {id:8, name:'Frost Shore',    act:'ACT III', bg:'ice',       sky:['#04080f','#02050c'],gr:'#0a1020',ac:'#40c0ff',mx:_COL[1],my:_R2Y,conn:[7,9],enemies:['golem','icearcher'],boss:'frostgiant',waves:3,maxE:4,loot:{coins:[20,36]}},
  {id:9, name:'Blizzard Pass',  act:'ACT III', bg:'blizzard',  sky:['#030610','#02040c'],gr:'#08101c',ac:'#60d0ff',mx:_COL[0],my:_R2Y,conn:[8,10],enemies:['wraith','golem','icelich'],boss:'icelich',waves:3,maxE:5,loot:{coins:[24,42]}},
  {id:10,name:'Glacial Spires', act:'ACT III', bg:'glacier',   sky:['#050812','#030510'],gr:'#0c1426',ac:'#80e0ff',mx:_COL[0],my:_R3Y,conn:[9,11],enemies:['icelicher','golem','icedrake'],boss:'crystalqueen',waves:4,maxE:5,loot:{coins:[28,48]}},
  {id:11,name:'Frozen Throne',  act:'ACT III', bg:'throne',    sky:['#040610','#02040c'],gr:'#060c1e',ac:'#a0d8ff',mx:_COL[1],my:_R3Y,conn:[10,12],enemies:['icelich','icedrake','golem'],boss:'winterking',waves:4,maxE:5,loot:{coins:[32,54]}},
  {id:12,name:'Mire Entrance',  act:'ACT IV',  bg:'swamp',     sky:['#050c02','#030800'],gr:'#0a1604',ac:'#80ff20',mx:_COL[2],my:_R3Y,conn:[11,13],enemies:['troll','bog'],boss:'boghag',waves:3,maxE:4,loot:{coins:[26,44]}},
  {id:13,name:'Venom Pools',    act:'ACT IV',  bg:'swamp2',    sky:['#060e02','#040900'],gr:'#0c1806',ac:'#a0ff40',mx:_COL[3],my:_R3Y,conn:[12,14],enemies:['troll','vbat','bog'],boss:'venomqueen',waves:3,maxE:5,loot:{coins:[30,50]}},
  {id:14,name:'Putrid Depths',  act:'ACT IV',  bg:'swamp3',    sky:['#040c02','#030800'],gr:'#081404',ac:'#60d040',mx:_COL[4],my:_R3Y,conn:[13,15],enemies:['vbat','bog','troll'],boss:'plagueguard',waves:4,maxE:5,loot:{coins:[34,56]}},
  {id:15,name:'The Rot Core',   act:'ACT IV',  bg:'swamp4',    sky:['#030a00','#020600'],gr:'#060e02',ac:'#40ff10',mx:_COL[4],my:_R4Y,conn:[14,16],enemies:['troll','vbat','bog'],boss:'rotlord',waves:4,maxE:6,loot:{coins:[38,62]}},
  {id:16,name:'Storm Approach', act:'ACT V',   bg:'sky',       sky:['#070510','#04030c'],gr:'#10082a',ac:'#c060ff',mx:_COL[3],my:_R4Y,conn:[15,17],enemies:['drake','stormkin'],boss:'stormdrake',waves:3,maxE:4,loot:{coins:[40,66]}},
  {id:17,name:'Cloud Ramparts', act:'ACT V',   bg:'sky2',      sky:['#090614','#060410'],gr:'#140a30',ac:'#e080ff',mx:_COL[2],my:_R4Y,conn:[16,18],enemies:['drake','stormkin','thunderel'],boss:'cloudgiant',waves:4,maxE:5,loot:{coins:[44,72]}},
  {id:18,name:'Apex Spire',     act:'ACT V',   bg:'sky3',      sky:['#0a0618','#070412'],gr:'#180c36',ac:'#ff80ff',mx:_COL[1],my:_R4Y,conn:[17,19],enemies:['thunderel','drake','stormkin'],boss:'skyemperor',waves:4,maxE:6,loot:{coins:[50,80]}},
  {id:19,name:'ETERNAL ABYSS',  act:'FINAL',   bg:'abyss',     sky:['#0c0000','#080000'],gr:'#1c0000',ac:'#ff0020',mx:_COL[0],my:_R4Y,conn:[18],enemies:['shade','voidknight'],boss:'chaosdragon',waves:5,maxE:6,loot:{coins:[80,150]}},
];

// â”€â”€ ENEMIES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const ET={
  imp:{name:'Lava Imp',hp:18,atk:6,def:1,xp:8,coins:12,color:'#c03010',sz:26,sp:'imp'},
  sprite:{name:'Fire Sprite',hp:14,atk:8,def:0,xp:6,coins:8,color:'#ff6010',sz:20,sp:'sprite'},
  demon:{name:'Fire Demon',hp:45,atk:13,def:3,xp:20,coins:32,color:'#8b1a00',sz:38,sp:'demon',boss:true},
  lavaking:{name:'Lava King',hp:70,atk:16,def:5,xp:32,coins:55,color:'#cc2200',sz:46,sp:'lavaking',boss:true},
  ashgolem:{name:'Ash Golem',hp:28,atk:9,def:4,xp:12,coins:16,color:'#5a3020',sz:32,sp:'golem2'},
  forge:{name:'Forge Guard',hp:22,atk:10,def:2,xp:10,coins:14,color:'#804010',sz:28,sp:'forge'},
  ruinwarden:{name:'Ruin Warden',hp:60,atk:14,def:6,xp:28,coins:48,color:'#703010',sz:44,sp:'ruinwarden',boss:true},
  forgelord:{name:'Forge Lord',hp:80,atk:18,def:6,xp:36,coins:65,color:'#aa5000',sz:50,sp:'forgelord',boss:true},
  wolf:{name:'Shadow Wolf',hp:22,atk:8,def:2,xp:10,coins:15,color:'#2a0a4a',sz:30,sp:'wolf'},
  hexbat:{name:'Hex Bat',hp:16,atk:9,def:1,xp:8,coins:10,color:'#3a0a1a',sz:20,sp:'bat'},
  spider:{name:'Hex Spider',hp:18,atk:10,def:1,xp:9,coins:12,color:'#1a0a30',sz:22,sp:'spider'},
  forestwitch:{name:'Forest Witch',hp:55,atk:14,def:4,xp:26,coins:46,color:'#2a1040',sz:42,sp:'forestwitch',boss:true},
  sporemind:{name:'Spore Mind',hp:72,atk:16,def:4,xp:34,coins:58,color:'#104030',sz:48,sp:'sporemind',boss:true},
  wraith:{name:'Wraith',hp:24,atk:11,def:2,xp:11,coins:14,color:'#60a0c0',sz:28,sp:'wraith'},
  necro:{name:'Necromancer',hp:30,atk:13,def:3,xp:14,coins:20,color:'#4a0a6a',sz:32,sp:'necro'},
  lichknight:{name:'Lich Knight',hp:80,atk:18,def:5,xp:38,coins:65,color:'#3a0860',sz:50,sp:'lichknight',boss:true},
  shadowdruid:{name:'Shadow Druid',hp:90,atk:20,def:6,xp:44,coins:75,color:'#060c20',sz:52,sp:'shadowdruid',boss:true},
  golem:{name:'Frost Golem',hp:36,atk:10,def:6,xp:15,coins:20,color:'#3060a0',sz:34,sp:'golem'},
  icedrake:{name:'Ice Drake',hp:30,atk:13,def:3,xp:14,coins:19,color:'#4080c0',sz:30,sp:'icedrake'},
  icelicher:{name:'Ice Licher',hp:26,atk:12,def:2,xp:13,coins:18,color:'#2050a0',sz:26,sp:'icelicher'},
  icelich:{name:'Ice Lich',hp:28,atk:14,def:2,xp:14,coins:19,color:'#1040a0',sz:28,sp:'icelicher'},
  icearcher:{name:'Frost Archer',hp:20,atk:11,def:1,xp:10,coins:14,color:'#3070b0',sz:24,sp:'iceArcher'},
  frostgiant:{name:'Frost Giant',hp:90,atk:18,def:7,xp:40,coins:70,color:'#2050a0',sz:54,sp:'frostgiant',boss:true},
  crystalqueen:{name:'Crystal Queen',hp:100,atk:20,def:7,xp:48,coins:82,color:'#4090d0',sz:54,sp:'crystalqueen',boss:true},
  winterking:{name:'Winter King',hp:120,atk:24,def:8,xp:58,coins:100,color:'#1030a0',sz:58,sp:'winterking',boss:true},
  troll:{name:'Bog Troll',hp:34,atk:11,def:5,xp:14,coins:19,color:'#2a4010',sz:34,sp:'troll'},
  bog:{name:'Bog Wisp',hp:18,atk:10,def:1,xp:9,coins:12,color:'#204010',sz:22,sp:'bogwisp'},
  vbat:{name:'Venom Bat',hp:20,atk:11,def:1,xp:10,coins:13,color:'#304008',sz:22,sp:'bat'},
  boghag:{name:'Bog Hag',hp:80,atk:16,def:5,xp:38,coins:66,color:'#1a3008',sz:48,sp:'boghag',boss:true},
  venomqueen:{name:'Venom Queen',hp:100,atk:20,def:5,xp:48,coins:85,color:'#204010',sz:54,sp:'venomqueen',boss:true},
  plagueguard:{name:'Plague Guard',hp:110,atk:22,def:6,xp:55,coins:95,color:'#184008',sz:56,sp:'plagueguard',boss:true},
  rotlord:{name:'Rot Lord',hp:130,atk:26,def:7,xp:65,coins:115,color:'#0a2004',sz:60,sp:'rotlord',boss:true},
  drake:{name:'Storm Drake',hp:44,atk:14,def:4,xp:20,coins:30,color:'#5028a0',sz:38,sp:'drake'},
  stormkin:{name:'Storm Kin',hp:28,atk:13,def:2,xp:12,coins:18,color:'#3020a0',sz:26,sp:'stormkin'},
  thunderel:{name:'Thunder Elf',hp:24,atk:14,def:2,xp:13,coins:19,color:'#4040c0',sz:26,sp:'thunderelf'},
  stormdrake:{name:'Storm Drake Boss',hp:100,atk:20,def:6,xp:50,coins:90,color:'#4010c0',sz:56,sp:'drake',boss:true},
  cloudgiant:{name:'Cloud Giant',hp:130,atk:24,def:7,xp:62,coins:110,color:'#5030a0',sz:60,sp:'cloudgiant',boss:true},
  skyemperor:{name:'Sky Emperor',hp:160,atk:28,def:9,xp:78,coins:140,color:'#2008a0',sz:64,sp:'skyemperor',boss:true},
  shade:{name:'Void Shade',hp:50,atk:16,def:4,xp:28,coins:42,color:'#200030',sz:32,sp:'shade'},
  voidknight:{name:'Void Knight',hp:60,atk:18,def:5,xp:34,coins:52,color:'#300050',sz:36,sp:'voidknight'},
  chaosdragon:{name:'CHAOS DRAGON',hp:250,atk:36,def:12,xp:200,coins:400,color:'#800000',sz:70,sp:'dragon',boss:true},
};

// â”€â”€ SHOP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const SHOP=[
  {id:'pot3', name:'Potions x3',      desc:'Restore 40% HP',        price:30, icon:'ğŸ§ª',stack:true,fn:()=>{G.pl.pots+=3;}},
  {id:'pot5', name:'Potions x5',      desc:'Restore 40% HP',        price:45, icon:'ğŸ§ª',stack:true,fn:()=>{G.pl.pots+=5;}},
  {id:'bom2', name:'Bombs x2',        desc:'50 dmg all enemies',    price:35, icon:'ğŸ’£',stack:true,fn:()=>{G.pl.bombs+=2;}},
  {id:'bom4', name:'Bombs x4',        desc:'50 dmg all enemies',    price:60, icon:'ğŸ’£',stack:true,fn:()=>{G.pl.bombs+=4;}},
  {id:'elx',  name:'Grand Elixir',    desc:'Fully restore HP',      price:90, icon:'âœ¨',stack:true,fn:()=>{G.pl.hp=G.pl.maxHp;}},
  {id:'mgp',  name:'Mega Potion',     desc:'Restore 70% HP',        price:65, icon:'ğŸ’Š',stack:true,fn:()=>{G.pl.hp=Math.min(G.pl.maxHp,G.pl.hp+~~(G.pl.maxHp*.7));}},
  {id:'phx',  name:'Phoenix Feather', desc:'Auto-revive once',      price:120,icon:'ğŸ”¥',stack:true,fn:()=>{G.pl.revive=true;}},
  {id:'tom',  name:'Tome of Power',   desc:'+50 XP instantly',      price:40, icon:'ğŸ“–',stack:true,fn:()=>{gainXP(50);}},
  {id:'sw1',  name:'Iron Sword',      desc:'+4 ATK',                price:55, icon:'âš”ï¸',fn:()=>{G.pl.atk+=4;}},
  {id:'sw2',  name:'Steel Blade',     desc:'+8 ATK',                price:110,icon:'ğŸ—¡ï¸',fn:()=>{G.pl.atk+=8;}},
  {id:'sw3',  name:'Magic Blade',     desc:'+12 ATK + AOE hits',    price:200,icon:'ğŸŒŸ',fn:()=>{G.pl.atk+=12;G.pl.aoe=true;}},
  {id:'swr',  name:'Soul Reaper',     desc:'+6 ATK +20% lifesteal', price:280,icon:'ğŸ’€',fn:()=>{G.pl.atk+=6;G.pl.lifesteal=.2;}},
  {id:'sh1',  name:'Iron Shield',     desc:'+6 DEF',                price:90, icon:'ğŸ›¡ï¸',fn:()=>{G.pl.def+=6;}},
  {id:'sh2',  name:'Rune Shield',     desc:'+10 DEF +reflect 2dmg', price:175,icon:'ğŸ”®',fn:()=>{G.pl.def+=10;G.pl.reflect=2;}},
  {id:'lr',   name:'Life Ring',       desc:'+20 Max HP',            price:55, icon:'ğŸ’',fn:()=>{G.pl.maxHp+=20;G.pl.hp+=20;}},
  {id:'rr',   name:'Regen Ring',      desc:'+30 MaxHP + regen',     price:110,icon:'ğŸ’',fn:()=>{G.pl.maxHp+=30;G.pl.hp+=30;G.pl.regen=true;}},
  {id:'bt1',  name:'Swiftboots',      desc:'+25% speed',            price:50, icon:'ğŸ‘Ÿ',fn:()=>{G.pl.spd=Math.min(G.pl.spd*1.25,240);}},
  {id:'bt2',  name:'Wind Treads',     desc:'+50% speed',            price:100,icon:'ğŸ’¨',fn:()=>{G.pl.spd=Math.min(G.pl.spd*1.5,280);}},
  {id:'cm1',  name:'Chain Mail',      desc:'+5 DEF -10 SPD',        price:80, icon:'ğŸª–',fn:()=>{G.pl.def+=5;G.pl.spd=Math.max(70,G.pl.spd-10);}},
  {id:'ar2',  name:'Dragon Armor',    desc:'+8 DEF +10 MaxHP',      price:180,icon:'ğŸ²',fn:()=>{G.pl.def+=8;G.pl.maxHp+=10;G.pl.hp+=10;}},
  {id:'dam',  name:'Death Amulet',    desc:'Survive killing blow',  price:130,icon:'â˜ ï¸',fn:()=>{G.pl.amulet=true;}},
  {id:'bch',  name:'Battle Charm',    desc:'+20% damage dealt',     price:150,icon:'ğŸ…',fn:()=>{G.pl.atkMult=(G.pl.atkMult||1)*1.2;}},
  {id:'arc',  name:'Arcane Scroll',   desc:'Double XP 3 stages',    price:95, icon:'ğŸ“œ',fn:()=>{G.pl.xpMult=2;G.pl.xpMultStages=3;}},
  {id:'cmp',  name:'Hero Compass',    desc:'Reveal all map names',  price:70, icon:'ğŸ§­',fn:()=>{G.pl.compass=true;}},
  {id:'stc',  name:'Stamina Crystal', desc:'+50 Max Stamina',       price:85, icon:'âš¡',fn:()=>{G.pl.maxStamina+=50;G.pl.stamina=G.pl.maxStamina;}},
];

// â”€â”€ RANKINGS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const RK='pq5:lb';
async function loadRank(){try{const r=await window.storage.get(RK,true);return r?JSON.parse(r.value):[]}catch{return[];}}
async function saveScore(e){
  let r=await loadRank();
  const i=r.findIndex(x=>x.name===e.name);
  if(i>=0){if(e.coins>r[i].coins)r[i]=e;}else r.push(e);
  r.sort((a,b)=>b.coins-a.coins);r=r.slice(0,50);
  try{await window.storage.set(RK,JSON.stringify(r),true);}catch{}
}
async function clearMyScore(){
  if(!G)return;
  let r=await loadRank();r=r.filter(x=>x.name!==G.pl.name);
  try{await window.storage.set(RK,JSON.stringify(r),true);}catch{}
  renderRank();
}

// â”€â”€ GAME START â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function startGame(){
  const nm=document.getElementById('ni').value.trim().toUpperCase()||'KNIGHT';
  document.getElementById('tscr').style.display='none';
  document.getElementById('mm').style.display='block';
  G={
    scene:'map',stage:null,stageIdx:null,
    enemies:[],particles:[],texts:[],
    bgA:0,keys:{},shakeT:0,
    wave:0,maxWave:0,bossSpawned:false,
    killCount:0,totalKills:0,totalCoins:0,
    stagesCleared:[],currentStageCleared:false,
    pl:{
      name:nm,x:180,y:240,
      hp:50,maxHp:50,xp:0,xpNext:30,
      atk:12,def:4,spd:120,level:1,
      coins:0,pots:3,bombs:0,
      stamina:100,maxStamina:100,
      aoe:false,lifesteal:0,reflect:0,regen:false,
      amulet:false,amuletUsed:false,revive:false,
      atkMult:1,xpMult:1,xpMultStages:0,compass:false,
      facing:1,moving:false,anim:0,invT:0,
      purchased:new Set(),
    },
  };
  openMap();updateHUD();loop(0);
}

function restartGame(){
  document.getElementById('ovl').style.display='none';
  document.getElementById('tscr').style.display='flex';
  cancelAnimationFrame(RAF);G=null;
}

function continueRun(){
  document.getElementById('ovl').style.display='none';
  if(!G)return;
  G.pl.hp=Math.floor(G.pl.maxHp*.5);
  G.pl.amuletUsed=false;G.pl.revive=false;
  G.enemies=[];G.wave=0;G.bossSpawned=false;
  G.killCount=0;G.currentStageCleared=false;
  document.getElementById('nextbtn').style.display='none';
  updateHUD();
  if(G.stageIdx!==null)beginStage(G.stageIdx);else openMap();
}

// â”€â”€ MAP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function isOpen(s){
  if(!G)return s.id===0;
  if(s.id===0)return true;
  if(G.stagesCleared.includes(s.id))return true;
  return G.stagesCleared.includes(s.id-1);
}
function openMap(){
  document.getElementById('mscr').style.display='flex';
  if(G){G.scene='map';drawWorldMap();}
}
function toggleMap(){
  const s=document.getElementById('mscr');
  if(s.style.display==='flex'){s.style.display='none';if(G)G.scene='battle';}
  else{s.style.display='flex';if(G)G.scene='map';drawWorldMap();}
}
function drawWorldMap(){
  const mc=document.getElementById('mapcv');
  const cx=mc.getContext('2d');
  cx.imageSmoothingEnabled=false;
  const W2=580,H2=300;mc.width=W2;mc.height=H2;
  cx.fillStyle='#030508';cx.fillRect(0,0,W2,H2);
  cx.fillStyle='#07090f';
  for(let i=0;i<W2;i+=20)for(let j=0;j<H2;j+=20)cx.fillRect(i,j,1,1);
  // Act bands
  [{y:0,h:88,c:'rgba(180,60,10,.06)',l:'ACT I â€” VOLCANIC'},{y:88,h:88,c:'rgba(20,160,40,.05)',l:'ACT II â€” FOREST'},
   {y:176,h:76,c:'rgba(30,100,220,.05)',l:'ACT III/IV'},{y:252,h:48,c:'rgba(120,40,220,.06)',l:'ACT V â€” SKY & ABYSS'}
  ].forEach(b=>{cx.fillStyle=b.c;cx.fillRect(0,b.y,W2,b.h);cx.fillStyle='rgba(180,120,30,.18)';cx.font='4px "Press Start 2P"';cx.textBaseline='top';cx.textAlign='left';cx.fillText(b.l,5,b.y+4);});
  // Connections
  for(const s of STAGES){
    for(const nb of s.conn){
      if(nb<=s.id)continue;
      const s2=STAGES[nb];
      const cl=G&&(G.stagesCleared.includes(s.id)||G.stagesCleared.includes(nb));
      cx.strokeStyle=cl?'rgba(240,180,40,.6)':'rgba(70,45,15,.5)';
      cx.lineWidth=cl?2.5:1.5;cx.setLineDash(cl?[]:[4,4]);
      cx.beginPath();cx.moveTo(s.mx,s.my);cx.lineTo(s2.mx,s2.my);cx.stroke();cx.setLineDash([]);
    }
  }
  // Nodes
  const now=G&&G.stageIdx!==null?G.stageIdx:-1;
  const aC={'ACT I':'#ff6010','ACT II':'#30c050','ACT III':'#40c0ff','ACT IV':'#80ff20','ACT V':'#c060ff','FINAL':'#ff1030'};
  const icons=['ğŸŒ‹','ğŸŒ‹','ğŸš','âš’','ğŸŒ²','ğŸ„','ğŸŒ²','ğŸŒ²','â„ï¸','â„ï¸','ğŸ”','â„ï¸','ğŸŒ¿','â˜ ï¸','ğŸŒ¿','ğŸŒ¿','âš¡','â˜ï¸','âš¡','ğŸ’€'];
  for(const s of STAGES){
    const cl=G&&G.stagesCleared.includes(s.id);
    const op=isOpen(s),ac=s.id===now,col=aC[s.act]||'#c8932a';
    if(ac){cx.fillStyle='rgba(240,200,60,.2)';cx.beginPath();cx.arc(s.mx,s.my,20,0,Math.PI*2);cx.fill();}
    else if(cl){cx.fillStyle='rgba(40,220,80,.1)';cx.beginPath();cx.arc(s.mx,s.my,17,0,Math.PI*2);cx.fill();}
    cx.fillStyle=cl?'#0a2010':ac?'#201400':op?'#100c02':'#0a0818';
    cx.strokeStyle=cl?'#30d050':ac?'#f0c060':op?col:'#282040';
    cx.lineWidth=ac?3:cl?2.5:2;
    cx.beginPath();cx.arc(s.mx,s.my,12,0,Math.PI*2);cx.fill();cx.stroke();
    cx.font='10px serif';cx.textAlign='center';cx.textBaseline='middle';
    cx.fillText(cl?'âœ…':(!op?'ğŸ”’':icons[s.id]),s.mx,s.my);
    cx.font='bold 4px "Press Start 2P"';cx.fillStyle=op||cl?col:'#302850';cx.textAlign='center';cx.textBaseline='middle';
    cx.fillText(s.id+1,s.mx-15,s.my-15);
    const nm=G&&G.pl&&G.pl.compass?s.name:(!op&&!cl?'???':s.name);
    cx.font='4px "Press Start 2P"';cx.textBaseline='top';
    cx.fillStyle=cl?'#60e070':ac?'#f0c060':op?'#b08030':'#3a2a60';
    cx.fillText(nm.slice(0,10),s.mx,s.my+14);
    if(nm.length>10)cx.fillText(nm.slice(10),s.mx,s.my+21);
  }
}
function mapClick(e){
  if(!G)return;
  const mc=document.getElementById('mapcv');
  const r=mc.getBoundingClientRect();
  const mx=(e.clientX-r.left)*(580/r.width),my=(e.clientY-r.top)*(300/r.height);
  for(const s of STAGES){
    const dx=mx-s.mx,dy=my-s.my;
    if(Math.sqrt(dx*dx+dy*dy)<16){
      if(!isOpen(s)){document.getElementById('mlbl').textContent=s.id>0?`ğŸ”’ Clear S${s.id}: ${STAGES[s.id-1].name} first`:'ğŸ”’ Locked';return;}
      document.getElementById('mscr').style.display='none';
      beginStage(s.id);return;
    }
  }
}

// â”€â”€ STAGE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function beginStage(id){
  const s=STAGES[id];
  G.stage=s;G.stageIdx=id;G.enemies=[];G.wave=0;G.maxWave=s.waves;
  G.bossSpawned=false;G.killCount=0;G.currentStageCleared=false;G.scene='battle';
  G.pl.x=120;G.pl.y=240;G.pl.amuletUsed=false;
  document.getElementById('nextbtn').style.display='none';
  document.getElementById('sc').style.display='none';
  document.getElementById('stnm').textContent=`S${id+1}: ${s.name}`;
  document.getElementById('stsb').textContent=s.act;
  updateHUD();spawnWave();showMsg(`âš” ${s.name}`);
}
function nextStage(){
  if(!G||!G.stage)return;
  document.getElementById('nextbtn').style.display='none';
  const nxt=G.stageIdx+1;
  if(nxt<STAGES.length)beginStage(nxt);else openMap();
}
function spawnWave(){
  if(!G||!G.stage)return;
  const s=G.stage;G.wave++;
  G.enemies=G.enemies.filter(e=>e.alive);
  const isBoss=G.wave>=G.maxWave&&!G.bossSpawned;
  if(isBoss){
    G.bossSpawned=true;
    const bt=ET[s.boss];if(!bt)return;
    const hp=~~(bt.hp*(1+G.stageIdx*.08));
    const e=mkE(bt,true,480,210);e.hp=hp;e.maxHp=hp;
    G.enemies.push(e);showMsg(`âš  BOSS: ${bt.name}!`);
  } else {
    const cnt=Math.min(G.wave+1,s.maxE);
    for(let i=0;i<cnt;i++){
      const tid=s.enemies[~~(Math.random()*s.enemies.length)];
      const t=ET[tid];if(!t)continue;
      const sc2=1+G.stageIdx*.06+G.wave*.04;
      const e=mkE(t,false,360+Math.random()*260,165+Math.random()*120);
      e.hp=~~(e.hp*sc2);e.maxHp=e.hp;e.atk=~~(e.atk*sc2);
      G.enemies.push(e);
    }
    showMsg(`Wave ${G.wave}/${G.maxWave-1} â€” ${cnt} enemies!`);
  }
  document.getElementById('stwv').textContent=isBoss?'âš  BOSS':`W${G.wave}/${G.maxWave}`;
}
function mkE(t,isBoss,x,y){
  return{...JSON.parse(JSON.stringify(t)),x,y,alive:true,isBoss,anim:0,hurtT:0,deathA:1,
    atkTimer:1+Math.random()*1.5,wanderX:x+(Math.random()-.5)*80,
    wanderY:clamp(y+(Math.random()-.5)*60,160,330),wanderT:2+Math.random()*2};
}

// â”€â”€ COMBAT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function plAtk(){
  if(!G||G.scene!=='battle')return;
  if(G.pl.stamina<10){showMsg('âš¡ No stamina!');return;}
  const alive=G.enemies.filter(e=>e.alive);if(!alive.length)return;
  G.pl.stamina=Math.max(0,G.pl.stamina-15);
  const tgts=G.pl.aoe?alive:[closest()].filter(Boolean);
  for(const e of tgts){
    const raw=~~((G.pl.atk+rng(-2,4))*(G.pl.atkMult||1));
    const dmg=Math.max(1,raw-e.def);
    e.hp=Math.max(0,e.hp-dmg);e.hurtT=.2;
    addFT('-'+dmg,e.x,e.y-28,e.isBoss?'#ff5050':'#ff9050');
    addPt(e.x,e.y,e.color,6);G.shakeT=.06;
    if(G.pl.lifesteal>0){const h=Math.ceil(dmg*G.pl.lifesteal);G.pl.hp=Math.min(G.pl.maxHp,G.pl.hp+h);if(h>0)addFT('+'+h,G.pl.x,G.pl.y-44,'#40ff80');}
    if(e.hp<=0)killEnemy(e);
  }
  addPt(G.pl.x+G.pl.facing*16,G.pl.y-10,'#fff',4);
  setTimeout(()=>{if(G&&G.scene==='battle')alive.filter(e=>e.alive&&dist(G.pl,e)<240).forEach(e=>enAtk(e));},320);
}
function enAtk(e){
  if(!G||!e.alive||G.pl.invT>0)return;
  const dmg=Math.max(1,e.atk-G.pl.def+rng(-2,3));
  const fin=G.pl.reflect>0?Math.max(0,dmg-G.pl.reflect):dmg;
  if(G.pl.reflect>0&&G.pl.reflect>=dmg){addFT('REFLECT!',G.pl.x,G.pl.y-50,'#80c0ff');e.hp=Math.max(0,e.hp-2);if(e.hp<=0){killEnemy(e);return;}}
  if(G.pl.hp-fin<=0){
    if(G.pl.revive&&!G.pl.amuletUsed){G.pl.hp=~~(G.pl.maxHp*.3);G.pl.amuletUsed=true;G.pl.revive=false;G.pl.invT=2;showMsg('ğŸ”¥ Phoenix saved you!');updateHUD();return;}
    if(G.pl.amulet&&!G.pl.amuletUsed){G.pl.hp=1;G.pl.amuletUsed=true;G.pl.invT=1.5;showMsg('â˜ ï¸ Amulet saved you!');updateHUD();return;}
    G.pl.hp=0;updateHUD();setTimeout(playerDeath,500);return;
  }
  G.pl.hp=Math.max(0,G.pl.hp-fin);G.pl.invT=.35;
  addFT('-'+fin,G.pl.x,G.pl.y-40,'#ff2020');addPt(G.pl.x,G.pl.y,'#ff2020',4);updateHUD();
}
function usePot(){
  if(!G)return;
  if(G.pl.pots<=0){showMsg('No potions!');return;}
  if(G.pl.hp>=G.pl.maxHp){showMsg('HP full!');return;}
  const h=~~(G.pl.maxHp*.4);
  G.pl.hp=Math.min(G.pl.maxHp,G.pl.hp+h);G.pl.pots--;
  addFT('+'+h+'HP',G.pl.x,G.pl.y-40,'#40ff80');addPt(G.pl.x,G.pl.y,'#40ff80',8);
  showMsg('ğŸ§ª +'+h+' HP');updateHUD();
}
function useBomb(){
  if(!G||!G.pl.bombs){showMsg('No bombs!');return;}
  G.pl.bombs--;
  const alive=G.enemies.filter(e=>e.alive);
  for(const e of alive){const d=Math.max(1,50-e.def);e.hp=Math.max(0,e.hp-d);addFT('-'+d,e.x,e.y-28,'#ff8020');addPt(e.x,e.y,'#ff6010',10);if(e.hp<=0)killEnemy(e);}
  addPt(G.pl.x,G.pl.y-20,'#ff8020',20);showMsg('ğŸ’£ BOOM! '+alive.length+' hit!');updateHUD();
}
function killEnemy(e){
  if(!e.alive)return;
  e.alive=false;e.deathA=1;
  addPt(e.x,e.y,'#fff',14);addPt(e.x,e.y,e.color,10);
  const xg=~~(e.xp*(G.pl.xpMult||1));
  const cg=e.coins+rng(0,~~(e.coins*.3));
  G.pl.coins+=cg;G.totalCoins+=cg;
  gainXP(xg);addFT('+'+cg+'ğŸª™',e.x,e.y-48,'#ffd700');
  G.killCount++;G.totalKills++;
  setTimeout(()=>{
    if(!G)return;
    if(!G.enemies.filter(e=>e.alive).length){
      if(e.isBoss)stageComplete();
      else if(!G.bossSpawned)setTimeout(spawnWave,1600);
    }
  },400);
}
function gainXP(a){
  if(!G)return;G.pl.xp+=a;
  while(G.pl.xp>=G.pl.xpNext){
    G.pl.xp-=G.pl.xpNext;G.pl.level++;G.pl.xpNext=~~(G.pl.xpNext*1.4);
    G.pl.maxHp+=12;G.pl.hp=Math.min(G.pl.maxHp,G.pl.hp+20);
    G.pl.atk+=2;G.pl.def+=1;G.pl.stamina=G.pl.maxStamina;
    addFT('LEVEL UP!',G.pl.x,G.pl.y-60,'#ffd700');showMsg('ğŸ‰ LV'+G.pl.level+'!');
  }
  updateHUD();
}

// â”€â”€ STAGE COMPLETE / DEATH / VICTORY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function stageComplete(){
  if(!G||G.currentStageCleared)return;
  G.currentStageCleared=true;
  if(!G.stagesCleared.includes(G.stageIdx))G.stagesCleared.push(G.stageIdx);
  if(G.pl.xpMultStages>0){G.pl.xpMultStages--;if(!G.pl.xpMultStages)G.pl.xpMult=1;}
  const bonus=rng(...G.stage.loot.coins)*2;
  G.pl.coins+=bonus;G.totalCoins+=bonus;
  addFT('+'+bonus+'ğŸª™ CLEAR!',350,190,'#ffd700');
  saveScore({name:G.pl.name,coins:G.pl.coins,level:G.pl.level,stage:G.stageIdx+1,kills:G.totalKills});
  const nxt=G.stageIdx+1,hasN=nxt<STAGES.length;
  document.getElementById('scr').textContent=`+${bonus} Gold  â€¢  ${G.killCount} Kills${hasN?'  â†’ S'+(nxt+1)+': '+STAGES[nxt].name:'  â˜… ALL CLEAR â˜…'}`;
  document.getElementById('sc').style.display='flex';
  const nb=document.getElementById('nextbtn');nb.style.display='inline-block';
  nb.textContent=hasN?`â–¶ S${nxt+1}`:'â–¶ MAP';
  updateHUD();
  setTimeout(()=>{document.getElementById('sc').style.display='none';if(G.stageIdx===19)setTimeout(victory,500);},3000);
}
function playerDeath(){
  if(!G)return;G.scene='dead';
  saveScore({name:G.pl.name,coins:G.pl.coins,level:G.pl.level,stage:G.stageIdx+1,kills:G.totalKills});
  document.getElementById('ovlt').innerHTML='<span style="color:#e02020">ğŸ’€ YOU FELL</span>';
  document.getElementById('fst').textContent=`Stage ${G.stageIdx+1}/20  â€¢  LV${G.pl.level}  â€¢  ğŸª™${G.pl.coins}\nKills: ${G.totalKills}  â€¢  Cleared: ${G.stagesCleared.length}`;
  document.getElementById('ovls').textContent='Score saved. Continue or start fresh.';
  document.getElementById('ovl').style.display='flex';
}
function victory(){
  if(!G)return;G.scene='win';
  saveScore({name:G.pl.name,coins:G.pl.coins,level:G.pl.level,stage:20,kills:G.totalKills});
  document.getElementById('ovlt').innerHTML='<span style="color:#ffd700">ğŸ† VICTORY!</span>';
  document.getElementById('fst').textContent=`All 20 Stages Cleared!\nLV${G.pl.level}  â€¢  ğŸª™${G.pl.coins}  â€¢  ${G.totalKills} Kills`;
  document.getElementById('ovls').textContent='The Ember Realm is saved!';
  document.getElementById('ovl').style.display='flex';
}

// â”€â”€ SHOP UI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toggleShop(){
  const s=document.getElementById('shscr');
  if(s.style.display==='flex'){s.style.display='none';if(G&&G.scene==='shop')G.scene='battle';}
  else{s.style.display='flex';if(G)G.scene='shop';renderShop();}
}
function renderShop(){
  if(!G)return;
  document.getElementById('sgo').textContent=G.pl.coins;
  const g=document.getElementById('shgrid');g.innerHTML='';
  for(const it of SHOP){
    const own=!it.stack&&G.pl.purchased.has(it.id);
    const d=document.createElement('div');d.className='si'+(own?' own':'');
    d.innerHTML=`<div class="si-n">${it.icon} ${it.name}</div><div class="si-d">${it.desc}</div><div class="si-p">ğŸª™${it.price}${own?' âœ…':''}</div>`;
    if(!own)d.onclick=()=>buyItem(it);
    g.appendChild(d);
  }
}
function buyItem(it){
  if(!G)return;
  if(G.pl.coins<it.price){showMsg('Not enough gold!');return;}
  G.pl.coins-=it.price;it.fn();
  if(!it.stack)G.pl.purchased.add(it.id);
  showMsg('âœ… '+it.name);updateHUD();renderShop();
}

// â”€â”€ RANK UI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toggleRank(){
  const s=document.getElementById('rkscr');
  if(s.style.display==='flex')s.style.display='none';
  else{s.style.display='flex';renderRank();}
}
async function renderRank(){
  const rows=await loadRank();
  const list=document.getElementById('rklist');list.innerHTML='';
  if(!rows.length){list.innerHTML='<div style="font-size:6px;color:#406080;padding:16px;text-align:center">No scores yet!</div>';return;}
  rows.forEach((r,i)=>{
    const me=G&&r.name===G.pl.name;
    const d=document.createElement('div');d.className='rr'+(me?' me':'');
    const m=i===0?'ğŸ¥‡':i===1?'ğŸ¥ˆ':i===2?'ğŸ¥‰':'';
    const c=i===0?'gd':i===1?'sv':i===2?'br':'';
    d.innerHTML=`<div class="rrk ${c}">${m||'#'+(i+1)}</div><div class="rnm">${me?'â–¶ ':''}${r.name}</div><div class="rco">ğŸª™${r.coins}</div><div class="rst">S${r.stage}</div><div class="rlv">LV${r.level}</div>`;
    list.appendChild(d);
  });
}

// â”€â”€ GAME LOOP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function loop(ts){
  const dt=Math.min((ts-lastT)/1000,.05);lastT=ts;
  if(G&&G.scene==='battle')update(dt);
  render();drawMinimap();
  RAF=requestAnimationFrame(loop);
}

function update(dt){
  G.bgA+=dt;if(G.shakeT>0)G.shakeT-=dt;
  const p=G.pl;p.anim+=dt*4;p.invT=Math.max(0,p.invT-dt);
  p.stamina=Math.min(p.maxStamina,p.stamina+dt*20);
  if(p.regen&&p.hp<p.maxHp)p.hp=Math.min(p.maxHp,p.hp+dt*2);
  let dx=0,dy=0;
  if(G.keys['ArrowLeft']||G.keys['a']||G.keys['A']||G.keys['dpad_left'])dx=-1;
  if(G.keys['ArrowRight']||G.keys['d']||G.keys['D']||G.keys['dpad_right'])dx=1;
  if(G.keys['ArrowUp']||G.keys['w']||G.keys['W']||G.keys['dpad_up'])dy=-1;
  if(G.keys['ArrowDown']||G.keys['s']||G.keys['S']||G.keys['dpad_down'])dy=1;
  if(dx&&dy){dx*=.707;dy*=.707;}
  if(dx)p.facing=dx;p.moving=!!dx||!!dy;
  p.x=clamp(p.x+dx*p.spd*dt,16,684);p.y=clamp(p.y+dy*p.spd*dt,130,340);
  for(const e of G.enemies){
    if(!e.alive){e.deathA=Math.max(0,e.deathA-dt*2);continue;}
    e.anim+=dt*(e.isBoss?1.8:3);e.hurtT=Math.max(0,e.hurtT-dt);e.atkTimer-=dt;
    const ex=p.x-e.x,ey=p.y-e.y,ed=Math.sqrt(ex*ex+ey*ey);
    e.facing=ex<0?-1:1;
    if(ed<300){e.x+=ex/ed*50*dt;e.y+=ey/ed*50*dt;}
    else{e.wanderT-=dt;if(e.wanderT<=0){e.wanderX=e.x+(Math.random()-.5)*120;e.wanderY=clamp(e.y+(Math.random()-.5)*80,150,330);e.wanderT=2+Math.random()*2;}const wx=e.wanderX-e.x,wy=e.wanderY-e.y,wd=Math.sqrt(wx*wx+wy*wy);if(wd>4){e.x+=wx/wd*26*dt;e.y+=wy/wd*26*dt;}}
    e.x=clamp(e.x,20,680);e.y=clamp(e.y,150,340);
    if(ed<38&&e.atkTimer<=0){e.atkTimer=e.isBoss?1.1:1.7;enAtk(e);}
  }
  for(const pt of G.particles){pt.x+=pt.vx;pt.y+=pt.vy;pt.vy+=.14;pt.life-=dt/pt.ml;}
  G.particles=G.particles.filter(p=>p.life>0);
  for(const t of G.texts){t.y+=t.vy;t.life-=dt*1.3;}
  G.texts=G.texts.filter(t=>t.life>0);
}

// â”€â”€ RENDER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function render(){
  const si=G&&G.stageIdx!==null?G.stageIdx:0;
  const st=STAGES[Math.min(si,19)];
  ctx.save();
  if(G&&G.shakeT>0)ctx.translate(Math.sin(G.bgA*60)*G.shakeT*10,0);
  const gr2=ctx.createLinearGradient(0,0,0,280);
  gr2.addColorStop(0,st.sky[0]);gr2.addColorStop(1,st.sky[1]);
  ctx.fillStyle=gr2;ctx.fillRect(0,0,CW,CH);
  if(G&&G.scene==='battle'){
    drawBG(st);drawGround(st);
    const obs=[...G.enemies,{...G.pl,_isp:true}].sort((a,b)=>a.y-b.y);
    for(const o of obs){if(o._isp)drawPlayer(G.pl);else if(o.alive||o.deathA>0)drawEnemy(o);}
    for(const p of G.particles){ctx.globalAlpha=Math.max(0,p.life);ctx.fillStyle=p.color;ctx.fillRect(~~(p.x-p.size/2),~~(p.y-p.size/2),p.size,p.size);}
    ctx.globalAlpha=1;
    ctx.textAlign='center';
    for(const t of G.texts){ctx.globalAlpha=Math.max(0,t.life);ctx.font='bold 8px "Press Start 2P"';ctx.fillStyle=t.c;ctx.shadowColor='#000';ctx.shadowBlur=4;ctx.fillText(t.t,~~t.x,~~t.y);}
    ctx.shadowBlur=0;ctx.globalAlpha=1;
    for(const e of G.enemies){
      if(!e.alive||e.hp>=e.maxHp)continue;
      const bw=e.isBoss?110:72,bx=e.x-bw/2,by=e.y-e.sz/2-20;
      ctx.fillStyle='#180606';ctx.fillRect(bx,by,bw,7);
      ctx.fillStyle=e.isBoss?'#ff1030':'#d02818';ctx.fillRect(bx,by,bw*(e.hp/e.maxHp),7);
      ctx.strokeStyle='#4a1010';ctx.lineWidth=1;ctx.strokeRect(bx,by,bw,7);
      ctx.font='5px "Press Start 2P"';ctx.fillStyle='#f0c060';ctx.textAlign='center';ctx.fillText(e.name,e.x,by-3);
    }
    ctx.font='6px "Press Start 2P"';ctx.textAlign='left';
    ctx.fillStyle='rgba(200,150,60,.5)';ctx.fillText(`W${G.wave}/${G.maxWave} | ${G.enemies.filter(e=>e.alive).length} left`,8,310);
    ctx.fillStyle='rgba(80,160,220,.4)';ctx.fillText(`Kills:${G.totalKills}`,8,320);
  } else {
    ctx.globalAlpha=.18;drawBG(st);drawGround(st);ctx.globalAlpha=1;
  }
  ctx.restore();
}

// â”€â”€ BACKGROUNDS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function drawBG(st){
  const t=G?G.bgA:0,f=st.bg;
  if(f==='lava'||f==='lava2'){
    dMtn(ctx,260,80,130,'#3a1a00');dMtn(ctx,460,100,90,'#2a1000');
    glow(ctx,280,55,50,'rgba(255,160,0,.7)');dLava(ctx,280,80,t);
    if(f==='lava2'){dLava(ctx,420,90,t+1.2);dLava(ctx,160,100,t+2.4);}
    dChain(ctx,60,20,110,190);dChain(ctx,580,10,560,170);
    dSkull(ctx,80,190,'#6a4020');dSkull(ctx,130+Math.sin(t*.8)*18,105+Math.sin(t*.5)*14,'#805020');
  }
  if(f==='ruins'){dMtn(ctx,300,90,110,'#2a1a10');ctx.fillStyle='#3a2010';for(let i=0;i<5;i++)ctx.fillRect(40+i*130,180-i*10,20,100);dLava(ctx,350,100,t+.5);}
  if(f==='forge'){ctx.fillStyle='#200c04';ctx.fillRect(0,80,CW,200);for(let i=0;i<3;i++){ctx.fillStyle='#3a1808';ctx.fillRect(60+i*220,100,80,140);glow(ctx,100+i*220,170,35,`rgba(255,${100+Math.sin(t*3+i)*50},0,${.4+Math.sin(t*2+i)*.3})`);ctx.fillStyle='rgba(255,120,0,.6)';ctx.fillRect(80+i*220,140,40,60);}dLava(ctx,200,110,t);}
  if(f==='forest'||f==='forest2'||f==='darkforest'){
    for(let i=0;i<7;i++)dTree(ctx,30+i*100,250-(70+Math.sin(i*1.4)*30),70+Math.sin(i*1.4)*30);
    for(let i=0;i<4;i++){const sx=80+i*(CW/4)+Math.sin(t*.7+i)*28,sy=140+Math.sin(t*.4+i*2)*22;ctx.fillStyle=`rgba(${f==='darkforest'?'80,0,120':'100,255,100'},${.12+Math.sin(t+i)*.08})`;ctx.fillRect(~~sx-7,~~sy-9,14,18);ctx.fillRect(~~sx-9,~~sy-5,18,12);}
    if(f==='darkforest'){ctx.strokeStyle='rgba(30,0,60,.5)';ctx.lineWidth=2;for(let i=0;i<6;i++){ctx.beginPath();ctx.moveTo(i*120,270);ctx.bezierCurveTo(i*120+30,230,i*120+60,250,i*120+80,270);ctx.stroke();}}
  }
  if(f==='mushroom'){
    for(let i=0;i<5;i++)dTree(ctx,40+i*150,250-(60+i*8),60+i*8);
    const mc=['#aa2060','#2060aa','#aa6020','#20aa60','#6020aa'];
    for(let i=0;i<5;i++)dBigMsh(ctx,60+i*140,280,mc[i]);
    for(let i=0;i<12;i++){const sx=(i*57+t*8*(i%3+.5))%700,sy=(i*41+t*6)%200+60;ctx.fillStyle=`rgba(100,255,100,${.3+Math.sin(t*2+i)*.2})`;ctx.fillRect(~~sx,~~sy,2,2);}
  }
  if(f==='ice'||f==='blizzard'||f==='glacier'||f==='throne'){
    dCastle(ctx,180,40,260,190);
    for(let i=0;i<9;i++)dCrystal(ctx,20+i*80,265-(28+Math.sin(i*2.2)*18),28+Math.sin(i*2.2)*18,'#3080c0');
    ctx.fillStyle='#a8c8e0';
    for(let i=0;i<(f==='blizzard'?35:20);i++){const sx=(i*61+t*18*((i%3)+.6))%700,sy=(i*43+t*12)%270;ctx.fillRect(~~sx,~~sy,2,2);}
    if(f==='throne')glow(ctx,350,160,80,'rgba(40,100,200,.2)');
  }
  if(f==='swamp'||f==='swamp2'||f==='swamp3'||f==='swamp4'){
    for(let i=0;i<6;i++)dTree(ctx,30+i*120,250-(55+i*7),55+i*7);
    ctx.fillStyle='rgba(20,60,10,.4)';ctx.fillRect(0,220,CW,55);
    for(let i=0;i<10;i++){const bx=(i*72+t*14*(i%3+.4))%700,by=220+(Math.sin(t*2+i)*10);ctx.strokeStyle='rgba(80,200,20,.4)';ctx.lineWidth=1;ctx.beginPath();ctx.arc(~~bx,~~by,2+i%4,0,Math.PI*2);ctx.stroke();}
    if(f==='swamp4')glow(ctx,350,160,100,'rgba(0,80,0,.15)');
  }
  if(f==='sky'||f==='sky2'||f==='sky3'){
    for(let i=0;i<4;i++)dCloud(ctx,(i*180+t*12)%760-30,50+i*38,'#120830');
    if(Math.sin(t*(f==='sky3'?2.5:3.8))>.8){ctx.strokeStyle='rgba(180,120,255,.8)';ctx.lineWidth=2;ctx.beginPath();ctx.moveTo(300,0);ctx.lineTo(278,82);ctx.lineTo(312,104);ctx.lineTo(288,200);ctx.stroke();}
    dTower(ctx,80,70,44,150);dTower(ctx,520,50,54,170);
  }
  if(f==='abyss'){
    for(let i=0;i<5;i++)dFirePillar(ctx,60+i*155,110,t+i,true);
    ctx.font='16px monospace';
    'áš áš¢áš¦áš¨áš±áš²á›—á›'.split('').forEach((r,i)=>{ctx.fillStyle=`rgba(255,20,0,${.25+Math.sin(t*2.5+i)*.2})`;ctx.fillText(r,40+i*82,38+Math.sin(t+i)*11);});
    glow(ctx,350,200,120,'rgba(150,0,0,.12)');
  }
}
function drawGround(st){
  const t=G?G.bgA:0;
  ctx.fillStyle=st.gr;ctx.fillRect(0,270,CW,150);
  ctx.strokeStyle=st.ac;ctx.lineWidth=2;
  [[40,270,120,308],[180,270,250,315],[340,270,290,308],[460,270,540,302],[140,302,175,312],[390,302,490,332]].forEach(([x1,y1,x2,y2])=>{
    ctx.beginPath();ctx.moveTo(x1,y1);ctx.lineTo(x2,y2);
    ctx.globalAlpha=.35+Math.sin(t*1.6+x1*.02)*.45;ctx.shadowColor=st.ac;ctx.shadowBlur=5;ctx.stroke();ctx.shadowBlur=0;
  });ctx.globalAlpha=1;
}

// â”€â”€ PLAYER SPRITE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function drawPlayer(p){
  const bob=(p.moving?Math.sin(p.anim*2):Math.sin(p.anim*.5))*2;
  ctx.save();ctx.translate(~~p.x,~~(p.y+bob));ctx.scale(p.facing,1);
  if(p.invT>0&&Math.floor(p.invT*20)%2===0){ctx.restore();return;}
  const ls=p.moving?Math.sin(p.anim*4)*5:0;
  ctx.fillStyle='rgba(0,0,0,.25)';ctx.fillRect(-13,23,26,5);
  ctx.fillStyle='#2a4a18';ctx.fillRect(-9,14+ls,7,11);ctx.fillRect(2,14-ls,7,11);
  ctx.fillStyle='#5a3010';ctx.fillRect(-10,22+ls,8,5);ctx.fillRect(2,22-ls,8,5);
  ctx.fillStyle='#1a5020';ctx.fillRect(-12,2,4,14);
  ctx.fillStyle='#2a7030';ctx.fillRect(-9,0,18,14);ctx.fillStyle='#8b5020';ctx.fillRect(-9,11,18,3);ctx.fillStyle='#c8832a';ctx.fillRect(-2,11,4,4);
  ctx.fillStyle='#5a7a90';ctx.fillRect(-7,-16,14,16);ctx.fillRect(-7,-16,14,6);
  ctx.fillStyle='#1a2a30';ctx.fillRect(-4,-10,8,3);ctx.fillStyle='#60d0f0';ctx.fillRect(-2,-10,4,2);
  ctx.fillStyle='#30c050';ctx.fillRect(-2,-22,4,8);ctx.fillRect(0,-24,2,4);
  const sa=p.moving?Math.sin(p.anim*4)*3:0;
  ctx.fillStyle='#5a7a90';ctx.fillRect(9,0,7,12);
  ctx.fillStyle='#c8c8d8';ctx.fillRect(13,-8+sa,3,20);ctx.fillStyle='#8b6020';ctx.fillRect(9,-2+sa,10,3);ctx.fillStyle='#e8e8f0';ctx.fillRect(13,-13+sa,3,6);
  ctx.fillStyle='#5a7a90';ctx.fillRect(-16,0,7,12);ctx.fillStyle='#2a6020';ctx.fillRect(-23,-4,12,18);ctx.fillStyle='#c8932a';ctx.fillRect(-19,2,5,5);
  ctx.restore();
  ctx.save();ctx.translate(~~p.x,~~(p.y+bob));
  ctx.font='5px "Press Start 2P"';ctx.textAlign='center';
  const nw=ctx.measureText(p.name).width+8;
  ctx.fillStyle='rgba(0,0,0,.75)';ctx.fillRect(-nw/2,-36,nw,10);
  ctx.fillStyle='#f0e060';ctx.shadowColor='#000';ctx.shadowBlur=3;ctx.fillText(p.name,0,-28);ctx.shadowBlur=0;
  ctx.font='4px "Press Start 2P"';ctx.fillStyle='#80c0ff';ctx.fillText('LV'+p.level,0,-40);
  ctx.restore();
}

// â”€â”€ ENEMY DRAW â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function drawEnemy(e){
  const bob=Math.sin(e.anim)*3;
  ctx.save();ctx.translate(~~e.x,~~(e.y+bob));
  if(!e.alive){ctx.globalAlpha=Math.max(0,e.deathA);ctx.translate(0,(1-e.deathA)*18);}
  if(e.hurtT>0)ctx.globalAlpha*=(.5+Math.sin(e.hurtT*35)*.45);
  ctx.scale(-(e.facing||1),1);const sc=e.isBoss?1.25:1;ctx.scale(sc,sc);
  ctx.globalAlpha*=.35;ctx.fillStyle='rgba(0,0,0,.3)';ctx.fillRect(-e.sz/2*.9,e.sz/2-2,e.sz*.9,5);
  ctx.globalAlpha=e.alive?(e.hurtT>0?.65:1):Math.max(0,e.deathA);
  drawSprite(e.sp,e.color,G?G.bgA:0,e.isBoss);
  if(e.isBoss){ctx.fillStyle=`rgba(${h2r(e.color)},${.06+Math.sin((G?G.bgA:0)*2.5)*.04})`;ctx.beginPath();ctx.arc(0,-8,48,0,Math.PI*2);ctx.fill();}
  ctx.restore();
}

// â”€â”€ SPRITES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function drawSprite(sp,c,t,boss){
  const dk=shade(c,.5);
  switch(sp){
    case'imp':ctx.fillStyle='#8b4010';ctx.fillRect(-3,-28,4,10);ctx.fillRect(6,-28,4,10);ctx.fillStyle=c;ctx.fillRect(-8,-18,20,16);ctx.fillStyle='#ff8020';ctx.fillRect(-4,-14,4,4);ctx.fillRect(4,-14,4,4);ctx.fillStyle='#8b2000';ctx.fillRect(-6,0,16,14);ctx.fillStyle=c;ctx.fillRect(-14,0,8,10);ctx.fillRect(10,0,8,10);ctx.fillStyle='#6b1800';ctx.fillRect(-4,14,6,10);ctx.fillRect(4,14,6,10);break;
    case'sprite':ctx.fillStyle=c;ctx.fillRect(-6,-16,12,20);ctx.fillStyle='#ff9010';ctx.fillRect(-4,-12,4,4);ctx.fillRect(4,-12,4,4);ctx.fillStyle=`rgba(255,180,0,${.5+Math.sin(t*8)*.3})`;ctx.fillRect(-16,-10,10,14);ctx.fillRect(6,-10,10,14);ctx.fillStyle=`rgba(255,100,0,${.6+Math.sin(t*5)*.3})`;ctx.fillRect(-4,-22,8,10);break;
    case'demon':ctx.fillStyle='#6b0000';ctx.fillRect(-6,-32,6,14);ctx.fillRect(8,-32,6,14);ctx.fillStyle=c;ctx.fillRect(-14,-18,32,20);ctx.fillStyle='#ff2000';ctx.fillRect(-8,-14,6,6);ctx.fillRect(4,-14,6,6);ctx.fillStyle='#4b0000';ctx.fillRect(-12,2,28,18);ctx.fillStyle=c;ctx.fillRect(-22,2,10,14);ctx.fillRect(12,2,10,14);ctx.fillStyle='#ff4000';ctx.fillRect(-24,14,8,6);ctx.fillRect(18,14,8,6);ctx.fillStyle='#4b0000';ctx.fillRect(-6,20,6,12);ctx.fillRect(6,20,6,12);glow(ctx,0,-5,28,`rgba(255,120,0,${.14+Math.sin(t*4)*.1})`);break;
    case'lavaking':ctx.fillStyle='#8a0000';ctx.fillRect(-10,-38,10,16);ctx.fillRect(8,-38,10,16);ctx.fillStyle='#ffd700';ctx.fillRect(-14,-42,4,8);ctx.fillRect(-6,-46,4,12);ctx.fillRect(2,-46,4,12);ctx.fillRect(10,-42,4,8);ctx.fillStyle=c;ctx.fillRect(-16,-22,36,24);ctx.fillStyle='#ff4000';ctx.fillRect(-10,-18,6,7);ctx.fillRect(4,-18,6,7);ctx.fillStyle='#5a0000';ctx.fillRect(-14,2,32,22);ctx.fillStyle=c;ctx.fillRect(-24,2,10,18);ctx.fillRect(16,2,10,18);ctx.fillStyle='#5a0000';ctx.fillRect(-8,24,8,14);ctx.fillRect(4,24,8,14);glow(ctx,0,0,40,`rgba(255,100,0,${.12+Math.sin(t*3)*.08})`);break;
    case'golem':case'golem2':ctx.fillStyle=sp==='golem2'?'#8a6050':'#c0d0e0';ctx.fillRect(-16,-26,36,24);ctx.fillStyle=sp==='golem2'?'#704030':'#3060a0';ctx.fillRect(-8,-18,6,6);ctx.fillRect(6,-18,6,6);ctx.fillStyle='#6090b0';ctx.fillRect(-14,0,32,20);ctx.fillStyle=sp==='golem2'?'#c09070':'#c0d0e0';ctx.fillRect(-22,0,8,16);ctx.fillRect(16,0,8,16);ctx.fillRect(-6,20,6,14);ctx.fillRect(6,20,6,14);break;
    case'wolf':ctx.fillStyle=c;ctx.fillRect(-8,-24,6,10);ctx.fillRect(6,-24,6,10);ctx.fillRect(-10,-16,24,18);ctx.fillStyle='#1a0030';ctx.fillRect(-6,-12,6,6);ctx.fillRect(6,-12,6,6);ctx.fillStyle='#3a1a5a';ctx.fillRect(-4,-4,12,8);ctx.fillStyle=c;ctx.fillRect(-12,2,28,16);ctx.fillRect(-6,18,6,12);ctx.fillRect(6,18,6,12);ctx.fillRect(14,0,12,6);ctx.fillRect(22,-6,8,8);break;
    case'bat':ctx.fillStyle=c;ctx.fillRect(-6,-6,12,14);ctx.fillRect(-4,-14,8,10);ctx.fillStyle='#ff0020';ctx.fillRect(-2,-12,2,2);ctx.fillRect(2,-12,2,2);const wf=Math.sin(t*10)*10;ctx.fillStyle=c;ctx.fillRect(-24,-8+wf,18,20-wf);ctx.fillRect(6,-8+wf,18,20-wf);break;
    case'spider':ctx.fillStyle=c;ctx.fillRect(-8,-8,16,14);ctx.fillRect(-4,-16,8,10);ctx.fillStyle='#ff0020';ctx.fillRect(-2,-14,2,2);ctx.fillRect(2,-14,2,2);ctx.strokeStyle=c;ctx.lineWidth=2;[-1.1,-.5,.5,1.1].forEach(a=>{ctx.beginPath();ctx.moveTo(-8,0);ctx.lineTo(-24,a*16);ctx.stroke();ctx.beginPath();ctx.moveTo(8,0);ctx.lineTo(24,a*16);ctx.stroke();});break;
    case'necro':ctx.fillStyle='#200030';ctx.fillRect(-14,-2,32,28);ctx.fillStyle=c;ctx.fillRect(-10,-18,24,18);ctx.fillStyle='#1a0028';ctx.fillRect(-12,-22,28,12);ctx.fillRect(-8,-28,20,10);ctx.fillStyle='#c0a060';ctx.fillRect(-6,-16,16,12);ctx.fillStyle='#8040c0';ctx.fillRect(-4,-12,4,4);ctx.fillRect(4,-12,4,4);ctx.fillStyle='#6040a0';ctx.fillRect(16,-30,4,50);ctx.fillStyle='#a060f0';ctx.fillRect(12,-36,12,10);glow(ctx,18,-28,14,`rgba(160,80,255,${.2+Math.sin(t*3)*.14})`);break;
    case'wraith':ctx.globalAlpha*=(.65+Math.sin(t*3)*.2);ctx.fillStyle=c;ctx.fillRect(-10,-30,24,40);ctx.fillRect(-14,-20,8,30);ctx.fillRect(14,-20,8,30);ctx.fillRect(-8,10,6,16);ctx.fillRect(4,10,6,16);ctx.fillStyle='#fff';ctx.fillRect(-6,-24,6,6);ctx.fillRect(4,-24,6,6);ctx.fillStyle='#40c0ff';ctx.fillRect(-5,-23,4,4);ctx.fillRect(5,-23,4,4);break;
    case'forestwitch':ctx.fillStyle='#1a0030';ctx.fillRect(-14,-38,30,14);ctx.fillStyle='#2a0050';ctx.fillRect(-10,-30,22,10);ctx.fillStyle=c;ctx.fillRect(-10,-22,24,20);ctx.fillStyle='#d0a0e0';ctx.fillRect(-6,-18,16,14);ctx.fillStyle='#aa50e0';ctx.fillRect(-4,-14,4,4);ctx.fillRect(4,-14,4,4);ctx.fillStyle='#1a0030';ctx.fillRect(-14,0,32,28);ctx.fillStyle='#8030c0';ctx.fillRect(18,-30,4,50);ctx.fillRect(14,-36,12,10);glow(ctx,20,-28,14,`rgba(160,50,255,${.2+Math.sin(t*3)*.15})`);break;
    case'sporemind':ctx.fillStyle=c;ctx.fillRect(-16,-28,34,22);ctx.fillStyle=dk;ctx.fillRect(-12,-24,26,14);ctx.fillStyle='#fff';ctx.fillRect(-8,-20,4,4);ctx.fillRect(4,-20,4,4);ctx.fillStyle=shade(c,1.3);ctx.fillRect(-8,0,18,28);ctx.fillStyle='#d0ffd0';ctx.fillRect(-4,-4,4,5);ctx.fillRect(4,-4,4,5);ctx.strokeStyle=c;ctx.lineWidth=3;[-1.4,-.8,.8,1.4].forEach(a=>{ctx.beginPath();ctx.moveTo(-8,18);ctx.bezierCurveTo(-8+a*10,26,-8+a*20,18,-8+a*28,30);ctx.stroke();ctx.beginPath();ctx.moveTo(10,18);ctx.bezierCurveTo(10+a*10,26,10+a*20,18,10+a*28,30);ctx.stroke();});glow(ctx,0,0,44,`rgba(50,200,80,${.08+Math.sin(t*2)*.06})`);break;
    case'lichknight':ctx.fillStyle='#2a0050';ctx.fillRect(-16,-34,36,28);ctx.fillStyle='#9000ff';ctx.fillRect(-10,-28,6,8);ctx.fillRect(4,-28,6,8);ctx.fillStyle='#180038';ctx.fillRect(-16,0,36,28);ctx.fillStyle='#5000c0';ctx.fillRect(-28,0,12,20);ctx.fillRect(18,0,12,20);ctx.fillStyle='#a040ff';ctx.fillRect(18,-20,6,34);ctx.fillRect(14,-6,14,4);ctx.fillStyle='#8a0000';ctx.fillRect(-8,-46,10,14);ctx.fillRect(6,-46,10,14);ctx.fillStyle='#c0b0d0';ctx.fillRect(-8,-26,18,16);ctx.fillRect(-8,28,7,14);ctx.fillRect(6,28,7,14);glow(ctx,0,0,52,`rgba(80,0,200,${.1+Math.sin(t*2)*.08})`);break;
    case'shadowdruid':ctx.fillStyle='#040a14';ctx.fillRect(-18,-42,38,32);ctx.strokeStyle='#1a2a40';ctx.lineWidth=3;ctx.beginPath();ctx.moveTo(-10,-42);ctx.lineTo(-20,-60);ctx.lineTo(-8,-50);ctx.stroke();ctx.beginPath();ctx.moveTo(10,-42);ctx.lineTo(20,-60);ctx.lineTo(8,-50);ctx.stroke();ctx.fillStyle=c;ctx.fillRect(-14,-12,30,22);ctx.fillStyle='#0080ff';ctx.fillRect(-8,-8,6,6);ctx.fillRect(6,-8,6,6);ctx.fillStyle='#040820';ctx.fillRect(-16,10,34,30);ctx.fillStyle='#0040a0';ctx.fillRect(-28,10,12,22);ctx.fillRect(18,10,12,22);ctx.fillStyle='#040820';ctx.fillRect(-8,40,8,14);ctx.fillRect(4,40,8,14);glow(ctx,0,0,56,`rgba(0,30,80,${.12+Math.sin(t*1.8)*.09})`);break;
    case'iceArcher':ctx.fillStyle=c;ctx.fillRect(-8,-20,18,18);ctx.fillStyle='#80c0ff';ctx.fillRect(-4,-16,4,4);ctx.fillRect(6,-16,4,4);ctx.fillStyle='#2060a0';ctx.fillRect(-10,0,22,18);ctx.strokeStyle='#a0e0ff';ctx.lineWidth=2;ctx.beginPath();ctx.arc(20,-10,16,-.8,.8);ctx.stroke();ctx.fillStyle='#e0f0ff';ctx.fillRect(34,-12,2,14);ctx.fillRect(-6,18,6,12);ctx.fillRect(6,18,6,12);break;
    case'icelicher':ctx.fillStyle=c;ctx.fillRect(-10,-28,24,42);ctx.fillStyle='#fff';ctx.fillRect(-6,-24,5,5);ctx.fillRect(4,-24,5,5);ctx.fillStyle='#1040a0';ctx.fillRect(-12,-36,26,12);ctx.fillStyle='#4080c0';ctx.fillRect(14,-32,4,52);ctx.fillRect(10,-38,12,8);glow(ctx,14,-30,12,`rgba(60,150,255,${.2+Math.sin(t*4)*.14})`);break;
    case'icedrake':ctx.fillStyle=c;ctx.fillRect(-24,-12,16,28);ctx.fillRect(14,-12,16,28);ctx.fillStyle='#3070b0';ctx.fillRect(-20,-8,12,22);ctx.fillRect(14,-8,12,22);ctx.fillStyle=c;ctx.fillRect(-14,-4,32,22);ctx.fillRect(-12,-20,26,18);ctx.fillStyle='#80d0ff';ctx.fillRect(-6,-16,5,5);ctx.fillRect(4,-16,5,5);ctx.fillRect(16,8,14,8);ctx.fillRect(28,2,10,8);break;
    case'frostgiant':ctx.fillStyle='#1a4080';ctx.fillRect(-6,-54,10,18);ctx.fillRect(4,-50,8,14);ctx.fillStyle=c;ctx.fillRect(-20,-36,44,28);ctx.fillStyle='#60a0ff';ctx.fillRect(-12,-30,8,8);ctx.fillRect(4,-30,8,8);ctx.fillStyle='#0a2060';ctx.fillRect(-22,0,48,32);ctx.fillStyle=c;ctx.fillRect(-36,0,14,26);ctx.fillRect(24,0,14,26);ctx.fillStyle='#c0e0ff';ctx.fillRect(-40,20,10,10);ctx.fillRect(32,20,10,10);ctx.fillStyle='#a0d0ff';ctx.fillRect(26,-20,10,52);ctx.fillRect(22,-24,18,10);ctx.fillStyle='#0a2060';ctx.fillRect(-10,32,10,18);ctx.fillRect(4,32,10,18);glow(ctx,0,0,60,`rgba(20,80,200,${.1+Math.sin(t*2)*.07})`);break;
    case'crystalqueen':ctx.fillStyle='#4090d0';ctx.fillRect(-8,-56,6,16);ctx.fillRect(2,-56,6,16);ctx.fillStyle=c;ctx.fillRect(-16,-40,36,26);ctx.fillStyle='#a0e0ff';ctx.fillRect(-10,-34,8,8);ctx.fillRect(4,-34,8,8);ctx.fillStyle='#2070b0';ctx.fillRect(-18,-14,40,32);ctx.fillStyle=`rgba(120,200,255,${.4+Math.sin(t*4)*.2})`;ctx.fillRect(-38,-14,20,36);ctx.fillRect(20,-14,20,36);ctx.fillStyle='#1050a0';ctx.fillRect(-8,18,8,16);ctx.fillRect(4,18,8,16);glow(ctx,0,0,56,`rgba(60,160,255,${.12+Math.sin(t*2.5)*.09})`);break;
    case'winterking':ctx.fillStyle='#0820a0';ctx.fillRect(-12,-58,8,20);ctx.fillRect(-4,-64,8,24);ctx.fillRect(4,-58,8,20);ctx.fillStyle='#ffd700';ctx.fillRect(-16,-46,36,26);ctx.fillStyle='#c0d8ff';ctx.fillRect(-16,-46,36,26);ctx.fillStyle='#60a8ff';ctx.fillRect(-10,-40,8,8);ctx.fillRect(4,-40,8,8);ctx.fillStyle='#0810a0';ctx.fillRect(-20,-20,44,36);ctx.fillStyle='#1428c0';ctx.fillRect(-36,-20,16,28);ctx.fillRect(22,-20,16,28);ctx.fillStyle='#80c8ff';ctx.fillRect(24,-36,6,56);ctx.fillRect(18,-42,18,10);ctx.fillStyle='#0818a0';ctx.fillRect(-10,16,10,20);ctx.fillRect(4,16,10,20);glow(ctx,0,0,64,`rgba(10,40,200,${.12+Math.sin(t*1.8)*.09})`);break;
    case'troll':ctx.fillStyle=c;ctx.fillRect(-16,-22,34,48);ctx.fillRect(-14,-34,30,16);ctx.fillStyle='#ffdd00';ctx.fillRect(-8,-28,6,6);ctx.fillRect(6,-28,6,6);ctx.fillStyle='#1a2804';ctx.fillRect(-10,-22,8,6);ctx.fillRect(6,-22,8,6);ctx.fillStyle=c;ctx.fillRect(-22,0,10,18);ctx.fillRect(18,0,10,18);ctx.fillRect(-8,26,8,16);ctx.fillRect(8,26,8,16);break;
    case'bogwisp':ctx.globalAlpha*=(.5+Math.sin(t*4)*.3);ctx.fillStyle=c;ctx.fillRect(-8,-12,16,24);ctx.fillRect(-4,-20,8,10);ctx.fillStyle='#80ff20';ctx.fillRect(-4,-16,3,3);ctx.fillRect(4,-16,3,3);break;
    case'boghag':ctx.fillStyle=c;ctx.fillRect(-14,-36,30,28);ctx.fillStyle='#202008';ctx.fillRect(-8,-30,5,5);ctx.fillRect(4,-30,5,5);ctx.fillStyle='#0a1804';ctx.fillRect(-16,0,34,30);ctx.fillStyle=c;ctx.fillRect(-26,0,10,22);ctx.fillRect(18,0,10,22);ctx.fillStyle='#304010';ctx.fillRect(-20,10,16,16);ctx.fillRect(-22,22,20,4);ctx.fillStyle=`rgba(100,255,20,${.4+Math.sin(t*4)*.3})`;ctx.fillRect(-18,12,12,12);ctx.fillStyle='#0a1804';ctx.fillRect(-8,30,8,14);ctx.fillRect(4,30,8,14);glow(ctx,0,0,46,`rgba(40,120,0,${.1+Math.sin(t*2)*.07})`);break;
    case'venomqueen':ctx.fillStyle=c;ctx.fillRect(-22,-24,48,34);ctx.fillRect(-14,-38,30,18);ctx.fillStyle='#c0ff40';ctx.fillRect(-8,-34,5,7);ctx.fillRect(5,-34,5,7);ctx.strokeStyle=c;ctx.lineWidth=4;[-1.4,-.7,0,.7,1.4].forEach(a=>{ctx.beginPath();ctx.moveTo(-22,8);ctx.lineTo(-56,a*32);ctx.stroke();ctx.beginPath();ctx.moveTo(24,8);ctx.lineTo(58,a*32);ctx.stroke();});ctx.fillRect(-8,10,7,22);ctx.fillRect(4,10,7,22);glow(ctx,0,0,52,`rgba(80,230,10,${.1+Math.sin(t*2.5)*.08})`);break;
    case'plagueguard':ctx.fillStyle='#183008';ctx.fillRect(-16,-36,36,28);ctx.fillStyle='#60d020';ctx.fillRect(-10,-30,6,7);ctx.fillRect(4,-30,6,7);ctx.fillStyle='#0e2004';ctx.fillRect(-18,0,40,32);ctx.fillStyle='#183008';ctx.fillRect(-30,0,12,24);ctx.fillRect(20,0,12,24);ctx.fillStyle='#80ff30';ctx.fillRect(-32,12,10,10);ctx.fillRect(24,12,10,10);ctx.fillStyle='#0e2004';ctx.fillRect(-8,32,8,16);ctx.fillRect(4,32,8,16);glow(ctx,0,0,52,`rgba(30,150,0,${.1+Math.sin(t*2.5)*.08})`);break;
    case'rotlord':ctx.fillStyle='#081002';ctx.fillRect(-6,-60,10,22);ctx.fillRect(4,-56,8,18);ctx.fillStyle='#162804';ctx.fillRect(-20,-40,44,30);ctx.fillStyle='#a0ff40';ctx.fillRect(-12,-34,8,8);ctx.fillRect(6,-34,8,8);ctx.fillStyle='#061002';ctx.fillRect(-22,0,48,36);ctx.fillStyle='#162804';ctx.fillRect(-38,0,16,28);ctx.fillRect(24,0,16,28);ctx.fillStyle='#90e020';ctx.fillRect(-42,14,12,12);ctx.fillRect(32,14,12,12);ctx.fillStyle='#061002';ctx.fillRect(-10,36,10,18);ctx.fillRect(4,36,10,18);ctx.strokeStyle=`rgba(80,200,10,${.3+Math.sin(t*4)*.2})`;ctx.lineWidth=2;for(let i=0;i<6;i++){ctx.beginPath();ctx.moveTo((i-3)*8,36);ctx.bezierCurveTo((i-3)*14,50,(i-2)*12,46,(i-2)*18,60);ctx.stroke();}glow(ctx,0,0,64,`rgba(10,100,0,${.14+Math.sin(t*2)*.1})`);break;
    case'stormkin':ctx.fillStyle=c;ctx.fillRect(-8,-20,18,18);ctx.fillStyle='#e0e0ff';ctx.fillRect(-4,-16,4,4);ctx.fillRect(6,-16,4,4);ctx.fillStyle='#2020a0';ctx.fillRect(-10,0,22,18);ctx.fillStyle=`rgba(180,180,255,${.5+Math.sin(t*6)*.3})`;ctx.fillRect(-16,-4,8,10);ctx.fillRect(12,-4,8,10);ctx.fillRect(-6,18,6,12);ctx.fillRect(6,18,6,12);break;
    case'thunderelf':ctx.fillStyle='#3030c0';ctx.fillRect(-6,-24,14,20);ctx.fillStyle='#8080ff';ctx.fillRect(-4,-20,4,4);ctx.fillRect(4,-20,4,4);ctx.fillStyle='#2020a0';ctx.fillRect(-8,0,18,18);ctx.strokeStyle='#c0c0ff';ctx.lineWidth=2;ctx.beginPath();ctx.arc(18,4,14,-.8,.8);ctx.stroke();ctx.fillStyle='#fff';ctx.fillRect(28,-8,2,16);ctx.fillRect(-6,18,6,12);ctx.fillRect(6,18,6,12);break;
    case'drake':ctx.fillStyle=c;ctx.fillRect(-36,-14,18,30);ctx.fillRect(24,-14,18,30);ctx.fillStyle='#3a1060';ctx.fillRect(-30,-10,12,22);ctx.fillRect(24,-10,12,22);ctx.fillStyle=c;ctx.fillRect(-16,-4,36,24);ctx.fillRect(-14,-22,30,20);ctx.fillStyle='#4a20a0';ctx.fillRect(-10,-32,6,12);ctx.fillRect(8,-32,6,12);ctx.fillStyle='#e0c000';ctx.fillRect(-8,-18,6,6);ctx.fillRect(6,-18,6,6);ctx.fillStyle=c;ctx.fillRect(18,8,16,8);ctx.fillRect(30,2,10,8);ctx.fillRect(-8,20,8,14);ctx.fillRect(6,20,8,14);break;
    case'cloudgiant':ctx.fillStyle='#3020a0';ctx.fillRect(-8,-58,10,22);ctx.fillRect(4,-54,8,18);ctx.fillStyle=c;ctx.fillRect(-22,-38,48,28);ctx.fillStyle='#d0b0ff';ctx.fillRect(-14,-32,8,8);ctx.fillRect(6,-32,8,8);ctx.fillStyle='#2010a0';ctx.fillRect(-26,0,56,36);ctx.fillStyle=c;ctx.fillRect(-44,0,18,28);ctx.fillRect(28,0,18,28);ctx.fillStyle='#d0a0ff';ctx.fillRect(-48,14,12,12);ctx.fillRect(38,14,12,12);ctx.fillStyle='#c0a0ff';ctx.fillRect(28,-24,12,60);ctx.fillRect(22,-28,24,12);ctx.fillStyle='#2010a0';ctx.fillRect(-12,36,12,18);ctx.fillRect(4,36,12,18);glow(ctx,0,0,70,`rgba(80,20,200,${.12+Math.sin(t*2)*.09})`);break;
    case'skyemperor':ctx.fillStyle='#1808a0';ctx.fillRect(-80,-24,40,60);ctx.fillRect(42,-24,40,60);ctx.fillStyle='#2010c0';ctx.fillRect(-72,-18,30,46);ctx.fillRect(44,-18,30,46);ctx.fillStyle='#0c0880';ctx.fillRect(-22,0,48,40);ctx.fillStyle='#3020c0';ctx.fillRect(-36,0,14,22);ctx.fillRect(24,0,14,22);ctx.fillStyle='#1810a0';ctx.fillRect(-20,-16,44,20);ctx.fillStyle='#a090e0';ctx.fillRect(-12,-34,28,20);ctx.fillStyle='#ffd700';ctx.fillRect(-14,-44,4,12);ctx.fillRect(-6,-50,5,18);ctx.fillRect(1,-50,5,18);ctx.fillRect(8,-44,4,12);ctx.fillRect(-14,-40,30,4);ctx.fillStyle='#ff40ff';ctx.fillRect(-8,-30,6,6);ctx.fillRect(4,-30,6,6);ctx.fillStyle='#c0a0ff';ctx.fillRect(26,-44,6,64);ctx.fillRect(20,-50,18,12);ctx.fillStyle='#0c0880';ctx.fillRect(-10,40,10,20);ctx.fillRect(2,40,10,20);glow(ctx,0,0,82,`rgba(30,10,180,${.14+Math.sin(t*1.6)*.1})`);break;
    case'shade':ctx.globalAlpha*=(.5+Math.sin(t*4)*.3);ctx.fillStyle=c;ctx.fillRect(-12,-32,28,48);ctx.fillStyle='rgba(200,0,200,.8)';ctx.fillRect(-6,-26,4,6);ctx.fillRect(6,-26,4,6);glow(ctx,0,-8,28,`rgba(180,0,180,${.18+Math.sin(t*6)*.14})`);break;
    case'voidknight':ctx.fillStyle=c;ctx.fillRect(-14,-34,32,26);ctx.fillStyle='#8000ff';ctx.fillRect(-8,-28,6,7);ctx.fillRect(4,-28,6,7);ctx.fillStyle=shade(c,1.4);ctx.fillRect(-16,0,36,28);ctx.fillStyle=c;ctx.fillRect(-28,0,12,20);ctx.fillRect(18,0,12,20);ctx.fillStyle='#6000ff';ctx.fillRect(20,-18,8,46);ctx.fillRect(14,-24,16,8);ctx.fillStyle=c;ctx.fillRect(-8,28,8,14);ctx.fillRect(4,28,8,14);glow(ctx,0,0,46,`rgba(60,0,180,${.12+Math.sin(t*3)*.09})`);break;
    case'forge':ctx.fillStyle='#804010';ctx.fillRect(-10,-20,24,18);ctx.fillStyle='#ff6000';ctx.fillRect(-6,-16,4,4);ctx.fillRect(4,-16,4,4);ctx.fillStyle='#602808';ctx.fillRect(-12,0,28,18);ctx.fillStyle='#804010';ctx.fillRect(-20,0,8,14);ctx.fillRect(14,0,10,14);ctx.fillStyle='#c0c0d0';ctx.fillRect(16,-10,10,8);ctx.fillRect(18,-18,6,10);ctx.fillRect(-8,18,6,12);ctx.fillRect(4,18,6,12);break;
    case'ruinwarden':ctx.fillStyle='#603020';ctx.fillRect(-14,-32,32,28);ctx.fillStyle='#ff6020';ctx.fillRect(-8,-26,6,6);ctx.fillRect(4,-26,6,6);ctx.fillStyle='#4a2010';ctx.fillRect(-16,0,36,26);ctx.fillStyle='#603020';ctx.fillRect(-26,0,10,20);ctx.fillRect(18,0,10,20);ctx.fillStyle='#301008';ctx.fillRect(-8,26,8,14);ctx.fillRect(4,26,8,14);ctx.fillStyle='#c08050';ctx.fillRect(-30,14,8,8);ctx.fillRect(22,14,8,8);glow(ctx,0,0,42,`rgba(180,80,20,${.08+Math.sin(t*2)*.06})`);break;
    case'forgelord':ctx.fillStyle='#aa5000';ctx.fillRect(-8,-44,10,16);ctx.fillRect(6,-44,10,16);ctx.fillStyle='#ffd700';ctx.fillRect(-12,-48,4,10);ctx.fillRect(-4,-52,4,14);ctx.fillRect(4,-52,4,14);ctx.fillRect(12,-48,4,10);ctx.fillRect(-12,-44,28,4);ctx.fillStyle=c;ctx.fillRect(-16,-28,36,24);ctx.fillStyle='#ff8000';ctx.fillRect(-10,-24,7,7);ctx.fillRect(4,-24,7,7);ctx.fillStyle='#7a3000';ctx.fillRect(-16,0,36,26);ctx.fillStyle=c;ctx.fillRect(-28,0,12,20);ctx.fillRect(18,0,12,20);ctx.fillStyle='#ffd700';ctx.fillRect(20,-14,14,10);ctx.fillRect(22,-22,10,10);ctx.fillStyle='#7a3000';ctx.fillRect(-8,26,8,16);ctx.fillRect(4,26,8,16);glow(ctx,0,0,50,`rgba(255,140,0,${.1+Math.sin(t*2.5)*.08})`);break;
    case'dragon':{
      const rg=ctx.createRadialGradient(0,0,8,0,0,70);rg.addColorStop(0,`rgba(255,0,20,${.14+Math.sin(t*2)*.08})`);rg.addColorStop(1,'transparent');ctx.fillStyle=rg;ctx.beginPath();ctx.arc(0,0,70,0,Math.PI*2);ctx.fill();
      ctx.fillStyle='#500000';ctx.fillRect(-70,-24,34,62);ctx.fillRect(38,-24,34,62);ctx.fillStyle='#300000';ctx.fillRect(-64,-18,26,48);ctx.fillRect(40,-18,26,48);
      ctx.fillStyle='#860000';ctx.fillRect(-26,-6,56,40);ctx.fillStyle='#640000';for(let i=0;i<3;i++)for(let j=0;j<4;j++)ctx.fillRect(-20+j*13,-4+i*12,11,9);
      ctx.fillStyle='#760000';ctx.fillRect(-9,-32,20,30);ctx.fillStyle='#860000';ctx.fillRect(-20,-54,44,26);ctx.fillRect(-16,-32,32,12);
      ctx.fillStyle='#ff0000';ctx.fillRect(-14,-50,9,9);ctx.fillRect(5,-50,9,9);ctx.fillStyle='#ff8000';ctx.fillRect(-13,-49,7,7);ctx.fillRect(6,-49,7,7);ctx.fillStyle='#ffff00';ctx.fillRect(-12,-48,5,5);ctx.fillRect(7,-48,5,5);
      ctx.fillStyle='#500000';ctx.fillRect(-18,-64,7,14);ctx.fillRect(-12,-70,4,8);ctx.fillRect(10,-64,7,14);ctx.fillRect(12,-70,4,8);
      ctx.fillStyle='#f0f0d0';for(let i=0;i<4;i++)ctx.fillRect(-14+i*7,-26,4,7);
      ctx.fillStyle='#760000';ctx.fillRect(-22,34,14,20);ctx.fillRect(10,34,14,20);
      ctx.fillStyle='#760000';ctx.fillRect(32,26,20,12);ctx.fillRect(50,18,16,12);ctx.fillRect(64,10,12,12);
      if(Math.sin(t*3)>-.2){const fi=Math.max(0,Math.sin(t*3));ctx.fillStyle=`rgba(255,${60+fi*100},0,${.5+fi*.4})`;ctx.fillRect(-90,-42,fi*90,18);ctx.fillStyle=`rgba(255,220,0,${.4+fi*.3})`;ctx.fillRect(-90,-38,fi*70,10);}
      glow(ctx,0,0,78,`rgba(180,0,0,${.14+Math.sin(t*1.5)*.1})`);break;}
    default:ctx.fillStyle=c;ctx.fillRect(-12,-20,24,36);ctx.fillStyle='#fff';ctx.fillRect(-5,-16,4,4);ctx.fillRect(3,-16,4,4);
  }
}

// â”€â”€ MINIMAP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function drawMinimap(){
  if(!G||G.scene!=='battle')return;
  mmx.fillStyle='#040202';mmx.fillRect(0,0,80,60);
  const sx=80/CW,sy=60/CH;
  mmx.fillStyle='#2a1008';mmx.fillRect(0,~~(270*sy),80,~~(150*sy));
  for(const e of G.enemies){if(!e.alive)continue;mmx.fillStyle=e.isBoss?'#ff1020':'#e03010';mmx.fillRect(~~(e.x*sx)-1,~~(e.y*sy)-1,3,3);}
  mmx.fillStyle='#40ff80';mmx.fillRect(~~(G.pl.x*sx)-2,~~(G.pl.y*sy)-2,4,4);
  mmx.strokeStyle='#8b6020';mmx.strokeRect(0,0,80,60);
}

// â”€â”€ HUD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateHUD(){
  if(!G)return;
  const p=G.pl;
  document.getElementById('hpf').style.width=(p.hp/p.maxHp*100)+'%';
  document.getElementById('xpf').style.width=(p.xp/p.xpNext*100)+'%';
  document.getElementById('stf').style.width=(p.stamina/p.maxStamina*100)+'%';
  document.getElementById('hptx').textContent=`${p.hp}/${p.maxHp}`;
  document.getElementById('xptx').textContent=`${p.xp}/${p.xpNext}`;
  document.getElementById('sttx').textContent=~~p.stamina;
  document.getElementById('lvltag').textContent='LV'+p.level;
  document.getElementById('cntx').textContent=p.coins;
  document.getElementById('pttx').textContent=p.pots;
  document.getElementById('bmtx').textContent=p.bombs;
  document.getElementById('pic').textContent=p.pots;
  document.getElementById('bic').textContent=p.bombs;
  const mpic=document.getElementById('mpic');if(mpic)mpic.textContent=p.pots;
  const mbic=document.getElementById('mbic');if(mbic)mbic.textContent=p.bombs;
}
function pslClick(n){
  document.querySelectorAll('.psl').forEach((el,i)=>el.classList.toggle('on',i===n));
  if(n===1)usePot();if(n===2)useBomb();
}
function showMsg(t){
  const el=document.getElementById('msg');el.textContent=t;el.classList.add('on');
  clearTimeout(msgT);msgT=setTimeout(()=>el.classList.remove('on'),2600);
}

// â”€â”€ HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function dMtn(c,x,y,w,col){c.fillStyle=col;for(let i=0;i<w;i++){const h=(1-Math.pow(i/w*2-1,2))*w*.8;c.fillRect(x-w/2+i,y+w*.8-h,1,h);}}
function dLava(c,x,y,t){for(let i=0;i<50;i++){const sy=y+i*3,sx=x+Math.sin(t*2+i*.35)*7,a=.35+Math.sin(t*3+i*.25)*.4;c.fillStyle=`rgba(255,${90+Math.sin(t*2+i*.5)*50},0,${a})`;c.fillRect(~~sx-2,~~sy,4+~~(Math.abs(Math.sin(i*.4))*4),4);}}
function dChain(c,x1,y1,x2,y2){const n=9;for(let i=0;i<=n;i++){const t=i/n,x=x1+(x2-x1)*t,y=y1+(y2-y1)*t;c.fillStyle='#5a4010';c.fillRect(~~x-3,~~y-3,6,6);c.fillStyle='#3a2808';c.fillRect(~~x-2,~~y-2,4,4);}}
function dSkull(c,x,y,col){c.fillStyle=col;c.fillRect(x-8,y-10,16,14);c.fillStyle='#0a0504';c.fillRect(x-5,y-8,4,4);c.fillRect(x+2,y-8,4,4);c.fillRect(x-3,y,8,4);}
function dTree(c,x,by,h,col){c.fillStyle=col||'#0a1808';c.fillRect(x-4,by,8,h);c.fillRect(x-20,by+h*.3,20,4);c.fillRect(x,by+h*.5,18,4);c.fillRect(x-14,by+h*.65,14,4);}
function dBigMsh(c,x,y,col){c.fillStyle='#2a1000';c.fillRect(x-5,y-20,10,20);c.fillStyle=col;c.fillRect(x-22,y-36,44,18);c.fillRect(x-16,y-42,32,12);c.fillRect(x-10,y-46,20,6);c.fillStyle='rgba(255,255,255,.4)';c.fillRect(x-14,y-32,6,6);c.fillRect(x+2,y-32,6,6);}
function dCrystal(c,x,y,h,col){c.fillStyle=col;c.fillRect(x-4,y,8,h);c.fillRect(x-2,y-8,4,10);c.fillStyle='rgba(150,220,255,.6)';c.fillRect(x-2,y,2,h*.4);}
function dCastle(c,x,y,w,h){c.fillStyle='#0a1828';c.fillRect(x,y+h*.3,w,h*.7);c.fillRect(x,y,44,h);c.fillRect(x+w-44,y,44,h);for(let i=0;i<5;i++){c.fillRect(x+i*11,y-12,7,12);c.fillRect(x+w-55+i*11,y-12,7,12);}c.fillStyle='#050c14';c.fillRect(x+w/2-17,y+h*.5,34,h*.5);}
function dCloud(c,x,y,col){c.fillStyle=col;c.fillRect(x,y,64,18);c.fillRect(x+8,y-12,44,16);c.fillRect(x+18,y-20,26,14);}
function dTower(c,x,y,w,h){c.fillStyle='#0f0820';c.fillRect(x-w/2,y,w,h);c.fillStyle='#180c30';for(let i=0;i<3;i++)c.fillRect(x-w/2+i*(w/3),y-12,w/4,12);}
function dFirePillar(c,x,y,t,v=false){for(let i=0;i<9;i++){const a=.2+Math.sin(t*4+i*.7)*.22,w=17-i*1.7,col=v?`rgba(180,0,80,${a})`:`rgba(255,${i*22},0,${a})`;c.fillStyle=col;c.fillRect(x-w/2+~~(Math.sin(t*3+i)*5),y+i*16,~~w,18);}}
function glow(c,x,y,r,col){const g=c.createRadialGradient(x,y,0,x,y,r);g.addColorStop(0,col);g.addColorStop(1,'transparent');c.fillStyle=g;c.fillRect(x-r,y-r,r*2,r*2);}
function shade(hex,f){const r=parseInt(hex.slice(1,3),16),g=parseInt(hex.slice(3,5),16),b=parseInt(hex.slice(5,7),16);return`#${cc(r*f)}${cc(g*f)}${cc(b*f)}`;}
function cc(v){return Math.max(0,Math.min(255,~~v)).toString(16).padStart(2,'0');}
function h2r(hex){const r=parseInt(hex.slice(1,3),16),g=parseInt(hex.slice(3,5),16),b=parseInt(hex.slice(5,7),16);return`${r},${g},${b}`;}
function addPt(x,y,c,n){for(let i=0;i<n;i++)G.particles.push({x,y,vx:(Math.random()-.5)*5.5,vy:(Math.random()-.5)*5.5-2,life:1,ml:.45+Math.random()*.4,color:c,size:2+~~(Math.random()*4)});}
function addFT(t,x,y,c){G.texts.push({t,x,y,c,life:1,vy:-1.1});}
function rng(a,b){return~~(Math.random()*(b-a))+a;}
function clamp(v,a,b){return Math.max(a,Math.min(b,v));}
function dist(a,b){const dx=a.x-b.x,dy=a.y-b.y;return Math.sqrt(dx*dx+dy*dy);}
function closest(){return G.enemies.filter(e=>e.alive).sort((a,b)=>dist(G.pl,a)-dist(G.pl,b))[0]||null;}

// â”€â”€ INPUT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.addEventListener('keydown',e=>{
  if(!G)return;G.keys[e.key]=true;
  if(e.key==='z'||e.key==='Z'){e.preventDefault();plAtk();}
  if(e.key==='x'||e.key==='X'){e.preventDefault();usePot();}
  if(e.key==='b'||e.key==='B'){e.preventDefault();useBomb();}
  if(e.key==='e'||e.key==='E'){e.preventDefault();toggleShop();}
  if(e.key==='m'||e.key==='M'){e.preventDefault();toggleMap();}
  if(e.key==='r'||e.key==='R'){e.preventDefault();toggleRank();}
  if(e.key==='Tab'){e.preventDefault();nextStage();}
});
document.addEventListener('keyup',e=>{if(G)delete G.keys[e.key];});
document.getElementById('ni').addEventListener('keydown',e=>{if(e.code==='Enter')startGame();});

// â”€â”€ TITLE STARS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
(function(){
  const c=document.getElementById('starbg');
  for(let i=0;i<50;i++){
    const s=document.createElement('div');
    const sz=Math.random()>.75?2:1;
    s.style.cssText=`position:absolute;width:${sz}px;height:${sz}px;background:#fff;left:${Math.random()*100}%;top:${Math.random()*100}%;animation:blink ${1.5+Math.random()*2.5}s step-end infinite;animation-delay:${Math.random()*3}s;`;
    c.appendChild(s);
  }
})();

// â”€â”€ BOOT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
layout();
setupDpad();
// Initial render loop (title screen)
(function initRender(){
  ctx.fillStyle='#050302';ctx.fillRect(0,0,CW,CH);
  requestAnimationFrame(initRender);
  if(G)return;
  const t=Date.now()/1000;
  const gr2=ctx.createLinearGradient(0,0,0,CH);gr2.addColorStop(0,'#200a00');gr2.addColorStop(1,'#050302');
  ctx.fillStyle=gr2;ctx.fillRect(0,0,CW,CH);
  dMtn(ctx,260,80,130,'#3a1a00');dMtn(ctx,460,100,90,'#2a1000');
  glow(ctx,280,55,50,'rgba(255,160,0,.7)');dLava(ctx,280,80,t);
  ctx.fillStyle='#3a1808';ctx.fillRect(0,270,CW,150);
})();
</script>
</body>
</html>