<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>‚öî Pixel Quest</title>
<link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
<style>
:root{
  --wood1:#7a4010;--wood2:#5a2c06;--wood3:#c8902a;--wood4:#e8b850;
  --wbg:rgba(48,24,6,.96);--wbg2:rgba(62,32,8,.98);
  --tx:#ffe080;--tx2:#ffd060;
}
*{margin:0;padding:0;box-sizing:border-box;image-rendering:pixelated;
  -webkit-tap-highlight-color:transparent;font-family:'Press Start 2P',monospace;}
html{height:100%;overflow:hidden;}
body{
  background:#1a1008;
  height:100%;width:100%;
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  overflow:hidden;user-select:none;
}

/* ‚ïê‚ïê WOODEN FRAME MIXIN ‚ïê‚ïê */
.wf{
  background:var(--wbg);
  border:3px solid var(--wood3);
  box-shadow:inset 0 1px 0 rgba(255,200,80,.25),inset 0 -2px 0 rgba(0,0,0,.6),
             2px 2px 0 var(--wood1), -1px -1px 0 rgba(255,200,80,.15);
  border-radius:2px;
}

/* ‚ïê‚ïê GAME SHELL ‚ïê‚ïê */
#shell{
  position:relative;display:flex;flex-direction:column;
  background:#1a0c04;overflow:hidden;
  border:4px solid var(--wood3);
  box-shadow:0 0 0 2px var(--wood1),0 0 40px rgba(80,160,255,.15),0 8px 32px rgba(0,0,0,.8);
}

/* ‚ïê‚ïê CANVAS ‚ïê‚ïê */
#gc{display:block;flex-shrink:0;border-bottom:2px solid var(--wood1);}

/* ‚ïê‚ïê HUD overlay ‚ïê‚ïê */
#hud{
  position:absolute;top:0;left:0;right:0;pointer-events:none;z-index:5;
  display:flex;justify-content:space-between;align-items:flex-start;
  padding:5px 6px;gap:4px;
}
.hbox{
  background:rgba(30,14,3,.9);
  border:3px solid var(--wood3);
  box-shadow:inset 0 1px 0 rgba(255,200,80,.2),inset 0 -2px 0 rgba(0,0,0,.7),2px 2px 0 var(--wood1);
  padding:5px 8px;min-width:110px;
}
/* corner ornaments */
.hbox::before{content:'‚óÜ';position:absolute;top:-5px;left:-5px;font-size:8px;color:var(--wood3);}
.hbox{position:relative;}
.hr{display:flex;align-items:center;gap:5px;margin-bottom:4px;white-space:nowrap;}
.hr:last-child{margin-bottom:0;}
.hrlabel{font-size:5px;color:var(--tx2);width:14px;text-align:center;}
.bar{
  width:80px;height:9px;flex-shrink:0;
  background:#1a0808;
  border:2px solid var(--wood1);
  box-shadow:inset 0 2px 0 rgba(0,0,0,.5);
  position:relative;overflow:hidden;
}
.bf{height:100%;position:absolute;top:0;left:0;transition:width .25s;}
#hpf{background:linear-gradient(180deg,#f85050 0%,#b01818 50%,#800000 100%);}
#xpf{background:linear-gradient(180deg,#60b0ff 0%,#1860e0 50%,#0030a0 100%);}
#stf{background:linear-gradient(180deg,#ffe060 0%,#d09010 50%,#906000 100%);}
.hbarval{position:absolute;right:3px;top:0;font-size:5px;color:#fff;text-shadow:1px 1px 0 #000;line-height:9px;pointer-events:none;}
.hright{display:flex;flex-direction:column;gap:3px;align-items:flex-end;}
.htag{
  font-size:5px;color:var(--tx2);
  background:rgba(30,14,3,.9);
  border:3px solid var(--wood3);
  box-shadow:inset 0 1px 0 rgba(255,200,80,.2),2px 2px 0 var(--wood1);
  padding:3px 7px;display:flex;align-items:center;gap:4px;white-space:nowrap;
}
.htag-icon{font-size:9px;}

/* minimap */
#mm{position:absolute;top:4px;left:50%;transform:translateX(-50%);pointer-events:none;z-index:5;display:none;}
#mmc{border:3px solid var(--wood3);box-shadow:2px 2px 0 var(--wood1);}

/* msg */
#msg{
  position:absolute;left:50%;transform:translateX(-50%);bottom:4px;
  background:rgba(30,14,3,.97);
  border:3px solid var(--wood3);
  box-shadow:inset 0 1px 0 rgba(255,200,80,.2),2px 2px 0 var(--wood1);
  padding:4px 12px;font-size:5px;color:var(--tx);
  white-space:nowrap;pointer-events:none;opacity:0;transition:opacity .18s;z-index:10;
}
#msg.on{opacity:1;}

/* stage clear overlay */
#sc{
  position:absolute;inset:0;
  background:linear-gradient(180deg,rgba(0,0,0,.3),rgba(20,50,0,.6));
  display:none;flex-direction:column;align-items:center;justify-content:center;
  z-index:20;pointer-events:none;
}
#sc h2{
  font-size:18px;color:#ffd700;text-align:center;
  text-shadow:0 0 40px rgba(255,220,0,1),3px 3px 0 #5a3000,-1px -1px 0 #000;
  animation:gp 1s ease-in-out infinite;
  background:rgba(20,10,0,.8);border:4px solid var(--wood3);
  box-shadow:2px 2px 0 var(--wood1);padding:10px 20px;
}
#sc p{font-size:6px;color:#c8e080;margin-top:8px;text-align:center;padding:4px 14px;
  background:rgba(10,20,5,.85);border:2px solid #4a7020;}

/* ‚ïê‚ïê STAGE INFO STRIP ‚ïê‚ïê */
#strip{
  flex-shrink:0;width:100%;
  background:linear-gradient(180deg,var(--wood2),#3a1a04);
  border-top:3px solid var(--wood3);
  display:flex;align-items:center;justify-content:space-between;
  padding:4px 10px;gap:6px;
}
#strip .sl{font-size:5px;color:var(--tx2);}
#strip .sr{font-size:5px;color:#c08040;}
#nextbtn{
  font-family:'Press Start 2P',monospace;font-size:5px;
  color:#fff8d0;
  background:linear-gradient(180deg,#6a9a20,#3a6010);
  border:3px solid #a0d040;
  box-shadow:inset 0 1px 0 rgba(200,255,80,.3),2px 2px 0 #2a4008;
  padding:4px 9px;cursor:pointer;display:none;flex-shrink:0;
}
#nextbtn:active{transform:scale(.94);}

/* ‚ïê‚ïê PC BOTTOM BAR ‚ïê‚ïê */
#pcbar{
  flex-shrink:0;width:100%;
  background:linear-gradient(180deg,var(--wood2),#2a1204);
  border-top:3px solid var(--wood3);
  display:flex;align-items:center;justify-content:space-between;
  padding:4px 7px;gap:5px;
}
.pbs{display:flex;gap:4px;}
.psl{
  width:34px;height:34px;
  background:linear-gradient(180deg,#4a2808,#2a1404);
  border:3px solid var(--wood3);
  box-shadow:inset 0 1px 0 rgba(255,200,80,.2),2px 2px 0 var(--wood1);
  display:flex;align-items:center;justify-content:center;
  font-size:14px;cursor:pointer;position:relative;
}
.psl:hover,.psl.on{
  border-color:var(--wood4);background:linear-gradient(180deg,#7a4018,#4a2008);
  box-shadow:inset 0 1px 0 rgba(255,220,80,.4),0 0 8px rgba(255,180,0,.4),2px 2px 0 var(--wood1);
}
.psl .c{position:absolute;bottom:1px;right:2px;font-size:5px;color:var(--tx2);text-shadow:1px 1px 0 #000;}
.pbv{display:flex;gap:3px;flex-wrap:wrap;justify-content:center;}
.pb{
  font-size:5px;color:var(--tx2);
  background:linear-gradient(180deg,#5a3010,#3a1c06);
  border:3px solid var(--wood3);
  box-shadow:inset 0 1px 0 rgba(255,200,80,.2),2px 2px 0 var(--wood1);
  padding:4px 6px;cursor:pointer;white-space:nowrap;
}
.pb:hover{background:linear-gradient(180deg,#8a5020,#5a3010);border-color:var(--wood4);}
.pb:active{transform:scale(.94);box-shadow:inset 0 2px 0 rgba(0,0,0,.4);}
.pb.r{border-color:#c05050;}.pb.r:hover{border-color:#ff8080;}
.pb.g{border-color:#40a040;}.pb.g:hover{border-color:#60ff60;}
.pb.b{border-color:#4060c0;}.pb.b:hover{border-color:#80a0ff;}
.pb.y{border-color:#c0a020;}.pb.y:hover{border-color:#ffff40;}
#pcctrl{font-size:4px;color:#907040;line-height:1.9;text-align:right;}

/* ‚ïê‚ïê MOBILE CONTROL PAD ‚ïê‚ïê */
#mpad{
  flex-shrink:0;width:100%;
  background:linear-gradient(180deg,#2a1406,#1a0c02);
  border-top:3px solid var(--wood3);
  display:none;align-items:stretch;
}

/* DPAD */
#dp{flex-shrink:0;position:relative;}
.dk{
  position:absolute;display:flex;align-items:center;justify-content:center;
  background:rgba(60,30,8,.65);border:2px solid var(--wood3);cursor:pointer;
  box-shadow:inset 0 1px 0 rgba(255,200,80,.15);
}
.dk:active,.dk.dn{background:rgba(180,100,20,.55);border-color:var(--wood4);}

/* ACTION BUTTONS */
#abns{
  flex:1;display:flex;flex-direction:column;
  align-items:center;justify-content:space-evenly;padding:4px 0;gap:3px;
}
.ar{display:flex;gap:3px;justify-content:center;width:100%;padding:0 4px;}
.mb{
  flex:1;font-family:'Press Start 2P',monospace;
  color:var(--tx2);
  background:linear-gradient(180deg,#6a3810,#3a1c06);
  border:3px solid var(--wood3);
  box-shadow:inset 0 1px 0 rgba(255,200,80,.2),2px 2px 0 var(--wood1);
  padding:7px 4px;cursor:pointer;text-align:center;min-width:0;
}
.mb:active{background:linear-gradient(180deg,#3a1c06,#6a3810);
  box-shadow:inset 0 2px 0 rgba(0,0,0,.5);transform:scale(.94);}
.mb.r{border-color:#c05050;color:#ffa0a0;}
.mb.r:active{background:linear-gradient(180deg,#4a1010,#8a2020);}
.mb.g{border-color:#40a040;color:#a0ffa0;}
.mb.g:active{background:linear-gradient(180deg,#0a2008,#1a5010);}
.mb.b{border-color:#4060c0;color:#a0c0ff;}
.mb.b:active{background:linear-gradient(180deg,#080818,#102040);}
.mb.y{border-color:#c0a020;color:#ffffa0;}
.mb.y:active{background:linear-gradient(180deg,#181206,#402a06);}

/* QUICK SLOTS */
#qs{
  flex-shrink:0;display:flex;flex-direction:column;
  align-items:center;justify-content:space-evenly;
  padding:4px;gap:3px;border-left:2px solid var(--wood1);
}
.ql{
  display:flex;align-items:center;justify-content:center;
  background:linear-gradient(180deg,#4a2808,#2a1404);
  border:3px solid var(--wood3);
  box-shadow:inset 0 1px 0 rgba(255,200,80,.2),2px 2px 0 var(--wood1);
  font-size:15px;cursor:pointer;position:relative;
}
.ql:active{border-color:var(--wood4);transform:scale(.9);}
.ql .c{position:absolute;bottom:1px;right:2px;font-size:5px;color:var(--tx2);text-shadow:1px 1px 0 #000;}

/* ‚ïê‚ïê SCREENS ‚ïê‚ïê */
.scr{
  position:absolute;inset:0;
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  z-index:30;overflow:hidden;
}

/* TITLE */
#tscr{background:linear-gradient(180deg,#1a4a80 0%,#0e2a50 40%,#0a1820 100%);}
#tscr h1{
  font-size:clamp(14px,4.5vw,24px);color:var(--tx);
  text-shadow:0 0 30px rgba(255,220,80,.9),3px 3px 0 #4a2000,-1px -1px 0 rgba(0,0,0,.8);
  margin-bottom:8px;animation:gp 2s ease-in-out infinite;text-align:center;
}
#tscr h2{font-size:clamp(5px,2vw,8px);color:#c8a050;margin-bottom:4px;letter-spacing:.1em;text-shadow:1px 1px 0 #000;}
#tscr h3{font-size:clamp(4px,1.5vw,6px);color:#9a7840;margin-bottom:clamp(12px,3vh,24px);letter-spacing:.04em;text-align:center;padding:0 12px;}
@keyframes gp{
  0%,100%{text-shadow:0 0 30px rgba(255,220,80,.9),3px 3px 0 #4a2000}
  50%{text-shadow:0 0 60px rgba(255,240,100,1),3px 3px 0 #4a2000}
}
#nf{display:flex;flex-direction:column;align-items:center;gap:8px;margin-bottom:clamp(12px,3vh,22px);}
#nf label{font-size:clamp(5px,2vw,7px);color:var(--tx2);}
#ni{
  font-family:'Press Start 2P',monospace;
  font-size:clamp(8px,2.5vw,11px);color:var(--tx);
  background:linear-gradient(180deg,#2a1604,#1a0c02);
  border:3px solid var(--wood3);
  box-shadow:inset 0 2px 0 rgba(0,0,0,.6),2px 2px 0 var(--wood1);
  outline:none;padding:8px 12px;text-align:center;
  width:clamp(180px,60vw,280px);
}
#ni::placeholder{color:#7a5020;}
.bb{
  font-family:'Press Start 2P',monospace;
  font-size:clamp(7px,2.5vw,10px);color:var(--tx);
  background:linear-gradient(180deg,#6a3810,#3a1c06);
  border:3px solid var(--wood3);
  box-shadow:inset 0 1px 0 rgba(255,200,80,.25),2px 2px 0 var(--wood1);
  padding:clamp(8px,2vh,12px) clamp(14px,4vw,26px);cursor:pointer;margin:3px;
}
.bb:hover{background:linear-gradient(180deg,#9a5820,#6a3010);border-color:var(--wood4);}
.bb:active{transform:scale(.94);box-shadow:inset 0 2px 0 rgba(0,0,0,.5);}
.bb.bl{animation:blink 1s step-end infinite;}
@keyframes blink{0%,100%{opacity:1}50%{opacity:.3}}

/* MAP */
#mscr{background:linear-gradient(180deg,#0e2040,#060c18);display:none;padding:6px 4px 4px;}
#mscr h2{font-size:clamp(7px,2.5vw,10px);color:var(--tx2);margin-bottom:8px;
  text-shadow:2px 2px 0 #1a0800;border-bottom:2px solid var(--wood3);padding-bottom:5px;}
#mapcv{
  border:3px solid var(--wood3);
  box-shadow:inset 0 0 20px rgba(0,0,0,.5),2px 2px 0 var(--wood1);
  cursor:pointer;max-width:100%;
}
#mlbl{font-size:clamp(5px,1.5vw,6px);color:#c0a060;margin-top:5px;
  background:rgba(20,10,2,.9);border:2px solid var(--wood1);padding:4px 10px;text-align:center;}

/* SHOP */
#shscr{background:linear-gradient(180deg,#1a1204,#0e0a02);display:none;padding:6px 4px 4px;overflow-y:auto;}
#shscr h2{font-size:clamp(7px,2.5vw,10px);color:var(--tx);margin-bottom:3px;text-shadow:2px 2px 0 #000;}
#sgold{font-size:clamp(5px,2vw,7px);color:#ffd700;margin-bottom:7px;}
#shgrid{
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(clamp(130px,28vw,180px),1fr));
  gap:5px;width:100%;max-height:62vh;overflow-y:auto;margin-bottom:7px;
}
.si{
  background:linear-gradient(180deg,#3a2008,#221004);
  border:3px solid var(--wood3);
  box-shadow:inset 0 1px 0 rgba(255,200,80,.15),2px 2px 0 var(--wood1);
  padding:7px 9px;cursor:pointer;display:flex;flex-direction:column;gap:3px;
}
.si:hover,.si:active{
  background:linear-gradient(180deg,#5a3010,#3a1c06);border-color:var(--wood4);
  box-shadow:inset 0 1px 0 rgba(255,220,80,.3),0 0 8px rgba(255,180,0,.2),2px 2px 0 var(--wood1);
}
.si.own{border-color:#40802a;opacity:.6;pointer-events:none;}
.si-n{font-size:clamp(5px,1.5vw,6px);color:var(--tx2);}
.si-d{font-size:clamp(4px,1.2vw,5px);color:#c0a050;line-height:1.6;}
.si-p{font-size:clamp(5px,1.5vw,6px);color:#ffd700;margin-top:2px;}

/* RANK */
#rkscr{background:linear-gradient(180deg,#060c1a,#030608);display:none;padding:6px 4px 4px;overflow-y:auto;}
#rkscr h2{font-size:clamp(7px,2.5vw,10px);color:#80d0ff;margin-bottom:3px;}
#rksub{font-size:clamp(4px,1.5vw,6px);color:#4080a0;margin-bottom:7px;}
#rklist{width:100%;max-height:62vh;overflow-y:auto;}
.rr{display:flex;align-items:center;gap:5px;padding:5px 8px;
  border-bottom:2px solid rgba(30,60,100,.4);font-size:clamp(5px,1.5vw,6px);}
.rr.me{background:rgba(40,80,160,.18);border-left:3px solid #60a0ff;}
.rrk{width:24px;color:#4080a0;text-align:center;flex-shrink:0;}
.rrk.gd{color:#ffd700;}.rrk.sv{color:#d0d0d8;}.rrk.br{color:#d08040;}
.rnm{flex:1;color:#90d0ff;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.rco{color:#ffd700;min-width:52px;text-align:right;flex-shrink:0;}
.rst{color:#a07040;min-width:32px;text-align:right;font-size:clamp(4px,1.2vw,5px);flex-shrink:0;}
.rlv{color:#60b060;min-width:30px;text-align:right;font-size:clamp(4px,1.2vw,5px);flex-shrink:0;}

/* GAME OVER */
#ovl{background:rgba(0,0,0,.93);display:none;padding:16px 12px;}
#ovl h2{font-size:clamp(14px,5vw,22px);margin-bottom:10px;text-align:center;}
#ovl p{font-size:clamp(5px,1.8vw,7px);color:#c0a040;margin-bottom:14px;text-align:center;line-height:2.4;}
#fst{font-size:clamp(5px,1.8vw,7px);color:#80d060;text-align:center;margin-bottom:12px;line-height:2.4;}
</style>
</head>
<body>
<div id="shell">
  <!-- CANVAS -->
  <canvas id="gc" width="700" height="420"></canvas>

  <!-- HUD OVERLAY -->
  <div id="hud">
    <div class="hbox">
      <div class="hr"><span class="hrlabel">‚ù§Ô∏è</span><div class="bar"><div class="bf" id="hpf"></div><span class="hbarval" id="hptx"></span></div></div>
      <div class="hr"><span class="hrlabel">‚≠ê</span><div class="bar"><div class="bf" id="xpf"></div><span class="hbarval" id="xptx"></span></div></div>
      <div class="hr"><span class="hrlabel">‚ö°</span><div class="bar"><div class="bf" id="stf"></div><span class="hbarval" id="sttx"></span></div></div>
    </div>
    <div id="mm"><canvas id="mmc" width="80" height="60"></canvas></div>
    <div class="hright">
      <div class="htag"><span class="htag-icon">ü™ô</span><span id="cntx">0</span></div>
      <div class="htag"><span class="htag-icon">üß™</span>x<span id="pttx">3</span></div>
      <div class="htag"><span class="htag-icon">üí£</span>x<span id="bmtx">0</span></div>
      <div class="htag" id="lvltag">LV1</div>
    </div>
  </div>
  <div id="msg"></div>

  <!-- STAGE CLEAR -->
  <div id="sc"><h2>‚öî STAGE CLEAR! ‚öî</h2><p id="scr"></p></div>

  <!-- STAGE INFO STRIP -->
  <div id="strip">
    <div class="sl" id="stnm">‚Äî</div>
    <div class="sr" id="stsb">‚Äî</div>
    <div class="sr" id="stwv">‚Äî</div>
    <button id="nextbtn" onclick="nextStage()">‚ñ∂NEXT</button>
  </div>

  <!-- PC BOTTOM BAR -->
  <div id="pcbar">
    <div class="pbs">
      <div class="psl on" onclick="pslClick(0)">‚öîÔ∏è</div>
      <div class="psl" onclick="pslClick(1)">üß™<span class="c" id="pic"></span></div>
      <div class="psl" onclick="pslClick(2)">üí£<span class="c" id="bic"></span></div>
    </div>
    <div class="pbv">
      <button class="pb r" onclick="plAtk()">‚öîATK[Z]</button>
      <button class="pb g" onclick="usePot()">üß™POT[X]</button>
      <button class="pb r" onclick="useBomb()">üí£BOM[B]</button>
      <button class="pb b" onclick="toggleShop()">üè™[E]</button>
      <button class="pb b" onclick="toggleMap()">üó∫[M]</button>
      <button class="pb y" onclick="toggleRank()">üèÜ[R]</button>
    </div>
    <div id="pcctrl">WASD/Arrows:Move<br>Z:Atk X:Pot B:Bomb<br>E:Shop M:Map R:Rank</div>
  </div>

  <!-- MOBILE PAD -->
  <div id="mpad">
    <!-- D-Pad (left) ‚Äî sized by JS -->
    <div id="dp">
      <canvas id="dpc"></canvas><!-- visual only -->
      <div class="dk" id="dk-u">‚ñ≤</div>
      <div class="dk" id="dk-d">‚ñº</div>
      <div class="dk" id="dk-l">‚óÄ</div>
      <div class="dk" id="dk-r">‚ñ∂</div>
      <div class="dk" id="dk-ul"></div>
      <div class="dk" id="dk-ur"></div>
      <div class="dk" id="dk-dl"></div>
      <div class="dk" id="dk-dr"></div>
      <div class="dk" id="dk-m" style="background:rgba(10,5,0,.4);border:none;cursor:default;border-radius:50%;"></div>
    </div>

    <!-- Action buttons (center) -->
    <div id="abns">
      <div class="ar">
        <button class="mb r" ontouchstart="plAtk()" onclick="plAtk()">‚öî<br>ATK</button>
        <button class="mb g" ontouchstart="usePot()" onclick="usePot()">üß™<br>POT</button>
        <button class="mb r" ontouchstart="useBomb()" onclick="useBomb()">üí£<br>BOM</button>
      </div>
      <div class="ar">
        <button class="mb b" ontouchstart="toggleShop()" onclick="toggleShop()">üè™<br>SHOP</button>
        <button class="mb b" ontouchstart="toggleMap()" onclick="toggleMap()">üó∫<br>MAP</button>
        <button class="mb y" ontouchstart="toggleRank()" onclick="toggleRank()">üèÜ<br>RANK</button>
      </div>
    </div>

    <!-- Quick slots (right) -->
    <div id="qs">
      <div class="ql" onclick="pslClick(0)">‚öîÔ∏è</div>
      <div class="ql" onclick="pslClick(1)">üß™<span class="c" id="mpic"></span></div>
      <div class="ql" onclick="pslClick(2)">üí£<span class="c" id="mbic"></span></div>
    </div>
  </div>

  <!-- SCREENS -->
  <div class="scr" id="tscr">
    <div id="starbg" style="position:absolute;inset:0;pointer-events:none;overflow:hidden;"></div>
    <div style="position:absolute;bottom:0;left:0;right:0;height:45%;background:linear-gradient(180deg,transparent,rgba(20,60,10,.8));pointer-events:none;"></div>
    <h1>‚öî PIXEL QUEST</h1>
    <h2>Chronicles of the Ember Realm</h2>
    <h3>20 STAGES ¬∑ GLOBAL RANKINGS ¬∑ ENDLESS PLAY</h3>
    <div id="nf">
      <label>ENTER YOUR NAME:</label>
      <input id="ni" type="text" maxlength="14" placeholder="KNIGHT" spellcheck="false" autocomplete="off" inputmode="text">
    </div>
    <button class="bb bl" onclick="startGame()">‚öî EMBARK</button>
    <button class="bb" onclick="toggleRank()" style="font-size:6px;margin-top:3px;">üèÜ RANKINGS</button>
  </div>

  <div class="scr" id="mscr">
    <h2>üó∫ WORLD MAP</h2>
    <canvas id="mapcv" width="580" height="300" onclick="mapClick(event)"></canvas>
    <div id="mlbl">Tap a stage to travel</div>
    <div style="display:flex;gap:8px;margin-top:6px;flex-wrap:wrap;justify-content:center;">
      <button class="bb" style="font-size:6px;padding:6px 16px;" onclick="toggleMap()">‚úñ CLOSE</button>
    </div>
  </div>

  <div class="scr" id="shscr">
    <h2>‚öó MERCHANT</h2>
    <div id="sgold">ü™ô <span id="sgo">0</span></div>
    <div id="shgrid"></div>
    <button class="bb" style="font-size:6px;padding:6px 14px;" onclick="toggleShop()">‚úñ CLOSE</button>
  </div>

  <div class="scr" id="rkscr">
    <h2>üèÜ RANKINGS</h2>
    <div id="rksub">Most gold collected</div>
    <div id="rklist"></div>
    <div style="margin-top:8px;display:flex;gap:6px;flex-wrap:wrap;justify-content:center;">
      <button class="bb" style="font-size:6px;padding:6px 14px;" onclick="toggleRank()">‚úñ CLOSE</button>
      <button class="bb" style="font-size:6px;padding:6px 14px;" onclick="clearMyScore()">üóë CLEAR</button>
    </div>
  </div>

  <div class="scr" id="ovl">
    <h2 id="ovlt"></h2>
    <div id="fst"></div>
    <p id="ovls"></p>
    <div style="display:flex;gap:8px;flex-wrap:wrap;justify-content:center;">
      <button class="bb" onclick="continueRun()">‚ñ∂ CONTINUE</button>
      <button class="bb" onclick="restartGame()" style="font-size:6px;">‚Ü∫ NEW GAME</button>
    </div>
  </div>
</div>
<script>
const cv=document.getElementById('gc'),ctx=cv.getContext('2d');
const mmc=document.getElementById('mmc'),mmx=mmc.getContext('2d');
ctx.imageSmoothingEnabled=false;mmx.imageSmoothingEnabled=false;
let G=null,RAF=null,lastT=0,msgT=null;
const CW=700,CH=420;

// ‚îÄ‚îÄ RESPONSIVE LAYOUT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let TOUCH=false;
function detectTouch(){TOUCH=('ontouchstart' in window)||navigator.maxTouchPoints>0;}
function layout(){
  detectTouch();
  const shell=document.getElementById('shell');
  const pcbar=document.getElementById('pcbar');
  const mpad=document.getElementById('mpad');
  const vw=window.innerWidth,vh=window.innerHeight;
  const ctrlH=TOUCH?Math.min(Math.max(vh*.28,100),180):Math.min(Math.max(vh*.1,44),60);
  const stripH=26;
  const availH=vh-ctrlH-stripH;
  const sx=vw/CW,sy=availH/CH;
  const SC=Math.min(sx,sy,1.5);
  const cw=~~(CW*SC),ch=~~(CH*SC);
  cv.style.width=cw+'px';cv.style.height=ch+'px';
  shell.style.width=cw+'px';
  if(TOUCH){
    pcbar.style.display='none';
    mpad.style.display='flex';mpad.style.height=ctrlH+'px';
    layoutDpad(ctrlH,cw);
  } else {
    pcbar.style.display='flex';
    mpad.style.display='none';
  }
  const mapcv=document.getElementById('mapcv');
  const mw=Math.min(580,cw-16);
  mapcv.style.width=mw+'px';mapcv.style.height=~~(mw*(300/580))+'px';
}

function layoutDpad(h,cw){
  const dp=document.getElementById('dp');
  const sz=Math.min(h-8,120);
  dp.style.width=sz+'px';dp.style.height=sz+'px';dp.style.flexShrink='0';dp.style.position='relative';
  const ids=['dk-ul','dk-u','dk-ur','dk-l','dk-m','dk-r','dk-dl','dk-d','dk-dr'];
  const cols=[0,1,2,0,1,2,0,1,2],rows=[0,0,0,1,1,1,2,2,2];
  const cs=~~(sz/3);
  ids.forEach((id,i)=>{
    const el=document.getElementById(id);if(!el)return;
    const base=`position:absolute;width:${cs}px;height:${cs}px;left:${cols[i]*cs}px;top:${rows[i]*cs}px;display:flex;align-items:center;justify-content:center;box-sizing:border-box;`;
    if(id==='dk-m'){el.style.cssText=base+`background:rgba(10,5,0,.4);border:none;border-radius:50%;cursor:default;`;}
    else if(['dk-ul','dk-ur','dk-dl','dk-dr'].includes(id)){el.style.cssText=base+`background:rgba(25,12,2,.3);border:1px solid #2a1008;font-size:0;`;}
    else{el.style.cssText=base+`background:rgba(40,20,5,.55);border:1px solid #3a2008;font-size:${~~(cs*.45)}px;cursor:pointer;`;}
  });
  // size quick slots
  const qs=document.getElementById('qs');
  const qsz=Math.min(~~(h/3)-4,48);
  qs.querySelectorAll('.ql').forEach(el=>{el.style.width=qsz+'px';el.style.height=qsz+'px';});
  qs.style.width=(qsz+8)+'px';
  // size action buttons text
  const fs=Math.max(6,Math.min(~~(h*.04),9));
  document.querySelectorAll('.mb').forEach(el=>el.style.fontSize=fs+'px');
}

const DKEYS={};
function setupDpad(){
  function applyDirs(){
    if(!G)return;
    G.keys['dpad_left'] =!!(DKEYS['dk-l']||DKEYS['dk-ul']||DKEYS['dk-dl']);
    G.keys['dpad_right']=!!(DKEYS['dk-r']||DKEYS['dk-ur']||DKEYS['dk-dr']);
    G.keys['dpad_up']   =!!(DKEYS['dk-u']||DKEYS['dk-ul']||DKEYS['dk-ur']);
    G.keys['dpad_down'] =!!(DKEYS['dk-d']||DKEYS['dk-dl']||DKEYS['dk-dr']);
  }
  ['dk-u','dk-d','dk-l','dk-r','dk-ul','dk-ur','dk-dl','dk-dr'].forEach(id=>{
    const el=document.getElementById(id);if(!el)return;
    const dn=e=>{e.preventDefault();DKEYS[id]=1;el.style.background='rgba(200,147,42,.3)';applyDirs();};
    const up=e=>{e.preventDefault();delete DKEYS[id];el.style.background=['dk-ul','dk-ur','dk-dl','dk-dr'].includes(id)?'rgba(25,12,2,.3)':'rgba(40,20,5,.55)';applyDirs();};
    el.addEventListener('touchstart',dn,{passive:false});
    el.addEventListener('touchend',up,{passive:false});
    el.addEventListener('touchcancel',up,{passive:false});
    el.addEventListener('mousedown',dn);
    el.addEventListener('mouseup',up);
    el.addEventListener('mouseleave',up);
  });
  const dp=document.getElementById('dp');
  dp.addEventListener('touchmove',e=>{
    e.preventDefault();
    const r=dp.getBoundingClientRect(),sz=r.width;
    Object.keys(DKEYS).forEach(k=>delete DKEYS[k]);
    for(const t of e.touches){
      if(t.clientX<r.left||t.clientX>r.right||t.clientY<r.top||t.clientY>r.bottom)continue;
      const dx=t.clientX-r.left-sz/2,dy=t.clientY-r.top-sz/2,dz=sz*.13;
      if(dx<-dz)DKEYS['dk-l']=1;if(dx>dz)DKEYS['dk-r']=1;
      if(dy<-dz)DKEYS['dk-u']=1;if(dy>dz)DKEYS['dk-d']=1;
    }
    applyDirs();
  },{passive:false});
  dp.addEventListener('touchend',e=>{e.preventDefault();Object.keys(DKEYS).forEach(k=>delete DKEYS[k]);applyDirs();},{passive:false});
  dp.addEventListener('touchcancel',e=>{e.preventDefault();Object.keys(DKEYS).forEach(k=>delete DKEYS[k]);applyDirs();},{passive:false});
}

window.addEventListener('resize',layout);
window.addEventListener('orientationchange',()=>setTimeout(layout,250));

// ‚îÄ‚îÄ MAP POSITIONS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const _R1Y=50,_R2Y=130,_R3Y=210,_R4Y=285;
const _COL=[40,145,250,355,460];

// ‚îÄ‚îÄ STAGES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const STAGES=[
  {id:0, name:'Ember Flats',    act:'ACT I',   bg:'lava',      sky:['#a04010','#601808'],gr:'#8a3808',ac:'#ff8030',mx:_COL[0],my:_R1Y,conn:[1],enemies:['imp','sprite'],boss:'demon',waves:2,maxE:3,loot:{coins:[8,18]}},
  {id:1, name:'Lava Chasms',    act:'ACT I',   bg:'lava2',     sky:['#b85010','#702010'],gr:'#9a4010',ac:'#ffa040',mx:_COL[1],my:_R1Y,conn:[0,2],enemies:['imp','demon'],boss:'lavaking',waves:2,maxE:4,loot:{coins:[12,22]}},
  {id:2, name:'Ashfall Ruins',  act:'ACT I',   bg:'ruins',     sky:['#904030','#581a18'],gr:'#6a2c18',ac:'#f07040',mx:_COL[2],my:_R1Y,conn:[1,3],enemies:['sprite','ashgolem'],boss:'ruinwarden',waves:3,maxE:4,loot:{coins:[14,26]}},
  {id:3, name:'The Smelter',    act:'ACT I',   bg:'forge',     sky:['#c06020','#783010'],gr:'#8a3c10',ac:'#ffcc40',mx:_COL[3],my:_R1Y,conn:[2,4],enemies:['imp','ashgolem','forge'],boss:'forgelord',waves:3,maxE:5,loot:{coins:[18,32]}},
  {id:4, name:'Twilight Grove', act:'ACT II',  bg:'forest',    sky:['#4a90d8','#80c8f8'],gr:'#3a8820',ac:'#50e870',mx:_COL[4],my:_R1Y,conn:[3,5],enemies:['wolf','hexbat'],boss:'forestwitch',waves:2,maxE:3,loot:{coins:[14,24]}},
  {id:5, name:'Mushroom Depths',act:'ACT II',  bg:'mushroom',  sky:['#2050a0','#4080c8'],gr:'#206018',ac:'#70ff90',mx:_COL[4],my:_R2Y,conn:[4,6],enemies:['spider','hexbat','wolf'],boss:'sporemind',waves:3,maxE:4,loot:{coins:[16,28]}},
  {id:6, name:'Wraithwood',     act:'ACT II',  bg:'forest2',   sky:['#2a6890','#4898b8'],gr:'#207018',ac:'#40d860',mx:_COL[3],my:_R2Y,conn:[5,7],enemies:['wraith','necro','wolf'],boss:'lichknight',waves:3,maxE:4,loot:{coins:[20,34]}},
  {id:7, name:'Black Canopy',   act:'ACT II',  bg:'darkforest',sky:['#1a3a50','#2a5870'],gr:'#1a4c18',ac:'#20c860',mx:_COL[2],my:_R2Y,conn:[6,8],enemies:['necro','wraith','spider'],boss:'shadowdruid',waves:3,maxE:5,loot:{coins:[24,40]}},
  {id:8, name:'Frost Shore',    act:'ACT III', bg:'ice',       sky:['#6090c8','#a0c8e8'],gr:'#8ab8d0',ac:'#60d8ff',mx:_COL[1],my:_R2Y,conn:[7,9],enemies:['golem','icearcher'],boss:'frostgiant',waves:3,maxE:4,loot:{coins:[20,36]}},
  {id:9, name:'Blizzard Pass',  act:'ACT III', bg:'blizzard',  sky:['#5080b8','#90b8d8'],gr:'#78a8c8',ac:'#90e0ff',mx:_COL[0],my:_R2Y,conn:[8,10],enemies:['wraith','golem','icelich'],boss:'icelich',waves:3,maxE:5,loot:{coins:[24,42]}},
  {id:10,name:'Glacial Spires', act:'ACT III', bg:'glacier',   sky:['#4070a8','#80b0d0'],gr:'#6898b8',ac:'#a0e8ff',mx:_COL[0],my:_R3Y,conn:[9,11],enemies:['icelicher','golem','icedrake'],boss:'crystalqueen',waves:4,maxE:5,loot:{coins:[28,48]}},
  {id:11,name:'Frozen Throne',  act:'ACT III', bg:'throne',    sky:['#3060a0','#6090c0'],gr:'#5880a8',ac:'#c0e8ff',mx:_COL[1],my:_R3Y,conn:[10,12],enemies:['icelich','icedrake','golem'],boss:'winterking',waves:4,maxE:5,loot:{coins:[32,54]}},
  {id:12,name:'Mire Entrance',  act:'ACT IV',  bg:'swamp',     sky:['#386828','#5a9040'],gr:'#284a18',ac:'#90e840',mx:_COL[2],my:_R3Y,conn:[11,13],enemies:['troll','bog'],boss:'boghag',waves:3,maxE:4,loot:{coins:[26,44]}},
  {id:13,name:'Venom Pools',    act:'ACT IV',  bg:'swamp2',    sky:['#304e20','#507838'],gr:'#203c10',ac:'#b0f850',mx:_COL[3],my:_R3Y,conn:[12,14],enemies:['troll','vbat','bog'],boss:'venomqueen',waves:3,maxE:5,loot:{coins:[30,50]}},
  {id:14,name:'Putrid Depths',  act:'ACT IV',  bg:'swamp3',    sky:['#284018','#40602a'],gr:'#183008',ac:'#80e050',mx:_COL[4],my:_R3Y,conn:[13,15],enemies:['vbat','bog','troll'],boss:'plagueguard',waves:4,maxE:5,loot:{coins:[34,56]}},
  {id:15,name:'The Rot Core',   act:'ACT IV',  bg:'swamp4',    sky:['#1c2e10','#30481e'],gr:'#102006',ac:'#60cc30',mx:_COL[4],my:_R4Y,conn:[14,16],enemies:['troll','vbat','bog'],boss:'rotlord',waves:4,maxE:6,loot:{coins:[38,62]}},
  {id:16,name:'Storm Approach', act:'ACT V',   bg:'sky',       sky:['#5840b8','#8070d8'],gr:'#3828a0',ac:'#d090ff',mx:_COL[3],my:_R4Y,conn:[15,17],enemies:['drake','stormkin'],boss:'stormdrake',waves:3,maxE:4,loot:{coins:[40,66]}},
  {id:17,name:'Cloud Ramparts', act:'ACT V',   bg:'sky2',      sky:['#6850c8','#9880e0'],gr:'#4830b0',ac:'#e0a8ff',mx:_COL[2],my:_R4Y,conn:[16,18],enemies:['drake','stormkin','thunderel'],boss:'cloudgiant',waves:4,maxE:5,loot:{coins:[44,72]}},
  {id:18,name:'Apex Spire',     act:'ACT V',   bg:'sky3',      sky:['#7860d8','#a090e8'],gr:'#5840c0',ac:'#ffc0ff',mx:_COL[1],my:_R4Y,conn:[17,19],enemies:['thunderel','drake','stormkin'],boss:'skyemperor',waves:4,maxE:6,loot:{coins:[50,80]}},
  {id:19,name:'ETERNAL ABYSS',  act:'FINAL',   bg:'abyss',     sky:['#380008','#200004'],gr:'#2c0004',ac:'#ff2040',mx:_COL[0],my:_R4Y,conn:[18],enemies:['shade','voidknight'],boss:'chaosdragon',waves:5,maxE:6,loot:{coins:[80,150]}},
];

// ‚îÄ‚îÄ ENEMIES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const ET={
  imp:{name:'Lava Imp',hp:18,atk:6,def:1,xp:8,coins:12,color:'#c03010',sz:26,sp:'imp'},
  sprite:{name:'Fire Sprite',hp:14,atk:8,def:0,xp:6,coins:8,color:'#ff6010',sz:20,sp:'sprite'},
  demon:{name:'Fire Demon',hp:45,atk:13,def:3,xp:20,coins:32,color:'#8b1a00',sz:38,sp:'demon',boss:true},
  lavaking:{name:'Lava King',hp:70,atk:16,def:5,xp:32,coins:55,color:'#cc2200',sz:46,sp:'lavaking',boss:true},
  ashgolem:{name:'Ash Golem',hp:28,atk:9,def:4,xp:12,coins:16,color:'#5a3020',sz:32,sp:'golem2'},
  forge:{name:'Forge Guard',hp:22,atk:10,def:2,xp:10,coins:14,color:'#804010',sz:28,sp:'forge'},
  ruinwarden:{name:'Ruin Warden',hp:60,atk:14,def:6,xp:28,coins:48,color:'#703010',sz:44,sp:'ruinwarden',boss:true},
  forgelord:{name:'Forge Lord',hp:80,atk:18,def:6,xp:36,coins:65,color:'#aa5000',sz:50,sp:'forgelord',boss:true},
  wolf:{name:'Shadow Wolf',hp:22,atk:8,def:2,xp:10,coins:15,color:'#2a0a4a',sz:30,sp:'wolf'},
  hexbat:{name:'Hex Bat',hp:16,atk:9,def:1,xp:8,coins:10,color:'#3a0a1a',sz:20,sp:'bat'},
  spider:{name:'Hex Spider',hp:18,atk:10,def:1,xp:9,coins:12,color:'#1a0a30',sz:22,sp:'spider'},
  forestwitch:{name:'Forest Witch',hp:55,atk:14,def:4,xp:26,coins:46,color:'#2a1040',sz:42,sp:'forestwitch',boss:true},
  sporemind:{name:'Spore Mind',hp:72,atk:16,def:4,xp:34,coins:58,color:'#104030',sz:48,sp:'sporemind',boss:true},
  wraith:{name:'Wraith',hp:24,atk:11,def:2,xp:11,coins:14,color:'#60a0c0',sz:28,sp:'wraith'},
  necro:{name:'Necromancer',hp:30,atk:13,def:3,xp:14,coins:20,color:'#4a0a6a',sz:32,sp:'necro'},
  lichknight:{name:'Lich Knight',hp:80,atk:18,def:5,xp:38,coins:65,color:'#3a0860',sz:50,sp:'lichknight',boss:true},
  shadowdruid:{name:'Shadow Druid',hp:90,atk:20,def:6,xp:44,coins:75,color:'#060c20',sz:52,sp:'shadowdruid',boss:true},
  golem:{name:'Frost Golem',hp:36,atk:10,def:6,xp:15,coins:20,color:'#3060a0',sz:34,sp:'golem'},
  icedrake:{name:'Ice Drake',hp:30,atk:13,def:3,xp:14,coins:19,color:'#4080c0',sz:30,sp:'icedrake'},
  icelicher:{name:'Ice Licher',hp:26,atk:12,def:2,xp:13,coins:18,color:'#2050a0',sz:26,sp:'icelicher'},
  icelich:{name:'Ice Lich',hp:28,atk:14,def:2,xp:14,coins:19,color:'#1040a0',sz:28,sp:'icelicher'},
  icearcher:{name:'Frost Archer',hp:20,atk:11,def:1,xp:10,coins:14,color:'#3070b0',sz:24,sp:'iceArcher'},
  frostgiant:{name:'Frost Giant',hp:90,atk:18,def:7,xp:40,coins:70,color:'#2050a0',sz:54,sp:'frostgiant',boss:true},
  crystalqueen:{name:'Crystal Queen',hp:100,atk:20,def:7,xp:48,coins:82,color:'#4090d0',sz:54,sp:'crystalqueen',boss:true},
  winterking:{name:'Winter King',hp:120,atk:24,def:8,xp:58,coins:100,color:'#1030a0',sz:58,sp:'winterking',boss:true},
  troll:{name:'Bog Troll',hp:34,atk:11,def:5,xp:14,coins:19,color:'#2a4010',sz:34,sp:'troll'},
  bog:{name:'Bog Wisp',hp:18,atk:10,def:1,xp:9,coins:12,color:'#204010',sz:22,sp:'bogwisp'},
  vbat:{name:'Venom Bat',hp:20,atk:11,def:1,xp:10,coins:13,color:'#304008',sz:22,sp:'bat'},
  boghag:{name:'Bog Hag',hp:80,atk:16,def:5,xp:38,coins:66,color:'#1a3008',sz:48,sp:'boghag',boss:true},
  venomqueen:{name:'Venom Queen',hp:100,atk:20,def:5,xp:48,coins:85,color:'#204010',sz:54,sp:'venomqueen',boss:true},
  plagueguard:{name:'Plague Guard',hp:110,atk:22,def:6,xp:55,coins:95,color:'#184008',sz:56,sp:'plagueguard',boss:true},
  rotlord:{name:'Rot Lord',hp:130,atk:26,def:7,xp:65,coins:115,color:'#0a2004',sz:60,sp:'rotlord',boss:true},
  drake:{name:'Storm Drake',hp:44,atk:14,def:4,xp:20,coins:30,color:'#5028a0',sz:38,sp:'drake'},
  stormkin:{name:'Storm Kin',hp:28,atk:13,def:2,xp:12,coins:18,color:'#3020a0',sz:26,sp:'stormkin'},
  thunderel:{name:'Thunder Elf',hp:24,atk:14,def:2,xp:13,coins:19,color:'#4040c0',sz:26,sp:'thunderelf'},
  stormdrake:{name:'Storm Drake Boss',hp:100,atk:20,def:6,xp:50,coins:90,color:'#4010c0',sz:56,sp:'drake',boss:true},
  cloudgiant:{name:'Cloud Giant',hp:130,atk:24,def:7,xp:62,coins:110,color:'#5030a0',sz:60,sp:'cloudgiant',boss:true},
  skyemperor:{name:'Sky Emperor',hp:160,atk:28,def:9,xp:78,coins:140,color:'#2008a0',sz:64,sp:'skyemperor',boss:true},
  shade:{name:'Void Shade',hp:50,atk:16,def:4,xp:28,coins:42,color:'#200030',sz:32,sp:'shade'},
  voidknight:{name:'Void Knight',hp:60,atk:18,def:5,xp:34,coins:52,color:'#300050',sz:36,sp:'voidknight'},
  chaosdragon:{name:'CHAOS DRAGON',hp:250,atk:36,def:12,xp:200,coins:400,color:'#800000',sz:70,sp:'dragon',boss:true},
};

// ‚îÄ‚îÄ SHOP ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const SHOP=[
  {id:'pot3', name:'Potions x3',      desc:'Restore 40% HP',        price:30, icon:'üß™',stack:true,fn:()=>{G.pl.pots+=3;}},
  {id:'pot5', name:'Potions x5',      desc:'Restore 40% HP',        price:45, icon:'üß™',stack:true,fn:()=>{G.pl.pots+=5;}},
  {id:'bom2', name:'Bombs x2',        desc:'50 dmg all enemies',    price:35, icon:'üí£',stack:true,fn:()=>{G.pl.bombs+=2;}},
  {id:'bom4', name:'Bombs x4',        desc:'50 dmg all enemies',    price:60, icon:'üí£',stack:true,fn:()=>{G.pl.bombs+=4;}},
  {id:'elx',  name:'Grand Elixir',    desc:'Fully restore HP',      price:90, icon:'‚ú®',stack:true,fn:()=>{G.pl.hp=G.pl.maxHp;}},
  {id:'mgp',  name:'Mega Potion',     desc:'Restore 70% HP',        price:65, icon:'üíä',stack:true,fn:()=>{G.pl.hp=Math.min(G.pl.maxHp,G.pl.hp+~~(G.pl.maxHp*.7));}},
  {id:'phx',  name:'Phoenix Feather', desc:'Auto-revive once',      price:120,icon:'üî•',stack:true,fn:()=>{G.pl.revive=true;}},
  {id:'tom',  name:'Tome of Power',   desc:'+50 XP instantly',      price:40, icon:'üìñ',stack:true,fn:()=>{gainXP(50);}},
  {id:'sw1',  name:'Iron Sword',      desc:'+4 ATK',                price:55, icon:'‚öîÔ∏è',fn:()=>{G.pl.atk+=4;}},
  {id:'sw2',  name:'Steel Blade',     desc:'+8 ATK',                price:110,icon:'üó°Ô∏è',fn:()=>{G.pl.atk+=8;}},
  {id:'sw3',  name:'Magic Blade',     desc:'+12 ATK + AOE hits',    price:200,icon:'üåü',fn:()=>{G.pl.atk+=12;G.pl.aoe=true;}},
  {id:'swr',  name:'Soul Reaper',     desc:'+6 ATK +20% lifesteal', price:280,icon:'üíÄ',fn:()=>{G.pl.atk+=6;G.pl.lifesteal=.2;}},
  {id:'sh1',  name:'Iron Shield',     desc:'+6 DEF',                price:90, icon:'üõ°Ô∏è',fn:()=>{G.pl.def+=6;}},
  {id:'sh2',  name:'Rune Shield',     desc:'+10 DEF +reflect 2dmg', price:175,icon:'üîÆ',fn:()=>{G.pl.def+=10;G.pl.reflect=2;}},
  {id:'lr',   name:'Life Ring',       desc:'+20 Max HP',            price:55, icon:'üíç',fn:()=>{G.pl.maxHp+=20;G.pl.hp+=20;}},
  {id:'rr',   name:'Regen Ring',      desc:'+30 MaxHP + regen',     price:110,icon:'üíé',fn:()=>{G.pl.maxHp+=30;G.pl.hp+=30;G.pl.regen=true;}},
  {id:'bt1',  name:'Swiftboots',      desc:'+25% speed',            price:50, icon:'üëü',fn:()=>{G.pl.spd=Math.min(G.pl.spd*1.25,240);}},
  {id:'bt2',  name:'Wind Treads',     desc:'+50% speed',            price:100,icon:'üí®',fn:()=>{G.pl.spd=Math.min(G.pl.spd*1.5,280);}},
  {id:'cm1',  name:'Chain Mail',      desc:'+5 DEF -10 SPD',        price:80, icon:'ü™ñ',fn:()=>{G.pl.def+=5;G.pl.spd=Math.max(70,G.pl.spd-10);}},
  {id:'ar2',  name:'Dragon Armor',    desc:'+8 DEF +10 MaxHP',      price:180,icon:'üê≤',fn:()=>{G.pl.def+=8;G.pl.maxHp+=10;G.pl.hp+=10;}},
  {id:'dam',  name:'Death Amulet',    desc:'Survive killing blow',  price:130,icon:'‚ò†Ô∏è',fn:()=>{G.pl.amulet=true;}},
  {id:'bch',  name:'Battle Charm',    desc:'+20% damage dealt',     price:150,icon:'üèÖ',fn:()=>{G.pl.atkMult=(G.pl.atkMult||1)*1.2;}},
  {id:'arc',  name:'Arcane Scroll',   desc:'Double XP 3 stages',    price:95, icon:'üìú',fn:()=>{G.pl.xpMult=2;G.pl.xpMultStages=3;}},
  {id:'cmp',  name:'Hero Compass',    desc:'Reveal all map names',  price:70, icon:'üß≠',fn:()=>{G.pl.compass=true;}},
  {id:'stc',  name:'Stamina Crystal', desc:'+50 Max Stamina',       price:85, icon:'‚ö°',fn:()=>{G.pl.maxStamina+=50;G.pl.stamina=G.pl.maxStamina;}},
];

// ‚îÄ‚îÄ RANKINGS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const RK='pq5:lb';
async function loadRank(){try{const r=await window.storage.get(RK,true);return r?JSON.parse(r.value):[]}catch{return[];}}
async function saveScore(e){
  let r=await loadRank();
  const i=r.findIndex(x=>x.name===e.name);
  if(i>=0){if(e.coins>r[i].coins)r[i]=e;}else r.push(e);
  r.sort((a,b)=>b.coins-a.coins);r=r.slice(0,50);
  try{await window.storage.set(RK,JSON.stringify(r),true);}catch{}
}
async function clearMyScore(){
  if(!G)return;
  let r=await loadRank();r=r.filter(x=>x.name!==G.pl.name);
  try{await window.storage.set(RK,JSON.stringify(r),true);}catch{}
  renderRank();
}

// ‚îÄ‚îÄ GAME START ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function startGame(){
  const nm=document.getElementById('ni').value.trim().toUpperCase()||'KNIGHT';
  document.getElementById('tscr').style.display='none';
  document.getElementById('mm').style.display='block';
  G={
    scene:'map',stage:null,stageIdx:null,
    enemies:[],particles:[],texts:[],
    bgA:0,keys:{},shakeT:0,
    wave:0,maxWave:0,bossSpawned:false,
    killCount:0,totalKills:0,totalCoins:0,
    stagesCleared:[],currentStageCleared:false,
    pl:{
      name:nm,x:180,y:240,
      hp:50,maxHp:50,xp:0,xpNext:30,
      atk:12,def:4,spd:120,level:1,
      coins:0,pots:3,bombs:0,
      stamina:100,maxStamina:100,
      aoe:false,lifesteal:0,reflect:0,regen:false,
      amulet:false,amuletUsed:false,revive:false,
      atkMult:1,xpMult:1,xpMultStages:0,compass:false,
      facing:1,moving:false,anim:0,invT:0,
      purchased:new Set(),
    },
  };
  openMap();updateHUD();loop(0);
}

function restartGame(){
  document.getElementById('ovl').style.display='none';
  document.getElementById('tscr').style.display='flex';
  cancelAnimationFrame(RAF);G=null;
}

function continueRun(){
  document.getElementById('ovl').style.display='none';
  if(!G)return;
  G.pl.hp=Math.floor(G.pl.maxHp*.5);
  G.pl.amuletUsed=false;G.pl.revive=false;
  G.enemies=[];G.wave=0;G.bossSpawned=false;
  G.killCount=0;G.currentStageCleared=false;
  document.getElementById('nextbtn').style.display='none';
  updateHUD();
  if(G.stageIdx!==null)beginStage(G.stageIdx);else openMap();
}

// ‚îÄ‚îÄ MAP ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function isOpen(s){
  if(!G)return s.id===0;
  if(s.id===0)return true;
  if(G.stagesCleared.includes(s.id))return true;
  return G.stagesCleared.includes(s.id-1);
}
function openMap(){
  document.getElementById('mscr').style.display='flex';
  if(G){G.scene='map';drawWorldMap();}
}
function toggleMap(){
  const s=document.getElementById('mscr');
  if(s.style.display==='flex'){s.style.display='none';if(G)G.scene='battle';}
  else{s.style.display='flex';if(G)G.scene='map';drawWorldMap();}
}
function drawWorldMap(){
  const mc=document.getElementById('mapcv');
  const cx=mc.getContext('2d');
  cx.imageSmoothingEnabled=false;
  const W2=580,H2=300;mc.width=W2;mc.height=H2;
  cx.fillStyle='#030508';cx.fillRect(0,0,W2,H2);
  cx.fillStyle='#07090f';
  for(let i=0;i<W2;i+=20)for(let j=0;j<H2;j+=20)cx.fillRect(i,j,1,1);
  // Act bands
  [{y:0,h:88,c:'rgba(180,60,10,.06)',l:'ACT I ‚Äî VOLCANIC'},{y:88,h:88,c:'rgba(20,160,40,.05)',l:'ACT II ‚Äî FOREST'},
   {y:176,h:76,c:'rgba(30,100,220,.05)',l:'ACT III/IV'},{y:252,h:48,c:'rgba(120,40,220,.06)',l:'ACT V ‚Äî SKY & ABYSS'}
  ].forEach(b=>{cx.fillStyle=b.c;cx.fillRect(0,b.y,W2,b.h);cx.fillStyle='rgba(180,120,30,.18)';cx.font='4px "Press Start 2P"';cx.textBaseline='top';cx.textAlign='left';cx.fillText(b.l,5,b.y+4);});
  // Connections
  for(const s of STAGES){
    for(const nb of s.conn){
      if(nb<=s.id)continue;
      const s2=STAGES[nb];
      const cl=G&&(G.stagesCleared.includes(s.id)||G.stagesCleared.includes(nb));
      cx.strokeStyle=cl?'rgba(240,180,40,.6)':'rgba(70,45,15,.5)';
      cx.lineWidth=cl?2.5:1.5;cx.setLineDash(cl?[]:[4,4]);
      cx.beginPath();cx.moveTo(s.mx,s.my);cx.lineTo(s2.mx,s2.my);cx.stroke();cx.setLineDash([]);
    }
  }
  // Nodes
  const now=G&&G.stageIdx!==null?G.stageIdx:-1;
  const aC={'ACT I':'#ff6010','ACT II':'#30c050','ACT III':'#40c0ff','ACT IV':'#80ff20','ACT V':'#c060ff','FINAL':'#ff1030'};
  const icons=['üåã','üåã','üèö','‚öí','üå≤','üçÑ','üå≤','üå≤','‚ùÑÔ∏è','‚ùÑÔ∏è','üèî','‚ùÑÔ∏è','üåø','‚ò†Ô∏è','üåø','üåø','‚ö°','‚òÅÔ∏è','‚ö°','üíÄ'];
  for(const s of STAGES){
    const cl=G&&G.stagesCleared.includes(s.id);
    const op=isOpen(s),ac=s.id===now,col=aC[s.act]||'#c8932a';
    if(ac){cx.fillStyle='rgba(240,200,60,.2)';cx.beginPath();cx.arc(s.mx,s.my,20,0,Math.PI*2);cx.fill();}
    else if(cl){cx.fillStyle='rgba(40,220,80,.1)';cx.beginPath();cx.arc(s.mx,s.my,17,0,Math.PI*2);cx.fill();}
    cx.fillStyle=cl?'#0a2010':ac?'#201400':op?'#100c02':'#0a0818';
    cx.strokeStyle=cl?'#30d050':ac?'#f0c060':op?col:'#282040';
    cx.lineWidth=ac?3:cl?2.5:2;
    cx.beginPath();cx.arc(s.mx,s.my,12,0,Math.PI*2);cx.fill();cx.stroke();
    cx.font='10px serif';cx.textAlign='center';cx.textBaseline='middle';
    cx.fillText(cl?'‚úÖ':(!op?'üîí':icons[s.id]),s.mx,s.my);
    cx.font='bold 4px "Press Start 2P"';cx.fillStyle=op||cl?col:'#302850';cx.textAlign='center';cx.textBaseline='middle';
    cx.fillText(s.id+1,s.mx-15,s.my-15);
    const nm=G&&G.pl&&G.pl.compass?s.name:(!op&&!cl?'???':s.name);
    cx.font='4px "Press Start 2P"';cx.textBaseline='top';
    cx.fillStyle=cl?'#60e070':ac?'#f0c060':op?'#b08030':'#3a2a60';
    cx.fillText(nm.slice(0,10),s.mx,s.my+14);
    if(nm.length>10)cx.fillText(nm.slice(10),s.mx,s.my+21);
  }
}
function mapClick(e){
  if(!G)return;
  const mc=document.getElementById('mapcv');
  const r=mc.getBoundingClientRect();
  const mx=(e.clientX-r.left)*(580/r.width),my=(e.clientY-r.top)*(300/r.height);
  for(const s of STAGES){
    const dx=mx-s.mx,dy=my-s.my;
    if(Math.sqrt(dx*dx+dy*dy)<16){
      if(!isOpen(s)){document.getElementById('mlbl').textContent=s.id>0?`üîí Clear S${s.id}: ${STAGES[s.id-1].name} first`:'üîí Locked';return;}
      document.getElementById('mscr').style.display='none';
      beginStage(s.id);return;
    }
  }
}

// ‚îÄ‚îÄ STAGE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function beginStage(id){
  const s=STAGES[id];
  G.stage=s;G.stageIdx=id;G.enemies=[];G.wave=0;G.maxWave=s.waves;
  G.bossSpawned=false;G.killCount=0;G.currentStageCleared=false;G.scene='battle';
  G.pl.x=120;G.pl.y=240;G.pl.amuletUsed=false;
  document.getElementById('nextbtn').style.display='none';
  document.getElementById('sc').style.display='none';
  document.getElementById('stnm').textContent=`S${id+1}: ${s.name}`;
  document.getElementById('stsb').textContent=s.act;
  updateHUD();spawnWave();showMsg(`‚öî ${s.name}`);
}
function nextStage(){
  if(!G||!G.stage)return;
  document.getElementById('nextbtn').style.display='none';
  const nxt=G.stageIdx+1;
  if(nxt<STAGES.length)beginStage(nxt);else openMap();
}
function spawnWave(){
  if(!G||!G.stage)return;
  const s=G.stage;G.wave++;
  G.enemies=G.enemies.filter(e=>e.alive);
  const isBoss=G.wave>=G.maxWave&&!G.bossSpawned;
  if(isBoss){
    G.bossSpawned=true;
    const bt=ET[s.boss];if(!bt)return;
    const hp=~~(bt.hp*(1+G.stageIdx*.08));
    const e=mkE(bt,true,480,210);e.hp=hp;e.maxHp=hp;
    G.enemies.push(e);showMsg(`‚ö† BOSS: ${bt.name}!`);
  } else {
    const cnt=Math.min(G.wave+1,s.maxE);
    for(let i=0;i<cnt;i++){
      const tid=s.enemies[~~(Math.random()*s.enemies.length)];
      const t=ET[tid];if(!t)continue;
      const sc2=1+G.stageIdx*.06+G.wave*.04;
      const e=mkE(t,false,360+Math.random()*260,165+Math.random()*120);
      e.hp=~~(e.hp*sc2);e.maxHp=e.hp;e.atk=~~(e.atk*sc2);
      G.enemies.push(e);
    }
    showMsg(`Wave ${G.wave}/${G.maxWave-1} ‚Äî ${cnt} enemies!`);
  }
  document.getElementById('stwv').textContent=isBoss?'‚ö† BOSS':`W${G.wave}/${G.maxWave}`;
}
function mkE(t,isBoss,x,y){
  return{...JSON.parse(JSON.stringify(t)),x,y,alive:true,isBoss,anim:0,hurtT:0,deathA:1,
    atkTimer:1+Math.random()*1.5,wanderX:x+(Math.random()-.5)*80,
    wanderY:clamp(y+(Math.random()-.5)*60,160,330),wanderT:2+Math.random()*2};
}

// ‚îÄ‚îÄ COMBAT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function plAtk(){
  if(!G||G.scene!=='battle')return;
  if(G.pl.stamina<10){showMsg('‚ö° No stamina!');return;}
  const alive=G.enemies.filter(e=>e.alive);if(!alive.length)return;
  G.pl.stamina=Math.max(0,G.pl.stamina-15);
  const tgts=G.pl.aoe?alive:[closest()].filter(Boolean);
  for(const e of tgts){
    const raw=~~((G.pl.atk+rng(-2,4))*(G.pl.atkMult||1));
    const dmg=Math.max(1,raw-e.def);
    e.hp=Math.max(0,e.hp-dmg);e.hurtT=.2;
    addFT('-'+dmg,e.x,e.y-28,e.isBoss?'#ff5050':'#ff9050');
    addPt(e.x,e.y,e.color,6);G.shakeT=.06;
    if(G.pl.lifesteal>0){const h=Math.ceil(dmg*G.pl.lifesteal);G.pl.hp=Math.min(G.pl.maxHp,G.pl.hp+h);if(h>0)addFT('+'+h,G.pl.x,G.pl.y-44,'#40ff80');}
    if(e.hp<=0)killEnemy(e);
  }
  addPt(G.pl.x+G.pl.facing*16,G.pl.y-10,'#fff',4);
  setTimeout(()=>{if(G&&G.scene==='battle')alive.filter(e=>e.alive&&dist(G.pl,e)<240).forEach(e=>enAtk(e));},320);
}
function enAtk(e){
  if(!G||!e.alive||G.pl.invT>0)return;
  const dmg=Math.max(1,e.atk-G.pl.def+rng(-2,3));
  const fin=G.pl.reflect>0?Math.max(0,dmg-G.pl.reflect):dmg;
  if(G.pl.reflect>0&&G.pl.reflect>=dmg){addFT('REFLECT!',G.pl.x,G.pl.y-50,'#80c0ff');e.hp=Math.max(0,e.hp-2);if(e.hp<=0){killEnemy(e);return;}}
  if(G.pl.hp-fin<=0){
    if(G.pl.revive&&!G.pl.amuletUsed){G.pl.hp=~~(G.pl.maxHp*.3);G.pl.amuletUsed=true;G.pl.revive=false;G.pl.invT=2;showMsg('üî• Phoenix saved you!');updateHUD();return;}
    if(G.pl.amulet&&!G.pl.amuletUsed){G.pl.hp=1;G.pl.amuletUsed=true;G.pl.invT=1.5;showMsg('‚ò†Ô∏è Amulet saved you!');updateHUD();return;}
    G.pl.hp=0;updateHUD();setTimeout(playerDeath,500);return;
  }
  G.pl.hp=Math.max(0,G.pl.hp-fin);G.pl.invT=.35;
  addFT('-'+fin,G.pl.x,G.pl.y-40,'#ff2020');addPt(G.pl.x,G.pl.y,'#ff2020',4);updateHUD();
}
function usePot(){
  if(!G)return;
  if(G.pl.pots<=0){showMsg('No potions!');return;}
  if(G.pl.hp>=G.pl.maxHp){showMsg('HP full!');return;}
  const h=~~(G.pl.maxHp*.4);
  G.pl.hp=Math.min(G.pl.maxHp,G.pl.hp+h);G.pl.pots--;
  addFT('+'+h+'HP',G.pl.x,G.pl.y-40,'#40ff80');addPt(G.pl.x,G.pl.y,'#40ff80',8);
  showMsg('üß™ +'+h+' HP');updateHUD();
}
function useBomb(){
  if(!G||!G.pl.bombs){showMsg('No bombs!');return;}
  G.pl.bombs--;
  const alive=G.enemies.filter(e=>e.alive);
  for(const e of alive){const d=Math.max(1,50-e.def);e.hp=Math.max(0,e.hp-d);addFT('-'+d,e.x,e.y-28,'#ff8020');addPt(e.x,e.y,'#ff6010',10);if(e.hp<=0)killEnemy(e);}
  addPt(G.pl.x,G.pl.y-20,'#ff8020',20);showMsg('üí£ BOOM! '+alive.length+' hit!');updateHUD();
}
function killEnemy(e){
  if(!e.alive)return;
  e.alive=false;e.deathA=1;
  addPt(e.x,e.y,'#fff',14);addPt(e.x,e.y,e.color,10);
  const xg=~~(e.xp*(G.pl.xpMult||1));
  const cg=e.coins+rng(0,~~(e.coins*.3));
  G.pl.coins+=cg;G.totalCoins+=cg;
  gainXP(xg);addFT('+'+cg+'ü™ô',e.x,e.y-48,'#ffd700');
  G.killCount++;G.totalKills++;
  setTimeout(()=>{
    if(!G)return;
    if(!G.enemies.filter(e=>e.alive).length){
      if(e.isBoss)stageComplete();
      else if(!G.bossSpawned)setTimeout(spawnWave,1600);
    }
  },400);
}
function gainXP(a){
  if(!G)return;G.pl.xp+=a;
  while(G.pl.xp>=G.pl.xpNext){
    G.pl.xp-=G.pl.xpNext;G.pl.level++;G.pl.xpNext=~~(G.pl.xpNext*1.4);
    G.pl.maxHp+=12;G.pl.hp=Math.min(G.pl.maxHp,G.pl.hp+20);
    G.pl.atk+=2;G.pl.def+=1;G.pl.stamina=G.pl.maxStamina;
    addFT('LEVEL UP!',G.pl.x,G.pl.y-60,'#ffd700');showMsg('üéâ LV'+G.pl.level+'!');
  }
  updateHUD();
}

// ‚îÄ‚îÄ STAGE COMPLETE / DEATH / VICTORY ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function stageComplete(){
  if(!G||G.currentStageCleared)return;
  G.currentStageCleared=true;
  if(!G.stagesCleared.includes(G.stageIdx))G.stagesCleared.push(G.stageIdx);
  if(G.pl.xpMultStages>0){G.pl.xpMultStages--;if(!G.pl.xpMultStages)G.pl.xpMult=1;}
  const bonus=rng(...G.stage.loot.coins)*2;
  G.pl.coins+=bonus;G.totalCoins+=bonus;
  addFT('+'+bonus+'ü™ô CLEAR!',350,190,'#ffd700');
  saveScore({name:G.pl.name,coins:G.pl.coins,level:G.pl.level,stage:G.stageIdx+1,kills:G.totalKills});
  const nxt=G.stageIdx+1,hasN=nxt<STAGES.length;
  document.getElementById('scr').textContent=`+${bonus} Gold  ‚Ä¢  ${G.killCount} Kills${hasN?'  ‚Üí S'+(nxt+1)+': '+STAGES[nxt].name:'  ‚òÖ ALL CLEAR ‚òÖ'}`;
  document.getElementById('sc').style.display='flex';
  const nb=document.getElementById('nextbtn');nb.style.display='inline-block';
  nb.textContent=hasN?`‚ñ∂ S${nxt+1}`:'‚ñ∂ MAP';
  updateHUD();
  setTimeout(()=>{document.getElementById('sc').style.display='none';if(G.stageIdx===19)setTimeout(victory,500);},3000);
}
function playerDeath(){
  if(!G)return;G.scene='dead';
  saveScore({name:G.pl.name,coins:G.pl.coins,level:G.pl.level,stage:G.stageIdx+1,kills:G.totalKills});
  document.getElementById('ovlt').innerHTML='<span style="color:#e02020">üíÄ YOU FELL</span>';
  document.getElementById('fst').textContent=`Stage ${G.stageIdx+1}/20  ‚Ä¢  LV${G.pl.level}  ‚Ä¢  ü™ô${G.pl.coins}\nKills: ${G.totalKills}  ‚Ä¢  Cleared: ${G.stagesCleared.length}`;
  document.getElementById('ovls').textContent='Score saved. Continue or start fresh.';
  document.getElementById('ovl').style.display='flex';
}
function victory(){
  if(!G)return;G.scene='win';
  saveScore({name:G.pl.name,coins:G.pl.coins,level:G.pl.level,stage:20,kills:G.totalKills});
  document.getElementById('ovlt').innerHTML='<span style="color:#ffd700">üèÜ VICTORY!</span>';
  document.getElementById('fst').textContent=`All 20 Stages Cleared!\nLV${G.pl.level}  ‚Ä¢  ü™ô${G.pl.coins}  ‚Ä¢  ${G.totalKills} Kills`;
  document.getElementById('ovls').textContent='The Ember Realm is saved!';
  document.getElementById('ovl').style.display='flex';
}

// ‚îÄ‚îÄ SHOP UI ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function toggleShop(){
  const s=document.getElementById('shscr');
  if(s.style.display==='flex'){s.style.display='none';if(G&&G.scene==='shop')G.scene='battle';}
  else{s.style.display='flex';if(G)G.scene='shop';renderShop();}
}
function renderShop(){
  if(!G)return;
  document.getElementById('sgo').textContent=G.pl.coins;
  const g=document.getElementById('shgrid');g.innerHTML='';
  for(const it of SHOP){
    const own=!it.stack&&G.pl.purchased.has(it.id);
    const d=document.createElement('div');d.className='si'+(own?' own':'');
    d.innerHTML=`<div class="si-n">${it.icon} ${it.name}</div><div class="si-d">${it.desc}</div><div class="si-p">ü™ô${it.price}${own?' ‚úÖ':''}</div>`;
    if(!own)d.onclick=()=>buyItem(it);
    g.appendChild(d);
  }
}
function buyItem(it){
  if(!G)return;
  if(G.pl.coins<it.price){showMsg('Not enough gold!');return;}
  G.pl.coins-=it.price;it.fn();
  if(!it.stack)G.pl.purchased.add(it.id);
  showMsg('‚úÖ '+it.name);updateHUD();renderShop();
}

// ‚îÄ‚îÄ RANK UI ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function toggleRank(){
  const s=document.getElementById('rkscr');
  if(s.style.display==='flex')s.style.display='none';
  else{s.style.display='flex';renderRank();}
}
async function renderRank(){
  const rows=await loadRank();
  const list=document.getElementById('rklist');list.innerHTML='';
  if(!rows.length){list.innerHTML='<div style="font-size:6px;color:#406080;padding:16px;text-align:center">No scores yet!</div>';return;}
  rows.forEach((r,i)=>{
    const me=G&&r.name===G.pl.name;
    const d=document.createElement('div');d.className='rr'+(me?' me':'');
    const m=i===0?'ü•á':i===1?'ü•à':i===2?'ü•â':'';
    const c=i===0?'gd':i===1?'sv':i===2?'br':'';
    d.innerHTML=`<div class="rrk ${c}">${m||'#'+(i+1)}</div><div class="rnm">${me?'‚ñ∂ ':''}${r.name}</div><div class="rco">ü™ô${r.coins}</div><div class="rst">S${r.stage}</div><div class="rlv">LV${r.level}</div>`;
    list.appendChild(d);
  });
}

// ‚îÄ‚îÄ GAME LOOP ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function loop(ts){
  const dt=Math.min((ts-lastT)/1000,.05);lastT=ts;
  if(G&&G.scene==='battle')update(dt);
  render();drawMinimap();
  RAF=requestAnimationFrame(loop);
}

function update(dt){
  G.bgA+=dt;if(G.shakeT>0)G.shakeT-=dt;
  const p=G.pl;p.anim+=dt*4;p.invT=Math.max(0,p.invT-dt);
  p.stamina=Math.min(p.maxStamina,p.stamina+dt*20);
  if(p.regen&&p.hp<p.maxHp)p.hp=Math.min(p.maxHp,p.hp+dt*2);
  let dx=0,dy=0;
  if(G.keys['ArrowLeft']||G.keys['a']||G.keys['A']||G.keys['dpad_left'])dx=-1;
  if(G.keys['ArrowRight']||G.keys['d']||G.keys['D']||G.keys['dpad_right'])dx=1;
  if(G.keys['ArrowUp']||G.keys['w']||G.keys['W']||G.keys['dpad_up'])dy=-1;
  if(G.keys['ArrowDown']||G.keys['s']||G.keys['S']||G.keys['dpad_down'])dy=1;
  if(dx&&dy){dx*=.707;dy*=.707;}
  if(dx)p.facing=dx;p.moving=!!dx||!!dy;
  p.x=clamp(p.x+dx*p.spd*dt,16,684);p.y=clamp(p.y+dy*p.spd*dt,130,340);
  for(const e of G.enemies){
    if(!e.alive){e.deathA=Math.max(0,e.deathA-dt*2);continue;}
    e.anim+=dt*(e.isBoss?1.8:3);e.hurtT=Math.max(0,e.hurtT-dt);e.atkTimer-=dt;
    const ex=p.x-e.x,ey=p.y-e.y,ed=Math.sqrt(ex*ex+ey*ey);
    e.facing=ex<0?-1:1;
    if(ed<300){e.x+=ex/ed*50*dt;e.y+=ey/ed*50*dt;}
    else{e.wanderT-=dt;if(e.wanderT<=0){e.wanderX=e.x+(Math.random()-.5)*120;e.wanderY=clamp(e.y+(Math.random()-.5)*80,150,330);e.wanderT=2+Math.random()*2;}const wx=e.wanderX-e.x,wy=e.wanderY-e.y,wd=Math.sqrt(wx*wx+wy*wy);if(wd>4){e.x+=wx/wd*26*dt;e.y+=wy/wd*26*dt;}}
    e.x=clamp(e.x,20,680);e.y=clamp(e.y,150,340);
    if(ed<38&&e.atkTimer<=0){e.atkTimer=e.isBoss?1.1:1.7;enAtk(e);}
  }
  for(const pt of G.particles){pt.x+=pt.vx;pt.y+=pt.vy;pt.vy+=.14;pt.life-=dt/pt.ml;}
  G.particles=G.particles.filter(p=>p.life>0);
  for(const t of G.texts){t.y+=t.vy;t.life-=dt*1.3;}
  G.texts=G.texts.filter(t=>t.life>0);
}

// ‚îÄ‚îÄ RENDER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function render(){
  const si=G&&G.stageIdx!==null?G.stageIdx:0;
  const st=STAGES[Math.min(si,19)];
  const t=G?G.bgA:Date.now()/1000;

  ctx.save();
  if(G&&G.shakeT>0){
    const sx=~~(Math.sin(t*62)*G.shakeT*14),sy=~~(Math.cos(t*55)*G.shakeT*7);
    ctx.translate(sx,sy);
  }

  // ‚îÄ‚îÄ SKY ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  drawSkyFull(st,t);

  if(G&&G.scene==='battle'){
    drawBG(st);

    // ‚îÄ‚îÄ HORIZON ATMOSPHERIC HAZE ‚îÄ‚îÄ
    const hg=ctx.createLinearGradient(0,220,0,275);
    const skyBot=st.sky[1];
    hg.addColorStop(0,'transparent');
    hg.addColorStop(1,skyBot.replace('#','rgba(')
      .replace(/(..)(..)(..)$/,(_,r,g,b)=>`${parseInt(r,16)},${parseInt(g,16)},${parseInt(b,16)},.38)`));
    ctx.fillStyle=hg;ctx.fillRect(0,220,CW,55);

    drawGround(st);

    // ‚îÄ‚îÄ DEPTH-SORTED DRAW ‚îÄ‚îÄ
    const props=[];
    if(G.stageIdx!==null){
      props.push({_isProp:true,_type:'chest',x:560,y:283});
      if(STAGES[G.stageIdx]&&['forest','forest2','mushroom'].includes(STAGES[G.stageIdx].bg))
        props.push({_isProp:true,_type:'sign',x:308,y:276});
    }
    const obs=[...G.enemies,...props,{...G.pl,_isp:true}].sort((a,b)=>a.y-b.y);
    for(const o of obs){
      if(o._isProp){
        if(o._type==='chest')drawChest(o.x,o.y,t);
        if(o._type==='sign')drawSign(o.x,o.y);
      }else if(o._isp){drawPlayer(G.pl);}
      else if(o.alive||o.deathA>0){drawEnemy(o);}
    }

    // ‚îÄ‚îÄ PARTICLES (with glow) ‚îÄ‚îÄ
    for(const p of G.particles){
      const a=Math.max(0,p.life);
      if(p.glow){
        ctx.globalAlpha=a*.5;
        glow(ctx,~~p.x,~~p.y,p.size*3.5,p.color);
      }
      ctx.globalAlpha=a;
      ctx.fillStyle=p.color;
      const ps=p.size;
      ctx.fillRect(~~(p.x-ps/2),~~(p.y-ps/2),ps,ps);
      if(p.trail){// ghost trail
        ctx.globalAlpha=a*.3;
        ctx.fillRect(~~(p.x-p.vx-ps/2),~~(p.y-p.vy-ps/2),ps,ps);
      }
    }
    ctx.globalAlpha=1;

    // ‚îÄ‚îÄ ATTACK SLASH VFX ‚îÄ‚îÄ
    if(G.slashT>0){
      const sa=G.slashT,sx2=G.slashX,sy2=G.slashY,sf=G.slashF;
      ctx.save();ctx.translate(sx2,sy2);ctx.scale(sf,1);
      ctx.globalAlpha=sa*.85;
      ctx.strokeStyle=`rgba(255,240,180,${sa})`;ctx.lineWidth=3;
      ctx.beginPath();ctx.moveTo(0,-22);ctx.lineTo(18,0);ctx.lineTo(0,22);ctx.stroke();
      ctx.strokeStyle=`rgba(255,255,255,${sa*.6})`;ctx.lineWidth=1.5;
      ctx.beginPath();ctx.moveTo(2,-16);ctx.lineTo(14,0);ctx.lineTo(2,16);ctx.stroke();
      // Sparkle dots
      ctx.fillStyle=`rgba(255,255,200,${sa})`;
      [[14,-14,3],[20,0,4],[14,14,3],[6,-8,2],[6,8,2]].forEach(([cx,cy,cr])=>
        ctx.fillRect(cx-cr/2,cy-cr/2,cr,cr));
      ctx.restore();
    }

    // ‚îÄ‚îÄ FLOATING TEXTS ‚îÄ‚îÄ
    ctx.textAlign='center';
    for(const ft of G.texts){
      const a=Math.max(0,ft.life);
      ctx.globalAlpha=a;
      const fs=ft.big?11:8;
      ctx.font=`bold ${fs}px "Press Start 2P"`;
      // Drop shadow
      ctx.fillStyle='rgba(0,0,0,.7)';ctx.fillText(ft.t,~~ft.x+1,~~ft.y+1);
      // Outline
      ctx.strokeStyle='rgba(0,0,0,.85)';ctx.lineWidth=3;ctx.strokeText(ft.t,~~ft.x,~~ft.y);
      // Main color with glow
      ctx.shadowColor=ft.c;ctx.shadowBlur=ft.big?10:6;
      ctx.fillStyle=ft.c;ctx.fillText(ft.t,~~ft.x,~~ft.y);
      ctx.shadowBlur=0;
    }
    ctx.globalAlpha=1;

    // ‚îÄ‚îÄ ENEMY HP BARS (wooden-frame) ‚îÄ‚îÄ
    for(const e of G.enemies){
      if(!e.alive||e.hp>=e.maxHp)continue;
      const bw=e.isBoss?130:84,bh=e.isBoss?11:8;
      const bx=~~(e.x-bw/2),by=~~(e.y-e.sz*(e.isBoss?1.5:1.15)-bh);
      // Wooden frame bg
      ctx.fillStyle='rgba(12,4,0,.88)';
      ctx.fillRect(bx-3,by-3,bw+6,bh+8);
      ctx.strokeStyle=e.isBoss?'#c83030':'#8b5020';
      ctx.lineWidth=e.isBoss?2:1.5;ctx.strokeRect(bx-3,by-3,bw+6,bh+8);
      // Inner corner nubs
      if(e.isBoss){
        ctx.fillStyle='#c83030';
        [[-3,-3],[bw+3,-3],[-3,bh+5],[bw+3,bh+5]].forEach(([nx,ny])=>ctx.fillRect(bx+nx-2,by+ny-2,4,4));
      }
      // Bar track
      ctx.fillStyle='#280808';ctx.fillRect(bx,by,bw,bh);
      // Fill gradient
      const pct=e.hp/e.maxHp;
      const barCol=pct>0.5?'#d82828':pct>0.25?'#e85020':'#ff2020';
      const bg=ctx.createLinearGradient(bx,by,bx,by+bh);
      bg.addColorStop(0,shade(barCol,1.5));bg.addColorStop(.5,barCol);bg.addColorStop(1,shade(barCol,.7));
      ctx.fillStyle=bg;ctx.fillRect(bx,by,~~(bw*pct),bh);
      // Boss: animated pulse
      if(e.isBoss){ctx.fillStyle=`rgba(255,180,180,${.12+Math.sin(t*4)*.1})`;ctx.fillRect(bx,by,~~(bw*pct),bh);}
      // Shine strip
      ctx.fillStyle='rgba(255,255,255,.2)';ctx.fillRect(bx,by,~~(bw*pct),~~(bh*.35));
      // Track border
      ctx.strokeStyle=e.isBoss?'#6a1010':'#381008';ctx.lineWidth=1;ctx.strokeRect(bx,by,bw,bh);
      // Name
      ctx.textAlign='center';
      ctx.font=(e.isBoss?'bold ':'')+`5px "Press Start 2P"`;
      ctx.shadowColor='#000';ctx.shadowBlur=4;
      ctx.fillStyle=e.isBoss?'#ffcccc':'#f0c060';
      ctx.fillText(e.name,~~e.x,by-5);ctx.shadowBlur=0;
    }

    // ‚îÄ‚îÄ WAVE INFO PANEL ‚îÄ‚îÄ
    const wlive=G.enemies.filter(e=>e.alive).length;
    ctx.fillStyle='rgba(10,5,1,.72)';ctx.fillRect(3,300,136,26);
    ctx.strokeStyle='rgba(180,130,50,.5)';ctx.lineWidth=1;ctx.strokeRect(3,300,136,26);
    ctx.font='5px "Press Start 2P"';ctx.textAlign='left';
    ctx.fillStyle='rgba(240,190,70,.85)';ctx.fillText(`WAVE ${G.wave}/${G.maxWave}`,8,312);
    ctx.fillStyle='rgba(80,200,255,.75)';ctx.fillText(`‚öî ${wlive} enemies`,8,322);

    // ‚îÄ‚îÄ VIGNETTE OVERLAY ‚îÄ‚îÄ
    const vg=ctx.createRadialGradient(CW/2,CH/2,CW*.25,CW/2,CH/2,CW*.75);
    vg.addColorStop(0,'transparent');vg.addColorStop(1,'rgba(0,0,0,.38)');
    ctx.fillStyle=vg;ctx.fillRect(0,0,CW,CH);

    // ‚îÄ‚îÄ SCREEN FLASH (boss hit, player hit) ‚îÄ‚îÄ
    if(G.flashT>0){
      ctx.globalAlpha=G.flashT*.45;
      ctx.fillStyle=G.flashCol||'#ffffff';
      ctx.fillRect(0,0,CW,CH);
      ctx.globalAlpha=1;
    }

  } else {
    ctx.globalAlpha=.14;drawBG(st);
    const hg2=ctx.createLinearGradient(0,220,0,275);
    hg2.addColorStop(0,'transparent');hg2.addColorStop(1,'rgba(0,0,0,.3)');
    ctx.fillStyle=hg2;ctx.fillRect(0,220,CW,55);
    ctx.globalAlpha=.28;drawGround(st);ctx.globalAlpha=1;
    // Vignette on title too
    const vg2=ctx.createRadialGradient(CW/2,CH/2,CW*.2,CW/2,CH/2,CW*.7);
    vg2.addColorStop(0,'transparent');vg2.addColorStop(1,'rgba(0,0,0,.55)');
    ctx.fillStyle=vg2;ctx.fillRect(0,0,CW,CH);
  }
  ctx.restore();
}

// ‚îÄ‚îÄ SKY WITH SUN/MOON/CLOUDS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function drawSkyFull(st,t){
  const f=st.bg;
  // Base sky gradient
  const gr=ctx.createLinearGradient(0,0,0,275);
  gr.addColorStop(0,st.sky[0]);gr.addColorStop(.7,st.sky[1]);
  // Blend toward lighter horizon
  const hcol=blendHex(st.sky[1],'#ffffff',0.18);
  gr.addColorStop(1,hcol);
  ctx.fillStyle=gr;ctx.fillRect(0,0,CW,280);

  const isNature=f==='forest'||f==='forest2'||f==='mushroom';
  const isIce=f==='ice'||f==='blizzard'||f==='glacier'||f==='throne';
  const isSky=f==='sky'||f==='sky2'||f==='sky3';
  const isLava=f==='lava'||f==='lava2'||f==='ruins'||f==='forge';

  if(isNature){
    // Sun
    const sunx=520,suny=55;
    // Sun rays
    for(let i=0;i<12;i++){
      const a=i/12*Math.PI*2+t*.08,r1=32,r2=52+Math.sin(t*2+i)*.8;
      ctx.strokeStyle=`rgba(255,240,120,${.08+Math.sin(t*.5+i)*.04})`;
      ctx.lineWidth=3;ctx.beginPath();
      ctx.moveTo(sunx+Math.cos(a)*r1,suny+Math.sin(a)*r1);
      ctx.lineTo(sunx+Math.cos(a)*r2,suny+Math.sin(a)*r2);
      ctx.stroke();
    }
    // Sun corona
    glow(ctx,sunx,suny,55,`rgba(255,230,80,.2)`);
    glow(ctx,sunx,suny,30,`rgba(255,245,150,.35)`);
    // Sun disk
    ctx.fillStyle='#fff8d0';ctx.beginPath();ctx.arc(sunx,suny,18,0,Math.PI*2);ctx.fill();
    ctx.fillStyle='#fffde0';ctx.beginPath();ctx.arc(sunx,suny,14,0,Math.PI*2);ctx.fill();
    ctx.fillStyle='#ffffff';ctx.beginPath();ctx.arc(sunx,suny,10,0,Math.PI*2);ctx.fill();
    // Lens flare streak
    ctx.strokeStyle='rgba(255,255,220,.12)';ctx.lineWidth=8;
    ctx.beginPath();ctx.moveTo(sunx-80,suny-24);ctx.lineTo(sunx+80,suny+24);ctx.stroke();
    // Clouds (3 parallax layers)
    for(let i=0;i<4;i++){// far layer, small grey
      const cx=(i*190+t*6)%780-30,cy=35+i*18;
      dFluffyCloud(ctx,cx,cy,'#c0ccd8',0.55,38);
    }
    for(let i=0;i<3;i++){// mid layer
      const cx=(i*240+t*11+80)%800-30,cy=28+i*25;
      dFluffyCloud(ctx,cx,cy,'#dde8f0',0.75,52);
    }
    for(let i=0;i<3;i++){// near layer, big white
      const cx=(i*260+t*16+140)%830-40,cy=18+i*20;
      dFluffyCloud(ctx,cx,cy,'#eef4f8',0.95,70);
    }
  }else if(isIce){
    // Moon
    const mx=120,my=60;
    glow(ctx,mx,my,50,`rgba(160,190,255,.2)`);
    glow(ctx,mx,my,25,`rgba(200,220,255,.3)`);
    ctx.fillStyle='#c8d8f0';ctx.beginPath();ctx.arc(mx,my,18,0,Math.PI*2);ctx.fill();
    ctx.fillStyle='#d8e8ff';ctx.beginPath();ctx.arc(mx,my,14,0,Math.PI*2);ctx.fill();
    ctx.fillStyle='rgba(60,80,140,.25)';ctx.beginPath();ctx.arc(mx+5,my-4,10,0,Math.PI*2);ctx.fill();// moon shadow
    // Stars
    for(let i=0;i<30;i++){
      const sx=(i*67+117)%700,sy=(i*43+29)%200;
      const sa=.3+Math.sin(t*2.5+i)*.25;
      ctx.fillStyle=`rgba(220,230,255,${sa})`;
      ctx.fillRect(sx,sy,i%4?1:2,i%4?1:2);
    }
    // Ice clouds (grey/blue)
    for(let i=0;i<3;i++){const cx=(i*230+t*8)%780-30,cy=22+i*28;dFluffyCloud(ctx,cx,cy,'#8899bb',0.55,55);}
  }else if(isLava){
    // Lava sun (dark red)
    const sx2=450,sy2=60;
    glow(ctx,sx2,sy2,50,`rgba(255,80,0,.25)`);
    ctx.fillStyle='#c84010';ctx.beginPath();ctx.arc(sx2,sy2,20,0,Math.PI*2);ctx.fill();
    ctx.fillStyle='#e05020';ctx.beginPath();ctx.arc(sx2,sy2,15,0,Math.PI*2);ctx.fill();
    ctx.fillStyle='#ff8040';ctx.beginPath();ctx.arc(sx2,sy2,8,0,Math.PI*2);ctx.fill();
    // Smoke clouds
    for(let i=0;i<4;i++){const cx=(i*180+t*9+60)%790-20,cy=18+i*22;dFluffyCloud(ctx,cx,cy,'#4a3020',0.45,45);}
  }else if(isSky){
    // Two moons / aurora
    glow(ctx,350,90,90,`rgba(100,60,200,.2)`);
    for(let i=0;i<35;i++){const sx2=(i*61+37)%700,sy2=(i*43+29)%220;ctx.fillStyle=`rgba(220,200,255,${.25+Math.sin(t*2+i)*.2})`;ctx.fillRect(sx2,sy2,i%3?1:2,i%3?1:2);}
    // Aurora bands
    for(let i=0;i<3;i++){
      const ay=40+i*30,aa=.07+Math.sin(t*.8+i)*.05;
      ctx.fillStyle=`rgba(${100+i*40},${60+i*30},255,${aa})`;
      ctx.fillRect(0,ay,CW,20+i*5);
    }
    // Dark storm clouds
    for(let i=0;i<4;i++){const cx=(i*190+t*10)%790-20,cy=18+i*28;dFluffyCloud(ctx,cx,cy,'#2a1860',0.65,58);}
  }else if(f==='abyss'){
    // Blood moon
    const mx2=350,my2=70;
    glow(ctx,mx2,my2,60,`rgba(180,0,0,.3)`);
    glow(ctx,mx2,my2,30,`rgba(255,20,0,.4)`);
    ctx.fillStyle='#a00000';ctx.beginPath();ctx.arc(mx2,my2,22,0,Math.PI*2);ctx.fill();
    ctx.fillStyle='#cc1010';ctx.beginPath();ctx.arc(mx2,my2,16,0,Math.PI*2);ctx.fill();
    ctx.fillStyle='#ff3020';ctx.beginPath();ctx.arc(mx2,my2,8,0,Math.PI*2);ctx.fill();
    for(let i=0;i<20;i++){const sx2=(i*61+37)%700,sy2=(i*43+29)%220;ctx.fillStyle=`rgba(255,20,0,${.2+Math.sin(t*3+i)*.15})`;ctx.fillRect(sx2,sy2,2,2);}
  }else{// swamp - overcast
    for(let i=0;i<4;i++){const cx=(i*175+t*7)%790-20,cy=15+i*26;dFluffyCloud(ctx,cx,cy,'#3a4a28',0.5,48);}
  }
}

// ‚îÄ‚îÄ BACKGROUNDS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function drawBG(st){
  const t=G?G.bgA:0,f=st.bg;

  // ‚îÄ‚îÄ FOREST / NATURE biomes ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  if(f==='forest'||f==='forest2'||f==='mushroom'){
    // Distant mountains
    const mc1=f==='forest'?'#6090a0':'#507890';
    dMtnSmooth(ctx,120,200,200,mc1);dMtnSmooth(ctx,350,190,180,'#708fa0');dMtnSmooth(ctx,560,210,150,mc1);
    // Snow caps
    ctx.fillStyle='#e8f4f8';dMtnSmooth(ctx,120,180,50,'#e8f4f8');dMtnSmooth(ctx,350,172,44,'#e8f4f8');
    // Rolling hills background
    ctx.fillStyle=f==='darkforest'?'#2a5018':'#4a8830';
    ctx.beginPath();ctx.moveTo(0,240);
    for(let x=0;x<=700;x+=14)ctx.lineTo(x,230+Math.sin(x*.018+1)*22+Math.sin(x*.031)*12);
    ctx.lineTo(700,420);ctx.lineTo(0,420);ctx.fill();
    // Middle hills
    ctx.fillStyle=f==='darkforest'?'#386024':'#60a840';
    ctx.beginPath();ctx.moveTo(0,258);
    for(let x=0;x<=700;x+=10)ctx.lineTo(x,248+Math.sin(x*.022+2)*18+Math.sin(x*.04)*8);
    ctx.lineTo(700,420);ctx.lineTo(0,420);ctx.fill();
    // Tall background trees (layered)
    for(let i=0;i<9;i++){
      const tx=i*80+Math.sin(i*2.3)*20,tw=55+Math.sin(i*1.7)*15;
      dPixelTree(ctx,tx,200,tw,f==='darkforest'?'#1a4010':'#2a6818');
    }
    // Medium trees
    for(let i=0;i<6;i++){
      const tx=30+i*110+Math.sin(i*1.9)*15,tw=70+Math.sin(i*2.1)*20;
      dPixelTree(ctx,tx,230,tw,f==='darkforest'?'#226014':'#368a20');
    }
    // Foreground large trees (sides)
    dPixelTree(ctx,-20,260,90,'#2a7018');dPixelTree(ctx,640,250,85,'#248018');
    // Castle in distance
    if(f==='forest'){dDistantCastle(ctx,460,120);}
    // Waterfall
    if(f==='forest'){dWaterfall(ctx,530,145,t);}
    // Floating particles (pollen/fireflies)
    for(let i=0;i<8;i++){
      const px=(i*97+t*18*(i%3+.5))%720-10;
      const py=120+Math.sin(t*1.2+i*.8)*40+(i%4)*20;
      ctx.fillStyle=f==='darkforest'?`rgba(140,255,100,${.4+Math.sin(t*2+i)*.3})`:`rgba(255,240,100,${.5+Math.sin(t*2+i)*.3})`;
      ctx.fillRect(~~px,~~py,3,3);
    }
    // Ground huts/campfire
    if(f==='forest'){dHut(ctx,60,245);dCampfire(ctx,190,262,t);}
    // Mushrooms
    if(f==='mushroom'){
      ['#dd2060','#2060cc','#cc6020','#20aa60','#8820cc'].forEach((mc,i)=>dBigMsh(ctx,60+i*140,275,mc));
      for(let i=0;i<14;i++){const px=(i*57+t*10*(i%3+.4))%720,py=(i*41+t*7)%220+50;ctx.fillStyle=`rgba(100,255,120,${.35+Math.sin(t*2+i)*.2})`;ctx.fillRect(~~px,~~py,2,2);}
    }
    // Dark forest vines
    if(f==='darkforest'){
      ctx.strokeStyle='rgba(40,0,60,.55)';ctx.lineWidth=2;
      for(let i=0;i<7;i++){ctx.beginPath();ctx.moveTo(i*110,250+Math.sin(i)*10);ctx.bezierCurveTo(i*110+30,210,i*110+60,230,i*110+90,255);ctx.stroke();}
    }
  }

  // ‚îÄ‚îÄ DARK FOREST ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  if(f==='darkforest'){
    dMtnSmooth(ctx,150,210,160,'#183820');dMtnSmooth(ctx,400,200,180,'#204828');
    for(let i=0;i<9;i++)dPixelTree(ctx,i*80,195,60+i%3*10,'#0e2a10');
    for(let i=0;i<6;i++)dPixelTree(ctx,30+i*115,230,80,'#162e14');
    dPixelTree(ctx,-20,250,95,'#122812');dPixelTree(ctx,640,245,88,'#122812');
    for(let i=0;i<8;i++){const px=(i*97+t*14*(i%3+.5))%720-10,py=110+Math.sin(t*1.2+i*.8)*35+(i%4)*22;ctx.fillStyle=`rgba(100,255,80,${.4+Math.sin(t*2+i)*.3})`;ctx.fillRect(~~px,~~py,3,3);}
  }

  // ‚îÄ‚îÄ LAVA biomes ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  if(f==='lava'||f==='lava2'||f==='ruins'||f==='forge'){
    // Volcanic mountains
    const lc=f==='lava'?'#5a2808':'#4a1c04';
    dMtnSmooth(ctx,180,220,180,lc);dMtnSmooth(ctx,420,200,160,'#3a1606');dMtnSmooth(ctx,600,230,120,'#4a1a06');
    // Lava glow on mountains
    glow(ctx,220,180,80,`rgba(255,${80+Math.sin(t*2)*40},0,.35)`);
    glow(ctx,460,160,70,`rgba(255,100,0,.3)`);
    // Lava falls
    dLava(ctx,220,180,t);
    if(f==='lava2'||f==='ruins'){dLava(ctx,440,190,t+1.4);dLava(ctx,100,200,t+2.8);}
    // Chains/ruins
    dChain(ctx,50,10,100,185);dChain(ctx,590,8,555,170);
    if(f==='ruins'){
      ctx.fillStyle='#5a3010';for(let i=0;i<6;i++)ctx.fillRect(30+i*120,180-i*8,22,100);
      ctx.fillStyle='#3a1c08';for(let i=0;i<3;i++)ctx.fillRect(80+i*220,150,40,100);
    }
    if(f==='forge'){
      ctx.fillStyle='#2a0e04';ctx.fillRect(0,80,CW,200);
      for(let i=0;i<3;i++){
        ctx.fillStyle='#4a1c08';ctx.fillRect(50+i*220,90,90,155);
        ctx.fillStyle='#2a0e04';ctx.fillRect(60+i*220,100,70,140);
        glow(ctx,95+i*220,175,38,`rgba(255,${80+~~(Math.sin(t*3+i)*60)},0,${.45+Math.sin(t*2+i)*.32})`);
        ctx.fillStyle=`rgba(255,${100+~~(Math.sin(t*4+i)*60)},0,.7)`;ctx.fillRect(72+i*220,140,46,65);
        // Chimney smoke
        for(let s=0;s<4;s++){const sx=88+i*220+Math.sin(t*2+s)*10,sy=70-s*12+~~(t*8%12);ctx.fillStyle=`rgba(120,80,60,${.4-s*.09})`;ctx.fillRect(~~sx,~~sy,10+s*2,8);}
      }
    }
    dSkull(ctx,70,185,'#8a5020');dSkull(ctx,110+~~(Math.sin(t*.8)*15),100+~~(Math.sin(t*.5)*12),'#a06020');
    // Embers
    for(let i=0;i<12;i++){const ex=(i*61+t*20*(i%3+.5))%720,ey=(i*43+t*16)%240+30;ctx.fillStyle=`rgba(255,${80+i*14},0,${.5+Math.sin(t*3+i)*.3})`;ctx.fillRect(~~ex,~~ey,2+i%3,2);}
  }

  // ‚îÄ‚îÄ ICE biomes ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  if(f==='ice'||f==='blizzard'||f==='glacier'||f==='throne'){
    // Snowy mountains
    dMtnSmooth(ctx,200,220,200,'#4878a8');dMtnSmooth(ctx,460,200,180,'#3868a0');dMtnSmooth(ctx,620,230,140,'#4878a8');
    // Snow on mountains
    dMtnSmooth(ctx,200,188,80,'#d8e8f8');dMtnSmooth(ctx,460,180,70,'#d0e0f0');
    // Ice castle
    dDistantIceCastle(ctx,220,90);
    // Ice crystals foreground
    for(let i=0;i<10;i++)dCrystal(ctx,20+i*72,265-(30+Math.sin(i*2.2)*20),30+Math.sin(i*2.2)*20,'#5090c8');
    // Snowfall
    ctx.fillStyle='#d8ecf8';
    const nf2=f==='blizzard'?50:28;
    for(let i=0;i<nf2;i++){const sx=(i*61+t*20*((i%3)+.5))%720,sy=(i*43+t*14)%280;ctx.fillRect(~~sx,~~sy,f==='blizzard'?3:2,f==='blizzard'?3:2);}
    if(f==='throne')glow(ctx,350,160,90,'rgba(60,120,255,.22)');
    // Icicles from top
    for(let i=0;i<12;i++){const ix=20+i*58;ctx.fillStyle='#90c0e0';ctx.fillRect(ix,0,8,8+i%4*6);ctx.fillStyle='#c0e0f8';ctx.fillRect(ix+1,0,3,6+i%4*5);}
  }

  // ‚îÄ‚îÄ SWAMP biomes ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  if(f==='swamp'||f==='swamp2'||f==='swamp3'||f==='swamp4'){
    dMtnSmooth(ctx,160,215,150,'#304820');dMtnSmooth(ctx,420,205,160,'#283c18');
    for(let i=0;i<8;i++)dPixelTree(ctx,i*90+10,200,65+i%3*12,'#182e10');
    for(let i=0;i<5;i++)dPixelTree(ctx,40+i*135,235,85,'#1c3612');
    dPixelTree(ctx,-15,255,100,'#162a0e');dPixelTree(ctx,640,248,95,'#162a0e');
    // Swamp mist
    for(let i=0;i<6;i++){const mx=(i*120+t*8*(i%2+.4))%740-20,mw=80+i*12;ctx.fillStyle=`rgba(80,160,60,${.12+Math.sin(t+i)*.06})`;ctx.fillRect(~~mx,230+i%3*10,mw,22);}
    // Poison bubbles
    for(let i=0;i<10;i++){const bx=(i*72+t*14*(i%3+.4))%720,by=230+(~~(Math.sin(t*2+i)*8));ctx.strokeStyle=`rgba(100,220,30,${.35+Math.sin(t*3+i)*.2})`;ctx.lineWidth=1;ctx.beginPath();ctx.arc(~~bx,~~by,3+i%4,0,Math.PI*2);ctx.stroke();}
    if(f==='swamp4')glow(ctx,350,170,120,'rgba(20,100,10,.18)');
    // Dead trees
    for(let i=0;i<4;i++){const dx=80+i*180;ctx.fillStyle='#2a3818';ctx.fillRect(dx,150,8,120);ctx.fillRect(dx-18,175,22,5);ctx.fillRect(dx+4,190,20,4);}
  }

  // ‚îÄ‚îÄ SKY biomes ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  if(f==='sky'||f==='sky2'||f==='sky3'){
    // Floating islands
    for(let i=0;i<3;i++){
      const ix=80+i*240+Math.sin(t*.4+i)*18,iy=80+i*42+Math.sin(t*.3+i*.8)*10;
      ctx.fillStyle='#5040b0';ctx.fillRect(~~ix,~~iy,80,16);ctx.fillRect(~~ix+8,~~iy-8,64,12);
      ctx.fillStyle='#6858c8';ctx.fillRect(~~ix+2,~~iy,76,6);
      // Grass on island
      ctx.fillStyle='#7050d0';ctx.fillRect(~~ix+8,~~iy-10,64,6);
      ctx.fillStyle='#8a70e8';ctx.fillRect(~~ix+8,~~iy-12,8,4);ctx.fillRect(~~ix+20,~~iy-14,8,6);ctx.fillRect(~~ix+36,~~iy-12,8,4);ctx.fillRect(~~ix+52,~~iy-13,8,5);
    }
    // Clouds (vibrant)
    const cloudCol=f==='sky3'?'#8060c0':'#6850b0';
    for(let i=0;i<5;i++)dPixelCloud(ctx,(i*160+t*10)%760-20,45+i*36,cloudCol);
    // Lightning
    if(Math.sin(t*(f==='sky3'?2.5:3.8))>.82){
      ctx.strokeStyle=`rgba(220,180,255,${.85+Math.sin(t*8)*.15})`;ctx.lineWidth=2;
      ctx.beginPath();ctx.moveTo(310,0);ctx.lineTo(292,75);ctx.lineTo(320,100);ctx.lineTo(300,195);ctx.stroke();
      glow(ctx,305,100,40,'rgba(200,150,255,.35)');
    }
    // Towers
    dTower(ctx,70,60,50,165);dTower(ctx,540,40,60,185);
    // Stars
    for(let i=0;i<20;i++){const sx=(i*61+37)%700,sy=(i*43+29)%220;ctx.fillStyle=`rgba(220,200,255,${.3+Math.sin(t*2+i)*.2})`;ctx.fillRect(sx,sy,2,2);}
  }

  // ‚îÄ‚îÄ ABYSS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  if(f==='abyss'){
    // Hellish sky gradient
    const ag=ctx.createLinearGradient(0,0,0,270);
    ag.addColorStop(0,'#380008');ag.addColorStop(1,'#200004');
    ctx.fillStyle=ag;ctx.fillRect(0,0,CW,270);
    // Fire pillars
    for(let i=0;i<5;i++)dFirePillar(ctx,60+i*155,100,t+i,true);
    // Dark jagged mountains
    dMtnSmooth(ctx,180,230,180,'#280004');dMtnSmooth(ctx,450,215,160,'#200002');
    // Runes
    ctx.font='16px monospace';
    '·ö†·ö¢·ö¶·ö®·ö±·ö≤·õó·õè'.split('').forEach((r,i)=>{ctx.fillStyle=`rgba(255,20,0,${.3+Math.sin(t*2.5+i)*.22})`;ctx.fillText(r,42+i*80,35+~~(Math.sin(t+i)*10));});
    // Blood rain
    for(let i=0;i<16;i++){const rx=(i*47+t*25*(i%3+.4))%720,ry=(i*39+t*20)%260;ctx.fillStyle=`rgba(200,0,30,${.4+Math.sin(t*4+i)*.3})`;ctx.fillRect(~~rx,~~ry,1,6+i%4);}
    glow(ctx,350,200,130,'rgba(180,0,0,.18)');
  }
}

function drawGround(st){
  const t=G?G.bgA:0;
  const f=st.bg;
  const isNature=f==='forest'||f==='forest2'||f==='mushroom'||f==='darkforest';
  const isIce=f==='ice'||f==='blizzard'||f==='glacier'||f==='throne';
  const isSwamp=f==='swamp'||f==='swamp2'||f==='swamp3'||f==='swamp4';
  const isSky=f.startsWith('sky');

  if(isNature){
    // Base grass gradient
    const gg=ctx.createLinearGradient(0,258,0,420);
    gg.addColorStop(0,f==='darkforest'?'#347016':'#52a82e');
    gg.addColorStop(.12,f==='darkforest'?'#28580e':'#3e8c20');
    gg.addColorStop(.45,f==='darkforest'?'#1c3c0a':'#2a6014');
    gg.addColorStop(1,f==='darkforest'?'#0e1e04':'#142808');
    ctx.fillStyle=gg;ctx.fillRect(0,258,CW,162);
    // Grass surface detail
    const gc=f==='darkforest'?'#3e8018':'#68c038';
    for(let x=0;x<CW;x+=3)if((x*7+11)%5)ctx.fillStyle=gc,ctx.fillRect(x,258+~~(Math.sin(x*.09)*3),2,4+~~(Math.sin(x*.15)*2));
    // Tall grass tufts
    const gtc=f==='darkforest'?'#2a6010':'#4a9c20',gtc2=f==='darkforest'?'#38800e':'#5ab828';
    [20,55,88,120,155,420,470,530,580,620,660].forEach(gx=>{
      ctx.fillStyle=gtc;ctx.fillRect(gx,252,3,12);ctx.fillRect(gx+4,254,3,10);ctx.fillRect(gx+8,251,3,13);
      ctx.fillStyle=gtc2;ctx.fillRect(gx+1,252,2,8);ctx.fillRect(gx+5,254,2,7);
    });
    // Dirt path
    const pg=ctx.createLinearGradient(0,295,0,380);
    pg.addColorStop(0,'#9a7040');pg.addColorStop(1,'#6a4820');
    ctx.fillStyle=pg;ctx.fillRect(150,298,400,100);
    ctx.fillStyle='rgba(80,50,15,.35)';
    for(let px=155;px<545;px+=18){ctx.fillRect(px,302,8,3);ctx.fillRect(px+5,310,6,2);ctx.fillRect(px+2,318,9,2);}
    // Path soft edges
    const pe1=ctx.createLinearGradient(150,0,172,0);
    pe1.addColorStop(0,f==='darkforest'?'rgba(28,56,10,.9)':'rgba(42,96,20,.9)');pe1.addColorStop(1,'transparent');
    ctx.fillStyle=pe1;ctx.fillRect(150,298,22,100);
    const pe2=ctx.createLinearGradient(528,0,550,0);
    pe2.addColorStop(0,'transparent');pe2.addColorStop(1,f==='darkforest'?'rgba(28,56,10,.9)':'rgba(42,96,20,.9)');
    ctx.fillStyle=pe2;ctx.fillRect(528,298,22,100);
    // Path stones
    [[185,318,12,7],[240,308,10,6],[300,322,14,8],[370,314,11,7],[435,320,13,7],[490,310,10,6]].forEach(([sx,sy,sw,sh])=>{
      ctx.fillStyle='#7a8898';ctx.fillRect(sx,sy,sw,sh);
      ctx.fillStyle='#92a0b0';ctx.fillRect(sx,sy,sw,~~(sh*.4));
      ctx.fillStyle='rgba(0,0,0,.25)';ctx.fillRect(sx+2,sy+sh-2,sw-2,3);
    });
    // Flowers
    [[105,268,'#ff6080'],[138,272,'#ffee40'],[185,265,'#ff6080'],[220,271,'#ffffff'],
     [490,269,'#ff80c0'],[535,267,'#ffee40'],[570,272,'#80ffff'],[610,268,'#ff6080'],
     [65,290,'#ffee40'],[640,285,'#ffffff']].forEach(([fx,fy,fc])=>{
      ctx.fillStyle='#2a6010';ctx.fillRect(fx,fy+6,2,8);
      ctx.fillStyle=fc;
      ctx.fillRect(fx-3,fy,3,3);ctx.fillRect(fx+2,fy,3,3);ctx.fillRect(fx,fy-3,3,3);ctx.fillRect(fx,fy+2,3,3);
      ctx.fillStyle='#ffff80';ctx.fillRect(fx,fy,3,3);
    });
    // Pebbles
    [[130,295,5],[168,302,4],[260,295,6],[330,290,4],[410,294,5],[460,298,4],[585,292,5]].forEach(([px,py,ps])=>{
      ctx.fillStyle='#606878';ctx.fillRect(px,py,ps,~~(ps*.7));
      ctx.fillStyle='#808898';ctx.fillRect(px,py,ps,~~(ps*.35));
    });
    // Bushes
    [[56,278,28],[290,274,22],[490,276,26],[660,280,20]].forEach(([bx,by,bw])=>{
      const bc=f==='darkforest'?'#2a6010':'#38a020';
      ctx.fillStyle=shade(bc,.7);ctx.fillRect(bx-~~(bw/2),by+4,bw,10);
      ctx.fillStyle=bc;ctx.fillRect(bx-~~(bw/2),by,bw,12);
      ctx.fillStyle=shade(bc,1.25);ctx.fillRect(bx-~~(bw/2)+2,by,bw-4,5);
      ctx.fillStyle='#ff4040';ctx.fillRect(~~(bx+bw*.1),~~(by+6),3,3);
    });
    dHut(ctx,48,248);dCampfire(ctx,192,264,t);

  }else if(isIce){
    const ig=ctx.createLinearGradient(0,262,0,420);
    ig.addColorStop(0,'#c8dff0');ig.addColorStop(.15,'#a8ccde');ig.addColorStop(1,'#6090b8');
    ctx.fillStyle=ig;ctx.fillRect(0,262,CW,158);
    ctx.fillStyle='#deeefa';
    for(let x=0;x<CW;x+=4)if((x*3+5)%7)ctx.fillRect(x,262+~~(Math.sin(x*.09)*4),3,3);
    for(let bx=0;bx<CW;bx+=40){ctx.fillStyle='rgba(255,255,255,.3)';ctx.beginPath();ctx.ellipse(bx+20,262,18,6,0,0,Math.PI*2);ctx.fill();}
    ctx.strokeStyle='rgba(100,170,230,.5)';ctx.lineWidth=1.5;
    [[40,274,130,290],[200,268,340,284],[380,272,470,288],[510,276,620,270]].forEach(([x1,y1,x2,y2])=>{
      ctx.beginPath();ctx.moveTo(x1,y1);ctx.lineTo(~~((x1+x2)/2)+rng(-10,10),~~((y1+y2)/2)+rng(-5,5));ctx.lineTo(x2,y2);ctx.stroke();
    });
    for(let i=0;i<20;i++){const sx=(i*71+23)%CW,sy=264+~~(Math.sin(i*1.3)*5);ctx.fillStyle=`rgba(200,230,255,${.4+Math.sin(t*4+i)*.35})`;ctx.fillRect(sx,sy,2,2);}
    for(let i=0;i<16;i++){const ix=22+i*44;ctx.fillStyle='#a8d0ee';ctx.fillRect(ix,263,6,8+i%5*4);ctx.fillStyle='#c8e8ff';ctx.fillRect(ix+1,263,3,5+i%5*3);}

  }else if(isSwamp){
    const sg=ctx.createLinearGradient(0,260,0,420);
    sg.addColorStop(0,'#2c4214');sg.addColorStop(.3,'#1e2e0c');sg.addColorStop(1,'#0e1606');
    ctx.fillStyle=sg;ctx.fillRect(0,260,CW,160);
    ctx.fillStyle='#3a4c18';
    for(let x=0;x<CW;x+=5)if((x*3+7)%6)ctx.fillRect(x,260+~~(Math.sin(x*.09)*3),3,4);
    [[110,292,70,22],[310,308,90,24],[510,296,65,20],[190,338,80,22]].forEach(([px,py,pw,ph])=>{
      const pg2=ctx.createRadialGradient(px,py,0,px,py,pw*.7);
      pg2.addColorStop(0,'rgba(40,90,20,.75)');pg2.addColorStop(1,'rgba(20,50,10,.4)');
      ctx.fillStyle=pg2;ctx.beginPath();ctx.ellipse(px,py,pw,ph,0,0,Math.PI*2);ctx.fill();
    });
    for(let i=0;i<8;i++){const bx=(i*92+t*18*(i%3+.5))%700,by=270+(Math.sin(t*2.5+i)*10);ctx.strokeStyle=`rgba(120,220,40,${.3+Math.sin(t*3+i)*.2})`;ctx.lineWidth=1;ctx.beginPath();ctx.arc(~~bx,~~by,3+i%3,0,Math.PI*2);ctx.stroke();}
    ctx.strokeStyle='#2a3c10';ctx.lineWidth=3;
    [[50,312,140,278],[200,316,260,264],[510,308,580,272],[610,322,648,272]].forEach(([x1,y1,x2,y2])=>{ctx.beginPath();ctx.moveTo(x1,y1);ctx.bezierCurveTo(x1+10,y1-20,x2-10,y2+18,x2,y2);ctx.stroke();});

  }else if(isSky){
    const sg2=ctx.createLinearGradient(0,264,0,420);
    sg2.addColorStop(0,'#4838b8');sg2.addColorStop(.3,'#2e2080');sg2.addColorStop(1,'#14103a');
    ctx.fillStyle=sg2;ctx.fillRect(0,264,CW,156);
    const pe=ctx.createLinearGradient(0,264,0,285);
    pe.addColorStop(0,'rgba(160,140,255,.4)');pe.addColorStop(1,'transparent');
    ctx.fillStyle=pe;ctx.fillRect(0,264,CW,21);
    for(let tx=0;tx<CW;tx+=28)if((tx*3)%7<4){ctx.fillStyle=`rgba(100,80,200,${.2+Math.sin(t*2+tx*.03)*.1})`;ctx.fillRect(tx,265,22,8);ctx.fillStyle='rgba(180,160,255,.15)';ctx.fillRect(tx,265,22,3);}
    for(let i=0;i<25;i++){const sx=(i*67+29)%CW,sy=280+(i*43)%130;ctx.fillStyle=`rgba(200,190,255,${.2+Math.sin(t*3+i)*.18})`;ctx.fillRect(sx,sy,i%3?1:2,i%3?1:2);}

  }else{
    const lg=ctx.createLinearGradient(0,263,0,420);
    lg.addColorStop(0,f==='abyss'?'#3c0808':'#8a3810');
    lg.addColorStop(1,f==='abyss'?'#220404':'#4e1e06');
    ctx.fillStyle=lg;ctx.fillRect(0,263,CW,157);
    ctx.lineWidth=2;
    [[40,266,125,308],[175,265,258,315],[342,265,292,307],[462,265,544,302],[138,302,177,314],[392,300,494,333]].forEach(([x1,y1,x2,y2])=>{
      const a=.45+Math.sin(t*1.9+x1*.022)*.5;
      ctx.strokeStyle=`rgba(255,${f==='abyss'?0:120},0,${a})`;
      ctx.shadowColor=st.ac;ctx.shadowBlur=8;
      ctx.beginPath();ctx.moveTo(x1,y1);ctx.lineTo(~~((x1+x2)/2)+rng(-4,4),~~((y1+y2)/2));ctx.lineTo(x2,y2);ctx.stroke();
    });
    ctx.shadowBlur=0;
    if(f!=='abyss')[180,350,520].forEach(lx=>{glow(ctx,lx,290,40,`rgba(255,120,0,.12)`);});
    if(f==='abyss')[140,350,560].forEach(lx=>{glow(ctx,lx,290,40,`rgba(200,0,0,.18)`);});
  }
}


// ‚îÄ‚îÄ PLAYER SPRITE (Knight) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function drawPlayer(p){
  const bob=(p.moving?Math.sin(p.anim*2):Math.sin(p.anim*.5))*2;
  const ls=p.moving?Math.sin(p.anim*4)*5:0;
  const rs=p.moving?-Math.sin(p.anim*4)*5:0;
  const sa=p.moving?Math.sin(p.anim*4)*5:0;
  ctx.save();ctx.translate(~~p.x,~~(p.y+bob));ctx.scale(p.facing,1);
  if(p.invT>0&&Math.floor(p.invT*20)%2===0){ctx.restore();return;}
  // Shadow
  ctx.fillStyle='rgba(0,0,0,.3)';ctx.beginPath();ctx.ellipse(0,28,14,4,0,0,Math.PI*2);ctx.fill();
  // LEFT LEG
  ctx.fillStyle='#3a7a28';ctx.fillRect(-9,14+ls,8,10);
  ctx.fillStyle='#788898';ctx.fillRect(-10,20+ls,9,6);ctx.fillStyle='#98a8b8';ctx.fillRect(-10,20+ls,9,3);
  ctx.fillStyle='#48586a';ctx.fillRect(-11,26+ls,10,5);
  // RIGHT LEG
  ctx.fillStyle='#3a7a28';ctx.fillRect(1,14+rs,8,10);
  ctx.fillStyle='#788898';ctx.fillRect(1,20+rs,9,6);ctx.fillStyle='#98a8b8';ctx.fillRect(1,20+rs,9,3);
  ctx.fillStyle='#48586a';ctx.fillRect(1,26+rs,10,5);
  // TORSO
  ctx.fillStyle='#3a8828';ctx.fillRect(-10,2,20,14);
  ctx.fillStyle='#8898a8';ctx.fillRect(-9,1,18,13);
  ctx.fillStyle='#b0c0d0';ctx.fillRect(-8,1,16,4);// chest highlight
  ctx.fillStyle='#5a6878';ctx.fillRect(-9,10,18,4);// chest shadow
  ctx.fillStyle='#30a030';ctx.fillRect(-1,2,2,8);ctx.fillStyle='#30a030';ctx.fillRect(-4,5,8,2);// green cross
  ctx.fillStyle='#8a5a20';ctx.fillRect(-9,13,18,3);// belt
  ctx.fillStyle='#f0c050';ctx.fillRect(-2,13,4,3);// buckle
  // SHIELD ARM (left)
  ctx.fillStyle='#7888a0';ctx.fillRect(-17,0-sa*.4,8,12);
  ctx.fillStyle='#98a8c0';ctx.fillRect(-16,0-sa*.4,6,4);
  // SHIELD
  const sy=-sa*.4;
  ctx.fillStyle='#1848a0';ctx.fillRect(-28,-6+sy,20,24);
  ctx.fillStyle='#2868d0';ctx.fillRect(-27,-5+sy,18,10);// top highlight
  ctx.fillStyle='#0a2870';ctx.fillRect(-27,9+sy,18,10);// bottom shadow
  ctx.fillStyle='#d8b820';ctx.fillRect(-19,-7+sy,3,26);// gold V stripe
  ctx.fillStyle='#d8b820';ctx.fillRect(-29,2+sy,22,3);// gold H stripe
  ctx.fillStyle='#48a848';ctx.fillRect(-26,-6+sy,7,12);// green top-left
  ctx.fillStyle='#48a848';ctx.fillRect(-26,7+sy,7,10);// green bottom-left
  ctx.fillStyle='#f0d840';ctx.fillRect(-20,-1+sy,4,4);// center gem
  ctx.strokeStyle='#d8b820';ctx.lineWidth=1;ctx.strokeRect(-28,-6+sy,20,24);
  // SWORD ARM (right)
  ctx.fillStyle='#7888a0';ctx.fillRect(9,0+sa*.4,8,12);
  ctx.fillStyle='#98a8c0';ctx.fillRect(10,0+sa*.4,6,4);
  // SWORD
  ctx.fillStyle='#8a6020';ctx.fillRect(14,0+sa*.5,5,5);// grip
  ctx.fillStyle='rgba(0,0,0,.2)';ctx.fillRect(12,-1+sa*.5,2,20);// grip wrap
  ctx.fillStyle='#c8932a';ctx.fillRect(11,-3+sa*.5,12,4);// crossguard
  ctx.fillStyle='#e0d0a0';ctx.fillRect(11,-3+sa*.5,12,2);// crossguard highlight
  ctx.fillStyle='#d0dce8';ctx.fillRect(14,-22+sa*.5,4,24);// blade
  ctx.fillStyle='#f0f8ff';ctx.fillRect(14,-22+sa*.5,2,12);// blade highlight
  ctx.fillStyle='#9090a0';ctx.fillRect(14,-22+sa*.5,4,2);// tip
  // HEAD
  ctx.fillStyle='#c8a878';ctx.fillRect(-4,-4,8,6);// neck
  ctx.fillStyle='#7888a0';ctx.fillRect(-9,-20,18,18);// helmet
  ctx.fillStyle='#b0c0d0';ctx.fillRect(-8,-20,16,6);// top shine
  ctx.fillStyle='#5a6880';ctx.fillRect(-9,-6,18,4);// bottom shadow
  ctx.fillStyle='#2a3848';ctx.fillRect(-6,-18,12,9);// visor area
  ctx.fillStyle='#1a2838';ctx.fillRect(-5,-17,10,7);
  ctx.fillStyle='#40d0f0';ctx.fillRect(-5,-15,4,3);// visor slit left
  ctx.fillStyle='#40d0f0';ctx.fillRect(1,-15,4,3);// visor slit right
  ctx.fillStyle='#6878a0';ctx.fillRect(-9,-13,4,7);// left cheekguard
  ctx.fillStyle='#6878a0';ctx.fillRect(5,-13,4,7);// right cheekguard
  ctx.fillStyle='#a0b0c0';ctx.fillRect(-2,-22,4,4);// crest base
  // GREEN PLUME
  for(let i=0;i<9;i++){
    const ph=Math.sin(p.anim*3.5+i*.35)*2.5;
    ctx.fillStyle=i<4?'#50c050':'#28882a';
    ctx.fillRect(-2+i*.25,~~(-33-i*2+ph),4-i*.1,7+i*.5);
  }
  ctx.restore();
  // Wooden name tag
  ctx.save();ctx.translate(~~p.x,~~(p.y+bob));
  ctx.font='5px "Press Start 2P"';ctx.textAlign='center';
  const nw=ctx.measureText(p.name).width+10;
  ctx.fillStyle='rgba(38,18,4,.9)';ctx.fillRect(-nw/2,-46,nw,13);
  ctx.strokeStyle='#c8902a';ctx.lineWidth=2;ctx.strokeRect(-nw/2,-46,nw,13);
  ctx.fillStyle='#ffe080';ctx.shadowColor='#000';ctx.shadowBlur=3;
  ctx.fillText(p.name,0,-36);ctx.shadowBlur=0;
  ctx.font='4px "Press Start 2P"';ctx.fillStyle='#80d0ff';ctx.fillText('LV'+p.level,0,-50);
  ctx.restore();
}

// ‚îÄ‚îÄ PROP HELPERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function drawChest(x,y,t){
  ctx.save();ctx.translate(~~x,~~y);
  // Glow when stage clear
  if(G&&G.currentStageCleared)glow(ctx,0,-8,22,`rgba(255,220,80,${.3+Math.sin(t*4)*.2})`);
  // Shadow
  ctx.fillStyle='rgba(0,0,0,.25)';ctx.fillRect(-13,10,26,5);
  // Main body
  ctx.fillStyle='#5a2c06';ctx.fillRect(-12,2,24,18);
  ctx.fillStyle='#7a3c0a';ctx.fillRect(-12,2,24,8);
  // Wood planks
  ctx.fillStyle='#6a3408';ctx.fillRect(-12,5,24,2);ctx.fillRect(-12,9,24,2);
  // Lid
  ctx.fillStyle='#5a2c06';ctx.fillRect(-12,-4,24,8);
  ctx.fillStyle='#8a4a10';ctx.fillRect(-12,-4,24,4);
  // Metal bands
  ctx.fillStyle='#c8a030';ctx.fillRect(-12,-2,24,3);ctx.fillRect(-12,10,24,3);
  ctx.fillRect(-3,-5,6,24);// vertical band
  // Lock
  ctx.fillStyle='#f0c030';ctx.fillRect(-4,6,8,6);
  ctx.fillStyle='#d0a020';ctx.fillRect(-3,8,6,3);
  ctx.fillStyle='#1a0c00';ctx.fillRect(-2,8,4,4);// keyhole
  ctx.fillStyle='rgba(255,200,60,.5)';ctx.fillRect(-2,9,4,1);// shine
  // Highlight on lid
  ctx.fillStyle='rgba(255,200,80,.2)';ctx.fillRect(-11,-3,22,3);
  // Corner studs
  ctx.fillStyle='#e0b020';[[-12,2],[10,2],[-12,17],[10,17]].forEach(([cx,cy])=>ctx.fillRect(cx,cy,4,4));
  ctx.restore();
}
function drawSign(x,y){
  ctx.save();ctx.translate(~~x,~~y);
  // Post
  ctx.fillStyle='#7a4a18';ctx.fillRect(-3,0,6,28);
  ctx.fillStyle='#9a6028';ctx.fillRect(-3,0,3,28);
  // Board
  ctx.fillStyle='#c8922a';ctx.fillRect(-20,-14,40,22);
  ctx.fillStyle='#e0a840';ctx.fillRect(-20,-14,40,9);
  ctx.fillStyle='#b87820';ctx.fillRect(-20,5,40,3);
  // Text on sign (pixel art style)
  ctx.fillStyle='#4a2808';
  [[-8,-9,4,4],[0,-9,4,4],[4,-9,4,4],[-8,-4,4,4],[0,-4,4,4],[4,-4,4,4]].forEach(([sx,sy,sw,sh])=>ctx.fillRect(sx,sy,sw,sh));
  // Border
  ctx.strokeStyle='#7a4a10';ctx.lineWidth=2;ctx.strokeRect(-20,-14,40,22);
  ctx.restore();
}
function drawStump(x,y){
  ctx.save();ctx.translate(~~x,~~y);
  ctx.fillStyle='rgba(0,0,0,.2)';ctx.fillRect(-12,8,24,5);
  ctx.fillStyle='#6a3c14';ctx.fillRect(-12,0,24,12);
  ctx.fillStyle='#5a2c08';ctx.fillRect(-12,6,24,6);
  // Tree rings on top
  ctx.fillStyle='#8a5828';ctx.fillRect(-12,0,24,6);
  ctx.fillStyle='#7a4818';ctx.fillRect(-8,1,16,4);
  ctx.fillStyle='#6a3808';ctx.fillRect(-5,2,10,2);
  // Moss
  ctx.fillStyle='#3a7020';
  for(let i=0;i<5;i++)ctx.fillRect(-12+i*5,0,4,3);
  ctx.restore();
}
function drawBarrel(x,y){
  ctx.save();ctx.translate(~~x,~~y);
  ctx.fillStyle='rgba(0,0,0,.2)';ctx.fillRect(-7,18,14,4);
  ctx.fillStyle='#6a3a0a';ctx.fillRect(-7,0,14,20);
  ctx.fillStyle='#8a5018';ctx.fillRect(-7,0,14,7);
  ctx.fillStyle='#5a2808';ctx.fillRect(-7,14,14,6);
  ctx.fillStyle='#c8901a';ctx.fillRect(-8,-1,16,3);ctx.fillRect(-8,8,16,3);ctx.fillRect(-8,16,16,3);
  ctx.fillStyle='#7a4010';ctx.fillRect(-7,2,2,16);
  ctx.restore();
}

// ‚îÄ‚îÄ ENEMY DRAW ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function drawEnemy(e){
  const bob=Math.sin(e.anim)*(e.isBoss?4:3);
  const sc=e.isBoss?1.3:1.0;
  ctx.save();
  ctx.translate(~~e.x,~~(e.y+bob));
  if(!e.alive){ctx.globalAlpha=Math.max(0,e.deathA);ctx.translate(0,(1-e.deathA)*22);}
  if(e.hurtT>0)ctx.globalAlpha*=(.45+Math.sin(e.hurtT*40)*.5);
  ctx.scale(-(e.facing||1)*sc,sc);
  // Ground shadow
  const sga=e.alive?(e.hurtT>0?.2:.3):Math.max(0,e.deathA*.3);
  ctx.globalAlpha*=sga/.3*sga;
  ctx.fillStyle='rgba(0,0,0,.3)';
  ctx.beginPath();ctx.ellipse(0,e.sz*.55,e.sz*.55,e.sz*.18,0,0,Math.PI*2);ctx.fill();
  ctx.globalAlpha=e.alive?(e.hurtT>0?.7:1):Math.max(0,e.deathA);
  // Boss aura
  if(e.isBoss){
    const aura=`rgba(${h2r(e.color)},${.08+Math.sin((G?G.bgA:0)*2.5)*.05})`;
    glow(ctx,0,0,52,aura);
  }
  drawSprite(e.sp,e.color,G?G.bgA:0,e.isBoss);
  ctx.restore();
}

// ‚îÄ‚îÄ SPRITES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function drawSprite(sp,c,t,boss){
  const hi=shade(c,1.8),dk=shade(c,.45),dk2=shade(c,.3);
  // Outline helper: draws solid color at offset positions
  const ol=(col)=>{ctx.fillStyle=col;};
  // Rounded pixel fill helper
  const pf=(x,y,w,h,col)=>{ctx.fillStyle=col;ctx.fillRect(x,y,w,h);};
  const hi2=shade(c,1.4);

  switch(sp){

    case'imp':{// Fire imp - small red devil with horns, tail, glowing eyes
      const bh=Math.sin(t*6)*.5;
      // Tail
      ctx.strokeStyle=dk;ctx.lineWidth=3;ctx.beginPath();ctx.moveTo(4,16);ctx.bezierCurveTo(18,8,22,-4,14,-10+~~bh);ctx.stroke();
      ctx.strokeStyle=c;ctx.lineWidth=2;ctx.beginPath();ctx.moveTo(4,16);ctx.bezierCurveTo(17,8,21,-4,14,-10+~~bh);ctx.stroke();
      // Diamond tail tip
      pf(12,-14+~~bh,6,6,dk);pf(13,-13+~~bh,4,4,'#ff4000');
      // Wings
      ctx.fillStyle=`rgba(160,20,0,${.5+Math.sin(t*5)*.2})`;
      ctx.beginPath();ctx.moveTo(-4,-2);ctx.lineTo(-22,-18);ctx.lineTo(-16,4);ctx.fill();
      ctx.beginPath();ctx.moveTo(8,-2);ctx.lineTo(26,-18);ctx.lineTo(16,4);ctx.fill();
      ctx.fillStyle=`rgba(220,60,0,${.3+Math.sin(t*5)*.2})`;
      ctx.beginPath();ctx.moveTo(-4,0);ctx.lineTo(-20,-16);ctx.lineTo(-14,4);ctx.fill();
      ctx.beginPath();ctx.moveTo(8,0);ctx.lineTo(24,-16);ctx.lineTo(14,4);ctx.fill();
      // Legs
      pf(-8,14,7,12,dk);pf(2,14,7,12,dk);
      pf(-9,22,8,6,'#1a0000');pf(1,22,8,6,'#1a0000');// feet
      pf(-8,14,4,12,c);pf(2,14,4,12,c);// leg front
      // Body
      pf(-10,-2,22,18,dk);pf(-9,-2,20,16,c);
      pf(-9,-2,20,6,hi2);// chest highlight
      // Arms
      pf(-16,0,8,12,dk);pf(10,0,8,12,dk);
      pf(-16,0,6,12,c);pf(10,0,6,12,c);
      // Claws
      for(let i=0;i<3;i++){pf(-20+i*3,10,2,4,'#ffdd00');pf(12+i*3,10,2,4,'#ffdd00');}
      // Head
      pf(-8,-18,18,18,dk);pf(-7,-18,16,16,c);pf(-7,-18,16,6,hi2);// head
      // Horns
      pf(-8,-24,4,8,dk);pf(6,-26,4,10,dk);pf(-7,-23,3,6,'#cc2000');pf(7,-25,3,8,'#cc2000');
      // Eyes
      pf(-5,-14,5,5,'#ffee00');pf(2,-14,5,5,'#ffee00');
      pf(-4,-13,3,3,'#ff6000');pf(3,-13,3,3,'#ff6000');
      pf(-3,-13,2,2,'#000');pf(4,-13,2,2,'#000');// pupils
      // Smile/teeth
      pf(-4,-8,9,3,dk2);pf(-3,-8,2,2,'#fff');pf(0,-8,2,2,'#fff');pf(3,-8,2,2,'#fff');
      glow(ctx,0,-5,18,`rgba(255,80,0,${.2+Math.sin(t*4)*.15})`);
      break;}

    case'sprite':{// Fire elemental
      const fl=Math.sin(t*7)*.4;
      // Outer fire ring
      for(let i=0;i<8;i++){const a=i/8*Math.PI*2,r=14+Math.sin(t*5+i)*3;
        pf(~~(Math.cos(a)*r)-2,~~(Math.sin(a)*r)-10,4,4,`rgba(255,${60+i*20},0,${.4+fl})`);
      }
      // Body flames
      pf(-6,-14,14,22,dk);pf(-5,-14,12,20,c);pf(-5,-14,12,8,hi);
      // Inner core
      pf(-3,-10,8,14,'#ffdd00');pf(-2,-10,6,10,'#ffffff');
      // Eyes glow
      pf(-3,-8,3,4,'#fff');pf(2,-8,3,4,'#fff');
      pf(-2,-7,2,2,'#ff4000');pf(3,-7,2,2,'#ff4000');
      // Top flame
      ctx.fillStyle=`rgba(255,${100+~~(Math.sin(t*8)*80)},0,${.8+fl})`;
      ctx.beginPath();ctx.moveTo(-4,-14);ctx.lineTo(0,-14-8-~~(Math.sin(t*6)*4));ctx.lineTo(4,-14);ctx.fill();
      break;}

    case'demon':{// Large red demon
      // Horns
      pf(-8,-38,6,14,'#8a0000');pf(4,-40,7,16,'#8a0000');
      pf(-7,-38,4,12,'#bb1010');pf(5,-40,4,14,'#bb1010');
      // Wings
      ctx.fillStyle=`rgba(100,0,0,${.6+Math.sin(t*3)*.15})`;
      ctx.beginPath();ctx.moveTo(-10,-8);ctx.lineTo(-38,-32);ctx.lineTo(-32,8);ctx.lineTo(-10,8);ctx.fill();
      ctx.beginPath();ctx.moveTo(14,-8);ctx.lineTo(42,-32);ctx.lineTo(36,8);ctx.lineTo(14,8);ctx.fill();
      ctx.fillStyle=`rgba(180,20,0,${.35})`;
      ctx.beginPath();ctx.moveTo(-10,-6);ctx.lineTo(-36,-28);ctx.lineTo(-10,6);ctx.fill();
      ctx.beginPath();ctx.moveTo(14,-6);ctx.lineTo(40,-28);ctx.lineTo(14,6);ctx.fill();
      // Legs/feet
      pf(-12,22,10,14,dk2);pf(4,22,10,14,dk2);
      pf(-14,32,12,6,'#1a0000');pf(4,32,12,6,'#1a0000');
      pf(-12,22,6,14,dk);pf(4,22,6,14,dk);
      // Body
      pf(-14,0,30,24,dk2);pf(-13,0,28,22,dk);pf(-12,0,26,16,c);pf(-12,0,26,6,hi2);
      // Arms
      pf(-22,0,12,16,dk);pf(-22,0,10,16,c);
      pf(12,0,12,16,dk);pf(12,0,10,16,c);
      for(let i=0;i<3;i++){pf(-26+i*2,14,2,6,'#ffdd00');pf(18+i*2,14,2,6,'#ffdd00');}
      // Head
      pf(-12,-22,26,24,dk2);pf(-11,-22,24,22,c);pf(-11,-22,24,8,hi2);
      // Eyes
      pf(-8,-16,7,7,'#ffee00');pf(3,-16,7,7,'#ffee00');
      pf(-7,-15,5,5,'#ff4000');pf(4,-15,5,5,'#ff4000');
      pf(-6,-14,3,3,'#200');pf(5,-14,3,3,'#200');
      pf(-6,-10,13,4,dk2);pf(-5,-9,2,3,'#fff');pf(-1,-9,3,3,'#fff');pf(4,-9,2,3,'#fff');
      glow(ctx,0,-4,32,`rgba(255,60,0,${.18+Math.sin(t*3)*.1})`);
      break;}

    case'lavaking':{
      // Crown
      pf(-14,-50,4,10,'#ffd700');pf(-6,-54,4,14,'#ffd700');pf(2,-54,4,14,'#ffd700');pf(10,-50,4,10,'#ffd700');
      pf(-14,-46,28,6,'#c8a020');
      pf(-2,-56,4,6,'#ff4040');pf(6,-58,4,6,'#ff4040');pf(-10,-52,4,6,'#ff4040');
      // Wings
      ctx.fillStyle=`rgba(120,0,0,${.55+Math.sin(t*2.5)*.12})`;
      ctx.beginPath();ctx.moveTo(-12,-10);ctx.lineTo(-44,-36);ctx.lineTo(-38,10);ctx.lineTo(-12,10);ctx.fill();
      ctx.beginPath();ctx.moveTo(16,-10);ctx.lineTo(48,-36);ctx.lineTo(42,10);ctx.lineTo(16,10);ctx.fill();
      // Legs
      pf(-12,28,10,16,dk2);pf(4,28,10,16,dk2);
      pf(-14,38,14,7,'#1a0000');pf(4,38,14,7,'#1a0000');
      pf(-12,28,6,16,dk);pf(4,28,6,16,dk);
      // Body
      pf(-16,-2,34,32,dk2);pf(-15,-2,32,30,dk);pf(-14,-2,30,22,c);pf(-14,-2,30,8,hi2);
      // Arms
      pf(-26,-2,14,18,dk);pf(-26,-2,12,18,c);
      pf(14,-2,14,18,dk);pf(14,-2,12,18,c);
      for(let i=0;i<4;i++){pf(-30+i*2,14,2,7,'#ffaa00');pf(22+i*2,14,2,7,'#ffaa00');}
      // Head
      pf(-14,-24,30,26,dk2);pf(-13,-24,28,24,c);pf(-13,-24,28,9,hi2);
      // Horns
      pf(-10,-34,7,12,'#8a0000');pf(6,-36,7,14,'#8a0000');
      pf(-9,-34,5,10,'#bb2020');pf(7,-36,5,12,'#bb2020');
      // Eyes
      pf(-8,-18,8,8,'#ffee00');pf(3,-18,8,8,'#ffee00');
      pf(-7,-17,6,6,'#ff6000');pf(4,-17,6,6,'#ff6000');
      pf(-6,-16,4,4,'#000');pf(5,-16,4,4,'#000');
      glow(ctx,0,0,44,`rgba(255,80,0,${.16+Math.sin(t*2.5)*.1})`);
      break;}

    case'golem':{// Frost Golem - chunky ice/rock body
      const isAsh=sp==='golem2';
      const bc=isAsh?'#9a7060':'#c0d8f0',bdk=isAsh?'#6a4030':'#5080c0';
      // Feet
      pf(-16,24,14,10,shade(bc,.7));pf(4,24,14,10,shade(bc,.7));
      pf(-17,24,10,10,shade(bc,.8));pf(5,24,10,10,shade(bc,.8));
      // Legs
      pf(-12,12,10,16,bdk);pf(4,12,10,16,bdk);
      pf(-12,12,7,16,bc);pf(4,12,7,16,bc);
      // Body
      pf(-18,-6,38,22,shade(bc,.7));pf(-17,-6,36,20,bdk);pf(-16,-6,34,18,bc);pf(-16,-6,34,7,shade(bc,1.5));
      // Arms
      pf(-30,-6,14,18,bdk);pf(-29,-6,12,18,bc);pf(18,-6,14,18,bdk);pf(18,-6,12,18,bc);
      pf(-34,6,10,8,shade(bc,.8));pf(26,6,10,8,shade(bc,.8));// fists
      // Head
      pf(-14,-24,30,22,bdk);pf(-13,-24,28,20,bc);pf(-13,-24,28,8,shade(bc,1.5));
      // Cracks/texture
      ctx.strokeStyle=shade(bc,.55);ctx.lineWidth=1.5;
      ctx.beginPath();ctx.moveTo(-6,-20);ctx.lineTo(-2,-12);ctx.lineTo(-8,-6);ctx.stroke();
      ctx.beginPath();ctx.moveTo(8,-22);ctx.lineTo(12,-14);ctx.stroke();
      // Eyes
      pf(-8,-18,7,7,isAsh?'#ff6020':'#40c0ff');
      pf(3,-18,7,7,isAsh?'#ff6020':'#40c0ff');
      pf(-7,-17,5,5,isAsh?'#ff3000':'#60e8ff');
      pf(4,-17,5,5,isAsh?'#ff3000':'#60e8ff');
      pf(-6,-16,3,3,'#000');pf(5,-16,3,3,'#000');
      break;}
    case'golem2':{// Ash Golem
      const bc='#8a6050',bdk='#6a3028';
      pf(-16,24,14,10,shade(bc,.7));pf(4,24,14,10,shade(bc,.7));
      pf(-12,12,10,16,bdk);pf(4,12,10,16,bdk);pf(-12,12,7,16,bc);pf(4,12,7,16,bc);
      pf(-18,-6,38,22,shade(bc,.7));pf(-17,-6,36,20,bdk);pf(-16,-6,34,18,bc);pf(-16,-6,34,7,shade(bc,1.4));
      pf(-30,-6,14,18,bdk);pf(-29,-6,12,18,bc);pf(18,-6,14,18,bdk);pf(18,-6,12,18,bc);
      pf(-34,6,10,8,shade(bc,.8));pf(26,6,10,8,shade(bc,.8));
      pf(-14,-24,30,22,bdk);pf(-13,-24,28,20,bc);pf(-13,-24,28,8,shade(bc,1.4));
      ctx.strokeStyle=shade(bc,.4);ctx.lineWidth=1.5;
      ctx.beginPath();ctx.moveTo(-6,-20);ctx.lineTo(-2,-12);ctx.lineTo(-8,-6);ctx.stroke();
      pf(-8,-18,7,7,'#ff6020');pf(3,-18,7,7,'#ff6020');pf(-7,-17,5,5,'#ff3000');pf(4,-17,5,5,'#ff3000');
      pf(-6,-16,3,3,'#1a0000');pf(5,-16,3,3,'#1a0000');
      // Embers
      for(let i=0;i<4;i++){pf(-10+i*6,-22+~~(Math.sin(t*5+i)*3),2,3,`rgba(255,${80+i*30},0,${.6+Math.sin(t*4+i)*.3})`);}
      glow(ctx,0,0,28,`rgba(200,80,0,${.08+Math.sin(t*3)*.06})`);
      break;}

    case'wolf':{// Shadow wolf - quadruped
      // Tail
      ctx.strokeStyle=dk;ctx.lineWidth=4;ctx.beginPath();ctx.moveTo(12,4);ctx.bezierCurveTo(26,-4,30,-14,22,-20);ctx.stroke();
      ctx.strokeStyle=c;ctx.lineWidth=2.5;ctx.beginPath();ctx.moveTo(12,4);ctx.bezierCurveTo(25,-4,28,-14,20,-20);ctx.stroke();
      // Hind legs
      pf(6,12,8,14,dk2);pf(6,12,6,14,dk);pf(6,22,10,6,'#0a0014');
      pf(-4,12,8,14,dk2);pf(-4,12,6,14,dk);pf(-4,22,10,6,'#0a0014');
      // Body
      pf(-14,-2,28,16,dk2);pf(-13,-2,26,14,dk);pf(-13,-2,26,6,c);
      // Front legs
      pf(-14,12,8,14,dk2);pf(-14,12,6,14,c);pf(-15,22,10,6,'#0a0014');
      pf(-6,12,8,14,dk2);pf(-6,12,6,14,c);pf(-7,22,10,6,'#0a0014');
      // Neck
      pf(-8,-12,14,14,dk);pf(-7,-12,12,12,c);pf(-7,-12,12,5,hi2);
      // Head
      pf(-10,-22,22,16,dk2);pf(-9,-22,20,14,c);pf(-9,-22,20,6,hi2);
      // Ears
      pf(-8,-30,6,10,dk2);pf(4,-30,6,10,dk2);pf(-7,-29,4,8,c);pf(5,-29,4,8,c);pf(-6,-27,2,4,'#cc3060');pf(6,-27,2,4,'#cc3060');
      // Snout
      pf(-10,-14,12,8,dk);pf(-9,-14,10,6,c);pf(-4,-12,8,3,'#200030');
      pf(-4,-11,4,2,'#ccaaff');pf(2,-11,4,2,'#ccaaff');// teeth
      // Eyes
      pf(-7,-20,6,5,'#ccaaff');pf(3,-20,6,5,'#ccaaff');
      pf(-6,-19,4,3,'#8060cc');pf(4,-19,4,3,'#8060cc');
      pf(-5,-19,2,2,'#000');pf(5,-19,2,2,'#000');
      break;}

    case'bat':{
      const wf=~~(Math.sin(t*10)*8);
      // Wing bones
      ctx.strokeStyle=dk2;ctx.lineWidth=2;
      ctx.beginPath();ctx.moveTo(-4,0);ctx.lineTo(-26,wf-10);ctx.moveTo(-4,0);ctx.lineTo(-20,wf+6);ctx.stroke();
      ctx.beginPath();ctx.moveTo(6,0);ctx.lineTo(28,wf-10);ctx.moveTo(6,0);ctx.lineTo(22,wf+6);ctx.stroke();
      // Wing membrane
      ctx.fillStyle=`rgba(${parseInt(c.slice(1,3),16)},${parseInt(c.slice(3,5),16)},${parseInt(c.slice(5,7),16)},${.55+Math.sin(t*10)*.15})`;
      ctx.beginPath();ctx.moveTo(-4,-2);ctx.lineTo(-26,wf-10);ctx.lineTo(-20,wf+8);ctx.lineTo(-4,6);ctx.fill();
      ctx.beginPath();ctx.moveTo(6,-2);ctx.lineTo(28,wf-10);ctx.lineTo(22,wf+8);ctx.lineTo(6,6);ctx.fill();
      // Body
      pf(-6,-4,14,16,dk2);pf(-5,-4,12,14,c);pf(-5,-4,12,5,hi2);
      // Head
      pf(-6,-14,12,12,dk2);pf(-5,-14,10,10,c);pf(-5,-14,10,4,hi2);
      // Ears
      pf(-7,-22,5,10,dk2);pf(4,-22,5,10,dk2);pf(-6,-21,3,8,c);pf(5,-21,3,8,c);
      // Eyes
      pf(-4,-12,4,4,'#ff2020');pf(2,-12,4,4,'#ff2020');
      pf(-3,-11,2,2,'#ffaaaa');pf(3,-11,2,2,'#ffaaaa');
      // Teeth
      pf(-3,-4,2,4,'#fff');pf(1,-4,2,4,'#fff');
      break;}

    case'spider':{
      // Legs - 4 pairs
      ctx.lineWidth=2;
      [[{x:-10,y:2,tx:-26,ty:-8},{x:-10,y:6,tx:-28,ty:12}],
       [{x:10,y:2,tx:26,ty:-8},{x:10,y:6,tx:28,ty:12}],
       [{x:-8,y:0,tx:-22,ty:-16},{x:8,y:0,tx:22,ty:-16}]
      ].forEach(pair=>{pair.forEach(({x,y,tx,ty})=>{ctx.strokeStyle=dk2;ctx.lineWidth=2.5;ctx.beginPath();ctx.moveTo(x,y);ctx.lineTo(~~((x+tx)/2)+2,~~((y+ty)/2)-6);ctx.lineTo(tx,ty);ctx.stroke();ctx.strokeStyle=c;ctx.lineWidth=1.5;ctx.beginPath();ctx.moveTo(x,y);ctx.lineTo(~~((x+tx)/2)+2,~~((y+ty)/2)-6);ctx.lineTo(tx,ty);ctx.stroke();});});
      // Abdomen
      pf(-10,2,22,18,dk2);pf(-9,2,20,16,dk);pf(-9,2,20,6,c);
      ctx.strokeStyle=shade(c,1.3);ctx.lineWidth=1;
      for(let i=0;i<3;i++){ctx.beginPath();ctx.ellipse(1,10+i*4,7-i*2,1.5,0,0,Math.PI*2);ctx.stroke();}
      // Head/cephalothorax
      pf(-8,-10,18,14,dk2);pf(-7,-10,16,12,c);pf(-7,-10,16,5,hi2);
      // Eyes (4 pairs)
      [[-6,-8],[-2,-8],[2,-8],[6,-8]].forEach(([ex,ey])=>{pf(ex,ey,3,3,'#ff2020');pf(ex+1,ey+1,1,1,'#ffaaaa');});
      // Fangs
      ctx.strokeStyle='#ffdd00';ctx.lineWidth=2;ctx.beginPath();ctx.moveTo(-4,-10);ctx.lineTo(-6,-14);ctx.stroke();ctx.beginPath();ctx.moveTo(6,-10);ctx.lineTo(8,-14);ctx.stroke();
      pf(-7,-15,4,6,'#ffdd00');pf(6,-15,4,6,'#ffdd00');
      break;}

    case'necro':{
      // Robe base
      pf(-14,0,30,30,dk2);pf(-12,0,28,28,dk);
      // Robe trim
      pf(-14,0,30,4,'#8040c0');pf(-14,26,30,4,'#8040c0');
      // Ritual markings
      ctx.strokeStyle='rgba(160,80,255,.5)';ctx.lineWidth=1;
      for(let i=0;i<4;i++)ctx.strokeRect(-11+i*7,4,5,20);
      // Arms/sleeves
      pf(-24,-2,12,16,dk2);pf(-23,-2,10,14,dk);
      pf(14,-2,12,16,dk2);pf(14,-2,10,14,dk);
      // Staff
      ctx.strokeStyle='#6040a0';ctx.lineWidth=3;ctx.beginPath();ctx.moveTo(20,-38);ctx.lineTo(18,28);ctx.stroke();
      ctx.strokeStyle='#8060c0';ctx.lineWidth=1.5;ctx.beginPath();ctx.moveTo(20,-38);ctx.lineTo(18,28);ctx.stroke();
      // Skull on staff
      pf(13,-44,15,13,'#c0b8c8');pf(14,-43,13,10,'#e0d8e8');
      pf(14,-40,4,4,'#1a0020');pf(20,-40,4,4,'#1a0020');
      pf(16,-35,6,3,'#1a0020');
      glow(ctx,18,-44,10,`rgba(180,80,255,${.3+Math.sin(t*4)*.2})`);
      // Body/chest
      pf(-10,-20,22,24,dk2);pf(-9,-20,20,22,dk);pf(-9,-20,20,8,shade(dk,1.4));
      // Skull face
      pf(-8,-36,18,18,dk2);pf(-7,-36,16,16,'#c0b8c8');pf(-7,-36,16,6,'#e0d8e8');
      pf(-5,-32,5,5,'#000');pf(2,-32,5,5,'#000');
      pf(-4,-31,3,3,'#2a006a');pf(3,-31,3,3,'#2a006a');
      pf(-4,-24,9,3,'#6a0090');pf(-3,-24,2,3,'#000');pf(0,-24,2,3,'#000');pf(3,-24,2,3,'#000');
      // Hat
      pf(-10,-44,22,10,dk2);pf(-6,-58,14,16,dk2);pf(-5,-57,12,14,dk);
      glow(ctx,18,-40,12,`rgba(180,80,255,${.2+Math.sin(t*3)*.15})`);
      break;}

    case'wraith':{
      const wa=.55+Math.sin(t*3)*.22;
      ctx.globalAlpha*=wa;
      // Trailing mist
      for(let i=0;i<5;i++){
        pf(-6+i*2,20+i*4,14-i*2,8,`rgba(${parseInt(c.slice(1,3),16)},${parseInt(c.slice(3,5),16)},${parseInt(c.slice(5,7),16)},${.3-i*.06})`);
      }
      // Robe body
      pf(-12,-6,26,40,dk2);pf(-11,-6,24,38,dk);pf(-10,-6,22,34,c);pf(-10,-6,22,8,hi2);
      // Ripple edges
      for(let i=0;i<4;i++){pf(-14+i*8,26,8,10+~~(Math.sin(t*4+i)*.4)*3,c);}
      // Arms
      pf(-22,-4,12,14,dk);pf(-21,-4,10,12,c);
      pf(12,-4,12,14,dk);pf(12,-4,10,12,c);
      // Claw hands
      for(let i=0;i<3;i++){pf(-26+i*3,8,2,7,'#a0c8ff');pf(16+i*3,8,2,7,'#a0c8ff');}
      // Head
      pf(-10,-24,22,20,dk2);pf(-9,-24,20,18,c);pf(-9,-24,20,7,hi2);
      // Hollow eyes
      pf(-6,-20,6,7,dk2);pf(2,-20,6,7,dk2);
      pf(-5,-19,4,5,'#40d0ff');pf(3,-19,4,5,'#40d0ff');
      pf(-4,-18,2,3,'#fff');pf(4,-18,2,3,'#fff');
      // Mouth
      pf(-4,-13,10,3,dk2);
      break;}

    case'forestwitch':{
      // Hat
      pf(-14,-46,30,10,dk2);pf(-8,-62,18,18,dk2);pf(-7,-61,16,16,dk);
      pf(-14,-46,30,5,'#8030d0');pf(-13,-46,28,3,shade('#8030d0',1.4));
      pf(-4,-64,4,6,'#40ff60');// feather
      // Hair
      pf(-12,-36,26,8,dk2);pf(-14,-32,6,14,dk2);pf(10,-32,6,14,dk2);
      // Robes
      pf(-14,0,30,30,dk2);pf(-13,0,28,28,dk);pf(-13,0,28,4,'#8030d0');pf(-13,24,28,6,shade('#8030d0',.7));
      // Stars on robe
      ['#ff80ff','#80ffff','#ffff80'].forEach((sc,i)=>pf(-8+i*7,8,4,4,sc));
      // Arms
      pf(-22,-2,12,14,dk2);pf(-21,-2,10,12,c);
      pf(12,-2,12,14,dk2);pf(12,-2,10,12,c);
      // Staff
      ctx.strokeStyle='#5020a0';ctx.lineWidth=3;ctx.beginPath();ctx.moveTo(18,-42);ctx.lineTo(16,28);ctx.stroke();
      pf(12,-50,13,12,'#40d040');pf(13,-49,11,10,'#60ff60');
      pf(16,-48,5,5,'#ffffff');
      glow(ctx,16,-46,14,`rgba(100,255,80,${.3+Math.sin(t*4)*.2})`);
      // Face
      pf(-10,-34,22,20,dk2);pf(-9,-34,20,18,c);pf(-9,-34,20,7,hi2);
      pf(-6,-30,5,5,'#ff80ff');pf(3,-30,5,5,'#ff80ff');pf(-5,-29,3,3,'#c040c0');pf(4,-29,3,3,'#c040c0');
      pf(-4,-28,2,2,'#100010');pf(4,-28,2,2,'#100010');
      pf(-4,-24,10,2,'#a050e0');// mouth
      pf(-2,-24,2,3,'#fff');pf(2,-24,2,3,'#fff');// teeth
      glow(ctx,0,0,42,`rgba(180,40,255,${.12+Math.sin(t*2.5)*.08})`);
      break;}

    case'troll':{// Bog Troll - large rocky green creature
      // Legs
      pf(-14,20,12,16,dk2);pf(4,20,12,16,dk2);
      pf(-14,20,10,16,dk);pf(4,20,10,16,dk);
      pf(-15,32,14,8,'#1a2808');pf(3,32,14,8,'#1a2808');// feet
      // Body
      pf(-18,-4,38,28,dk2);pf(-17,-4,36,26,dk);pf(-16,-4,34,20,c);pf(-16,-4,34,8,hi2);
      // Rock texture
      ctx.strokeStyle=dk2;ctx.lineWidth=1.5;
      ctx.beginPath();ctx.moveTo(-10,-2);ctx.lineTo(-4,10);ctx.moveTo(6,-2);ctx.lineTo(2,8);ctx.moveTo(8,-2);ctx.lineTo(14,6);ctx.stroke();
      // Arms
      pf(-28,-4,14,20,dk2);pf(-27,-4,12,18,c);
      pf(16,-4,14,20,dk2);pf(16,-4,12,18,c);
      pf(-32,8,10,8,shade(c,.8));pf(24,8,10,8,shade(c,.8));// fists
      for(let i=0;i<3;i++){pf(-34+i*2,10,2,5,'#c8aa20');pf(26+i*2,10,2,5,'#c8aa20');}// claws
      // Head
      pf(-16,-24,34,24,dk2);pf(-15,-24,32,22,dk);pf(-14,-24,30,20,c);pf(-14,-24,30,8,hi2);
      // Head bumps
      pf(-10,-28,8,6,dk);pf(4,-28,8,6,dk);
      // Ears
      pf(-18,-18,6,12,dk2);pf(14,-18,6,12,dk2);pf(-17,-17,4,10,c);pf(15,-17,4,10,c);
      // Eyes
      pf(-10,-18,8,7,'#ffee00');pf(4,-18,8,7,'#ffee00');
      pf(-9,-17,6,5,'#dd9900');pf(5,-17,6,5,'#dd9900');
      pf(-8,-16,4,4,'#1a2808');pf(6,-16,4,4,'#1a2808');
      // Nose
      pf(-2,-12,6,5,dk2);pf(-1,-11,2,3,'#000');pf(3,-11,2,3,'#000');
      // Tusks
      pf(-6,-8,4,6,'#fff');pf(4,-8,4,6,'#fff');pf(-5,-7,2,5,'#ddd');pf(5,-7,2,5,'#ddd');
      break;}

    case'bogwisp':{
      ctx.globalAlpha*=(.45+Math.sin(t*4)*.28);
      for(let i=0;i<5;i++){
        const r=8-i*.5,a=i*.4;
        pf(-r+~~(Math.sin(t*3+a)*4),-r*2.5+~~(Math.sin(t*2+a)*3),r*2,r*2,
          i===0?hi:i===1?c:i===2?dk:i===3?dk2:'rgba(0,0,0,.5)');
      }
      pf(-3,-14,4,4,'#80ff40');pf(1,-14,4,4,'#80ff40');
      break;}

    case'boghag':{
      // Hair/tendrils
      ctx.strokeStyle=dk2;ctx.lineWidth=2;
      for(let i=0;i<5;i++){ctx.beginPath();ctx.moveTo(-10+i*5,-38+~~(Math.sin(t*3+i)*.5)*3);ctx.bezierCurveTo(-10+i*5,-52,i*3-8,-56+~~(Math.sin(t*2+i)*5),i*4-8,-60+~~(Math.sin(t*2+i)*5));ctx.stroke();}
      // Robes
      pf(-16,0,34,32,dk2);pf(-15,0,32,30,dk);pf(-14,0,30,22,c);pf(-14,0,30,6,hi2);
      // Tentacle arms
      ctx.strokeStyle=dk;ctx.lineWidth=5;
      ctx.beginPath();ctx.moveTo(-14,4);ctx.bezierCurveTo(-28,0,-34,-8,-30,-18);ctx.stroke();
      ctx.strokeStyle=c;ctx.lineWidth=3;
      ctx.beginPath();ctx.moveTo(-14,4);ctx.bezierCurveTo(-27,0,-33,-8,-30,-18);ctx.stroke();
      ctx.strokeStyle=dk;ctx.lineWidth=5;
      ctx.beginPath();ctx.moveTo(16,4);ctx.bezierCurveTo(30,0,36,-8,32,-18);ctx.stroke();
      ctx.strokeStyle=c;ctx.lineWidth=3;
      ctx.beginPath();ctx.moveTo(16,4);ctx.bezierCurveTo(29,0,35,-8,32,-18);ctx.stroke();
      // Claw tips
      for(let i=0;i<3;i++){pf(-34+i*3,-22,2,5,'#c8d820');pf(30+i*3,-22,2,5,'#c8d820');}
      // Head
      pf(-14,-38,30,40,dk2);pf(-13,-38,28,38,dk);pf(-12,-38,26,28,c);pf(-12,-38,26,10,hi2);
      // Warts
      for(let i=0;i<4;i++)pf(-8+i*6,-32+i%2*4,5,5,shade(c,1.25));
      // Eyes
      pf(-8,-30,8,7,'#40ff20');pf(2,-30,8,7,'#40ff20');
      pf(-7,-29,6,5,'#20dd00');pf(3,-29,6,5,'#20dd00');
      pf(-6,-28,4,4,'#002000');pf(4,-28,4,4,'#002000');
      pf(-4,-22,10,3,dk2);pf(-4,-21,2,3,'#c8d820');pf(0,-21,3,3,'#c8d820');pf(4,-21,2,3,'#c8d820');
      glow(ctx,0,0,44,`rgba(60,200,10,${.12+Math.sin(t*2)*.08})`);
      break;}

    case'dragon':{// CHAOS DRAGON - The final boss
      const rg=ctx.createRadialGradient(0,0,10,0,0,80);
      rg.addColorStop(0,`rgba(255,30,0,${.2+Math.sin(t*2)*.1})`);rg.addColorStop(1,'transparent');
      ctx.fillStyle=rg;ctx.beginPath();ctx.arc(0,0,80,0,Math.PI*2);ctx.fill();
      // Tail
      ctx.strokeStyle='#3a0000';ctx.lineWidth=14;
      ctx.beginPath();ctx.moveTo(16,24);ctx.bezierCurveTo(50,10,70,-10,58,-28);ctx.stroke();
      ctx.strokeStyle='#5a0000';ctx.lineWidth=10;
      ctx.beginPath();ctx.moveTo(16,24);ctx.bezierCurveTo(48,10,68,-10,56,-28);ctx.stroke();
      ctx.strokeStyle='#800000';ctx.lineWidth=6;
      ctx.beginPath();ctx.moveTo(16,24);ctx.bezierCurveTo(47,10,66,-10,54,-28);ctx.stroke();
      // Tail spike
      pf(52,-32,8,8,'#c8a000');pf(54,-30,4,4,'#ffee00');
      // Wings (massive)
      ctx.fillStyle=`rgba(70,0,0,${.65+Math.sin(t*1.5)*.12})`;
      ctx.beginPath();ctx.moveTo(-14,-14);ctx.lineTo(-70,-52);ctx.lineTo(-60,-20);ctx.lineTo(-50,0);ctx.lineTo(-20,8);ctx.fill();
      ctx.beginPath();ctx.moveTo(18,-14);ctx.lineTo(74,-52);ctx.lineTo(64,-20);ctx.lineTo(54,0);ctx.lineTo(24,8);ctx.fill();
      ctx.fillStyle=`rgba(120,0,0,${.4})`;
      ctx.beginPath();ctx.moveTo(-14,-12);ctx.lineTo(-68,-50);ctx.lineTo(-20,6);ctx.fill();
      ctx.beginPath();ctx.moveTo(18,-12);ctx.lineTo(72,-50);ctx.lineTo(24,6);ctx.fill();
      // Wing membrane detail
      ctx.strokeStyle='rgba(150,0,0,.35)';ctx.lineWidth=1.5;
      for(let i=0;i<3;i++){
        ctx.beginPath();ctx.moveTo(-14,-12);ctx.lineTo(-68+i*18,-50+i*12);ctx.stroke();
        ctx.beginPath();ctx.moveTo(18,-12);ctx.lineTo(72-i*18,-50+i*12);ctx.stroke();
      }
      // Hind legs
      pf(-20,34,14,18,'#3a0000');pf(-20,34,12,18,'#550000');
      pf(8,34,14,18,'#3a0000');pf(8,34,12,18,'#550000');
      for(let i=0;i<4;i++){pf(-24+i*2,50,3,8,'#ffee00');pf(10+i*3,50,3,8,'#ffee00');}
      // Front legs
      pf(-26,8,14,22,'#3a0000');pf(-26,8,12,22,'#660000');
      pf(14,8,14,22,'#3a0000');pf(14,8,12,22,'#660000');
      for(let i=0;i<4;i++){pf(-30+i*2,28,3,7,'#ffee00');pf(16+i*3,28,3,7,'#ffee00');}
      // Body (armored)
      pf(-20,-4,42,42,'#2a0000');pf(-19,-4,40,40,'#440000');pf(-18,-4,38,34,'#660000');pf(-18,-4,38,12,'#880000');
      // Scales
      ctx.strokeStyle='rgba(0,0,0,.5)';ctx.lineWidth=1;
      for(let i=0;i<3;i++)for(let j=0;j<4;j++){ctx.beginPath();ctx.ellipse(-12+j*12,4+i*12,5,4,0,0,Math.PI*2);ctx.stroke();}
      // Belly scales
      pf(-12,4,26,26,'#550000');
      for(let i=0;i<4;i++)pf(-9+i*6,6,4,22,'#440000');
      // Neck
      pf(-12,-20,26,20,'#3a0000');pf(-11,-20,24,18,'#660000');pf(-11,-20,24,8,'#880000');
      // Head
      pf(-20,-48,42,32,'#3a0000');pf(-19,-48,40,30,'#550000');pf(-18,-48,38,24,'#770000');pf(-18,-48,38,10,'#990000');
      // Horns (4)
      pf(-16,-64,8,18,'#3a0000');pf(-14,-62,5,16,'#6a0000');
      pf(-6,-68,6,22,'#3a0000');pf(-4,-66,4,20,'#6a0000');
      pf(4,-66,6,20,'#3a0000');pf(6,-64,4,18,'#6a0000');
      pf(12,-62,8,16,'#3a0000');pf(14,-60,5,14,'#6a0000');
      // Eyes (glowing)
      pf(-12,-42,10,10,'#ff2000');pf(4,-42,10,10,'#ff2000');
      pf(-11,-41,8,8,'#ff6020');pf(5,-41,8,8,'#ff6020');
      pf(-10,-40,6,6,'#ffaa40');pf(6,-40,6,6,'#ffaa40');
      pf(-9,-39,4,4,'#ffffff');pf(7,-39,4,4,'#ffffff');
      pf(-8,-38,2,2,'#000');pf(8,-38,2,2,'#000');
      // Nostrils
      pf(-10,-34,4,4,'#1a0000');pf(-2,-34,4,4,'#1a0000');
      // Mouth
      pf(-18,-32,38,6,'#1a0000');
      for(let i=0;i<6;i++){pf(-16+i*6,-32,4,8,'#f0f0d0');pf(-14+i*6,-32,2,6,'#ffffff');}
      // Fire breath animation
      if(Math.sin(t*2.5)>.6){
        const fi=Math.max(0,Math.sin(t*2.5)-.6)*2.5;
        const fg=ctx.createLinearGradient(-90,-36,0,-32);
        fg.addColorStop(0,'rgba(255,220,0,.0)');fg.addColorStop(.5,`rgba(255,${100+~~(fi*80)},0,${.7*fi})`);fg.addColorStop(1,`rgba(255,80,0,${.9*fi})`);
        ctx.fillStyle=fg;ctx.fillRect(-90,-44,90,20);
        ctx.fillStyle=`rgba(255,200,50,${.6*fi})`;ctx.fillRect(-80,-40,70,12);
        ctx.fillStyle=`rgba(255,255,100,${.4*fi})`;ctx.fillRect(-70,-38,50,8);
        glow(ctx,-80,-36,28,`rgba(255,120,0,${.4*fi})`);
      }
      glow(ctx,0,0,82,`rgba(180,0,0,${.16+Math.sin(t*1.5)*.1})`);
      break;}

    default:// Generic enemy fallback
      pf(-10,-20,22,14,dk);pf(-9,-20,20,12,c);pf(-9,-20,20,5,hi2);
      pf(-12,0,26,24,dk2);pf(-11,0,24,22,c);
      pf(-14,24,12,8,dk);pf(4,24,12,8,dk);
      pf(-6,-18,5,5,'#ff2020');pf(3,-18,5,5,'#ff2020');
      pf(-5,-17,3,3,'#ffaa00');pf(4,-17,3,3,'#ffaa00');
      pf(-2,-12,6,3,dk2);
  }
}

// ‚îÄ‚îÄ MINIMAP ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function drawMinimap(){
  if(!G||G.scene!=='battle')return;
  mmx.fillStyle='#040202';mmx.fillRect(0,0,80,60);
  const sx=80/CW,sy=60/CH;
  mmx.fillStyle='#2a1008';mmx.fillRect(0,~~(270*sy),80,~~(150*sy));
  for(const e of G.enemies){if(!e.alive)continue;mmx.fillStyle=e.isBoss?'#ff1020':'#e03010';mmx.fillRect(~~(e.x*sx)-1,~~(e.y*sy)-1,3,3);}
  mmx.fillStyle='#40ff80';mmx.fillRect(~~(G.pl.x*sx)-2,~~(G.pl.y*sy)-2,4,4);
  mmx.strokeStyle='#8b6020';mmx.strokeRect(0,0,80,60);
}

// ‚îÄ‚îÄ HUD ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function updateHUD(){
  if(!G)return;
  const p=G.pl;
  document.getElementById('hpf').style.width=(p.hp/p.maxHp*100)+'%';
  document.getElementById('xpf').style.width=(p.xp/p.xpNext*100)+'%';
  document.getElementById('stf').style.width=(p.stamina/p.maxStamina*100)+'%';
  document.getElementById('hptx').textContent=`${p.hp}/${p.maxHp}`;
  document.getElementById('xptx').textContent=`${p.xp}/${p.xpNext}`;
  document.getElementById('sttx').textContent=~~p.stamina;
  document.getElementById('lvltag').textContent='LV'+p.level;
  document.getElementById('cntx').textContent=p.coins;
  document.getElementById('pttx').textContent=p.pots;
  document.getElementById('bmtx').textContent=p.bombs;
  document.getElementById('pic').textContent=p.pots;
  document.getElementById('bic').textContent=p.bombs;
  const mpic=document.getElementById('mpic');if(mpic)mpic.textContent=p.pots;
  const mbic=document.getElementById('mbic');if(mbic)mbic.textContent=p.bombs;
}
function pslClick(n){
  document.querySelectorAll('.psl').forEach((el,i)=>el.classList.toggle('on',i===n));
  if(n===1)usePot();if(n===2)useBomb();
}
function showMsg(t){
  const el=document.getElementById('msg');el.textContent=t;el.classList.add('on');
  clearTimeout(msgT);msgT=setTimeout(()=>el.classList.remove('on'),2600);
}

// ‚îÄ‚îÄ HELPERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function dMtn(c,x,y,w,col){c.fillStyle=col;for(let i=0;i<w;i++){const h=(1-Math.pow(i/w*2-1,2))*w*.8;c.fillRect(x-w/2+i,y+w*.8-h,1,h);}}
function dLava(c,x,y,t){for(let i=0;i<50;i++){const sy=y+i*3,sx=x+Math.sin(t*2+i*.35)*7,a=.35+Math.sin(t*3+i*.25)*.4;c.fillStyle=`rgba(255,${90+Math.sin(t*2+i*.5)*50},0,${a})`;c.fillRect(~~sx-2,~~sy,4+~~(Math.abs(Math.sin(i*.4))*4),4);}}
function dChain(c,x1,y1,x2,y2){const n=9;for(let i=0;i<=n;i++){const t=i/n,x=x1+(x2-x1)*t,y=y1+(y2-y1)*t;c.fillStyle='#5a4010';c.fillRect(~~x-3,~~y-3,6,6);c.fillStyle='#3a2808';c.fillRect(~~x-2,~~y-2,4,4);}}
function dSkull(c,x,y,col){c.fillStyle=col;c.fillRect(x-8,y-10,16,14);c.fillStyle='#0a0504';c.fillRect(x-5,y-8,4,4);c.fillRect(x+2,y-8,4,4);c.fillRect(x-3,y,8,4);}
function dTree(c,x,by,h,col){c.fillStyle=col||'#0a1808';c.fillRect(x-4,by,8,h);c.fillRect(x-20,by+h*.3,20,4);c.fillRect(x,by+h*.5,18,4);c.fillRect(x-14,by+h*.65,14,4);}
function dBigMsh(c,x,y,col){c.fillStyle='#2a1000';c.fillRect(x-5,y-20,10,20);c.fillStyle=col;c.fillRect(x-22,y-36,44,18);c.fillRect(x-16,y-42,32,12);c.fillRect(x-10,y-46,20,6);c.fillStyle='rgba(255,255,255,.4)';c.fillRect(x-14,y-32,6,6);c.fillRect(x+2,y-32,6,6);}
function dCrystal(c,x,y,h,col){c.fillStyle=col;c.fillRect(x-4,y,8,h);c.fillRect(x-2,y-8,4,10);c.fillStyle='rgba(150,220,255,.6)';c.fillRect(x-2,y,2,h*.4);}
function dCastle(c,x,y,w,h){c.fillStyle='#0a1828';c.fillRect(x,y+h*.3,w,h*.7);c.fillRect(x,y,44,h);c.fillRect(x+w-44,y,44,h);for(let i=0;i<5;i++){c.fillRect(x+i*11,y-12,7,12);c.fillRect(x+w-55+i*11,y-12,7,12);}c.fillStyle='#050c14';c.fillRect(x+w/2-17,y+h*.5,34,h*.5);}
function dCloud(c,x,y,col){c.fillStyle=col;c.fillRect(x,y,64,18);c.fillRect(x+8,y-12,44,16);c.fillRect(x+18,y-20,26,14);}
function dTower(c,x,y,w,h){c.fillStyle='#0f0820';c.fillRect(x-w/2,y,w,h);c.fillStyle='#180c30';for(let i=0;i<3;i++)c.fillRect(x-w/2+i*(w/3),y-12,w/4,12);}
function dFirePillar(c,x,y,t,v=false){for(let i=0;i<9;i++){const a=.2+Math.sin(t*4+i*.7)*.22,w=17-i*1.7,col=v?`rgba(180,0,80,${a})`:`rgba(255,${i*22},0,${a})`;c.fillStyle=col;c.fillRect(x-w/2+~~(Math.sin(t*3+i)*5),y+i*16,~~w,18);}}
function dMtnSmooth(c,x,y,w,col){
  c.fillStyle=col;c.beginPath();c.moveTo(x-w/2,y+w*.7);
  const steps=~~(w/4)+1;
  for(let i=0;i<=steps;i++){const p=i/steps,mx=x-w/2+p*w,my=y+w*.7-w*.85*(1-Math.pow(p*2-1,2));c.lineTo(mx,my);}
  c.closePath();c.fill();
}
function dPixelTree(c,x,by,h,col){
  const trunkW=Math.max(5,~~(h*.08)),trunkH=~~(h*.35);
  const trunkCol=shade(col,.45);
  // Trunk
  c.fillStyle=trunkCol;c.fillRect(x-~~(trunkW/2),by+h-trunkH,trunkW,trunkH);
  c.fillStyle=shade(trunkCol,.7);c.fillRect(x-~~(trunkW/2),by+h-trunkH,~~(trunkW/2),trunkH);
  // Layered triangular canopy (3 tiers)
  const tiers=3;
  for(let i=0;i<tiers;i++){
    const ty=by+~~(h*(i/(tiers+.5)));
    const tw=~~(h*.55*(1-i*.18));
    const th=~~(h*.42*(1-i*.12));
    const tc=i===0?shade(col,.82):i===1?col:shade(col,1.22);
    // Triangle body
    c.fillStyle=tc;
    c.beginPath();c.moveTo(x,ty-4);c.lineTo(x+~~(tw/2),ty+th);c.lineTo(x-~~(tw/2),ty+th);c.fill();
    // Highlight edge
    c.fillStyle=shade(tc,1.35);
    c.beginPath();c.moveTo(x,ty-4);c.lineTo(x+~~(tw/6),ty+~~(th*.4));c.lineTo(x-~~(tw/8),ty+~~(th*.4));c.fill();
    // Pixel top jagged edge
    c.fillStyle=shade(tc,1.18);
    for(let px=x-~~(tw/2)+2;px<x+~~(tw/2)-2;px+=4){
      if((px+x)%8<4)c.fillRect(px,ty-4,3,5);
    }
    // Dark underside
    c.fillStyle=shade(tc,.65);
    c.fillRect(x-~~(tw/2),ty+th-5,tw,5);
  }
}
function blendHex(c1,c2,t){
  const r1=parseInt(c1.slice(1,3),16),g1=parseInt(c1.slice(3,5),16),b1=parseInt(c1.slice(5,7),16);
  const r2=parseInt(c2.slice(1,3),16),g2=parseInt(c2.slice(3,5),16),b2=parseInt(c2.slice(5,7),16);
  const r=~~(r1+(r2-r1)*t),g=~~(g1+(g2-g1)*t),b=~~(b1+(b2-b1)*t);
  return`#${r.toString(16).padStart(2,'0')}${g.toString(16).padStart(2,'0')}${b.toString(16).padStart(2,'0')}`;
}
function dPixelCloud(c,x,y,col){// legacy wrapper
  dFluffyCloud(c,x,y,col,0.8,55);
}
function dFluffyCloud(c,x,y,col,alpha,size){
  const s=size||55,a=alpha||0.85;
  c.save();c.globalAlpha*=a;
  const shadow=shade(col,.7),hi=blendHex(col,'#ffffff',.35);
  // Bottom shadow row
  c.fillStyle=shadow;
  [[0,s*.55,s*.55,s*.25],[s*.1,s*.65,s*.45,s*.2],[s*.45,s*.6,s*.45,s*.22]].forEach(([bx,by,bw,bh])=>c.fillRect(~~(x+bx),~~(y+by),~~bw,~~bh));
  // Main body blocks
  c.fillStyle=col;
  [[0,s*.35,s*.6,s*.3],[s*.4,s*.3,s*.55,s*.35],[s*.15,s*.2,s*.65,s*.4],[s*.05,s*.4,s*.9,s*.25]].forEach(([bx,by,bw,bh])=>c.fillRect(~~(x+bx),~~(y+by),~~bw,~~bh));
  // Top highlight bumps
  c.fillStyle=hi;
  [[s*.12,s*.08,s*.3,s*.18],[s*.44,s*.04,s*.28,s*.2],[s*.22,s*.02,s*.2,s*.15]].forEach(([bx,by,bw,bh])=>c.fillRect(~~(x+bx),~~(y+by),~~bw,~~bh));
  // Pixel edge top row
  c.fillStyle=blendHex(hi,'#ffffff',.5);
  for(let px=~~(x+s*.14);px<~~(x+s*.82);px+=4)c.fillRect(px,~~(y+s*.04),3,3);
  c.restore();
}
function dHut(c,x,y){
  // Thatched hut
  c.fillStyle='#5a3808';c.fillRect(x,y,70,40);// walls
  c.fillStyle='#6a4410';c.fillRect(x,y,70,14);// wall top
  c.fillStyle='#c8a030';// thatch
  c.beginPath();c.moveTo(x-8,y);c.lineTo(x+35,y-30);c.lineTo(x+78,y);c.fill();
  c.fillStyle='#e0b840';c.fillRect(x-6,y-2,84,6);// thatch layers
  c.fillRect(x-4,y-10,80,5);c.fillRect(x+2,y-18,68,4);c.fillRect(x+8,y-26,58,4);
  c.fillStyle='#3a2208';c.fillRect(x+18,y+10,18,30);// door
  c.fillStyle='#1a0e04';c.fillRect(x+20,y+12,14,28);
  c.fillStyle='#5a3808';c.fillRect(x+45,y+16,14,12);// window
  c.fillStyle='#a0c0e0';c.fillRect(x+47,y+18,10,8);
  // Fence
  c.fillStyle='#8a6030';for(let fi=0;fi<6;fi++){c.fillRect(x-10+fi*16,y+30,6,12);c.fillRect(x+70+fi*16,y+30,6,12);}
  c.fillRect(x-10,y+32,100,4);
}
function dCampfire(c,x,y,t){
  // Logs
  c.fillStyle='#5a2808';c.save();c.translate(x,y);c.rotate(.3);c.fillRect(-18,0,36,7);c.restore();
  c.save();c.translate(x,y);c.rotate(-.3);c.fillRect(-18,0,36,7);c.restore();
  // Flames
  const lh=12+~~(Math.sin(t*5)*4);const lh2=9+~~(Math.sin(t*6+1)*3);
  c.fillStyle=`rgba(255,${60+~~(Math.sin(t*4)*30)},0,.9)`;
  c.beginPath();c.moveTo(x-10,y);c.lineTo(x,y-lh);c.lineTo(x+10,y);c.fill();
  c.fillStyle=`rgba(255,${140+~~(Math.sin(t*5)*40)},0,.8)`;
  c.beginPath();c.moveTo(x-6,y);c.lineTo(x,y-lh2);c.lineTo(x+6,y);c.fill();
  c.fillStyle=`rgba(255,230,80,${.7+Math.sin(t*6)*.2})`;
  c.beginPath();c.moveTo(x-3,y);c.lineTo(x,y-lh2+4);c.lineTo(x+3,y);c.fill();
  glow(c,x,y-8,28,`rgba(255,140,0,${.22+Math.sin(t*4)*.12})`);
}
function dDistantCastle(c,x,y){
  // Distant pixel castle (from reference image)
  c.fillStyle='#9aacbc';
  c.fillRect(x+20,y+40,80,70);// main body
  c.fillRect(x,y+50,30,60);// left tower base
  c.fillRect(x+90,y+50,30,60);// right tower base
  c.fillStyle='#8a9cac';
  c.fillRect(x+2,y+40,28,12);c.fillRect(x+90,y+40,28,12);// tower tops
  // Battlements
  c.fillStyle='#7a8c9c';
  for(let i=0;i<4;i++){c.fillRect(x+2+i*8,y+36,6,8);c.fillRect(x+92+i*8,y+36,6,8);}
  for(let i=0;i<6;i++){c.fillRect(x+22+i*12,y+36,8,8);}
  // Windows
  c.fillStyle='#1a2838';
  c.fillRect(x+10,y+58,8,12);c.fillRect(x+100,y+58,8,12);
  c.fillRect(x+35,y+56,10,14);c.fillRect(x+55,y+56,10,14);c.fillRect(x+75,y+56,10,14);
  // Flags (red)
  c.fillStyle='#cc2020';c.fillRect(x+8,y+28,14,10);c.fillRect(x+100,y+28,14,10);
  c.fillStyle='#6a2020';c.fillRect(x+6,y+26,3,14);c.fillRect(x+98,y+26,3,14);
  // Highlight
  c.fillStyle='rgba(200,220,240,.15)';c.fillRect(x+20,y+40,80,4);
}
function dDistantIceCastle(c,x,y){
  c.fillStyle='#6090c0';
  c.fillRect(x+20,y+40,80,70);
  c.fillRect(x,y+50,28,60);c.fillRect(x+92,y+50,28,60);
  c.fillStyle='#80b0d0';c.fillRect(x+2,y+40,26,12);c.fillRect(x+92,y+40,26,12);
  c.fillStyle='#4878a8';
  for(let i=0;i<4;i++){c.fillRect(x+2+i*7,y+36,5,8);c.fillRect(x+92+i*7,y+36,5,8);}
  for(let i=0;i<5;i++){c.fillRect(x+24+i*13,y+36,8,8);}
  c.fillStyle='#1030a8';c.fillRect(x+10,y+58,8,12);c.fillRect(x+100,y+58,8,12);
  c.fillRect(x+38,y+54,10,16);c.fillRect(x+58,y+54,10,16);
  // Icicle towers
  c.fillStyle='#a0d0f0';c.fillRect(x+8,y+24,8,18);c.fillRect(x+98,y+24,8,18);
  c.fillRect(x+10,y+18,4,10);c.fillRect(x+100,y+18,4,10);
}
function dWaterfall(c,x,y,t){
  // Waterfall from rocks
  c.fillStyle='#6888a8';c.fillRect(x-16,y-20,36,30);c.fillRect(x-10,y-28,24,12);// rocks
  c.fillStyle='#8aaac8';c.fillRect(x-14,y-18,34,6);// rock top
  for(let i=0;i<5;i++){
    const wx=x-4+i*3,wy=y,wh=50+i*4;
    c.fillStyle=`rgba(100,160,220,${.5+Math.sin(t*4+i)*.2})`;
    c.fillRect(wx,wy,3+i%2,wh);
  }
  glow(c,x+6,y+30,22,`rgba(80,160,240,.2)`);
  // Pool at bottom
  c.fillStyle='rgba(60,120,200,.55)';c.beginPath();c.ellipse(x+6,y+52,22,10,0,0,Math.PI*2);c.fill();
}
function drawChest(x,y,t){
  ctx.save();ctx.translate(~~x,~~y);
  // Shadow
  ctx.fillStyle='rgba(0,0,0,.3)';ctx.beginPath();ctx.ellipse(0,8,20,5,0,0,Math.PI*2);ctx.fill();
  // Body
  ctx.fillStyle='#5a3208';ctx.fillRect(-18,-12,36,20);
  ctx.fillStyle='#7a4810';ctx.fillRect(-18,-12,36,6);// top stripe
  ctx.fillStyle='#3e1e04';ctx.fillRect(-18,2,36,6);// bottom darker
  // Horizontal strap
  ctx.fillStyle='#c8922a';ctx.fillRect(-18,-4,36,5);
  ctx.fillStyle='#f0b840';ctx.fillRect(-18,-4,36,2);// strap shine
  // Lock
  ctx.fillStyle='#d0a020';ctx.fillRect(-5,-7,10,8);
  ctx.fillStyle='#f0c030';ctx.fillRect(-4,-7,8,4);
  ctx.fillStyle='#1a0e00';ctx.fillRect(-2,-3,4,4);ctx.fillRect(-1,-5,2,3);
  // Lid highlight
  ctx.fillStyle='rgba(255,200,80,.2)';ctx.fillRect(-17,-12,34,4);
  // Corner nails
  ctx.fillStyle='#d0a020';
  [[- 14,-9],[12,-9],[-14,3],[12,3]].forEach(([nx,ny])=>{ctx.fillRect(nx,ny,4,4);ctx.fillStyle='#f0c030';ctx.fillRect(nx+1,ny,2,2);ctx.fillStyle='#d0a020';});
  // Glow if wave cleared
  const isCleared=G&&G.currentStageCleared;
  if(isCleared){
    glow(ctx,0,-4,32,`rgba(255,200,0,${.25+Math.sin((t||0)*4)*.15})`);
    ctx.fillStyle=`rgba(255,220,80,${.4+Math.sin((t||0)*6)*.3})`;
    ctx.fillRect(-2,-18,4,10);ctx.fillRect(-6,-14,3,3);ctx.fillRect(3,-14,3,3);
  }
  ctx.restore();
}
function drawSign(x,y){
  ctx.save();ctx.translate(~~x,~~y);
  // Post
  ctx.fillStyle='#7a5020';ctx.fillRect(-4,0,8,35);
  ctx.fillStyle='#9a6830';ctx.fillRect(-3,0,4,35);// highlight
  // Sign board
  ctx.fillStyle='#aa7830';ctx.fillRect(-22,-28,44,26);
  ctx.fillStyle='#c89040';ctx.fillRect(-22,-28,44,6);// top highlight
  ctx.fillStyle='#7a5020';ctx.fillRect(-22,-6,44,4);// bottom shadow
  // Arrow
  ctx.fillStyle='#3a2008';ctx.font='7px "Press Start 2P"';ctx.textAlign='center';
  ctx.fillText('‚ñ∫',0,-14);
  // Shadow
  ctx.fillStyle='rgba(0,0,0,.25)';ctx.beginPath();ctx.ellipse(0,36,6,2,0,0,Math.PI*2);ctx.fill();
  ctx.restore();
}
function glow(c,x,y,r,col){const g=c.createRadialGradient(x,y,0,x,y,r);g.addColorStop(0,col);g.addColorStop(1,'transparent');c.fillStyle=g;c.fillRect(x-r,y-r,r*2,r*2);}
function shade(hex,f){const r=parseInt(hex.slice(1,3),16),g=parseInt(hex.slice(3,5),16),b=parseInt(hex.slice(5,7),16);return`#${cc(r*f)}${cc(g*f)}${cc(b*f)}`;}
function cc(v){return Math.max(0,Math.min(255,~~v)).toString(16).padStart(2,'0');}
function h2r(hex){const r=parseInt(hex.slice(1,3),16),g=parseInt(hex.slice(3,5),16),b=parseInt(hex.slice(5,7),16);return`${r},${g},${b}`;}
function addPt(x,y,c,n){for(let i=0;i<n;i++)G.particles.push({x,y,vx:(Math.random()-.5)*5.5,vy:(Math.random()-.5)*5.5-2,life:1,ml:.45+Math.random()*.4,color:c,size:2+~~(Math.random()*4)});}
function addFT(t,x,y,c){G.texts.push({t,x,y,c,life:1,vy:-1.1});}
function rng(a,b){return~~(Math.random()*(b-a))+a;}
function clamp(v,a,b){return Math.max(a,Math.min(b,v));}
function dist(a,b){const dx=a.x-b.x,dy=a.y-b.y;return Math.sqrt(dx*dx+dy*dy);}
function closest(){return G.enemies.filter(e=>e.alive).sort((a,b)=>dist(G.pl,a)-dist(G.pl,b))[0]||null;}

// ‚îÄ‚îÄ INPUT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
document.addEventListener('keydown',e=>{
  if(!G)return;G.keys[e.key]=true;
  if(e.key==='z'||e.key==='Z'){e.preventDefault();plAtk();}
  if(e.key==='x'||e.key==='X'){e.preventDefault();usePot();}
  if(e.key==='b'||e.key==='B'){e.preventDefault();useBomb();}
  if(e.key==='e'||e.key==='E'){e.preventDefault();toggleShop();}
  if(e.key==='m'||e.key==='M'){e.preventDefault();toggleMap();}
  if(e.key==='r'||e.key==='R'){e.preventDefault();toggleRank();}
  if(e.key==='Tab'){e.preventDefault();nextStage();}
});
document.addEventListener('keyup',e=>{if(G)delete G.keys[e.key];});
document.getElementById('ni').addEventListener('keydown',e=>{if(e.code==='Enter')startGame();});

// ‚îÄ‚îÄ TITLE STARS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
(function(){
  const c=document.getElementById('starbg');
  for(let i=0;i<50;i++){
    const s=document.createElement('div');
    const sz=Math.random()>.75?2:1;
    s.style.cssText=`position:absolute;width:${sz}px;height:${sz}px;background:#fff;left:${Math.random()*100}%;top:${Math.random()*100}%;animation:blink ${1.5+Math.random()*2.5}s step-end infinite;animation-delay:${Math.random()*3}s;`;
    c.appendChild(s);
  }
})();

// ‚îÄ‚îÄ BOOT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
layout();
setupDpad();
// Initial render loop (title screen uses forest stage visuals)
(function initRender(){
  if(G)return;
  requestAnimationFrame(initRender);
  const t=Date.now()/1000;
  // Sky gradient - bright blue like reference
  const gr2=ctx.createLinearGradient(0,0,0,CH);
  gr2.addColorStop(0,'#4a90d8');gr2.addColorStop(.5,'#80c8f8');gr2.addColorStop(1,'#b0dcf8');
  ctx.fillStyle=gr2;ctx.fillRect(0,0,CW,CH);
  // Distant mountains with snow
  dMtnSmooth(ctx,120,200,200,'#6090a0');dMtnSmooth(ctx,350,190,180,'#708fa0');dMtnSmooth(ctx,560,210,150,'#6090a0');
  ctx.fillStyle='#e8f4f8';dMtnSmooth(ctx,120,182,50,'#e8f4f8');dMtnSmooth(ctx,350,172,44,'#e8f4f8');
  // Rolling hills
  ctx.fillStyle='#4a8830';ctx.beginPath();ctx.moveTo(0,240);
  for(let x=0;x<=700;x+=14)ctx.lineTo(x,230+Math.sin(x*.018+1)*22+Math.sin(x*.031)*12);
  ctx.lineTo(700,420);ctx.lineTo(0,420);ctx.fill();
  ctx.fillStyle='#60a840';ctx.beginPath();ctx.moveTo(0,258);
  for(let x=0;x<=700;x+=10)ctx.lineTo(x,248+Math.sin(x*.022+2)*18+Math.sin(x*.04)*8);
  ctx.lineTo(700,420);ctx.lineTo(0,420);ctx.fill();
  // Trees
  for(let i=0;i<9;i++)dPixelTree(ctx,i*80,200,60+i%3*10,'#2a6818');
  for(let i=0;i<6;i++)dPixelTree(ctx,30+i*110,228,72+i%3*14,'#368a20');
  dPixelTree(ctx,-20,258,90,'#2a7018');dPixelTree(ctx,640,250,85,'#248018');
  // Castle
  dDistantCastle(ctx,470,118);
  // Waterfall
  dWaterfall(ctx,535,143,t);
  // Ground
  const gg=ctx.createLinearGradient(0,260,0,420);
  gg.addColorStop(0,'#4a9428');gg.addColorStop(.3,'#3a7820');gg.addColorStop(1,'#1a3010');
  ctx.fillStyle=gg;ctx.fillRect(0,260,CW,160);
  ctx.fillStyle='#58b030';
  for(let x=0;x<CW;x+=6)ctx.fillRect(x,260+~~(Math.sin(x*.08)*3),3,5+~~(Math.sin(x*.14)*3));
  ctx.fillStyle='#8a6838';ctx.fillRect(170,300,360,120);
  // Path
  ctx.fillStyle='#9a7848';ctx.fillRect(172,302,356,116);
  // Hut and campfire
  dHut(ctx,55,245);dCampfire(ctx,190,262,t);
  // Flowers
  [[130,278,'#ff6080'],[255,273,'#ffee40'],[435,276,'#ff6080'],[545,280,'#ffffff'],[78,308,'#ffee40'],[625,283,'#ff80c0']].forEach(([fx,fy,fc])=>{ctx.fillStyle=fc;ctx.fillRect(fx,fy,4,4);ctx.fillRect(fx-4,fy,4,4);ctx.fillRect(fx+4,fy,4,4);ctx.fillStyle='#ffff60';ctx.fillRect(fx,fy,2,2);});
  // Rocks
  [[100,295,18],[480,298,16],[540,312,10],[120,350,11]].forEach(([rx,ry,rs])=>{ctx.fillStyle='#7a8090';ctx.fillRect(rx-rs/2,ry-rs/3,rs,rs*.6);ctx.fillStyle='#9aaab8';ctx.fillRect(rx-rs/2,ry-rs/3,rs,rs*.25);});
  // Floating pollen
  for(let i=0;i<8;i++){const px=(i*97+t*18*(i%3+.5))%720-10,py=120+Math.sin(t*1.2+i*.8)*40+(i%4)*20;ctx.fillStyle=`rgba(255,240,100,${.5+Math.sin(t*2+i)*.3})`;ctx.fillRect(~~px,~~py,3,3);}
})();
</script>
</body>
</html>